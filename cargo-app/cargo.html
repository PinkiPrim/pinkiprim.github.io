<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Cargo Pilot Helper</title>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #0277bd;
            --primary-dim: #004c8c;
            --bg-glass: rgba(15, 15, 15, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(2, 119, 189, 0.3);
            --green: #00e676;
            --orange: #ff9800;
            --red: #ff5252;
            --accent: #ffc107;
            --gold: #ffd700;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #tracker-app {
            position: absolute;
            top: 50px; left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            min-height: 200px;
            transition: width 0.2s ease, height 0.2s ease;
        }

        /* --- MINI MODE --- */
        #tracker-app.mini-mode {
            width: 420px !important;
            height: 74px !important;
            min-height: 74px !important;
            border-radius: 12px;
            background: rgba(10, 10, 10, 0.98);
            border: 1px solid var(--primary);
            resize: none;
        }

        #tracker-app.mini-mode header, 
        #tracker-app.mini-mode #sky-container,
        #tracker-app.mini-mode #content,
        #tracker-app.mini-mode #grinder-panel { display: none !important; }

        #micro-view {
            display: none;
            flex-direction: column;
            justify-content: center;
            height: 100%;
            padding: 0 12px;
            font-family: 'Rajdhani', sans-serif;
            cursor: move;
        }
        #tracker-app.mini-mode #micro-view { display: flex; }

        .micro-row { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 50%; }
        .micro-group { display: flex; align-items: center; gap: 8px; }
        .micro-sep { width: 1px; height: 12px; background: rgba(255,255,255,0.2); }
        .micro-label { color: var(--text-dim); font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; }
        .micro-val { color: #fff; font-weight: 700; font-size: 0.9em; }
        .micro-val.highlight { color: var(--primary); }
        .micro-val.active { color: var(--green); }
        
        .micro-progress-bg { width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 0 5px; }
        .micro-progress-fill { height: 100%; background: var(--primary); width: 0%; }

        .micro-btn {
            position: absolute; top: 4px; right: 4px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #aaa; padding: 0px 4px; border-radius: 3px; font-size: 0.6em; cursor: pointer;
        }
        .micro-btn:hover { background: var(--primary); color: white; }

        /* --- HEADER & ANIMATION --- */
        header {
            background: linear-gradient(180deg, var(--primary-dim), rgba(2, 119, 189, 0.2));
            height: 70px; 
            padding: 0 10px;
            cursor: move;
            position: relative;
            display: flex; align-items: flex-start; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            overflow: visible; 
            padding-top: 5px;
            z-index: 60;
        }

        .header-title {
            position: absolute; left: 50%; top: 20%;
            transform: translate(-50%, -50%);
            font-family: 'Rajdhani', sans-serif; 
            font-weight: 900; font-size: 1.2em;
            text-transform: uppercase; letter-spacing: 2px;
            color: #fff; pointer-events: none; white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }

        #sky-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            overflow: hidden; pointer-events: none; z-index: 5;
        }

        .drop-group {
            position: absolute; top: -90px; 
            display: flex; flex-direction: column; align-items: center; opacity: 0.8;
        }
        .parachute { font-size: 2.2em; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); z-index: 6; }
        .crate {
            font-size: 1.8em; margin-top: -5px; 
            animation: crateWiggle 2s ease-in-out infinite alternate;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5)); transform-origin: top center; 
        }

        @keyframes dropFall {
            0% { top: -90px; opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { top: 110px; opacity: 0; } 
        }
        @keyframes crateWiggle { from { transform: rotate(-15deg); } to { transform: rotate(15deg); } }

        .drop-1 { left: 10%; animation: dropFall 8s linear infinite; transform: scale(0.8); }
        .drop-2 { left: 30%; animation: dropFall 6s linear infinite 2s; transform: scale(1); }
        .drop-3 { left: 50%; animation: dropFall 9s linear infinite 1s; transform: scale(0.7); }
        .drop-4 { left: 70%; animation: dropFall 7s linear infinite 4s; transform: scale(0.9); }
        .drop-5 { left: 90%; animation: dropFall 10s linear infinite 0.5s; transform: scale(0.6); }

        .header-controls { display: flex; gap: 8px; z-index: 30; align-items: center; }
        .nav-icon { text-decoration: none; font-size: 1.1em; cursor: pointer; color: #ccc; }
        .nav-icon:hover { color: #fff; }
        
        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #fff; font-size: 0.85em; z-index: 20; margin-top: 4px; }

        /* BURGER MENU */
        .menu-container { position: relative; }
        .burger-btn {
            background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; padding: 2px 6px; border-radius: 4px; cursor: pointer;
            font-size: 1.2em; line-height: 1; display: flex; align-items: center; justify-content: center;
        }
        .burger-btn:hover { background: var(--primary); color: white; border-color: var(--accent); }

        .dropdown-menu {
            position: absolute; top: 100%; right: 0; margin-top: 5px;
            background: #121212; border: 1px solid var(--primary); border-radius: 4px;
            width: 140px; display: none; flex-direction: column; z-index: 100;
            box-shadow: 0 5px 15px rgba(0,0,0,0.9);
        }
        .dropdown-menu.show { display: flex; }
        
        .menu-item {
            padding: 10px; color: #ccc; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.9em;
            border-bottom: 1px solid rgba(255,255,255,0.1); transition: 0.2s;
        }
        .menu-item:hover { background: var(--primary); color: #000; }
        .menu-item:last-child { border-bottom: none; }

        /* GRINDER PANEL */
        #grinder-panel {
            position: absolute; top: 70px; left: 0; width: 100%; height: calc(100% - 70px);
            background: rgba(10, 10, 10, 0.98); z-index: 50; display: none;
            flex-direction: column; padding: 15px; box-sizing: border-box;
            backdrop-filter: blur(5px); overflow-y: auto;
        }
        #grinder-panel.active { display: flex; }

        .grinder-header {
            font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 1.1em;
            color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px;
            display: flex; justify-content: space-between;
        }

        .stat-row {
            display: flex; justify-content: space-between; margin-bottom: 8px;
            font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 4px;
        }
        .stat-val.gold { color: var(--gold); }
        .stat-val.green { color: var(--green); }
        
        .bonus-list {
            margin-top: 10px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px;
            font-size: 0.8em; color: #ccc;
        }
        .bonus-item { color: var(--primary); margin-bottom: 4px; display: flex; align-items: center; gap: 5px; }
        
        .quick-btn { 
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); 
            color: #ccc; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; 
            cursor: pointer; flex: 1; font-family: inherit; font-weight: bold;
        }
        .quick-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* --- CONTENT --- */
        #content { padding: 12px; flex: 1; overflow-y: auto; scrollbar-width: thin; }

        .destination-display { background: rgba(255, 193, 7, 0.1); border: 1px dashed var(--accent); border-radius: 6px; padding: 10px; margin-bottom: 15px; text-align: center; transition: all 0.3s ease; }
        .dest-label { font-size: 0.7em; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 4px; }
        .dest-value { font-family: 'Rajdhani', sans-serif; font-size: 1.3em; font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); line-height: 1.1; }
        
        .multi-warning { display: none; font-size: 0.75em; margin-top: 8px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; animation: warnPulse 1s infinite alternate; }
        @keyframes warnPulse { from { color: white; text-shadow: 0 0 2px black; } to { color: #ff3333; text-shadow: 0 0 10px red; } }

        .section { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .section:last-child { border-bottom: none; }

        .label { font-size: 0.7em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }

        .progress-container { position: relative; height: 16px; background: rgba(0,0,0,0.5); border-radius: 4px; margin: 5px 0 5px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; text-shadow: 1px 1px 2px black; font-weight: bold; z-index: 2; }

        .xp-remaining-text { text-align: center; font-size: 0.8em; color: var(--text-dim); margin-bottom: 10px; }
        .xp-remaining-text b { color: var(--primary); }

        .run-box { background: rgba(2, 119, 189, 0.1); border: 1px solid rgba(2, 119, 189, 0.3); border-radius: 4px; padding: 8px; margin-bottom: 10px; }
        .run-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em; }
        .run-val { font-weight: bold; color: #fff; }
        .run-label { font-size: 0.8em; color: #aaa; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 6px; border-radius: 4px; text-align: center; }

        .trunk-header { display: flex; justify-content: space-between; align-items: center; }
        .sync-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #444; margin-left: 5px; }
        .sync-dot.live { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .sync-dot.cached { background: var(--orange); }
        .trunk-item { display: flex; justify-content: space-between; font-size: 0.85em; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }

        input[type="number"] { width: 90%; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; margin-top: 5px; font-family: inherit; font-size: 0.9em; }
        input:focus { outline: 1px solid var(--primary); }
        .calc-output { margin-top: 5px; font-size: 0.8em; line-height: 1.3; color: var(--text-dim); word-wrap: break-word; }
        
        .quick-btn-row { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        
        #resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; }
    </style>
</head>
<body>

<div id="tracker-app">
    <div id="micro-view" onmousedown="dragStart(event)">
        <button class="micro-btn" onclick="window.toggleMini()">EXPAND</button>
        
        <div class="micro-row" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="micro-group">
                <span style="font-size:1.2em">üì¶</span>
                <span class="micro-val highlight">CARGO OPS</span>
            </div>
            <div class="micro-group">
                <span class="micro-label">Dest:</span>
                <span class="micro-val" id="micro-dest" style="max-width:140px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">--</span>
            </div>
            <div class="micro-group">
                <span class="micro-label">Load:</span>
                <span class="micro-val active" id="micro-weight">0kg</span>
            </div>
        </div>

        <div class="micro-row">
            <div class="micro-group" style="min-width: 90px;">
                <span class="micro-label">Lvl</span>
                <span class="micro-val highlight" id="micro-level">0</span>
                <div class="micro-progress-bg">
                    <div class="micro-progress-fill" id="micro-bar"></div>
                </div>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">XP:</span>
                <span class="micro-val" id="micro-xp">0</span>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Tok:</span>
                <span class="micro-val active" id="micro-tokens">0</span>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Left:</span>
                <span class="micro-val highlight" id="micro-calc">--</span>
            </div>
        </div>
    </div>

    <header id="drag-handle" onmousedown="dragStart(event)">
        <div class="header-controls">
            <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon">üè†</a>
        </div>
        
        <div class="header-title">CARGO OPS</div>
        
        <div id="sky-container">
            <div class="drop-group drop-1"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-2"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-3"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-4"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
            <div class="drop-group drop-5"><div class="parachute">ü™Ç</div><div class="crate">üì¶</div></div>
        </div>

        <div class="header-controls" style="flex-direction:column; gap:2px; align-items:flex-end;">
            <div class="menu-container">
                <button class="burger-btn" onclick="toggleMenu()">‚ò∞</button>
                <div class="dropdown-menu" id="main-menu">
                    <div class="menu-item" onclick="window.toggleMini()">üóñ Mini Mode</div>
                    <div class="menu-item" onclick="toggleGrinder()">üìà Grinder Stats</div>
                    <div class="menu-item" onclick="resetSession()">üîÑ Reset Session</div>
                </div>
            </div>
            <span id="clock">00:00</span>
        </div>
    </header>

    <div id="grinder-panel">
        <div class="grinder-header">
            <span>BXP TOKEN TRACKER</span>
            <span style="color:#aaa; font-size:0.7em">CARGO PILOT</span>
        </div>
        <div class="stat-row"><span class="label" style="color:#ccc">Session Earned</span><span class="stat-val gold" id="g-session">0</span></div>
        <div class="stat-row"><span class="label" style="color:#ccc">AVG Per Drop</span><span class="stat-val" id="g-avg">0</span></div>
        <div class="stat-row"><span class="label" style="color:#ccc">Est. Per Hour</span><span class="stat-val green" id="g-ph">0</span></div>
        <div class="stat-row"><span class="label" style="color:#ccc">Start Balance</span><span class="stat-val" id="g-start">0</span></div>
        <div class="grinder-header" style="margin-top:15px; color:var(--primary); border-bottom:1px solid #444;"><span>ACTIVE BONUSES</span></div>
        <div class="bonus-list" id="bonus-container"><div style="font-style:italic; opacity:0.5; font-size:0.8em">Open 'Identity' menu in-game to scan...</div></div>
        <div style="margin-top:auto; text-align:center;"><button class="quick-btn" onclick="toggleGrinder()">CLOSE PANEL</button></div>
    </div>

    <div id="content">
        
        <div class="destination-display" id="dest-box">
            <div class="dest-label">Next Destination</div>
            <div class="dest-value" id="disp-destination">Waiting for cargo...</div>
            <div id="multi-warning" class="multi-warning">‚ö† Multiple Cargo Types ‚ö†</div>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Pilot Level</div><div class="value highlight" style="font-size:1.6em" id="disp-level">...</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>
            
            <div class="xp-remaining-text" id="disp-xp-remaining">Waiting for drop...</div>

            <div class="run-box">
                <div style="border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px; padding-bottom:3px; color:var(--primary); font-size:0.85em; font-weight:bold; letter-spacing:1px;">FLIGHT SESSION</div>
                <div class="run-grid">
                    <div>
                        <div class="run-label">Current Flight XP</div>
                        <div class="run-val" id="disp-flight-xp" style="color:var(--green)">0 XP</div>
                    </div>
                    <div style="text-align:right">
                        <div class="run-label">Avg XP / Flight</div>
                        <div class="run-val" id="disp-flight-avg">0 XP</div>
                    </div>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-box"><div class="label">BXP Tokens</div><div class="value bxp" id="disp-bxp">0</div></div>
                <div class="stat-box"><div class="label">Flights Done</div><div class="value" id="disp-ops" style="color:var(--accent)">0</div></div>
            </div>
        </div>

        <div class="section">
            <div class="trunk-header">
                <div class="label">üì¶ Cargo Hold <span id="sync-status" class="sync-dot"></span></div>
                <div class="label" id="trunk-capacity"></div>
            </div>
            <div id="trunk-list" style="min-height:30px; color:#666; font-size:0.8em; font-style:italic;">
                No cargo loaded.
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Flight Calculator</div>
            <div style="font-size:0.7em; color:#888;">Enter <b>Target XP</b>:</div>
            <input type="number" id="target-input" placeholder="e.g. 1000000">
            
            <div class="quick-btn-row">
                <button class="quick-btn" onclick="setCalc(100000)">100K</button>
                <button class="quick-btn" onclick="setCalc(1000000)">1M</button>
                <button class="quick-btn" onclick="setCalc(10000000)">10M</button>
            </div>

            <div class="calc-output" id="calc-result">Complete 1 flight to calibrate...</div>
        </div>

    </div>
    <div id="resize-handle" style="position:absolute; bottom:0; right:0; width:15px; height:15px; cursor:nwse-resize;"></div>
</div>

<script>
// --- AIRPORT DATABASE ---
const AIRPORTS = {
    "LSIA": "Los Santos INTL.", "SSIA": "Sandy Sh. INTL. Airport", "ZMA": "Zancudo Military Airport",
    "RAM": "Arroyo Muerto Municipal", "PBA": "Arroyo Muerto Municipal", 
    "POA": "Pacific Ocean Airport", "MGA": "Mount Gorgo Airport",
    "CIA": "Chumash Island Airport", "SCA": "San Chianski Airport", "POP": "PostOp Airport",
    "SAN": "Sandy Shores Airfield", "MKA": "McKenzie Airfield", "CPA": "Cayo Perico Airfield",
    "TVH": "Tongva Hills Airfield", "CV": "Carrier"
};

// --- STATE ---
let TRUNK_KEY = null;
let LAST_VEHICLE = null; 
let SESSION_START_TIME = Date.now();
const STORAGE_KEY_CALC = "target_xp_cargo";
const STORAGE_KEY_MINI = "mini_mode_cargo";

let MEMORY = {
    inventory: {},
    trunk: {},
    weight: 0,
    lastTrunkUpdate: 0,
    bonuses: []
};

const JOB_EXP_KEY = "exp_piloting_cargos";
const JOB_BXP_KEY_BONUS = "exp_token_a|piloting|cargos";
const JOB_BXP_KEY_TOKEN = "exp_token|piloting|cargos"; 

const STATE = {
    currentXP: 0, 
    runActive: false,
    runStartXP: 0, 
    currentRunGain: 0, 
    completedRuns: 0,
    totalRunXP: 0, 
    avgRunXP: 0,
    startTokens: null, 
    currentTokens: 0
};

// --- INIT ---
const savedTarget = localStorage.getItem(STORAGE_KEY_CALC);
if (savedTarget) document.getElementById('target-input').value = savedTarget;

const savedMini = localStorage.getItem(STORAGE_KEY_MINI);
if (savedMini === "true") {
    document.getElementById('tracker-app').classList.add('mini-mode');
}

// --- UI FUNCTIONS ---
window.toggleMini = function() {
    const app = document.getElementById('tracker-app');
    app.classList.toggle('mini-mode');
    localStorage.setItem(STORAGE_KEY_MINI, app.classList.contains('mini-mode'));
    document.getElementById('main-menu').classList.remove('show');
};

function toggleMenu() { document.getElementById('main-menu').classList.toggle('show'); }
window.onclick = function(e) { if (!e.target.matches('.burger-btn')) document.getElementById('main-menu').classList.remove('show'); }
function toggleGrinder() { document.getElementById('grinder-panel').classList.toggle('active'); document.getElementById('main-menu').classList.remove('show'); }

function resetSession() {
    STATE.startXP = STATE.currentXP;
    STATE.startTokens = STATE.currentTokens;
    STATE.runStartXP = 0;
    STATE.currentRunGain = 0;
    STATE.completedRuns = 0;
    STATE.totalRunXP = 0;
    STATE.avgRunXP = 0;
    SESSION_START_TIME = Date.now();
    document.getElementById('main-menu').classList.remove('show');
    if(STATE.currentTokens) updateGrinderUI(STATE.currentTokens);
    renderStats();
}

window.setCalc = function(amount) {
    document.getElementById('target-input').value = amount;
    runCalculator();
};

setInterval(() => {
    safeSetText('clock', new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
}, 1000);

// --- ENGINE ---
function requestData() {
    if(window.parent) {
        try { 
            let keys = [
                JOB_EXP_KEY, JOB_BXP_KEY_BONUS, JOB_BXP_KEY_TOKEN, 
                "inventory", "vehicle", "plate", 
                "chest", "trunkCapacity", "trunkWeight", "menu_choices"
            ];
            if(TRUNK_KEY) keys.push(TRUNK_KEY);
            window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
            window.parent.postMessage({ type: "getData" }, "*"); 
        } catch(e) {}
    }
}
setInterval(requestData, 1000); 

window.addEventListener('message', (event) => {
    let payload = event.data;
    if (payload && payload.type === 'data' && payload.data) payload = payload.data;
    if (!payload) return;

    processPayload(payload);
});

function processPayload(data) {
    // 1. SMART VEHICLE DETECTION
    let incomingPlate = data.plate || data.vehicle;
    if (incomingPlate) {
        if(LAST_VEHICLE && LAST_VEHICLE !== incomingPlate) {
            MEMORY.trunk = {}; 
            MEMORY.weight = 0;
            TRUNK_KEY = null;
            STATE.runActive = false;
            STATE.currentRunGain = 0;
        }
        LAST_VEHICLE = incomingPlate;
    }

    // 2. TRUNK KEY DISCOVERY
    if(data.chest && typeof data.chest === 'string' && data.chest.includes("veh_")) {
        TRUNK_KEY = "chest_" + data.chest;
    }
    if(!TRUNK_KEY) {
        for(let key in data) {
            if(key.startsWith("chest_") && key.includes("veh_") && typeof data[key] === 'string' && data[key] !== "{}") {
                TRUNK_KEY = key;
                break;
            }
        }
    }

    // 3. PARSE INVENTORIES
    if(data.inventory) {
        try { MEMORY.inventory = (typeof data.inventory === 'string') ? JSON.parse(data.inventory) : data.inventory; } catch(e){}
    }
    
    // UPDATE WEIGHT
    if(data.trunkWeight !== undefined) MEMORY.weight = Math.round(data.trunkWeight);
    
    // TRUNK PARSING LOGIC
    let incomingTrunk = null;
    if(TRUNK_KEY && data[TRUNK_KEY]) {
        try { 
            if(data[TRUNK_KEY] !== "") {
                incomingTrunk = (typeof data[TRUNK_KEY] === 'string') ? JSON.parse(data[TRUNK_KEY]) : data[TRUNK_KEY];
            }
        } catch(e){}
    }

    const syncDot = document.getElementById('sync-status');
    const now = Date.now();

    if(incomingTrunk && Object.keys(incomingTrunk).length > 0) {
        MEMORY.trunk = incomingTrunk;
        MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    } 
    else if (MEMORY.weight === 0) {
        MEMORY.trunk = {};
        MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    }
    else {
        if(now - MEMORY.lastTrunkUpdate > 3000) {
            syncDot.className = "sync-dot cached";
        }
    }

    // 4. DESTINATION & RUN DETECTION
    let hasCargo = checkForCargo(MEMORY.inventory, MEMORY.trunk);
    
    // 5. XP LOGIC
    let currentXP = data[JOB_EXP_KEY];
    if(!currentXP && MEMORY.inventory[JOB_EXP_KEY]) currentXP = MEMORY.inventory[JOB_EXP_KEY];

    if (typeof currentXP === 'number') {
        updateRunLogic(currentXP, hasCargo);
        renderStats();
    }

    // 6. RENDER UI
    renderTrunkList(MEMORY.trunk);
    if(data.trunkCapacity !== undefined) {
        let txt = `${MEMORY.weight}/${Math.round(data.trunkCapacity)}kg`;
        safeSetText('trunk-capacity', txt);
        safeSetText('micro-weight', txt);
    }

    // 7. BXP & TOKENS
    let bxp = data[JOB_BXP_KEY_BONUS];
    if (!bxp && MEMORY.inventory[JOB_BXP_KEY_BONUS]) bxp = MEMORY.inventory[JOB_BXP_KEY_BONUS];
    if (bxp) {
        let val = (typeof bxp === 'object') ? bxp.amount : bxp;
        safeSetText('disp-bxp', formatNumber(val));
    }

    let tokens = data[JOB_BXP_KEY_TOKEN];
    if (!tokens && MEMORY.inventory[JOB_BXP_KEY_TOKEN]) tokens = MEMORY.inventory[JOB_BXP_KEY_TOKEN];
    if (tokens) {
        let val = (typeof tokens === 'object') ? tokens.amount : tokens;
        let txt = formatNumber(val);
        safeSetText('micro-tokens', txt);
        
        if(STATE.startTokens === null) STATE.startTokens = val;
        STATE.currentTokens = val;
        updateGrinderUI(val);
    }

    // 8. BONUS SCAN
    if (data.menu_choices) {
        try {
            let menu = (typeof data.menu_choices === 'string') ? JSON.parse(data.menu_choices) : data.menu_choices;
            let identityHtml = menu.find(m => m[0] === "Identity")?.[1];
            if (identityHtml) parseBonuses(identityHtml);
        } catch(e) {}
    }
}

// --- FLIGHT SESSION LOGIC ---

function checkForCargo(pockets, trunk) {
    let cargoCounts = {}; 
    let cargoFound = false;

    const scan = (inv) => {
        if(!inv) return;
        for (const key in inv) {
            const item = inv[key];
            let qty = 0;
            if (typeof item === 'number') qty = item;
            else if (typeof item === 'object') qty = item.amount || item.count || 0;
            if (qty <= 0) continue;

            const upperKey = key.toUpperCase();
            if(upperKey.includes("CARGO")) {
                for(const code in AIRPORTS) {
                    if (upperKey.includes(code)) {
                        if (!cargoCounts[code]) cargoCounts[code] = 0;
                        cargoCounts[code] += qty;
                        cargoFound = true;
                    }
                }
            }
        }
    };

    scan(trunk);
    scan(pockets);
    
    const box = document.getElementById('dest-box');
    const txt = document.getElementById('disp-destination');
    const warningEl = document.getElementById('multi-warning');
    const microDest = document.getElementById('micro-dest');
    
    if (!cargoFound) {
        txt.innerText = "Waiting for cargo...";
        microDest.innerText = "No Cargo";
        box.style.borderColor = "var(--accent)";
        box.style.background = "rgba(255, 193, 7, 0.1)";
        txt.style.color = "#fff";
        warningEl.style.display = "none";
        return false; 
    }

    const locations = Object.keys(cargoCounts);
    let bestLoc = locations[0];
    for (let loc of locations) {
        if (cargoCounts[loc] > cargoCounts[bestLoc]) {
            bestLoc = loc;
        }
    }

    let destText = `${bestLoc} - ${AIRPORTS[bestLoc]}`;
    txt.innerText = destText;
    microDest.innerText = destText.substring(0, 15);
    
    box.style.borderColor = "var(--green)";
    box.style.background = "rgba(0, 230, 118, 0.1)";
    txt.style.color = "var(--green)";

    if (locations.length > 1) {
        warningEl.style.display = "block";
        warningEl.innerText = `‚ö† Multiple Cargo Types ‚ö†`;
    } else {
        warningEl.style.display = "none";
    }

    return true; 
}

function updateRunLogic(currentXP, hasCargo) {
    if (STATE.currentXP === 0) STATE.currentXP = currentXP;

    if (hasCargo && !STATE.runActive) {
        STATE.runActive = true;
        STATE.runStartXP = currentXP;
        STATE.currentRunGain = 0;
    }

    if (STATE.runActive) {
        if (currentXP > STATE.runStartXP) {
            STATE.currentRunGain = currentXP - STATE.runStartXP;
        }
    }

    if (!hasCargo && STATE.runActive) {
        STATE.completedRuns++;
        STATE.totalRunXP += STATE.currentRunGain;
        STATE.avgRunXP = STATE.totalRunXP / STATE.completedRuns;
        STATE.runActive = false;
        STATE.currentRunGain = 0;
    }

    STATE.currentXP = currentXP;
}

function renderStats() {
    const lvl = getLevelInfo(STATE.currentXP);
    const xpTxt = formatNumber(STATE.currentXP);
    
    safeSetText('disp-xp', xpTxt);
    safeSetText('micro-xp', xpTxt);
    safeSetText('disp-level', lvl.level);
    safeSetText('micro-level', lvl.level);
    
    const pct = getPercentValue(lvl.expInLevel, lvl.expForNext);
    document.getElementById('level-bar').style.width = pct + "%";
    safeSetText('level-text', pct + "%");
    const mBar = document.getElementById('micro-bar');
    if(mBar) mBar.style.width = pct + "%";

    safeSetText('disp-flight-xp', formatNumber(STATE.currentRunGain) + " XP");
    safeSetText('disp-flight-avg', Math.round(STATE.avgRunXP) + " XP");
    safeSetText('disp-ops', STATE.completedRuns);

    const needed = Math.round(lvl.expForNext - lvl.expInLevel);
    safeSetHTML('disp-xp-remaining', `<b>${formatNumber(needed)}</b> XP to Next Level`);
    safeSetText('micro-calc', formatNumber(needed));

    runCalculator();
}

function updateGrinderUI(currentVal) {
    let earned = currentVal - STATE.startTokens;
    if(earned < 0) { STATE.startTokens = currentVal; earned = 0; }

    safeSetText('g-session', formatNumber(earned));
    safeSetText('g-start', formatNumber(STATE.startTokens));

    let avg = STATE.completedRuns > 0 ? Math.round(earned / STATE.completedRuns) : 0;
    safeSetText('g-avg', formatNumber(avg));

    let mins = (Date.now() - SESSION_START_TIME) / 60000;
    if(mins > 1) {
        let ph = Math.round((earned / mins) * 60);
        safeSetText('g-ph', formatNumber(ph));
    }
}

function parseBonuses(html) {
    const lines = html.split(/<br\s*\/?>/i);
    let newBonuses = [];
    lines.forEach(line => {
        let decoded = line.replace(/&#(\d+);/g, (match, dec) => String.fromCharCode(dec));
        let text = decoded.replace(/<[^>]*>/g, '').trim();
        if (text && (text.includes("Exp Bonus") || text.includes("Premium") || text.includes("Skill of the Day"))) {
            newBonuses.push(text);
        }
    });
    
    if (newBonuses.length > 0) {
        MEMORY.bonuses = newBonuses;
        renderBonuses();
    } else if (MEMORY.bonuses.length > 0) {
        renderBonuses(); 
    } else {
        const container = document.getElementById('bonus-container');
        if(container) container.innerHTML = "<div style='opacity:0.5;font-size:0.8em'>Open 'Identity' menu in-game to scan...</div>";
    }
}

function renderBonuses() {
    const container = document.getElementById('bonus-container');
    if(!container) return;
    container.innerHTML = "";
    MEMORY.bonuses.forEach(text => {
        let div = document.createElement('div');
        div.className = 'bonus-item';
        div.innerText = "‚òÖ " + text;
        container.appendChild(div);
    });
}

function renderTrunkList(trunk) {
    const el = document.getElementById('trunk-list');
    el.innerHTML = "";
    
    if((!trunk || Object.keys(trunk).length === 0) && MEMORY.weight > 0) {
        el.innerHTML = "<div style='color:var(--orange); font-style:italic;'>‚ö† Cargo Detected<br>(Open Trunk to Sync)</div>";
        return;
    }
    
    if(!trunk || Object.keys(trunk).length === 0) {
        el.innerHTML = "Cargo hold is empty.";
        return;
    }

    for(let key in trunk) {
        let item = trunk[key];
        let qty = item.amount || item.count || item;
        if(qty > 0) {
            let cleanKey = key.replace(/_/g, " ").replace("tcargo", "").toUpperCase();
            el.innerHTML += `<div class="trunk-item"><span>${cleanKey}</span><span>x${qty}</span></div>`;
        }
    }
}

function cleanString(str) {
    if (!str) return "";
    return str.replace(/~[a-z]~/g, "").trim();
}

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "K";
    return num.toLocaleString();
}

function getLevelInfo(exp) {
    let level = 0, xpCap = 5;
    while (exp >= xpCap) { exp -= xpCap; level++; xpCap = (level + 1) * 5; }
    return { level, expInLevel: exp, expForNext: xpCap };
}

function getPercentValue(exp, cap) {
    return Math.min(100, Math.max(0, ((exp / cap) * 100))).toFixed(1);
}

function runCalculator() {
    const inp = document.getElementById('target-input');
    if(!inp) return;
    const val = inp.value;
    const el = document.getElementById('calc-result');
    const microEl = document.getElementById('micro-calc');
    
    localStorage.setItem(STORAGE_KEY_CALC, val);
    if (!val) { if(el) el.innerText = ""; return; }
    
    let inputVal = parseInt(val.replace(/,/g, ''));
    let targetXP = inputVal;
    if (inputVal < 200) { 
         let lvlXP = 0; 
         for(let i=0; i<inputVal; i++) lvlXP += (5 * i * (i + 1)) / 2;
         targetXP = (5 * inputVal * (inputVal + 1)) / 2;
    }

    if (targetXP > STATE.currentXP) {
        const diff = targetXP - STATE.currentXP;
        const ops = Math.ceil(diff / STATE.avgRunXP);
        if(el) el.innerHTML = `Remaining: <b>${formatNumber(diff)} XP</b><br><span style="color:var(--primary)">Est. Flights: <b>${formatNumber(ops)}</b></span>`;
        if(microEl) microEl.innerText = formatNumber(ops);
    } else {
        if(el) el.innerHTML = `Target reached.`;
        if(microEl) microEl.innerText = "Done";
    }
}

// Drag & Resize Logic
const elm = document.getElementById("tracker-app");
const head = document.getElementById("drag-handle");
const microView = document.getElementById("micro-view");
let isDragging = false, startX, startY, initLeft, initTop;

const startDrag = (e) => {
    if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
    e.preventDefault(); isDragging = true;
    startX = e.clientX; startY = e.clientY;
    const r = elm.getBoundingClientRect();
    initLeft = r.left; initTop = r.top;
    document.addEventListener("mousemove", dragMove);
    document.addEventListener("mouseup", dragEnd);
};
const dragMove = (e) => {
    if(!isDragging) return;
    elm.style.left = (initLeft + e.clientX - startX) + "px";
    elm.style.top = (initTop + e.clientY - startY) + "px";
};
const dragEnd = () => {
    isDragging = false;
    document.removeEventListener("mousemove", dragMove);
    document.removeEventListener("mouseup", dragEnd);
};
head.addEventListener("mousedown", startDrag);
microView.addEventListener("mousedown", startDrag);

const rh = document.getElementById('resize-handle');
if (rh) {
    rh.addEventListener('mousedown', (e) => {
        e.preventDefault();
        window.addEventListener('mousemove', resize);
        window.addEventListener('mouseup', stopResize);
    });
}
function resize(e) {
    if(elm.classList.contains('mini-mode')) return;
    elm.style.width = Math.max(280, e.clientX - elm.getBoundingClientRect().left) + 'px';
    elm.style.height = Math.max(200, e.clientY - elm.getBoundingClientRect().top) + 'px';
}
function stopResize() {
    window.removeEventListener('mousemove', resize);
    window.removeEventListener('mouseup', stopResize);
}
</script>
</body>
</html>
