<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Mechanic Helper</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        /* --- THEME --- */
        :root {
            --primary: #0091ea; 
            --primary-dim: #0064b7;
            --bg-glass: rgba(15, 15, 15, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(0, 145, 234, 0.3);
            --green: #00e676;
            --alert: #ff3d00;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #app-container {
            position: absolute;
            top: 50px; left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            min-height: 200px;
        }

        /* --- HEADER & ANIMATION --- */
        header {
            /* Garage Gradient */
            background: linear-gradient(135deg, #01579b, #0288d1, #01579b);
            background-size: 200% 200%;
            animation: shopLight 5s ease infinite;
            padding: 0 12px;
            height: 70px; /* Taller for scene */
            cursor: move;
            display: flex; justify-content: space-between; align-items: flex-start;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            padding-top: 5px;
        }

        @keyframes shopLight {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .header-title {
            font-family: 'Rajdhani', sans-serif; font-weight: 900;
            text-transform: uppercase; letter-spacing: 1px; font-size: 1.2em;
            z-index: 10;
        }

        /* SCENE CONTAINER */
        #mech-scene {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 40px;
            pointer-events: none; overflow: hidden;
        }

        /* ACTORS */
        .actor { position: absolute; bottom: 2px; font-size: 1.8em; }
        
        #truck { left: -50px; z-index: 5; }
        #mechanic { left: -50px; z-index: 6; opacity: 0; }
        #car { right: 20px; z-index: 4; filter: grayscale(100%); } /* Broken car is grey */
        #tool { position: absolute; bottom: 15px; right: 25px; font-size: 1.2em; opacity: 0; z-index: 7; }

        /* SCENE ANIMATION (12s Cycle) */
        /* 1. Truck Arrives */
        @keyframes driveIn {
            0% { left: -50px; }
            20% { left: 40px; } /* Park */
            80% { left: 40px; } /* Wait */
            100% { left: 350px; } /* Drive Off */
        }
        #truck { animation: driveIn 12s linear infinite; }

        /* 2. Mechanic Gets Out */
        @keyframes fixAction {
            0%, 20% { opacity: 0; left: 40px; }
            25% { opacity: 1; left: 40px; } /* Appear */
            35% { left: 180px; } /* Walk to car */
            65% { left: 180px; } /* Work */
            75% { left: 40px; } /* Walk back */
            80% { opacity: 0; } /* Get in */
            100% { opacity: 0; left: 40px; }
        }
        #mechanic { animation: fixAction 12s linear infinite; }

        /* 3. Wrench Work */
        @keyframes wrenchTurn {
            0%, 35% { opacity: 0; }
            36% { opacity: 1; transform: rotate(0deg); }
            45% { transform: rotate(-45deg); }
            55% { transform: rotate(0deg); }
            64% { opacity: 1; }
            65% { opacity: 0; }
            100% { opacity: 0; }
        }
        #tool { animation: wrenchTurn 12s linear infinite; }

        /* 4. Car Fixed */
        @keyframes carFix {
            0%, 60% { filter: grayscale(100%); }
            65% { filter: grayscale(0%); filter: drop-shadow(0 0 5px gold); } /* Fixed! */
            90% { opacity: 1; }
            95% { opacity: 0; } /* Disappear to reset */
            100% { opacity: 0; filter: grayscale(100%); }
        }
        #car { animation: carFix 12s linear infinite; }


        /* NAME ANIMATION (Hammer Fix) */
        #user-name-mech {
            position: absolute; top: 28px; left: 50%; transform: translateX(-50%);
            font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.9em;
            white-space: nowrap; color: #fff;
            animation: nameBreakFix 10s ease-in-out infinite;
        }
        
        #hammer-anim {
            position: absolute; top: 10px; left: 60%; 
            font-size: 1.5em; opacity: 0;
            animation: hammerSmack 10s ease-in-out infinite;
        }

        @keyframes nameBreakFix {
            0%, 40% { transform: translateX(-50%) rotate(15deg) translateY(5px); color: #888; letter-spacing: -1px; } /* Broken */
            45% { transform: translateX(-50%) rotate(0deg) translateY(0px); color: #fff; letter-spacing: 1px; text-shadow: 0 0 10px var(--primary); } /* Fixed */
            90% { opacity: 1; }
            100% { opacity: 0; }
        }

        @keyframes hammerSmack {
            0%, 35% { opacity: 0; transform: rotate(45deg); }
            40% { opacity: 1; top: 10px; transform: rotate(45deg); } /* Raise */
            43% { top: 25px; transform: rotate(-45deg); } /* SMACK */
            45% { opacity: 0; }
            100% { opacity: 0; }
        }

        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.8em; z-index: 20; }

        /* --- CONTENT --- */
        #content { padding: 12px; flex: 1; overflow-y: auto; scrollbar-width: thin; }

        .section { margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .section:last-child { border-bottom: none; }

        .label { font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }

        .progress-container { position: relative; height: 18px; background: rgba(0,0,0,0.5); border-radius: 4px; margin: 5px 0 5px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; text-shadow: 1px 1px 2px black; font-weight: bold; z-index: 2; }

        .inv-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid var(--text-dim); }
        .inv-name { font-size: 0.8em; }
        .inv-stats { font-size: 0.8em; text-align: right; }
        .inv-used { color: var(--primary); font-weight: bold; margin-left: 6px; }
        .low-stock { border-left-color: var(--alert); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px; text-align: center; }

        input[type="number"] { width: 90%; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; margin-top: 5px; font-family: inherit; }
        input:focus { outline: 1px solid var(--primary); }
        
        .calc-output { margin-top: 8px; font-size: 0.85em; line-height: 1.4; color: var(--text-dim); word-wrap: break-word; }
        .calc-output b { color: white; }
        
        .quick-btn-row { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        .quick-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: bold; flex: 1; }
        .quick-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<div id="app-container">
    <header id="drag-handle">
        <a href="https://pinkiprim.github.io/pinkiapps.html" style="text-decoration:none; margin-right:12px; cursor:pointer; font-size:1.2em; z-index:20;">üè†</a>
        <span class="header-title">üîß Mechanic Ops</span>
        
        <div id="mech-scene">
            <div id="truck" class="actor">üõª</div>
            <div id="mechanic" class="actor">üßë‚Äçüîß</div>
            <div id="tool" class="actor">üîß</div>
            <div id="car" class="actor">üöó</div>
        </div>
        
        <div id="hammer-anim">üî®</div>
        <div id="user-name-mech">Mechanic ...</div>

        <span id="clock" style="z-index:20;">00:00</span>
    </header>

    <div id="content">
        
        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Mechanic Level</div><div class="value highlight" style="font-size:1.6em" id="disp-level">...</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>

            <div class="stat-grid">
                <div class="stat-box"><div class="label">BXP Tokens</div><div class="value bxp" id="disp-bxp">0</div></div>
                <div class="stat-box"><div class="label">Avg XP</div><div class="value" id="disp-avg">0</div></div>
                <div class="stat-box"><div class="label">Callouts</div><div class="value" id="disp-callouts">0</div></div>
            </div>
        </div>

        <div class="section">
            <div class="label">Session Statistics</div>
            
            <div class="inv-row" id="row-tire">
                <div class="inv-name">üîò Tire / Towing</div>
                <div class="inv-stats"><span class="inv-used" id="used-tire">+0</span></div>
            </div>

            <div class="inv-row" id="row-wrench">
                <div class="inv-name">üîß Blown Engine</div>
                <div class="inv-stats">Stock: <span id="stock-wrench">--</span> <span class="inv-used" id="used-wrench">+0</span></div>
            </div>

            <div class="inv-row" id="row-jumper">
                <div class="inv-name">‚ö° Dead Battery</div>
                <div class="inv-stats">Stock: <span id="stock-jumper">--</span> <span class="inv-used" id="used-jumper">+0</span></div>
            </div>

            <div class="inv-row" id="row-jerry">
                <div class="inv-name">‚õΩ Out of Gas</div>
                <div class="inv-stats">Stock: <span id="stock-jerry">--</span> <span class="inv-used" id="used-jerry">+0</span></div>
            </div>

            <div class="inv-row" id="row-hammer">
                <div class="inv-name">üî® Bent Chassis</div>
                <div class="inv-stats">Stock: <span id="stock-hammer">--</span> <span class="inv-used" id="used-hammer">+0</span></div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Target Calculator</div>
            <div style="font-size:0.7em; color:#888;">Enter <b>Target XP</b>:</div>
            <input type="number" id="target-input" placeholder="e.g. 100000">
            
            <div class="quick-btn-row">
                <button class="quick-btn" onclick="window.setCalc(100000)">100K</button>
                <button class="quick-btn" onclick="window.setCalc(1000000)">1M</button>
                <button class="quick-btn" onclick="window.setCalc(10000000)">10M</button>
            </div>

            <div class="calc-output" id="calc-result">Start working to enable calculator...</div>
        </div>

    </div>
</div>

<script>
    // --- GLOBAL SCOPE ---
    window.setCalc = function(amount) {
        document.getElementById('target-input').value = amount;
        runCalculator();
    };

    // --- MECHANIC CONFIG ---
    const KEYS = {
        XP: "exp_trucking_mechanic",
        BXP: "exp_token_a|trucking|mechanic"
    };
    const STORAGE_KEY_CALC = "target_xp_mechanic";

    const ITEMS = {
        wrench: { keywords: ["wrench"], stock: 0, session: 0 },
        jumper: { keywords: ["jumper", "cable"], stock: 0, session: 0 },
        jerry:  { keywords: ["jerry", "petrol"], stock: 0, session: 0 },
        hammer: { keywords: ["hammer"], stock: 0, session: 0 }
    };

    const STATE = {
        currentXP: 0, currentBXP: 0, startXP: null,
        callouts: 0, avgXP: 0, inventoryInit: false
    };

    // --- INIT ---
    const savedTarget = localStorage.getItem(STORAGE_KEY_CALC);
    if (savedTarget) document.getElementById('target-input').value = savedTarget;
    
    document.getElementById('target-input').addEventListener('input', runCalculator);

    setInterval(() => {
        document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }, 1000);

    requestData();
    setInterval(requestData, 1000);

    // --- COMMS ---
    function requestData() {
        if(window.parent) {
            try {
                window.parent.postMessage({ 
                    type: "getNamedData",
                    keys: [KEYS.XP, KEYS.BXP, "inventory", "name"]
                }, "*");
                window.parent.postMessage({ type: "getData" }, "*");
            } catch(e) {}
        }
    }
    
    // --- DATA LISTENER ---
    window.addEventListener('message', (event) => {
        let payload = event.data;
        if (payload && payload.type === 'data' && payload.data) payload = payload.data;
        if (!payload) return;

        if(payload.name) document.getElementById('user-name-mech').innerText = "Mechanic " + payload.name;

        if (typeof payload[KEYS.XP] === 'number') {
            updateXP(payload[KEYS.XP]);
        }

        if (payload.inventory) {
            try {
                const inv = typeof payload.inventory === 'string' ? JSON.parse(payload.inventory) : payload.inventory;
                processInventory(inv);
            } catch(e){}
        } else if (payload[KEYS.BXP]) {
            updateBXP(payload[KEYS.BXP]);
        }
    });

    function processInventory(inv) {
        if (!inv) return;
        if (inv[KEYS.BXP]) updateBXP(inv[KEYS.BXP]);

        const invArray = Object.entries(inv).map(([id, data]) => {
            let qty = 0;
            if (typeof data === 'number') qty = data;
            else if (typeof data === 'object') qty = data.amount || data.count || data.qty || 0;
            return { id: id.toLowerCase(), qty: qty };
        });

        for (let type in ITEMS) {
            let itemData = ITEMS[type];
            let foundQty = 0;
            const matches = invArray.filter(invItem => 
                itemData.keywords.some(k => invItem.id.includes(k))
            );
            if (matches.length > 0) foundQty = matches.reduce((sum, item) => sum + item.qty, 0);
            updateItemStats(type, foundQty);
        }
        STATE.inventoryInit = true;
        calculateRemainder();
    }

    function updateBXP(val) {
        let amt = (typeof val === 'object') ? val.amount : val;
        if (amt >= 0) {
            STATE.currentBXP = amt;
            document.getElementById('disp-bxp').innerText = formatNum(amt);
        }
    }

    function updateItemStats(type, newStock) {
        const item = ITEMS[type];
        if (STATE.inventoryInit && item.stock > 0 && newStock < item.stock) {
            const diff = item.stock - newStock;
            if (diff < 10) item.session += diff;
        }
        item.stock = newStock;
        document.getElementById(`stock-${type}`).innerText = newStock;
        document.getElementById(`used-${type}`).innerText = `+${item.session}`;
        
        const row = document.getElementById(`row-${type}`);
        if (newStock < 2) row.classList.add('low-stock');
        else row.classList.remove('low-stock');
    }

    function updateXP(newXP) {
        if (STATE.startXP === null) {
            STATE.startXP = newXP;
            STATE.currentXP = newXP;
            renderDisplay();
            return;
        }
        if (newXP > STATE.currentXP) {
            STATE.callouts++; 
            const gained = newXP - STATE.startXP;
            STATE.avgXP = gained / STATE.callouts;
        }
        STATE.currentXP = newXP;
        calculateRemainder();
        renderDisplay();
    }

    function calculateRemainder() {
        const totalItemsUsed = ITEMS.wrench.session + ITEMS.jumper.session + ITEMS.jerry.session + ITEMS.hammer.session;
        const remainder = Math.max(0, STATE.callouts - totalItemsUsed);
        document.getElementById('used-tire').innerText = `+${remainder}`;
    }

    function renderDisplay() {
        const lvl = getLevelFromXP(STATE.currentXP);
        const nextLvlXP = getXPFromLevel(lvl + 1);
        const prevLvlXP = getXPFromLevel(lvl);
        const percent = Math.min(100, Math.max(0, ((STATE.currentXP - prevLvlXP) / (nextLvlXP - prevLvlXP)) * 100));

        document.getElementById('disp-level').innerText = lvl;
        document.getElementById('disp-xp').innerText = formatNum(STATE.currentXP);
        document.getElementById('level-bar').style.width = percent + "%";
        document.getElementById('level-text').innerText = percent.toFixed(1) + "%";
        document.getElementById('disp-callouts').innerText = STATE.callouts;
        document.getElementById('disp-avg').innerText = Math.round(STATE.avgXP);

        runCalculator();
    }

    // --- UTILS ---
    function getLevelFromXP(xp) { return Math.floor((Math.sqrt(1 + 8 * xp / 5) - 1) / 2); }
    function getXPFromLevel(level) { return Math.floor((5 * level * (level + 1)) / 2); }
    function formatNum(n) { return Math.floor(n).toLocaleString("en-US"); }

    // --- CALCULATOR ---
    function runCalculator() {
        const val = document.getElementById('target-input').value;
        const el = document.getElementById('calc-result');
        
        localStorage.setItem(STORAGE_KEY_CALC, val);

        if (STATE.avgXP === 0) {
            el.innerHTML = "<i>Complete a job to enable calc...</i>";
            return;
        }
        if (!val) {
            el.innerText = "Enter target above.";
            return;
        }

        let inputVal = parseInt(val.replace(/,/g, ''));
        let targetXP = inputVal;

        if (inputVal < 200) { 
             let lvlXP = getXPFromLevel(inputVal);
             if (lvlXP > STATE.currentXP) targetXP = lvlXP;
        }

        if (targetXP > STATE.currentXP) {
            const diff = targetXP - STATE.currentXP;
            const jobs = Math.ceil(diff / STATE.avgXP);
            el.innerHTML = `Remaining XP: <b>${formatNum(diff)}</b><br>` + 
                           `<span style="color:var(--primary)">Callouts to go: <b>${formatNum(jobs)}</b></span>`;
        } else {
            const jobs = Math.ceil(inputVal / STATE.avgXP);
            el.innerHTML = `To add ${formatNum(inputVal)} XP:<br>Effort: <b>${formatNum(jobs)} jobs</b>`;
        }
    }

    // --- DRAG HANDLER ---
    const elmnt = document.getElementById("app-container");
    const header = document.getElementById("drag-handle");
    let isDragging = false, startX, startY, initialLeft, initialTop;

    header.addEventListener('mousedown', (e) => {
        if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const rect = elmnt.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
    });

    function dragMove(e) {
        if(!isDragging) return;
        e.preventDefault();
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        elmnt.style.left = (initialLeft + dx) + "px";
        elmnt.style.top = (initialTop + dy) + "px";
    }

    function dragEnd() {
        isDragging = false;
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
    }
</script>
</body>
</html>
