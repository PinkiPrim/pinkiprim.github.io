<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Train Helper</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #ffb300; 
            --primary-dim: #c68400;
            --bg-glass: rgba(18, 18, 18, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(255, 179, 0, 0.3);
            --green: #00e676;
            --orange: #ff9800;
            --red: #ff5252;
            --accent: #ffd54f;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #tracker-app {
            position: absolute;
            top: 50px; left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            min-height: 200px;
        }

        header {
            background: linear-gradient(90deg, var(--primary-dim), var(--primary));
            padding: 8px 12px;
            cursor: move;
            display: flex; justify-content: space-between; align-items: center;
            font-family: 'Rajdhani', sans-serif; font-weight: 700;
            text-transform: uppercase; letter-spacing: 1px; font-size: 1.1em;
            color: #000;
        }

        #speed-display {
            cursor: pointer;
            border-bottom: 1px dotted #000;
        }
        #speed-display:hover { opacity: 0.8; }

        #content { padding: 12px; flex: 1; overflow-y: auto; scrollbar-width: thin; }

        /* VEHICLE INFO */
        .info-display {
            background: rgba(255, 255, 255, 0.05);
            border: 1px dashed var(--accent);
            border-radius: 6px; padding: 10px; margin-bottom: 15px;
            text-align: center;
        }
        .info-label {
            font-size: 0.7em; color: var(--accent);
            text-transform: uppercase; letter-spacing: 2px; margin-bottom: 4px;
        }
        .info-value {
            font-family: 'Rajdhani', sans-serif; font-size: 1.3em; font-weight: 700;
            color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); line-height: 1.1;
            padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 8px;
        }

        /* DASHBOARD GRID */
        .dash-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 5px;
        }
        .dash-cell {
            background: rgba(0,0,0,0.3); border-radius: 4px; padding: 5px;
        }
        .dash-sublabel { font-size: 0.65em; color: #888; text-transform: uppercase; }
        .dash-val { font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 1.1em; }

        /* MISSED STOP WARNING */
        .missed-warning {
            display: none;
            margin-top: 8px; font-size: 0.9em; font-weight: bold;
            color: var(--red);
            background: rgba(255, 0, 0, 0.1);
            border: 1px solid var(--red);
            padding: 4px; border-radius: 4px;
            text-transform: uppercase; letter-spacing: 1px;
            animation: flashRed 0.5s infinite alternate;
        }
        @keyframes flashRed {
            from { opacity: 0.5; transform: scale(0.98); } 
            to { opacity: 1; transform: scale(1.02); text-shadow: 0 0 10px red; }
        }

        /* STATS */
        .section { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .section:last-child { border-bottom: none; }

        .label { font-size: 0.7em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }

        .progress-container {
            position: relative; height: 16px;
            background: rgba(0,0,0,0.5); border-radius: 4px; margin: 5px 0 5px 0;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
        }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 0.7em; text-shadow: 1px 1px 2px black; font-weight: bold; z-index: 2;
        }

        .xp-remaining-text { text-align: center; font-size: 0.8em; color: var(--text-dim); margin-bottom: 10px; }
        .xp-remaining-text b { color: var(--primary); }

        /* SESSION BOX */
        .run-box {
            background: rgba(251, 192, 45, 0.1);
            border: 1px solid rgba(251, 192, 45, 0.3);
            border-radius: 4px; padding: 8px; margin-bottom: 10px;
        }
        .run-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em; }
        .run-val { font-weight: bold; color: #fff; }
        .run-label { font-size: 0.8em; color: #aaa; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 6px; border-radius: 4px; text-align: center; }

        /* CALCULATOR */
        input[type="number"] {
            width: 90%; background: rgba(0,0,0,0.3);
            border: 1px solid #444; color: white; padding: 5px;
            border-radius: 4px; margin-top: 5px; font-family: inherit;
        }
        input:focus { outline: 1px solid var(--primary); }
        .calc-output { margin-top: 5px; font-size: 0.8em; line-height: 1.3; color: var(--text-dim); word-wrap: break-word; }
        
        #settings-panel, #job-list, #summary-table { display: none !important; }
    </style>
</head>
<body>

<div id="tracker-app">
    <header id="drag-handle">
        <div style="display:flex; align-items:center;">
            <a href="https://pinkiprim.github.io/pinkiapps.html" style="text-decoration:none; margin-right:12px; cursor:pointer; font-size:1.2em;">üè†</a>
            <span>üöÇ Train Ops</span>
        </div>
        <div style="text-align:right;">
            <span id="clock" style="font-size:0.8em; margin-left:8px;">00:00</span>
        </div>
    </header>

    <div id="content">
        
        <div class="info-display" id="status-box">
            <div class="info-label">Current Vehicle</div>
            <div class="info-value" id="disp-vehicle">Waiting...</div>
            
            <div class="dash-grid">
                <div class="dash-cell" onclick="toggleSpeedUnit()" title="Click to Switch Unit" style="cursor:pointer;">
                    <div class="dash-sublabel">Speed (Toggle)</div>
                    <div class="dash-val" id="speed-display">0 km/h</div>
                </div>
                <div class="dash-cell">
                    <div class="dash-sublabel">Stop Dist.</div>
                    <div class="dash-val" id="disp-dist">-</div>
                </div>
            </div>
            
            <div id="missed-warning" class="missed-warning">‚ö† MISSED STOP - REVERSE ‚ö†</div>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Conductor Level</div><div class="value highlight" style="font-size:1.6em" id="disp-level">...</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>
            
            <div class="xp-remaining-text" id="disp-xp-remaining">Awaiting Dispatch...</div>

            <div class="run-box">
                <div style="border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px; padding-bottom:3px; color:var(--primary); font-size:0.85em; font-weight:bold; letter-spacing:1px;">SESSION TRACKER</div>
                <div class="run-grid">
                    <div>
                        <div class="run-label">Session XP Gain</div>
                        <div class="run-val" id="disp-session-xp" style="color:var(--green)">0 XP</div>
                    </div>
                    <div style="text-align:right">
                        <div class="run-label">Avg XP / Min</div>
                        <div class="run-val" id="disp-xp-rate">0 XP/m</div>
                    </div>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-box"><div class="label">Train Tokens</div><div class="value bxp" id="disp-bxp">0</div></div>
                <div class="stat-box"><div class="label">Total XP</div><div class="value" id="disp-total-xp" style="color:var(--accent)">0</div></div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Level Calculator</div>
            <input type="number" id="target-input" placeholder="e.g. 500000">
            <div class="calc-output" id="calc-result">Start driving to calibrate...</div>
        </div>

    </div>
    <div id="resize-handle" style="position:absolute; bottom:0; right:0; width:15px; height:15px; cursor:nwse-resize;"></div>
</div>

<div id="settings-icon" style="display:none;"></div>
<div id="settings-panel" style="display:none;">
    <input type="checkbox" id="toggle-bxp"><input type="checkbox" id="toggle-current-level">
    <button id="reset-exp-log"></button>
    <div id="xp-font-size-value"></div>
</div>
<div id="job-list" style="display:none;"></div>
<table id="summary-table" style="display:none;"></table>

<script>
// --- STATE ---
let SESSION_START_TIME = Date.now();

const JOB_EXP_KEY = "exp_train_train"; 
const JOB_BXP_KEY = "exp_token_a|train|train";

const STATE = {
    currentXP: 0, 
    startXP: 0,
    sessionGain: 0,
    useMPH: false, 
    
    // Distance / Stop Tracking
    lastWaypointX: 0,
    lastDistance: null
};

// --- CLOCK ---
setInterval(() => {
    document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}, 1000);

// --- ENGINE ---
function requestData() {
    if(window.parent) {
        try { 
            let keys = [
                "exp_train_train", "exp_token_a|train|train", 
                "vehicle", "vehicleName", "speed", 
                "pos_x", "pos_y", "waypoint_x", "waypoint_y"
            ];
            // NO INVENTORY, NO CHEST, NO TRUNK REQUESTS
            window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
            window.parent.postMessage({ type: "getData" }, "*"); 
        } catch(e) {}
    }
}
setInterval(requestData, 1000); 

window.addEventListener('message', (event) => {
    let payload = event.data;
    if (payload && payload.type === 'data' && payload.data) payload = payload.data;
    if (!payload) return;

    processPayload(payload);
});

function toggleSpeedUnit() {
    STATE.useMPH = !STATE.useMPH;
}

function processPayload(data) {
    // 1. VEHICLE NAME (Strictly from Vehicle Data)
    let vName = data.vehicleName || data.vehicle || "Waiting...";
    if(vName === "freight") vName = "Freight Train";
    if(vName === "metrotrain") vName = "Metro Train";
    
    // DIRECT UPDATE
    document.getElementById('disp-vehicle').innerText = vName;

    // 2. SPEED DISPLAY
    if(data.speed !== undefined) {
        let speedVal = 0;
        let unit = "";
        if(STATE.useMPH) {
            speedVal = Math.round(data.speed * 2.23694);
            unit = "mph";
        } else {
            speedVal = Math.round(data.speed * 3.6);
            unit = "km/h";
        }
        document.getElementById('speed-display').innerText = `${speedVal} ${unit}`;
    }

    // 3. DISTANCE & MISSED STOP LOGIC
    if(data.pos_x && data.waypoint_x) {
        let dist = Math.hypot(data.waypoint_x - data.pos_x, data.waypoint_y - data.pos_y);
        let distEl = document.getElementById('disp-dist');
        distEl.innerText = `${Math.round(dist)}m`;
        
        if(dist < 50) distEl.style.color = "var(--green)";
        else if(dist < 300) distEl.style.color = "var(--orange)";
        else distEl.style.color = "#fff";

        const warnEl = document.getElementById('missed-warning');
        
        // Reset if target changes
        if (Math.abs(data.waypoint_x - STATE.lastWaypointX) > 5) {
            STATE.lastWaypointX = data.waypoint_x;
            STATE.lastDistance = dist;
            warnEl.style.display = "none";
        }

        // Logic: Moving Away AND Close AND Not Stopped
        if (STATE.lastDistance !== null) {
            let isMovingAway = dist > (STATE.lastDistance + 0.2); 
            // Warn if between 20m and 400m
            if (isMovingAway && dist > 20 && dist < 400) {
                warnEl.style.display = "block";
            } else {
                warnEl.style.display = "none";
            }
        }
        STATE.lastDistance = dist;
    } else {
        document.getElementById('disp-dist').innerText = "-";
        document.getElementById('missed-warning').style.display = "none";
    }

    // 4. XP LOGIC
    let currentXP = data[JOB_EXP_KEY];
    if (typeof currentXP === 'number') {
        if (STATE.startXP === 0) STATE.startXP = currentXP;
        STATE.currentXP = currentXP;
        STATE.sessionGain = currentXP - STATE.startXP;
        renderStats();
    }

    // 5. BXP LOGIC (Direct check, no inventory parsing)
    let bxp = data[JOB_BXP_KEY];
    if (bxp) {
        let val = (typeof bxp === 'object') ? bxp.amount : bxp;
        document.getElementById('disp-bxp').innerText = formatNumber(val);
    }
}

function renderStats() {
    const lvl = getLevelInfo(STATE.currentXP);
    document.getElementById('disp-xp').innerText = formatNumber(STATE.currentXP);
    document.getElementById('disp-level').innerText = lvl.level;
    document.getElementById('disp-total-xp').innerText = formatNumber(STATE.currentXP);
    
    const pct = getPercentValue(lvl.expInLevel, lvl.expForNext);
    document.getElementById('level-bar').style.width = pct + "%";
    document.getElementById('level-text').innerText = pct + "%";

    document.getElementById('disp-session-xp').innerText = formatNumber(STATE.sessionGain) + " XP";
    
    let minutes = (Date.now() - SESSION_START_TIME) / 60000;
    let rate = minutes > 0 ? Math.round(STATE.sessionGain / minutes) : 0;
    document.getElementById('disp-xp-rate').innerText = rate + " XP/m";

    const needed = Math.round(lvl.expForNext - lvl.expInLevel);
    document.getElementById('disp-xp-remaining').innerHTML = `<b>${formatNumber(needed)}</b> XP to Next Level`;

    runCalculator();
}

// --- UTILS ---
function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "K";
    return num.toLocaleString();
}

function getLevelInfo(exp) {
    let level = 0, xpCap = 5;
    while (exp >= xpCap) { exp -= xpCap; level++; xpCap = (level + 1) * 5; }
    return { level, expInLevel: exp, expForNext: xpCap };
}

function getPercentValue(exp, cap) {
    return Math.min(100, Math.max(0, ((exp / cap) * 100))).toFixed(1);
}

// --- CALCULATOR ---
const calcInput = document.getElementById('target-input');
if(calcInput) calcInput.addEventListener('input', runCalculator);

function runCalculator() {
    const val = document.getElementById('target-input').value;
    const el = document.getElementById('calc-result');
    
    if (STATE.sessionGain < 50) { el.innerHTML = "<i>Drive to calibrate...</i>"; return; }
    if (!val) { el.innerText = "Enter target above."; return; }

    let inputVal = parseInt(val.replace(/,/g, ''));
    let targetXP = inputVal;
    
    if (inputVal < 200) { 
         let lvlXP = 0; 
         for(let i=0; i<inputVal; i++) lvlXP += (5 * i * (i + 1)) / 2;
         targetXP = (5 * inputVal * (inputVal + 1)) / 2;
    }

    if (targetXP > STATE.currentXP) {
        const diff = targetXP - STATE.currentXP;
        let ratePerMin = (STATE.sessionGain / ((Date.now() - SESSION_START_TIME)/60000));
        if(ratePerMin <= 0) ratePerMin = 1;
        
        let minsLeft = Math.ceil(diff / ratePerMin);
        let hours = Math.floor(minsLeft / 60);
        let mins = minsLeft % 60;
        
        el.innerHTML = `Remaining: <b>${formatNumber(diff)} XP</b><br><span style="color:var(--primary)">Est. Time: <b>${hours}h ${mins}m</b></span>`;
    } else {
        el.innerHTML = `Target reached.`;
    }
}

// --- DRAG HANDLER ---
(() => {
    const app = document.getElementById('tracker-app');
    const handle = document.getElementById('drag-handle');
    const rh = document.getElementById('resize-handle');
    if (!app || !handle) return;
    
    let sx=0, sy=0, ax=0, ay=0, dragging=false;
    let sw=0, sh=0, resizing=false;

    function startDrag(clientX, clientY, e) {
        if (e && e.target.closest('button, span, .dash-cell')) return; 
        if (e) { e.preventDefault(); e.stopPropagation(); }
        dragging = true; sx = clientX; sy = clientY;
        const rect = app.getBoundingClientRect(); ax = rect.left; ay = rect.top;
        handle.classList.add('dragging');
    }

    handle.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY, e));

    if (rh) {
        function startResize(clientX, clientY, e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            resizing = true; sx = e.clientX; sy = e.clientY;
            const rect = app.getBoundingClientRect(); sw = rect.width; sh = rect.height;
        }
        rh.addEventListener('mousedown', (e) => startResize(e.clientX, e.clientY, e));
    }

    function handleMove(clientX, clientY, e) {
        if (dragging) {
            if (e) e.preventDefault();
            const dx = clientX - sx, dy = clientY - sy;
            app.style.transform = `translate(${dx}px, ${dy}px)`;
        } else if (resizing) {
            if (e) e.preventDefault();
            const dx = clientX - sx, dy = clientY - sy;
            app.style.width  = `${Math.max(280, sw + dx)}px`;
            app.style.height = `${Math.max(120, sh + dy)}px`;
        }
    }
    
    window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY, e));

    function endDrag() {
        if (dragging) {
            const transform = app.style.transform;
            const match = transform.match(/translate\(([-\d.]+)px, ([-\d.]+)px\)/);
            if (match) {
                const dx = parseFloat(match[1]) || 0;
                const dy = parseFloat(match[2]) || 0;
                app.style.transform = '';
                app.style.left = `${ax + dx}px`;
                app.style.top = `${ay + dy}px`;
            }
        }
        dragging = false; resizing = false;
        handle.classList.remove('dragging');
    }
    window.addEventListener('mouseup', endDrag);
})();
</script>
</body>
</html>
