<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Cabbie Ops v5.1 (Focus Fix)</title>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #fbc02d;      
            --primary-dim: #f57f17; 
            --accent: #fff176;       
            --bg-glass: rgba(20, 20, 10, 0.96);
            --bg-dark: rgba(10, 10, 5, 0.99);
            --text-main: #ffffff;
            --text-dim: #fff9c4;
            --border: 1px solid rgba(251, 192, 45, 0.5);
            --green: #76ff03;
            --red: #ff1744;
            --heart-color: #ff4081; /* Pinki Pink */
        }

        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: transparent; color: var(--text-main); overflow: hidden; height: 100vh; width: 100vw; user-select: none; }

        #tracker-app {
            position: absolute; top: 50px; left: 50px; width: 320px;
            background: var(--bg-glass); border: var(--border); border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.9); display: flex; flex-direction: column;
            overflow: hidden; min-height: 400px; transition: width 0.2s, height 0.2s;
        }

        #tracker-app.mini-mode { width: 420px !important; height: 90px !important; min-height: 90px !important; border-radius: 12px; background: #1a1a00; border: 1px solid var(--accent); resize: none; }
        #tracker-app.mini-mode header, 
        #tracker-app.mini-mode #content, 
        #tracker-app.mini-mode #breakdown-panel,
        #tracker-app.mini-mode .support-footer { display: none !important; }

        #micro-view { display: none; flex-direction: column; justify-content: center; height: 100%; padding: 0 10px; font-family: 'Rajdhani', sans-serif; cursor: move; }
        #tracker-app.mini-mode #micro-view { display: flex; }
        
        .micro-row { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 33%; gap: 5px; }
        .micro-group { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .micro-val { color: #fff; font-weight: 700; font-size: 0.9em; }
        .micro-val.highlight { color: var(--accent); }
        .micro-progress-bg { width: 40px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-left: 4px; }
        .micro-progress-fill { height: 100%; background: var(--accent); width: 0%; }
        .micro-btn { position: absolute; top: 4px; right: 4px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #aaa; padding: 0px 4px; border-radius: 3px; font-size: 0.6em; cursor: pointer; text-transform: uppercase; z-index: 99; }
        .micro-btn:hover { background: var(--primary); color: white; }

        header { background: linear-gradient(180deg, var(--primary-dim), rgba(0, 0, 0, 0.9)); height: 60px; padding: 0; cursor: move; position: relative; display: flex; flex-direction: column; border-bottom: 1px solid rgba(255,255,255,0.15); overflow: hidden; z-index: 60; }
        .header-title { position: absolute; top: 8px; left: 50%; transform: translateX(-50%); font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.2em; text-transform: uppercase; letter-spacing: 2px; color: #fff; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.8); z-index: 10; }
        .header-job { position: absolute; top: 28px; left: 50%; transform: translateX(-50%); font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.75em; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; z-index: 10; }

        #taxi-scene { position: absolute; bottom: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 1; background: linear-gradient(to bottom, transparent 60%, #111 90%); }
        .marquee-container { position: absolute; width: 100%; overflow: hidden; display: flex; white-space: nowrap; }
        .road-lane { bottom: 2px; height: 30px; }
        .marquee-content { display: flex; min-width: 200%; animation: loopRight 8s linear infinite; }
        .vehicle-set { width: 50%; display: flex; justify-content: space-around; }
        @keyframes loopRight { 0% { transform: translateX(-50%); } 100% { transform: translateX(0%); } }
        .vehicle-icon { font-size: 24px; transform: scaleX(-1); filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.5)); }

        .nav-icon { position: absolute; top: 5px; left: 8px; text-decoration: none; font-size: 1.1em; cursor: pointer; color: #ccc; z-index: 99; }
        .nav-icon:hover { color: #fff; }
        
        .header-btn-group { position: absolute; top: 5px; right: 8px; display: flex; gap: 4px; z-index: 99; }
        .header-btn { 
            background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); 
            color: #fff; padding: 1px 5px; border-radius: 4px; cursor: pointer; 
            font-size: 0.65em; font-weight: bold; font-family: 'Rajdhani', sans-serif; 
        }
        .header-btn:hover { background: var(--primary); border-color: var(--accent); }
        
        #clock { position: absolute; bottom: 2px; right: 8px; font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #aaa; font-size: 0.75em; z-index: 20; }

        #content { padding: 8px; flex: 1; overflow-y: auto; scrollbar-width: thin; }

        #breakdown-panel { position: absolute; top: 60px; left: 0; width: 100%; height: calc(100% - 60px); background: rgba(10, 10, 5, 0.98); z-index: 50; display: none; flex-direction: column; padding: 15px; box-sizing: border-box; backdrop-filter: blur(5px); overflow-y: auto; }
        #breakdown-panel.active { display: flex; }
        .bd-header { font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 1.1em; color: var(--primary); border-bottom: 1px solid #333; padding-bottom: 5px; margin-bottom: 10px; display: flex; justify-content: space-between; }
        .bd-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9em; color: #ccc; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 2px; }
        .bd-val { font-weight: bold; color: #fff; }
        .bd-val.green { color: var(--green); }
        .bd-sub-list { margin-top: 5px; background: rgba(255,255,255,0.05); padding: 8px; border-radius: 4px; font-size: 0.8em; }
        .bd-item { color: var(--accent); margin-bottom: 2px; }

        .status-box { background: rgba(251, 192, 45, 0.05); border: 1px dashed var(--accent); border-radius: 6px; padding: 5px; margin-bottom: 8px; text-align: center; }
        .status-title { font-size: 0.65em; color: var(--accent); letter-spacing: 1px; margin-bottom: 2px; text-transform: uppercase; }
        .status-main { font-family: 'Rajdhani', sans-serif; font-size: 1.1em; font-weight: 800; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        .status-details { display: flex; flex-direction: column; gap: 1px; margin-top: 3px; }
        .status-line { font-size: 0.85em; color: #ddd; font-weight: bold; }
        .idle-val { color: var(--red); font-weight: 900; }
        .bonus-val { color: var(--green); font-weight: 900; }

        .section { padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 8px; }
        .label { font-size: 0.7em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: 800; }
        .highlight { color: var(--primary); }

        .progress-group { margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .progress-header { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1px; }
        .lvl-block { font-size: 0.75em; color: var(--text-dim); font-weight: bold; }
        .lvl-val { font-size: 1.4em; color: var(--accent); margin-left: 4px; font-weight: 900; font-family: 'Rajdhani', sans-serif; }
        .xp-val { font-size: 0.8em; color: #fff; }
        .progress-container { position: relative; height: 10px; background: rgba(0,0,0,0.6); border-radius: 4px; margin-bottom: 2px; overflow: hidden; border: 1px solid #333; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.4s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.6em; font-weight: 900; z-index: 2; text-shadow: 1px 1px 2px black; }
        .progress-footer { display: flex; justify-content: space-between; font-size: 0.7em; color: #888; font-style: italic; }
        .session-val { color: var(--green); font-weight: bold; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 5px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 4px; text-align: center; border-radius: 4px; }
        .stat-val { font-weight: bold; font-size: 1em; }

        .streak-display { text-align: center; font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.2em; color: var(--primary); text-shadow: 0 0 10px rgba(251, 192, 45, 0.4); margin: 6px 0; letter-spacing: 2px; text-transform: uppercase; transition: color 0.2s; }
        .streak-display.synced { color: var(--green); text-shadow: 0 0 10px rgba(0, 230, 118, 0.4); }

        #streak-status { font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.75em; margin-bottom: 4px; color: var(--primary); text-align: center; border: 1px dashed var(--primary-dim); padding: 3px; border-radius: 4px; }

        select { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #444; color: var(--accent); padding: 4px; border-radius: 4px; font-family: 'Rajdhani', sans-serif; font-weight: bold; margin-bottom: 4px; text-transform: uppercase; cursor: pointer; font-size: 0.85em; }
        option { background: #111; color: white; }
        input[type="number"] { width: 95%; background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; font-family: 'Rajdhani', sans-serif; font-weight: bold; margin-top: 4px; font-size: 0.9em; }
        .calc-result { font-size: 0.75em; color: var(--text-dim); margin-top: 4px; }
        .quick-btn-row { display: flex; gap: 4px; margin-top: 4px; justify-content: center; }
        .quick-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-size: 0.65em; padding: 2px 4px; border-radius: 3px; cursor: pointer; flex: 1; font-family: 'Rajdhani', sans-serif; font-weight: bold; }
        .quick-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .breakdown-btn { font-size: 0.65em; padding: 2px 6px; cursor: pointer; background: rgba(0,0,0,0.3); border: 1px solid #555; color: #aaa; border-radius: 3px; float: right; }
        .breakdown-btn:hover { background: var(--primary); color: white; }

        #resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 100; }
        
        .locked { filter: blur(4px); pointer-events: none; opacity: 0.5; }

        /* --- SUPPORT FOOTER --- */
        .support-footer {
            width: 100%;
            text-align: center;
            padding: 4px 0;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .support-link {
            font-size: 0.65em;
            color: var(--text-dim);
            text-decoration: none;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            opacity: 0.6;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .support-link:hover { opacity: 1; color: #fff; }
        .heart-spin {
            display: inline-block;
            color: var(--heart-color);
            margin-left: 2px;
            font-size: 1.1em;
            animation: spinHeart 2.5s infinite linear;
        }
        @keyframes spinHeart { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

    </style>
</head>
<body>

<div id="tracker-app">
    <div id="micro-view" onmousedown="dragStart(event)">
        <button class="micro-btn" onclick="toggleMini()">EXPAND</button>
        <div class="micro-row" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="micro-group"><span style="font-size:1.2em">üöï</span><span class="micro-val highlight" id="micro-status">IDLE</span></div>
            <div class="micro-group"><span class="micro-label">Streak:</span><span class="micro-val active" id="micro-streak">?</span></div>
        </div>
        <div class="micro-row">
            <div class="micro-group"><span class="micro-label">Fares:</span><span class="micro-val active" id="micro-fares">0</span></div>
            <div class="micro-sep">|</div>
            <div class="micro-group"><span class="micro-label">Biz</span><span class="micro-val highlight" id="micro-biz-lvl">0</span><div class="micro-progress-bg"><div class="micro-progress-fill" id="micro-biz-bar"></div></div></div>
            <div class="micro-group"><span class="micro-label">Race</span><span class="micro-val highlight" id="micro-race-lvl">0</span><div class="micro-progress-bg"><div class="micro-progress-fill" id="micro-race-bar"></div></div></div>
        </div>
    </div>

    <header id="drag-handle">
        <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon">üè†</a>
        <div class="header-btn-group">
            <button class="header-btn" onclick="forceResync()" title="Un-Sync Streak">üîÑ</button>
            <button class="header-btn" onclick="toggleMini()">MINI</button>
        </div>
        
        <div class="header-title">CABBIE OPS</div>
        <div class="header-job">COLLINSCO TAXI</div>
        <span id="clock">00:00</span>
        <div id="taxi-scene">
            <div class="marquee-container road-lane">
                <div class="marquee-content">
                    <div class="vehicle-set"><span class="vehicle-icon">üöï</span><span class="vehicle-icon">üöï</span><span class="vehicle-icon">üöñ</span><span class="vehicle-icon">üöï</span></div>
                    <div class="vehicle-set"><span class="vehicle-icon">üöï</span><span class="vehicle-icon">üöï</span><span class="vehicle-icon">üöñ</span><span class="vehicle-icon">üöï</span></div>
                </div>
            </div>
        </div>
    </header>

    <div id="breakdown-panel">
        <div class="bd-header">
            <span>XP BREAKDOWN</span>
            <span style="font-size:0.7em; color:#aaa; cursor:pointer;" onclick="toggleBreakdown()">[CLOSE]</span>
        </div>
        
        <div class="bd-row"><span class="label">Base Fare (Long Dist)</span><span class="bd-val">7.5 XP</span></div>
        <div class="bd-row"><span class="label">Streak Multiplier</span><span class="bd-val" id="bd-streak-mult">1.0x</span></div>
        <div class="bd-row"><span class="label">Time Bonus</span><span class="bd-val">2.0x</span></div>
        
        <div class="bd-header" style="margin-top:10px; font-size:0.9em; color:#fff;">ACTIVE BONUSES</div>
        <div class="bd-sub-list" id="bd-bonus-list">
            <div style="font-style:italic; opacity:0.5;">Scan Identity tab to see...</div>
        </div>
        
        <div class="bd-row" style="margin-top:10px; border-top:1px solid #444; padding-top:5px;">
            <span class="label">Est. XP / Fare</span>
            <span class="bd-val green" style="font-size:1.2em" id="bd-total">0 XP</span>
        </div>
    </div>

    <div id="content">
        <div class="status-box">
            <div class="status-title">CURRENT STATUS</div>
            <div class="status-main" id="disp-status">Waiting...</div>
            <div class="status-details">
                <div class="status-line" id="disp-loc">--</div>
                <div class="status-line" id="disp-dist" style="font-size:0.8em; color:var(--text-dim);">--</div>
                <div style="display:flex; justify-content:center; gap:10px; margin-top:2px;">
                    <div class="status-line" style="font-size:0.8em">IDLE: <span class="idle-val" id="disp-idle">0/30</span></div>
                    <div class="status-line" style="font-size:0.8em">BONUS: <span class="bonus-val" id="disp-bonus">0</span></div>
                </div>
            </div>
        </div>

        <div class="streak-display" id="main-streak-display">STREAK: ?</div>

        <div class="progress-group">
            <div class="progress-header">
                <div class="lvl-block">BUSINESS <span class="lvl-val" id="disp-biz-lvl">0</span></div>
                <div class="xp-val" id="disp-biz-xp">0</div>
            </div>
            <div class="progress-container"><div class="progress-bar" id="biz-bar"></div><div class="progress-text" id="biz-text">0%</div></div>
            <div class="progress-footer">
                <div>Session: <span class="session-val" id="sess-biz">+0 XP</span></div>
                <div id="biz-needed">...</div>
            </div>
        </div>

        <div class="progress-group">
            <div class="progress-header">
                <div class="lvl-block">RACING <span class="lvl-val" id="disp-race-lvl">0</span></div>
                <div class="xp-val" id="disp-race-xp">0</div>
            </div>
            <div class="progress-container"><div class="progress-bar" id="race-bar"></div><div class="progress-text" id="race-text">0%</div></div>
            <div class="progress-footer">
                <div>Session: <span class="session-val" id="sess-race">+0 XP</span></div>
                <div id="race-needed">...</div>
            </div>
        </div>

        <div class="section">
            <div class="stat-grid">
                <div class="stat-box"><div class="label">Fares</div><div class="stat-val" style="color:var(--accent)" id="disp-fares">0</div></div>
                <div class="stat-box"><div class="label">Avg Race</div><div class="stat-val" style="color:#fff" id="disp-avg-race">0</div></div>
                <div class="stat-box"><div class="label">Avg Biz</div><div class="stat-val" style="color:#fff" id="disp-avg-biz">0</div></div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">XP Calculator <button class="breakdown-btn" onclick="toggleBreakdown()">üìä BREAKDOWN</button></div>
            <div id="sync-warning" style="text-align:center; margin-bottom:5px; color:var(--primary); font-weight:bold; font-size:0.9em; animation: flash 2s infinite;">‚ö† OPEN IDENTITY TAB TO SYNC</div>
            <div id="calc-container" class="locked">
                <select id="calc-mode" onchange="runCalculator()">
                    <option value="biz">Business XP</option>
                    <option value="race">Racing XP</option>
                </select>
                <input type="number" id="target-input" placeholder="Target XP" oninput="runCalculator()">
                <div class="quick-btn-row">
                    <button class="quick-btn" onclick="setCalc(100000)">100K</button>
                    <button class="quick-btn" onclick="setCalc(1000000)">1M</button>
                    <button class="quick-btn" onclick="setCalc(10000000)">10M</button>
                </div>
                <div class="calc-result" id="calc-result">Waiting for streak...</div>
            </div>
        </div>
    </div>
    
    <div class="support-footer">
        <div onclick="openExternal('https://www.paypal.com/paypalme/pinkiprim')" class="support-link">
            Support PinkiPrim <span class="heart-spin">‚ù§</span>
        </div>
    </div>
    
    <div id="resize-handle"></div>
</div>

<script>
// --- HELPERS ---
function safeSetText(id, text) { const el = document.getElementById(id); if (el) el.innerText = text; }
function safeSetHTML(id, html) { const el = document.getElementById(id); if (el) el.innerHTML = html; }

function openExternal(url) {
    try {
        window.invokeNative('openUrl', url);
    } catch(e) {
        window.open(url, '_blank');
    }
}

// --- STATE ---
let STATE = {
    internalFares: 0, // Master Session Counter
    
    bizXP: 0, startBizXP: null, 
    raceXP: 0, startRaceXP: null,
    
    streak: 0, streakSynced: false,
    
    activeBonuses: [], totalBonusPercent: 0,
    
    lastFareTime: 0,
    lastRaceXP: 0, lastBizXP: 0 // Store previous XP to calculate delta
};

// --- UI LOGIC ---
function toggleMini() { document.getElementById('tracker-app').classList.toggle('mini-mode'); document.getElementById('breakdown-panel').classList.remove('active'); }
function toggleBreakdown() { document.getElementById('breakdown-panel').classList.toggle('active'); updateBreakdownUI(); }
function setCalc(val) { document.getElementById('target-input').value = val; runCalculator(); }

function forceResync() {
    STATE.streakSynced = false;
    STATE.streak = 0;
    document.getElementById('sync-warning').style.display = 'block';
    document.getElementById('calc-container').classList.add('locked');
    safeSetHTML('streak-status', '‚ö† RESYNC REQUIRED');
    safeSetText('micro-streak', '?');
    let mainStreak = document.getElementById('main-streak-display');
    mainStreak.innerText = "STREAK: ?";
    mainStreak.classList.remove('synced');
}

// --- HELPERS ---
function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "K";
    return num.toLocaleString();
}
function cleanString(s) { return s ? s.replace(/~[a-zA-Z]~/g, "").trim() : ""; }
function getLevel(exp) {
    let level = 0, xpCap = 5;
    while (exp >= xpCap) { exp -= xpCap; level++; xpCap = (level + 1) * 5; }
    return { level, percent: (exp/xpCap*100).toFixed(1), needed: Math.round(xpCap - exp).toLocaleString() };
}

// --- DRAG LOGIC ---
let isDragging = false, dragStartX, dragStartY, initialLeft, initialTop;
function dragStart(e) {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
    e.preventDefault(); isDragging = true; dragStartX = e.clientX; dragStartY = e.clientY;
    let app = document.getElementById('tracker-app'); let rect = app.getBoundingClientRect();
    initialLeft = rect.left; initialTop = rect.top;
    window.addEventListener('mousemove', onDrag); window.addEventListener('mouseup', stopDrag);
}
function onDrag(e) {
    if (!isDragging) return;
    let app = document.getElementById('tracker-app');
    app.style.left = (initialLeft + e.clientX - dragStartX) + 'px';
    app.style.top = (initialTop + e.clientY - dragStartY) + 'px';
}
function stopDrag() {
    isDragging = false; window.removeEventListener('mousemove', onDrag); window.removeEventListener('mouseup', stopDrag);
}

// --- MAIN LISTENER ---
window.addEventListener('message', (event) => {
    let data = event.data.type === 'data' ? event.data.data : event.data;
    if (!data) return;

    // 1. Status Parsing (Just for Display)
    if(data.status) {
        try {
            let s = (typeof data.status === 'string') ? JSON.parse(data.status) : data.status;
            if(s.lines) {
                let status = "Idle", location = "--", distance = "", idle = "0 / 30", timer = "0", currentFares = 0;
                
                s.lines.forEach(line => {
                    let clean = cleanString(line);
                    if(clean.startsWith("Status:")) status = clean.replace("Status:", "").trim();
                    if(clean.startsWith("Area:")) location = clean.replace("Area:", "").trim();
                    if(clean.includes("Distance to destination:")) distance = clean;
                    if(clean.startsWith("Fares This Session:")) {
                        currentFares = parseInt(clean.replace("Fares This Session:", "").trim());
                    }
                    if(clean.includes("Idle Cycles:")) idle = clean.replace("Idle Cycles:", "").trim();
                    if(clean.includes("Time Bonus:")) timer = clean.replace("Time Bonus:", "").trim();
                });
                
                // Display Fares from Game Logic (Pure Display)
                safeSetText('disp-fares', currentFares); safeSetText('micro-fares', currentFares);
                
                safeSetText('disp-status', status); safeSetText('micro-status', status.substring(0, 10));
                safeSetText('disp-loc', location); safeSetText('disp-dist', distance);
                safeSetText('disp-idle', idle); safeSetText('disp-bonus', timer); safeSetText('micro-bonus', timer);
            }
        } catch(e){}
    }

    // 2. XP Parsing (Trigger Logic)
    let raceXP = parseXP(data, "exp_player_racing");
    let bizXP = parseXP(data, "exp_business_business");
    
    // Strict Init: Only accept > 0
    if (raceXP > 0) checkXPUpdates(raceXP, 'race');
    if (bizXP > 0) checkXPUpdates(bizXP, 'biz');
    
    // 3. Menu Scanning (Identity)
    if (data.menu_choices) {
        try {
            let rawMenu = (typeof data.menu_choices === 'object') ? JSON.stringify(data.menu_choices) : data.menu_choices;
            parseIdentity(rawMenu);
            parseBonuses(rawMenu);
        } catch(e) {}
    }
    
    updateUI();
});

// v2.7 STRICT IDENTITY PARSER (No "High Score", just strict read if menu open)
function parseIdentity(rawString) {
    let match = rawString.match(/Cabbie:\s*(\d+)/i);
    if (match && match[1]) {
        let streakVal = parseInt(match[1]);
        if (!isNaN(streakVal)) {
            // Only update if we aren't already synced
            if (!STATE.streakSynced) {
                STATE.streak = streakVal;
                STATE.streakSynced = true;
                document.getElementById('sync-warning').style.display = 'none';
                document.getElementById('calc-container').classList.remove('locked');
                updateStreakUI();
            }
        }
    }
}

function parseBonuses(rawString) {
    let newBonuses = [];
    let totalPct = 0;
    let baseBonusFound = false;

    let baseMatch = rawString.match(/Base Experience Bonus:\s*(\d+(\.\d+)?)%/i);
    if (baseMatch && baseMatch[1]) {
        totalPct = parseFloat(baseMatch[1]);
        baseBonusFound = true;
        newBonuses.push("TOTAL BASE: " + totalPct + "%");
    }

    if (!baseBonusFound) {
        let expBonusMatches = rawString.matchAll(/(\d+)%\s+Exp\s+Bonus/gi);
        for (const match of expBonusMatches) {
            totalPct += parseInt(match[1]);
            newBonuses.push(match[0]);
        }
    }
    
    STATE.activeBonuses = newBonuses;
    STATE.totalBonusPercent = totalPct;
    updateBreakdownUI();
}

function updateBreakdownUI() {
    const container = document.getElementById('bd-bonus-list');
    if(STATE.activeBonuses.length > 0) {
        container.innerHTML = "";
        STATE.activeBonuses.forEach(b => {
            let div = document.createElement('div');
            div.className = 'bd-item';
            div.innerText = "‚òÖ " + b;
            container.appendChild(div);
        });
    }
    let streakMult = (100 + STATE.streak) / 100;
    safeSetText('bd-streak-mult', streakMult.toFixed(2) + "x");
    let xpPerFare = calculateCabbieXP(STATE.streak);
    safeSetText('bd-total', "~" + Math.round(xpPerFare) + " XP");
}

function parseXP(data, key) {
    let val = data[key];
    if (!val && data.inventory) {
        try { let inv = typeof data.inventory === 'string' ? JSON.parse(data.inventory) : data.inventory; if(inv[key]) val = inv[key]; } catch(e){}
    }
    if (typeof val === 'object' && val !== null && val.amount !== undefined) val = val.amount;
    if (typeof val === 'string') val = parseFloat(val);
    return (typeof val === 'number' && !isNaN(val)) ? val : 0;
}

// XP TRIGGER LOGIC
function checkXPUpdates(val, type) {
    const newXP = Number(val);
    if (isNaN(newXP) || newXP <= 0) return;

    if (type === 'race') {
        if (STATE.startRaceXP === null) { STATE.startRaceXP = newXP; STATE.raceXP = newXP; STATE.lastRaceXP = newXP; return; }
        // Simple Jump Check (> 5 XP difference)
        if (newXP > (STATE.lastRaceXP + 5)) { registerFare(); }
        STATE.raceXP = newXP;
        STATE.lastRaceXP = newXP;
    } 
    else if (type === 'biz') {
        if (STATE.startBizXP === null) { STATE.startBizXP = newXP; STATE.bizXP = newXP; STATE.lastBizXP = newXP; return; }
        // Simple Jump Check
        if (newXP > (STATE.lastBizXP + 5)) { registerFare(); }
        STATE.bizXP = newXP;
        STATE.lastBizXP = newXP;
    }
}

function registerFare() {
    const now = Date.now();
    // 8 Second Debounce (To prevent double count if Race and Biz XP update at same time)
    if (now - STATE.lastFareTime > 8000) {
        STATE.internalFares++; // Tracks session fares for average calculation
        
        if (STATE.streakSynced) {
            STATE.streak++; 
            updateStreakUI();
        }
        STATE.lastFareTime = now;
    }
}

function updateStreakUI() {
    if (STATE.streakSynced) {
        safeSetHTML('streak-status', `Tracking: <span style="color:var(--green)">${STATE.streak}</span>`);
        let mainStreak = document.getElementById('main-streak-display');
        if(mainStreak) { mainStreak.innerText = "STREAK: " + STATE.streak; mainStreak.classList.add('synced'); }
        safeSetText('micro-streak', STATE.streak);
        runCalculator(); 
    }
}

function updateUI() {
    // USE INTERNAL COUNTER FOR AVERAGES
    let sessionFares = Math.max(1, STATE.internalFares);

    if (STATE.raceXP > 0 && STATE.startRaceXP !== null) {
        let rData = getLevel(STATE.raceXP);
        safeSetText('disp-race-lvl', rData.level); safeSetText('disp-race-xp', STATE.raceXP.toLocaleString());
        let rBar = document.getElementById('race-bar'); if(rBar) rBar.style.width = rData.percent + "%";
        safeSetText('race-text', rData.percent + "%"); safeSetText('race-needed', rData.needed + " to Next");
        
        let gain = Math.max(0, STATE.raceXP - STATE.startRaceXP); 
        safeSetText('sess-race', `+${gain.toLocaleString()} XP`);
        safeSetText('micro-race-lvl', rData.level); let mBar = document.getElementById('micro-race-bar'); if(mBar) mBar.style.width = rData.percent + "%";
        
        // Only show average if we have actually done a fare internally
        if (STATE.internalFares > 0) safeSetText('disp-avg-race', Math.round(gain / sessionFares));
        else safeSetText('disp-avg-race', 0);
    }

    if (STATE.bizXP > 0 && STATE.startBizXP !== null) {
        let bData = getLevel(STATE.bizXP);
        safeSetText('disp-biz-lvl', bData.level); safeSetText('disp-biz-xp', STATE.bizXP.toLocaleString());
        let bBar = document.getElementById('biz-bar'); if(bBar) bBar.style.width = bData.percent + "%";
        safeSetText('biz-text', bData.percent + "%"); safeSetText('biz-needed', bData.needed + " to Next");
        
        let gain = Math.max(0, STATE.bizXP - STATE.startBizXP);
        safeSetText('sess-biz', `+${gain.toLocaleString()} XP`);
        safeSetText('micro-biz-lvl', bData.level); let mbBar = document.getElementById('micro-biz-bar'); if(mbBar) mbBar.style.width = bData.percent + "%";
        
        if (STATE.internalFares > 0) safeSetText('disp-avg-biz', Math.round(gain / sessionFares));
        else safeSetText('disp-avg-biz', 0);
    }

    runCalculator();
}

function calculateCabbieXP(streak) {
    const distanceXP = 7.5; 
    const timeBonus = 2; 
    const streakMult = (100 + streak) / 100;
    const globalMult = 1 + (STATE.totalBonusPercent / 100);
    return (distanceXP * streakMult * timeBonus) * globalMult;
}

function runCalculator() {
    let t = parseInt(document.getElementById('target-input').value);
    let mode = document.getElementById('calc-mode').value;
    
    if (!STATE.streakSynced) { safeSetHTML('calc-result', "<span style='color:orange'>Please open Identity tab to sync Streak data first.</span>"); return; }
    if (!t) { safeSetText('calc-result', "Enter XP amount above."); return; }
    
    let currentXP = (mode === 'race') ? STATE.raceXP : STATE.bizXP;
    if (t > currentXP) {
        const diff = t - currentXP;
        const xpPerFare = calculateCabbieXP(STATE.streak);
        const fares = Math.ceil(diff / xpPerFare);
        safeSetHTML('calc-result', `Remaining: <b>${formatNumber(diff)} XP</b><br>Streak XP: ~${Math.round(xpPerFare)}<br><span style="color:var(--primary)">Est. Fares: <b>${formatNumber(fares)}</b></span>`);
    } else { safeSetHTML('calc-result', `Target reached.`); }
}

const dH = document.getElementById("drag-handle");
if(dH) { dH.onmousedown = (e) => { if (!document.getElementById('tracker-app').classList.contains('mini-mode')) { dragStart(e); } }; }

setInterval(() => {
    let keys = [ "exp_player_racing", "exp_business_business", "inventory", "status", "name", "menu_choices" ];
    if(window.parent) window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
    let d = new Date(); safeSetText('clock', d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
}, 1000);

// --- KEYDOWN LISTENER FOR ESC ---
window.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' || e.keyCode === 27) { 
        // 1. CHECK IF TYPING: If inside a text box, just unfocus it
        if (document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA") {
            document.activeElement.blur();
            return;
        }

        // 2. CHECK FOR MODALS: If a modal/menu is open, close IT
        const breakdownPanel = document.getElementById('breakdown-panel');
        if (breakdownPanel && breakdownPanel.classList.contains('active')) {
            breakdownPanel.classList.remove('active');
            return;
        }

        // 3. RETURN FOCUS TO GAME (Keep UI Visible)
        releaseFocus();
    }
});

// --- RELEASE FOCUS FUNCTION ---
function releaseFocus() {
    if(window.GetParentResourceName) {
        fetch(`https://${GetParentResourceName()}/close`, { method: 'POST' }).catch(err => {});
    }
    
    // Legacy/Alternative callback method
    try {
        window.parent.postMessage({ type: "close" }, "*");
    } catch(e) {}
}

const rh = document.getElementById('resize-handle');
if(rh) { rh.onmousedown = e => { e.preventDefault(); window.addEventListener('mousemove', rs); window.addEventListener('mouseup', rsEnd); }; }
function rs(e) { let a=document.getElementById('tracker-app'); if(!a.classList.contains('mini-mode')) { a.style.width=Math.max(280, e.clientX-a.getBoundingClientRect().left)+'px'; a.style.height=Math.max(200, e.clientY-a.getBoundingClientRect().top)+'px'; } }
function rsEnd() { window.removeEventListener('mousemove', rs); window.removeEventListener('mouseup', rsEnd); }
</script>
</body>
</html>
