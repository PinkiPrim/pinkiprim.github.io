<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tycoon Deep Probe</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;600&family=Rajdhani:wght@600;800&display=swap');

        :root {
            --bg: #0f0f12;
            --panel: #1a1a1e;
            --border: #2f2f35;
            --accent: #ff0055;
            --text: #e0e0e0;
            --code: #00e676;
            --highlight: #ffb300;
        }

        body {
            margin: 0; padding: 0;
            background: transparent;
            font-family: 'Roboto Mono', monospace;
            color: var(--text);
            height: 100vh; width: 100vw;
            overflow: hidden;
            user-select: none;
        }

        #app {
            position: absolute; top: 50px; left: 50px;
            width: 500px; height: 600px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            display: flex; flex-direction: column;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            resize: both; overflow: hidden;
        }

        header {
            background: #111; padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            cursor: move;
        }
        
        .title { font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 1.1em; color: var(--accent); letter-spacing: 1px; }

        #content { flex: 1; display: flex; flex-direction: column; overflow: hidden; }

        /* --- TOP: COMMAND TESTER --- */
        .tester-area {
            padding: 10px; background: var(--panel); border-bottom: 1px solid var(--border);
            display: flex; gap: 5px; align-items: center;
        }
        
        .tester-label { font-size: 0.7em; color: #888; text-transform: uppercase; }
        
        #cmd-input {
            flex: 1; background: #000; border: 1px solid var(--border);
            color: var(--code); padding: 8px; font-family: inherit; font-size: 0.9em;
            border-radius: 3px;
        }
        
        .btn {
            background: var(--border); border: none; color: #fff;
            padding: 8px 12px; cursor: pointer; border-radius: 3px;
            font-family: 'Rajdhani', sans-serif; font-weight: bold;
        }
        .btn:hover { background: var(--accent); }
        .btn.copy { background: var(--highlight); color: #000; }

        /* --- BOTTOM: LIVE DATA --- */
        .data-header {
            padding: 5px 10px; background: #000; font-size: 0.75em; color: #666;
            display: flex; justify-content: space-between; align-items: center;
        }

        #data-log {
            flex: 1; overflow-y: auto; padding: 5px;
            font-size: 0.8em; scrollbar-width: thin;
        }

        .log-row {
            display: flex; border-bottom: 1px solid #222;
            padding: 4px 0; transition: background 0.5s;
        }
        .log-row.flash { background: rgba(255, 179, 0, 0.2); }

        .key-col { width: 40%; color: #aaa; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; padding-right: 5px; }
        .val-col { width: 60%; color: var(--code); word-break: break-all; }
        
        .null-val { color: #555; font-style: italic; }

    </style>
</head>
<body>

<div id="app">
    <header id="drag-handle">
        <div class="title">DATA PROBE // REPORT GEN</div>
        <button class="btn" style="font-size:0.7em;" onclick="window.closeApp()">X</button>
    </header>

    <div id="content">
        <div class="tester-area" style="flex-direction:column; align-items:stretch;">
            <div style="display:flex; justify-content:space-between;">
                <span class="tester-label">Command Injector (Try variants here)</span>
            </div>
            <div style="display:flex; gap:5px;">
                <input type="text" id="cmd-input" placeholder='e.g. "say hello" or just "hello"'>
                <button class="btn" onclick="window.injectCommand()">SEND</button>
            </div>
            <div style="font-size:0.7em; color:#666; margin-top:2px;">
                *Use "say hello" to test command. Use "hello" to test raw text.
            </div>
        </div>

        <div class="data-header">
            <span>LIVE DATA FEED</span>
            <span id="update-indicator">‚óè Listening...</span>
        </div>
        
        <div id="data-log">
            <div style="padding:20px; text-align:center; color:#444;">
                Waiting for game data...
            </div>
        </div>

        <div style="padding:10px; background:#000; text-align:center;">
            <button class="btn copy" style="width:100%;" onclick="window.copyReport()">COPY FULL REPORT TO CLIPBOARD</button>
        </div>
    </div>
</div>

<script>
// --- CORE ---
let DATA_CACHE = {};
let LAST_UPDATE = Date.now();

// Init
window.addEventListener('load', () => {
    // Start Data Loop
    setInterval(requestData, 1000);
});

// 1. DATA REQUESTER (Asks for EVERYTHING)
function requestData() {
    if(window.parent) {
        // We request 'getData' which returns the full cache usually
        // We also request keys that might not be in cache by default if we know them
        window.parent.postMessage({ type: "getData" }, "*");
    }
}

// 2. DATA LISTENER
window.addEventListener('message', (event) => {
    let payload = event.data;
    if (payload && payload.type === 'data' && payload.data) {
        processData(payload.data);
    }
});

function processData(newData) {
    const log = document.getElementById('data-log');
    const indicator = document.getElementById('update-indicator');
    
    // Pulse indicator
    indicator.style.color = "#00e676";
    setTimeout(() => indicator.style.color = "#666", 200);

    let hasChanges = false;

    // Merge and Check differences
    for (const [key, value] of Object.entries(newData)) {
        let stringVal = JSON.stringify(value);
        
        // If new key or value changed
        if (DATA_CACHE[key] !== stringVal) {
            DATA_CACHE[key] = stringVal;
            hasChanges = true;
        }
    }

    if (hasChanges) renderList();
}

function renderList() {
    const container = document.getElementById('data-log');
    container.innerHTML = "";

    // Sort keys alphabetically
    const keys = Object.keys(DATA_CACHE).sort();

    keys.forEach(key => {
        let val = DATA_CACHE[key];
        
        // Truncate long JSON strings for display
        let displayVal = val;
        if (val.length > 80) displayVal = val.substring(0, 80) + "...";

        const row = document.createElement("div");
        row.className = "log-row";
        row.innerHTML = `
            <div class="key-col">${key}</div>
            <div class="val-col">${displayVal}</div>
        `;
        container.appendChild(row);
    });
}

// --- COMMAND INJECTOR ---
window.injectCommand = function() {
    const input = document.getElementById('cmd-input');
    const cmd = input.value.trim();
    if(!cmd) return;

    if(window.parent) {
        window.parent.postMessage({
            type: "sendCommand",
            command: cmd
        }, "*");
    } else {
        console.log("Mock Send:", cmd);
    }
};

// --- REPORT GENERATOR ---
window.copyReport = function() {
    const reportObj = {
        timestamp: new Date().toISOString(),
        keys_found: Object.keys(DATA_CACHE).length,
        data: DATA_CACHE
    };

    const text = JSON.stringify(reportObj, null, 2);
    
    navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('.btn.copy');
        btn.innerText = "COPIED!";
        setTimeout(() => btn.innerText = "COPY FULL REPORT TO CLIPBOARD", 2000);
    });
};

window.closeApp = function() {
    if (window.parent) window.parent.postMessage({ type: "close" }, "*");
};

// --- DRAG ---
const elm = document.getElementById("app");
const head = document.getElementById("drag-handle");
let isDragging = false, startX, startY, initLeft, initTop;

head.addEventListener("mousedown", e => {
    if(e.target.tagName === 'BUTTON') return;
    e.preventDefault();
    isDragging = true;
    startX = e.clientX; startY = e.clientY;
    const r = elm.getBoundingClientRect();
    initLeft = r.left; initTop = r.top;
    document.addEventListener("mousemove", dragMove);
    document.addEventListener("mouseup", dragEnd);
});

function dragMove(e) {
    if(!isDragging) return;
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    elm.style.left = (initLeft + dx) + "px";
    elm.style.top = (initTop + dy) + "px";
}

function dragEnd() {
    isDragging = false;
    document.removeEventListener("mousemove", dragMove);
    document.removeEventListener("mouseup", dragEnd);
}
</script>
</body>
</html>
