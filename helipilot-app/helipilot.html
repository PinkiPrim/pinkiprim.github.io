<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Heli Ops</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #ff9800;
            --primary-dim: #b26a00;
            --bg-glass: rgba(20, 20, 20, 0.98);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(255, 152, 0, 0.4);
            --green: #00e676;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        /* MAIN CONTAINER */
        #tracker-app {
            position: absolute;
            top: 50px; left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            min-height: 200px;
            transition: width 0.1s, height 0.1s;
        }

        /* --- MINI MODE STATE --- */
        #tracker-app.mini-mode {
            width: 420px !important;
            height: 70px !important;
            min-height: 70px !important;
            border-radius: 12px;
            resize: none;
        }
        /* HIDE Normal Elements in Mini Mode */
        #tracker-app.mini-mode #main-header, 
        #tracker-app.mini-mode #main-content { display: none !important; }
        /* SHOW Micro Elements in Mini Mode */
        #tracker-app.mini-mode #micro-view { display: flex !important; }

        /* --- ANIMATION LAYER (Background) --- */
        #sky-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 60px;
            overflow: hidden; pointer-events: none; z-index: 0;
        }
        
        #heli-anim {
            position: absolute; bottom: 5px; left: 20px; font-size: 2em; z-index: 2;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5));
            transform: scaleX(-1);
            animation: heliBob 2s ease-in-out infinite alternate;
        }
        @keyframes heliBob { from { top: 15px; } to { top: 5px; } }

        .building {
            position: absolute; bottom: -5px; font-size: 2.5em; right: -60px;
            animation: scrollCity 12s linear infinite;
        }
        .b-front { z-index: 3; opacity: 0.9; }
        .b-back { z-index: 1; filter: brightness(0.5); font-size: 2em; }
        
        .b1 { animation-delay: 0s; }
        .b2 { animation-delay: -3s; }
        .b3 { animation-delay: -6s; }
        .b4 { animation-delay: -9s; }

        @keyframes scrollCity {
            0% { transform: translateX(0); visibility: visible; }
            100% { transform: translateX(-450px); visibility: visible; }
        }

        /* --- HEADER --- */
        #main-header {
            position: relative; height: 60px; width: 100%;
            background: linear-gradient(180deg, var(--primary-dim), rgba(20,20,20,0));
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; box-sizing: border-box;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: move; z-index: 10;
        }

        .header-ui { z-index: 20; display: flex; align-items: center; gap: 10px; }
        .nav-icon { text-decoration: none; font-size: 1.2em; color: #ccc; cursor: pointer; }
        .title-text { font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.2em; text-transform: uppercase; letter-spacing: 2px; color: white; text-shadow: 0 2px 4px black; }

        /* BUTTONS */
        .btn-mini {
            font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.7em;
            background: rgba(0,0,0,0.6); border: 1px solid #555; color: #ccc;
            padding: 2px 6px; border-radius: 4px; cursor: pointer;
            z-index: 1000; pointer-events: auto;
        }
        .btn-mini:hover { background: var(--primary); color: white; border-color: white; }

        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: white; font-size: 0.85em; }

        /* --- CONTENT --- */
        #main-content { padding: 10px; overflow-y: auto; z-index: 10; position: relative; }

        .flight-board { background: rgba(255,255,255,0.05); border: 1px dashed #555; border-radius: 6px; padding: 8px; margin-bottom: 10px; }
        .f-label { font-size: 0.7em; color: var(--primary); text-transform: uppercase; }
        .f-value { font-family: 'Rajdhani', sans-serif; font-size: 1.2em; font-weight: 700; color: white; }
        
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; margin-top: 5px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px; text-align: center; }
        .val-sml { font-weight: bold; font-size: 1em; }

        /* --- MICRO VIEW (MINI) --- */
        #micro-view {
            display: none; flex-direction: column; justify-content: center; height: 100%; padding: 0 10px;
            font-family: 'Rajdhani', sans-serif; cursor: move;
        }
        .micro-row { display: flex; justify-content: space-between; align-items: center; height: 50%; width: 100%; }
        .micro-data { display: flex; align-items: center; gap: 8px; font-size: 0.8em; color: #ccc; }
        .micro-val { color: white; font-weight: bold; }
        .active { color: var(--green); }

        /* INPUTS */
        input { width: 90%; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; margin-top: 5px; }
        .quick-row { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        .q-btn { background: rgba(255,255,255,0.1); border: 1px solid #444; color: #ccc; font-size: 0.7em; padding: 2px 5px; cursor: pointer; flex: 1; }
        .q-btn:hover { background: var(--primary); color: white; }

        #resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 100; }
    </style>
</head>
<body>

<div id="tracker-app">
    
    <div id="micro-view">
        <button id="btn-expand" class="btn-mini" style="position:absolute; top:4px; right:4px;">EXPAND</button>
        <div class="micro-row" style="border-bottom:1px solid #333;">
            <div class="micro-data"><span style="font-size:1.2em">üöÅ</span> <span style="color:var(--primary)">HELI OPS</span></div>
            <div class="micro-data">To: <span class="micro-val" id="m-dest">Waiting...</span></div>
            <div class="micro-data">Dist: <span class="micro-val active" id="m-dist">--</span></div>
        </div>
        <div class="micro-row">
            <div class="micro-data">Lvl: <span class="micro-val" id="m-lvl">0</span></div>
            <div class="micro-data">XP: <span class="micro-val" id="m-xp">0</span></div>
            <div class="micro-data">Left: <span class="micro-val" id="m-calc">--</span></div>
        </div>
    </div>

    <header id="main-header">
        <div id="sky-container">
            <div id="heli-anim">üöÅ</div>
            <div class="building b-front b1">üè¢</div>
            <div class="building b-back b2">üè´</div>
            <div class="building b-front b3">üè¨</div>
            <div class="building b-back b4">üè®</div>
        </div>

        <div class="header-ui">
            <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon">üè†</a>
        </div>
        
        <div class="title-text" style="z-index:20;">HELI OPS</div>

        <div class="header-ui" style="flex-direction:column; gap:2px; align-items:flex-end;">
            <button id="btn-mini" class="btn-mini">MINI</button>
            <span id="clock">00:00</span>
        </div>
    </header>

    <div id="main-content">
        
        <div class="flight-board">
            <div class="f-label">Current Job</div>
            <div class="f-value" id="d-dest">Waiting for data...</div>
            <div style="display:flex; justify-content:space-between; margin-top:5px;">
                <div><div class="f-label">Distance</div><div class="f-value" style="font-size:1em" id="d-dist">--</div></div>
                <div style="text-align:right"><div class="f-label">Stops</div><div class="f-value" style="font-size:1em" id="d-stops">--</div></div>
            </div>
        </div>

        <div class="stat-grid">
            <div class="stat-box"><div class="f-label">Level</div><div class="val-sml" style="color:var(--primary)" id="d-lvl">0</div></div>
            <div class="stat-box"><div class="f-label">XP</div><div class="val-sml" id="d-xp">0</div></div>
            <div class="stat-box"><div class="f-label">Tokens</div><div class="val-sml" style="color:var(--green)" id="d-tok">0</div></div>
        </div>

        <div style="margin-top:10px; border-top:1px solid #333; padding-top:5px;">
            <div class="f-label">Calculator</div>
            <input type="number" id="calc-input" placeholder="Target XP e.g. 100000">
            <div class="quick-row">
                <button class="q-btn" id="btn-100k">100K</button>
                <button class="q-btn" id="btn-1m">1M</button>
                <button class="q-btn" id="btn-10m">10M</button>
            </div>
            <div class="f-label" style="margin-top:5px; color:#888;" id="calc-result">Start flying to enable...</div>
        </div>

    </div>

    <div id="resize-handle"></div>
</div>

<script>
    // --- 1. SAFE STARTUP ---
    document.addEventListener("DOMContentLoaded", function() {
        initApp();
    });

    // --- 2. GLOBAL STATE ---
    const STATE = {
        xp: 0, jobs: 0, avg: 0, sessionXP: 0, lastXP: -1, startXP: null
    };
    const KEYS = { XP: "exp_piloting_heli", TOK: "exp_token_a|piloting|heli", STAT: "status" };

    function initApp() {
        // Clock
        setInterval(() => {
            const now = new Date();
            const timeStr = now.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
            document.getElementById('clock').innerText = timeStr;
        }, 1000);

        // Buttons - Using Event Listeners (Safe Method)
        document.getElementById('btn-mini').addEventListener('click', toggleMiniMode);
        document.getElementById('btn-expand').addEventListener('click', toggleMiniMode);
        
        // Calc Buttons
        document.getElementById('btn-100k').addEventListener('click', () => runCalc(100000));
        document.getElementById('btn-1m').addEventListener('click', () => runCalc(1000000));
        document.getElementById('btn-10m').addEventListener('click', () => runCalc(10000000));
        document.getElementById('calc-input').addEventListener('input', (e) => runCalc(e.target.value));

        // Restore Settings
        if(localStorage.getItem('heli_mini') === 'true') toggleMiniMode();
        const savedTarget = localStorage.getItem('heli_target');
        if(savedTarget) document.getElementById('calc-input').value = savedTarget;

        // Start Data
        setInterval(requestGameData, 1000);
        requestGameData();

        // Start Drag
        initDrag();
    }

    // --- 3. UI FUNCTIONS ---
    function toggleMiniMode() {
        const app = document.getElementById('tracker-app');
        app.classList.toggle('mini-mode');
        const isMini = app.classList.contains('mini-mode');
        localStorage.setItem('heli_mini', isMini);
    }

    function updateUI(xp, level, tokens) {
        // Main
        document.getElementById('d-lvl').innerText = level;
        document.getElementById('d-xp').innerText = formatNum(xp);
        document.getElementById('d-tok').innerText = formatNum(tokens);
        
        // Mini
        document.getElementById('m-lvl').innerText = level;
        document.getElementById('m-xp').innerText = formatNum(xp);
        document.getElementById('m-calc').innerText = STATE.avg > 0 ? "Ready" : "--";
        
        runCalc(document.getElementById('calc-input').value);
    }

    function updateFlight(dest, dist, stops) {
        // Main
        document.getElementById('d-dest').innerText = dest;
        document.getElementById('d-dist').innerText = dist;
        document.getElementById('d-stops').innerText = stops;

        // Mini
        document.getElementById('m-dest').innerText = dest.substring(0, 15);
        document.getElementById('m-dist').innerText = dist;

        // Color Logic
        const color = (dist.includes('m') && parseInt(dist) < 200) ? 'var(--green)' : '#ccc';
        document.getElementById('d-dist').style.color = color;
        document.getElementById('m-dist').style.color = color;
    }

    function runCalc(val) {
        if(!val) return;
        localStorage.setItem('heli_target', val);
        const target = parseInt(val);
        const resEl = document.getElementById('calc-result');
        const mEl = document.getElementById('m-calc');

        if(STATE.avg === 0) {
            resEl.innerText = "Complete a job first...";
            return;
        }

        let goal = target;
        // Smart Goal: If target < current, assume they want NEXT level
        if(target < 200) {
             // Simple logic for level calc if needed, or assume raw XP target
        }

        if(goal > STATE.xp) {
            const diff = goal - STATE.xp;
            const stops = Math.ceil(diff / STATE.avg);
            resEl.innerHTML = `Need <b>${formatNum(diff)} XP</b> (~<b>${stops}</b> stops)`;
            mEl.innerText = stops;
        } else {
            resEl.innerText = "Target Reached.";
            mEl.innerText = "Done";
        }
    }

    // --- 4. DATA LOGIC ---
    function requestGameData() {
        if(window.parent) {
            window.parent.postMessage({
                type: "getNamedData",
                keys: [KEYS.XP, KEYS.TOK, KEYS.STAT, "inventory"]
            }, "*");
        }
    }

    window.addEventListener('message', (e) => {
        if(e.data && e.data.type === 'data') {
            const data = e.data.data;
            processData(data);
        }
    });

    function processData(data) {
        // A. Flight Status
        if(data[KEYS.STAT]) {
            try {
                const status = JSON.parse(data[KEYS.STAT]);
                if(status.lines) {
                    let dest="--", dist="--", stops="--";
                    status.lines.forEach(l => {
                        const clean = l.replace(/~[a-z]~/g, "").trim();
                        if(clean.startsWith("Destination:")) dest = clean.split(":")[1].trim();
                        if(clean.startsWith("Distance:")) dist = clean.split(":")[1].trim();
                        if(clean.startsWith("Stops:")) stops = clean.split(":")[1].trim();
                    });
                    updateFlight(dest, dist, stops);
                }
            } catch(e) {}
        }

        // B. XP
        let rawXP = data[KEYS.XP];
        if(!rawXP && data.inventory) {
            try {
                const inv = JSON.parse(data.inventory);
                if(inv[KEYS.XP]) rawXP = inv[KEYS.XP];
            } catch(e){}
        }

        if(typeof rawXP === 'number') {
            if(STATE.startXP === null) {
                STATE.startXP = rawXP;
                STATE.lastXP = rawXP;
            } else if (rawXP > STATE.lastXP) {
                const diff = rawXP - STATE.lastXP;
                if(diff > 0) {
                    STATE.sessionXP += diff;
                    STATE.jobs++;
                    STATE.avg = STATE.sessionXP / STATE.jobs;
                    STATE.lastXP = rawXP;
                }
            }
            STATE.xp = rawXP;
            // Simple Level Calc: 0-5 = 1, etc.
            // Using standard formula approximation
            const lvl = Math.floor((Math.sqrt(1 + 8 * rawXP / 5) - 1) / 2);
            
            // C. Tokens
            let tok = 0;
            if(data[KEYS.TOK]) tok = (typeof data[KEYS.TOK] === 'object') ? data[KEYS.TOK].amount : data[KEYS.TOK];
            
            updateUI(rawXP, lvl, tok);
        }
    }

    // --- 5. DRAG & RESIZE (Bulletproof) ---
    function initDrag() {
        const app = document.getElementById("tracker-app");
        // Drag Entire App
        app.onmousedown = function(e) {
            // IGNORE buttons and inputs so we can click them
            if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            
            e.preventDefault();
            let startX = e.clientX;
            let startY = e.clientY;
            let startLeft = app.offsetLeft;
            let startTop = app.offsetTop;

            function doDrag(ev) {
                app.style.left = (startLeft + ev.clientX - startX) + "px";
                app.style.top = (startTop + ev.clientY - startY) + "px";
            }

            function stopDrag() {
                document.removeEventListener('mousemove', doDrag);
                document.removeEventListener('mouseup', stopDrag);
            }

            document.addEventListener('mousemove', doDrag);
            document.addEventListener('mouseup', stopDrag);
        };

        // Resize
        const rh = document.getElementById('resize-handle');
        rh.onmousedown = function(e) {
            e.stopPropagation(); // Don't drag main window
            e.preventDefault();
            let startX = e.clientX;
            let startY = e.clientY;
            let startW = app.offsetWidth;
            let startH = app.offsetHeight;

            function doResize(ev) {
                if(app.classList.contains('mini-mode')) return;
                app.style.width = Math.max(280, startW + ev.clientX - startX) + "px";
                app.style.height = Math.max(200, startH + ev.clientY - startY) + "px";
            }

            function stopResize() {
                document.removeEventListener('mousemove', doResize);
                document.removeEventListener('mouseup', stopResize);
            }

            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
        };
    }

    function formatNum(n) { return n ? n.toLocaleString() : "0"; }

</script>
</body>
</html>
