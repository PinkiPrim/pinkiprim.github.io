<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pinki's Hunting & Fishing Calc v1.2</title>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Roboto:wght@400;700&display=swap');

        :root {
            --bg-body: #121214;
            --bg-panel: #1a1a1d;
            --primary: #ff4081;
            --primary-dim: #c60055;
            --accent: #00e676;
            --text-main: #ffffff;
            --text-dim: #888;
            --border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* HIDE SCROLLBARS GLOBALLY */
        *::-webkit-scrollbar { display: none; }
        * { scrollbar-width: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #app {
            position: absolute; top: 50px; left: 50px;
            width: 800px; height: 530px; /* Slight height bump for new toggles */
            background: var(--bg-body);
            border-radius: 8px;
            border: 1px solid var(--primary);
            box-shadow: 0 10px 40px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            overflow: hidden;
        }

        /* HEADER */
        header {
            height: 35px; background: #1a1a1a; border-bottom: var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 10px; cursor: move; flex-shrink: 0;
        }
        .app-title { font-family: 'Rajdhani', sans-serif; font-weight: 800; font-size: 1.1em; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; }
        .nav-home { font-size: 1.2em; text-decoration: none; color: var(--text-dim); transition: 0.2s; cursor: pointer; }
        .nav-home:hover { color: #fff; }

        /* MAIN LAYOUT */
        .main-content { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR (MULTIPLIERS) */
        .sidebar {
            width: 250px; background: rgba(0,0,0,0.2);
            border-right: var(--border); padding: 10px;
            display: flex; flex-direction: column; gap: 8px;
            flex-shrink: 0;
        }
        
        .section-header {
            font-family: 'Rajdhani', sans-serif; font-weight: 700; color: var(--primary); 
            text-transform: uppercase; font-size: 0.85em; border-bottom: 1px solid rgba(255,255,255,0.1); 
            padding-bottom: 2px; margin-bottom: 5px;
        }

        /* Compact Boost Grid */
        .boost-grid { display: flex; flex-direction: column; gap: 2px; }
        .boost-row { display: flex; align-items: center; justify-content: space-between; font-size: 0.8em; }
        .boost-label { color: #ccc; }
        /* DX P Special Style */
        .dxp-label { color: var(--accent); font-weight: bold; }
        
        input[type="checkbox"] { transform: scale(1); cursor: pointer; accent-color: var(--primary); }

        .perk-input { 
            width: 100%; background: #222; border: 1px solid #444; color: #fff; 
            padding: 3px; border-radius: 4px; text-align: center; font-weight: bold; font-size: 0.85em;
        }

        .total-mult-box {
            background: rgba(0, 230, 118, 0.05); border: 1px dashed var(--accent);
            padding: 5px; border-radius: 4px; text-align: center; margin-top: auto;
        }
        .mult-val { font-size: 1.4em; font-weight: 900; color: var(--accent); font-family: 'Rajdhani'; line-height: 1; }

        /* WORKSPACE */
        .workspace { flex: 1; padding: 10px; display: flex; flex-direction: column; overflow: hidden; }

        /* XP GOALS BAR */
        .goals-bar {
            display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px;
            background: var(--bg-panel); padding: 8px; border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.05); margin-bottom: 10px;
        }
        .input-mini { display: flex; flex-direction: column; gap: 2px; }
        .input-mini label { font-size: 0.65em; color: var(--text-dim); text-transform: uppercase; font-weight: bold; }
        .std-input { 
            background: #111; border: 1px solid #333; color: #fff; padding: 4px 6px; 
            border-radius: 3px; font-family: 'Rajdhani'; font-weight: bold; font-size: 0.95em; width: 100%; box-sizing: border-box;
        }
        .std-input:focus { border-color: var(--primary); outline: none; }
        
        .sync-btn { 
            background: var(--primary-dim); border: none; color: #fff; padding: 2px 6px; 
            border-radius: 3px; cursor: pointer; font-size: 0.7em; font-weight: bold; width: 100%; margin-top: 2px;
        }
        .sync-btn:active { transform: translateY(1px); }

        .remaining-text { text-align: right; font-family: 'Rajdhani'; font-size: 0.9em; color: #888; margin-top: 2px; }
        .remaining-val { color: var(--primary); font-weight: bold; font-size: 1.1em; }

        /* TABS */
        .mode-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
        .mode-tab { 
            flex: 1; text-align: center; padding: 6px; background: rgba(255,255,255,0.05); 
            color: #888; cursor: pointer; font-family: 'Rajdhani'; font-weight: 700; font-size: 0.9em; 
            text-transform: uppercase; border-radius: 4px; transition: 0.2s;
        }
        .mode-tab.active { background: var(--primary); color: #fff; }

        /* PANELS */
        .calc-panel { display: none; height: 100%; }
        .calc-panel.active { display: flex; flex-direction: column; }

        /* RESULTS COMPACT */
        .result-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; 
            background: rgba(255,255,255,0.02); padding: 10px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.05); flex: 1;
        }
        .res-item { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.03); padding: 3px 0; font-size: 0.85em; }
        .res-label { color: #888; }
        .res-val { font-weight: bold; font-family: 'Rajdhani'; }
        .res-highlight { color: var(--accent); font-size: 1.1em; }

        /* FOOTER */
        .support-footer { padding: 5px; text-align: center; background: rgba(0,0,0,0.3); border-top: var(--border); font-size: 0.7em; flex-shrink: 0; }
        .support-link { color: var(--text-dim); text-decoration: none; cursor: pointer; }
        .support-link:hover { color: #fff; }
        .heart { color: var(--primary); display: inline-block; animation: beat 1s infinite; }
        @keyframes beat { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

    </style>
</head>
<body>

    <div id="app">
        <header id="drag-handle">
            <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-home">üè†</a>
            <div class="app-title">Hunting & Fishing Calculator</div>
            <div style="width:20px"></div>
        </header>

        <div class="main-content">
            <div class="sidebar">
                <div>
                    <div class="section-header">Active Multipliers</div>
                    <div class="boost-grid">
                        <div class="boost-row"><span class="boost-label dxp-label">DXP (x2)</span><input type="checkbox" id="dxp-check" onchange="calc()"></div>
                        <div class="boost-row"><span class="boost-label">Discord (5%)</span><input type="checkbox" class="boost-cb" value="5" checked></div>
                        <div class="boost-row"><span class="boost-label">Faction (5%)</span><input type="checkbox" class="boost-cb" value="5"></div>
                        <div class="boost-row"><span class="boost-label">Voice (10%)</span><input type="checkbox" class="boost-cb" value="10"></div>
                        <div class="boost-row"><span class="boost-label">Pilot (5%)</span><input type="checkbox" class="boost-cb" value="5"></div>
                        <div class="boost-row"><span class="boost-label">Monke (25%)</span><input type="checkbox" class="boost-cb" value="25"></div>
                    </div>
                </div>
                
                <div>
                    <div class="section-header">Skill Perks</div>
                    <input type="number" id="perk-count" class="perk-input" min="0" max="19" value="0" placeholder="0 - 19" oninput="calc()">
                </div>

                <div>
                    <div class="section-header">Active Tokens</div>
                    <div class="boost-grid">
                        <div class="boost-row"><span class="boost-label">15% (1 Hr)</span><input type="checkbox" class="token-cb" data-xp="15" data-mins="60"></div>
                        <div class="boost-row"><span class="boost-label">10% (90m)</span><input type="checkbox" class="token-cb" data-xp="10" data-mins="90"></div>
                        <div class="boost-row"><span class="boost-label">5% (1 Wk)</span><input type="checkbox" class="token-cb" data-xp="5" data-mins="10080"></div>
                        <div class="boost-row"><span class="boost-label">10% (1 Day)</span><input type="checkbox" class="token-cb" data-xp="10" data-mins="1440"></div>
                        <div class="boost-row"><span class="boost-label">5% (2 Hr)</span><input type="checkbox" class="token-cb" data-xp="5" data-mins="120"></div>
                    </div>
                </div>

                <div class="total-mult-box">
                    <div style="font-size:0.7em; color:#888; text-transform:uppercase;">Multiplier</div>
                    <div class="mult-val" id="disp-mult">1.00x</div>
                </div>
            </div>

            <div class="workspace">
                
                <div class="goals-bar">
                    <div class="input-mini">
                        <label>Current XP</label>
                        <input type="number" id="current-xp" class="std-input" value="0" oninput="calc()">
                        <button class="sync-btn" onclick="requestSync()">FETCH</button>
                    </div>
                    <div class="input-mini">
                        <label>Target Level</label>
                        <input type="number" id="target-lvl" class="std-input" placeholder="Lvl" oninput="lvlToXp()">
                        <div class="remaining-text">REM: <span id="disp-remaining" class="remaining-val">0</span></div>
                    </div>
                    <div class="input-mini">
                        <label>Target XP</label>
                        <input type="number" id="target-xp" class="std-input" placeholder="Total XP" oninput="calc()">
                    </div>
                </div>

                <div class="mode-tabs">
                    <div class="mode-tab active" onclick="switchMode('hunting')">Hunting</div>
                    <div class="mode-tab" onclick="switchMode('fishing')">Fishing</div>
                </div>

                <div id="panel-hunting" class="calc-panel active">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div class="input-mini" style="flex:2;">
                            <label>Target Animal</label>
                            <select id="animal-select" class="std-input" onchange="calc()"></select>
                        </div>
                        <div class="input-mini" style="flex:1;">
                            <label>Kills / Hour</label>
                            <input type="number" id="hunt-rate" class="std-input" value="60" oninput="calc()">
                        </div>
                    </div>

                    <div class="result-grid">
                        <div class="res-item"><span class="res-label">Base XP</span><span class="res-val" id="hunt-base">0</span></div>
                        <div class="res-item"><span class="res-label">Boosted XP</span><span class="res-val" id="hunt-boosted" style="color:var(--primary)">0</span></div>
                        <div class="res-item"><span class="res-label">Needed</span><span class="res-val res-highlight" id="hunt-needed">0</span></div>
                        <div class="res-item"><span class="res-label">Time</span><span class="res-val" id="hunt-time">0h 0m</span></div>
                        
                        <div class="res-item" id="token-row" style="grid-column: span 2; border:none; margin-top:5px; display:none;">
                            <span class="res-label">Est. Refills:</span> 
                            <span class="res-val" id="hunt-tokens" style="color:var(--accent); float:right;">0</span>
                        </div>
                    </div>
                </div>

                <div id="panel-fishing" class="calc-panel">
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div class="input-mini" style="flex:1;">
                            <label>Avg Weight (kg)</label>
                            <input type="number" id="fish-weight" class="std-input" value="10" oninput="calc()">
                        </div>
                        <div class="input-mini" style="flex:1;">
                            <label>Tug Amount</label>
                            <input type="number" id="fish-amount" class="std-input" value="1" oninput="calc()">
                        </div>
                    </div>

                    <div class="result-grid" style="flex:0 auto; margin-bottom:10px;">
                        <div class="res-item"><span class="res-label">Pole XP</span><span class="res-val" id="fish-pole">0</span></div>
                        <div class="res-item"><span class="res-label">Tug XP</span><span class="res-val" id="fish-tug">0</span></div>
                        <div class="res-item"><span class="res-label">Pole Need</span><span class="res-val res-highlight" id="pole-needed">0</span></div>
                        <div class="res-item"><span class="res-label">Tug Need</span><span class="res-val res-highlight" id="tug-needed">0</span></div>
                    </div>

                    <div class="section-header" style="margin-top:5px;">Meat Exchange</div>
                    <div style="display:flex; gap:5px;">
                        <input type="number" id="meat-reg" class="std-input" placeholder="Reg Meat" oninput="calcMeat()">
                        <input type="number" id="meat-prem" class="std-input" placeholder="Prem Meat" oninput="calcMeat()">
                    </div>
                    <div style="text-align:right; margin-top:5px; font-weight:bold; color:var(--accent);" id="meat-result">0 XP</div>
                </div>

            </div>
        </div>

        <div class="support-footer">
            <div onclick="openExternal('https://www.paypal.com/paypalme/pinkiprim')" class="support-link">
                Support PinkiPrim <span class="heart">‚ù§</span>
            </div>
        </div>
    </div>

<script>
// --- CONFIG DATA ---
const ANIMALS = [
    {name: "Bobcat", xp: 5.0}, {name: "Brown Bear", xp: 10.0}, {name: "Leopard", xp: 8.0},
    {name: "Lion", xp: 6.5}, {name: "Wolf", xp: 5.0}, {name: "Skunk", xp: 0.5},
    {name: "Coyote", xp: 1.5}, {name: "Deer", xp: 2.0}, {name: "Cougar", xp: 2.5},
    {name: "Rabbit", xp: 1.5}, {name: "Rat", xp: 0.5}, {name: "Boar", xp: 1.5},
    {name: "Hammerhead Shark", xp: 15.0}, {name: "Tiger Shark", xp: 15.0},
    {name: "Stingray", xp: 15.0}, {name: "Humpback Whale", xp: 15.0},
    {name: "Killer Whale", xp: 15.0}, {name: "Dolphin", xp: 15.0},
    {name: "Fish", xp: 0.5}, {name: "Bird (Generic)", xp: 0.5}
];

// --- INIT ---
window.onload = function() {
    const sel = document.getElementById('animal-select');
    ANIMALS.sort((a,b) => a.name.localeCompare(b.name));
    ANIMALS.forEach(a => {
        let opt = document.createElement('option');
        opt.value = a.xp;
        opt.innerText = `${a.name} (${a.xp})`;
        sel.appendChild(opt);
    });
    
    // Position Restore
    const pos = JSON.parse(localStorage.getItem('tt_huntcalc_pos'));
    if(pos) {
        document.getElementById('app').style.left = pos.left + 'px';
        document.getElementById('app').style.top = pos.top + 'px';
    }

    // Attach listeners
    document.querySelectorAll('.boost-cb, .token-cb').forEach(cb => {
        cb.addEventListener('change', calc);
    });

    calc();
};

function openExternal(url) {
    try { window.invokeNative('openUrl', url); } catch(e) { window.open(url, '_blank'); }
}

// --- CORE CALCULATIONS ---
function getMultiplierAndTokens() {
    let base = 100; // 100% base
    
    // 1. Standard Boosts
    document.querySelectorAll('.boost-cb:checked').forEach(cb => {
        base += parseFloat(cb.value);
    });

    // 2. Perks
    let perks = parseInt(document.getElementById('perk-count').value) || 0;
    if (perks > 0) {
        base += 5; // First perk
        if (perks > 1) base += (perks - 1) * 2.5;
    }
    if(base > (100 + 50 + 100)) {} 

    // 3. Tokens (Stackable)
    let minDuration = Infinity;
    let tokensActive = false;

    document.querySelectorAll('.token-cb:checked').forEach(cb => {
        let xpVal = parseFloat(cb.dataset.xp);
        let mins = parseFloat(cb.dataset.mins);
        
        base += xpVal;
        tokensActive = true;
        if (mins < minDuration) minDuration = mins; // Find constraining token
    });

    let multiplier = base / 100;

    // 4. DXP Check (Doubles EVERYTHING)
    if (document.getElementById('dxp-check').checked) {
        multiplier *= 2;
    }

    return { 
        val: multiplier, 
        tokenDuration: tokensActive ? minDuration : 0 
    };
}

function calc() {
    let result = getMultiplierAndTokens();
    let mult = result.val;
    
    document.getElementById('disp-mult').innerText = mult.toFixed(2) + "x";

    let curXP = parseFloat(document.getElementById('current-xp').value) || 0;
    let tarXP = parseFloat(document.getElementById('target-xp').value) || 0;
    
    let remXP = Math.max(0, tarXP - curXP);
    document.getElementById('disp-remaining').innerText = remXP.toLocaleString();

    // --- HUNTING ---
    let baseAnimalXP = parseFloat(document.getElementById('animal-select').value) || 0;
    let boostedAnimalXP = baseAnimalXP * mult;
    
    document.getElementById('hunt-base').innerText = baseAnimalXP.toFixed(1);
    document.getElementById('hunt-boosted').innerText = boostedAnimalXP.toFixed(2);

    let animalsNeeded = remXP > 0 ? Math.ceil(remXP / boostedAnimalXP) : 0;
    document.getElementById('hunt-needed').innerText = animalsNeeded.toLocaleString();

    // Time & Tokens
    let rate = parseFloat(document.getElementById('hunt-rate').value) || 1;
    let hoursNeeded = animalsNeeded / rate;
    
    let h = Math.floor(hoursNeeded);
    let m = Math.round((hoursNeeded - h) * 60);
    document.getElementById('hunt-time').innerText = `${h}h ${m}m`;

    let tokenRow = document.getElementById('token-row');
    if (result.tokenDuration > 0 && hoursNeeded > 0) {
        tokenRow.style.display = 'flex';
        let totalMins = hoursNeeded * 60;
        let tokens = Math.ceil(totalMins / result.tokenDuration);
        document.getElementById('hunt-tokens').innerText = tokens + "x (" + result.tokenDuration + "m ea)";
    } else {
        tokenRow.style.display = 'none';
    }

    // --- FISHING ---
    let weight = parseFloat(document.getElementById('fish-weight').value) || 0;
    let amount = parseFloat(document.getElementById('fish-amount').value) || 1;

    // Pole: max(0.1, weight / 15)
    let poleBase = Math.max(0.1, weight / 15);
    let poleBoosted = poleBase * mult;
    
    // Tug: max(0.1, weight / 20) * amount
    let tugBase = Math.max(0.1, weight / 20) * amount;
    let tugBoosted = tugBase * mult;

    document.getElementById('fish-pole').innerText = poleBoosted.toFixed(2);
    document.getElementById('fish-tug').innerText = tugBoosted.toFixed(2);

    document.getElementById('pole-needed').innerText = remXP > 0 ? Math.ceil(remXP / poleBoosted).toLocaleString() : 0;
    document.getElementById('tug-needed').innerText = remXP > 0 ? Math.ceil(remXP / tugBoosted).toLocaleString() : 0;
}

// --- LEVEL MATH ---
// Formula: Total XP = 2.5 * L * (L+1)
function lvlToXp() {
    let lvl = parseInt(document.getElementById('target-lvl').value);
    if (isNaN(lvl)) return;
    let totalXP = 2.5 * lvl * (lvl + 1);
    document.getElementById('target-xp').value = totalXP;
    calc();
}

function calcMeat() {
    let reg = parseFloat(document.getElementById('meat-reg').value) || 0;
    let prem = parseFloat(document.getElementById('meat-prem').value) || 0;
    
    let xp = (reg / 200) + (prem / 100);
    document.getElementById('meat-result').innerText = xp.toFixed(2) + " XP";
}

// --- UI TABS ---
function switchMode(mode) {
    document.querySelectorAll('.calc-panel').forEach(p => p.classList.remove('active'));
    document.getElementById('panel-' + mode).classList.add('active');
    
    document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
    event.target.classList.add('active');
}

// --- NUI BRIDGE ---
function requestSync() {
    window.parent.postMessage({ type: "getData" }, "*");
}

window.addEventListener('message', (event) => {
    const data = event.data.type === 'data' ? event.data.data : event.data;
    if (data.exp_hunting_skill || data.exp_farming_fishing) {
        // ONLY UPDATE ON FETCH BUTTON CLICK via requestSync -> message loop
        let huntXP = data.exp_hunting_skill || 0;
        let fishXP = data.exp_farming_fishing || 0;
        
        // Use active tab to decide which XP to grabbing
        let isHunting = document.getElementById('panel-hunting').classList.contains('active');
        let newVal = isHunting ? huntXP : fishXP;
        
        // Update input
        document.getElementById('current-xp').value = newVal;
        calc();
    }
});

// --- DRAG LOGIC ---
const elm = document.getElementById("app");
const header = document.getElementById("drag-handle");
let isDragging = false, startX, startY, initLeft, initTop;

header.addEventListener("mousedown", (e) => {
    if(e.target.tagName === 'A') return;
    e.preventDefault(); isDragging = true;
    startX = e.clientX; startY = e.clientY;
    const r = elm.getBoundingClientRect();
    initLeft = r.left; initTop = r.top;
    window.addEventListener("mousemove", drag);
    window.addEventListener("mouseup", stopDrag);
});

function drag(e) {
    if (!isDragging) return;
    elm.style.left = (initLeft + e.clientX - startX) + "px";
    elm.style.top = (initTop + e.clientY - startY) + "px";
}

function stopDrag() {
    isDragging = false;
    window.removeEventListener("mousemove", drag);
    window.removeEventListener("mouseup", stopDrag);
    localStorage.setItem('tt_huntcalc_pos', JSON.stringify({ left: elm.offsetLeft, top: elm.offsetTop }));
}

</script>
</body>
</html>
