<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Paramedic Helper</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        /* --- THEME --- */
        :root {
            --primary: #e53935; /* EMS Red */
            --primary-dim: #b71c1c;
            --bg-glass: rgba(15, 15, 15, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(229, 57, 53, 0.3);
            --green: #00e676;
            --alert: #ff9100;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* --- CONTAINER --- */
        #tracker-app {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            min-height: 250px;
        }

        header {
            background: linear-gradient(90deg, var(--primary-dim), var(--primary));
            padding: 8px 12px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1em;
        }

        #content {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .section {
            margin-bottom: 10px; padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .section:last-child { border-bottom: none; }

        .label {
            font-size: 0.7em; color: var(--text-dim);
            text-transform: uppercase; margin-bottom: 2px;
        }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }

        .progress-container {
            position: relative; height: 16px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px; margin: 5px 0 5px 0;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
        }
        .progress-bar {
            height: 100%; background: var(--primary);
            width: 0%; transition: width 0.3s ease;
        }
        .progress-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7em; text-shadow: 1px 1px 2px black;
            font-weight: bold; z-index: 2;
        }

        .xp-remaining-text {
            text-align: center;
            font-size: 0.8em;
            color: var(--text-dim);
            margin-bottom: 10px;
        }
        .xp-remaining-text b { color: var(--primary); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .stat-box {
            background: rgba(255,255,255,0.05); padding: 6px;
            border-radius: 4px; text-align: center;
        }

        /* INFO ROW */
        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 6px 8px;
            margin-bottom: 4px; border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .info-row:hover { background: rgba(255,255,255,0.15); }
        .info-text { font-family: 'Rajdhani', sans-serif; font-weight: 600; color: #fff; }

        .inv-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 4px 8px;
            margin-bottom: 4px; border-radius: 4px;
            border-left: 3px solid var(--text-dim);
        }
        .inv-name { font-size: 0.8em; }
        .inv-stats { font-size: 0.8em; font-weight: bold; text-align: right; }
        .low-stock { border-left-color: var(--alert); }

        input[type="number"] {
            width: 90%; background: rgba(0,0,0,0.3);
            border: 1px solid #444; color: white; padding: 5px;
            border-radius: 4px; margin-top: 5px; font-family: inherit;
        }
        input:focus { outline: 1px solid var(--primary); }
        .calc-output {
            margin-top: 5px; font-size: 0.8em; line-height: 1.3;
            color: var(--text-dim); word-wrap: break-word;
        }
        
        #settings-panel, #job-list, #summary-table { display: none !important; }
    </style>
</head>
<body>

<div id="tracker-app">
    <header id="drag-handle">
        <span>üöë EMS Ops</span>
        <span id="clock" style="font-size:0.8em">00:00</span>
    </header>

    <div id="content">
        
        <div class="section">
            <div class="label" style="display:flex; justify-content:space-between;">
                <span>Current Status</span>
                <span style="font-size:0.8em; opacity:0.6;">(Click to Edit)</span>
            </div>
            
            <div class="info-row" id="btn-region">
                <div style="font-size:0.8em; color:#aaa;">üìç Region</div>
                <div class="info-text" id="disp-region">Select Region...</div>
            </div>

            <div class="info-row" id="btn-vehicle">
                <div style="font-size:0.8em; color:#aaa;">üöë Vehicle</div>
                <div class="info-text" id="disp-vehicle">Set Vehicle...</div>
            </div>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div>
                    <div class="label">Paramedic Level</div>
                    <div class="value highlight" style="font-size:1.6em" id="disp-level">...</div>
                </div>
                <div style="text-align:right;">
                    <div class="label">Current XP</div>
                    <div class="value" id="disp-xp" style="font-size:0.9em">0</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>
            
            <div class="xp-remaining-text" id="disp-xp-remaining">
                Waiting for data...
            </div>

            <div class="stat-grid">
                <div class="stat-box">
                    <div class="label">BXP Tokens</div>
                    <div class="value bxp" id="disp-bxp">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Revives/Heals</div>
                    <div class="value" id="disp-callouts">0</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="label">Inventory</div>
            <div class="inv-row" id="row-defib">
                <div class="inv-name">‚ö° Defib Kit</div>
                <div class="inv-stats">
                    Stock: <span id="stock-defib">--</span>
                </div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Target Calculator</div>
            <div style="font-size:0.7em; color:#888;">Enter <b>Target XP</b> (e.g. 100,000):</div>
            <input type="number" id="target-input" placeholder="e.g. 100000">
            <div class="calc-output" id="calc-result">
                Start working to enable calculator...
            </div>
        </div>

    </div>
    <div id="resize-handle" style="position:absolute; bottom:0; right:0; width:15px; height:15px; cursor:nwse-resize;"></div>
</div>

<div id="settings-icon" style="display:none;"></div>
<div id="settings-panel" style="display:none;">
    <input type="checkbox" id="toggle-bxp"><input type="checkbox" id="toggle-current-level">
    <input type="checkbox" id="toggle-exp-hr"><input type="checkbox" id="toggle-exp-min">
    <input type="checkbox" id="toggle-perk-chance"><input type="checkbox" id="toggle-1m-percent">
    <input type="checkbox" id="toggle-10m-percent"><input type="checkbox" id="toggle-level">
    <input type="number" id="xp-font-size">
    <button id="reset-exp-log"></button>
    <div id="xp-font-size-value"></div>
</div>
<div id="job-list" style="display:none;"></div>
<table id="summary-table" style="display:none;"><thead id="summary-thead"></thead><tbody id="summary-tbody"></tbody></table>

<script>
// --- CLOCK ---
function updateClock() {
    const now = new Date();
    const el = document.getElementById('clock');
    if(el) el.innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
}
setInterval(updateClock, 1000);
updateClock();

// --- MANUAL INTERACTION LOGIC ---
const REGIONS = [
    "West Vinewood",
    "East Vinewood",
    "Central Los Santos",
    "Palomino Highlands",
    "Blaine County",
    "Zancudo",
    "Paleto Bay",
    "Roxwood"
];
let regionIndex = 0;

document.getElementById('btn-region').addEventListener('click', () => {
    document.getElementById('disp-region').innerText = REGIONS[regionIndex];
    regionIndex = (regionIndex + 1) % REGIONS.length;
});

document.getElementById('btn-vehicle').addEventListener('click', () => {
    const current = document.getElementById('disp-vehicle').innerText;
    if (current === "On Foot") {
        document.getElementById('disp-vehicle').innerText = "Ambulance";
    } else if (current === "Ambulance") {
        document.getElementById('disp-vehicle').innerText = "Helicopter";
    } else {
        document.getElementById('disp-vehicle').innerText = "On Foot";
    }
});

// --- YOUR PROVIDED SCRIPT ---

let lastInventoryObj = {};
let selectedJobs = [];
let expLogs = {};
let lastBXPs = {};
let initialExps = {};
let lastExps = {};
let hasFirstGain = {};
let lastUpdateTime = {};
let lastDisplayedExps = {};
let lastRenderTime = 0;
let hasReceivedAnyData = false;
let hasRequestedOnce = false;

const TRACKER_SIZE_KEY = "tracker-app-size";
const TRACKER_POSITION_KEY = "tracker-app-position";
const XP_FONT_SIZE_KEY = "xp-font-size";
const RECENT_WINDOW_MS = 10 * 60 * 1000;
const RENDER_THROTTLE_MS = 500;

const JOBS = [
  { key: "trucker", label: "Trucker" },
  { key: "mechanic", label: "Mechanic" },
  { key: "garbage", label: "Garbage" },
  { key: "postop", label: "PostOP" },
  { key: "pilot", label: "Airline Pilot" },
  { key: "helicopterpilot", label: "Helicopter Pilot" },
  { key: "cargopilot", label: "Cargo Pilot" },
  { key: "busdriver", label: "Bus Driver" },
  { key: "conductor", label: "Train Conductor" },
  { key: "emergency", label: "EMS" },
  { key: "player", label: "Player" },
  { key: "firefighter", label: "Firefighter" },
  { key: "racer", label: "Racer" },
  { key: "farmer", label: "Farmer" },
  { key: "fisher", label: "Fisher" },
  { key: "strength", label: "Strength" },
  { key: "miner", label: "Miner" },
  { key: "business", label: "Business" },
  { key: "hunter", label: "Hunter" }
];

const JOB_EXP_KEYS = {
  trucker: "exp_trucking_trucking",
  mechanic: "exp_trucking_mechanic",
  garbage: "exp_trucking_garbage",
  postop: "exp_trucking_postop",
  pilot: "exp_piloting_piloting",
  helicopterpilot: "exp_piloting_heli",
  cargopilot: "exp_piloting_cargos",
  busdriver: "exp_train_bus",
  conductor: "exp_train_train",
  emergency: "exp_ems_ems",
  firefighter: "exp_ems_fire",
  racer: "exp_player_racing",
  farmer: "exp_farming_farming",
  fisher: "exp_farming_fishing",
  miner: "exp_farming_mining",
  business: "exp_business_business",
  hunter: "exp_hunting_skill",
  player: "exp_player_player",
  strength: "exp_physical_strength"
};

const JOB_BXP_KEYS = {
  trucker:       "exp_token_a|trucking|trucking",
  mechanic:      "exp_token_a|trucking|mechanic",
  garbage:       "exp_token_a|trucking|garbage",
  postop:        "exp_token_a|trucking|postop",
  pilot:         "exp_token_a|piloting|piloting",
  helicopterpilot:"exp_token_a|piloting|heli",
  cargopilot:    "exp_token_a|piloting|cargos",
  busdriver:     "exp_token_a|train|bus",
  conductor:     "exp_token_a|train|train",
  emergency:     "exp_token_a|ems|ems",
  firefighter:   "exp_token_a|ems|fire",
  racer:         "exp_token_a|player|racing",
  farmer:        "exp_token_a|farming|farming",
  fisher:        "exp_token_a|farming|fishing",
  miner:         "exp_token_a|farming|mining",
  business:      "exp_token_a|business|business",
  hunter:        "exp_token_a|hunting|skill",
  player:        "exp_token_a|player|player",
  strength:      "exp_token_a|physical|strength"
};

function formatNumber(num) {
  if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
  if (num >= 1000) return (num / 1000).toFixed(1) + "K";
  return num.toLocaleString();
}

function getAllRequiredKeys() {
  const expKeys = Object.values(JOB_EXP_KEYS);
  const bxpKeys = Object.values(JOB_BXP_KEYS);
  const inventoryKey = ["inventory", "exp_paramedic"];
  return [...expKeys, ...bxpKeys, ...inventoryKey];
}

function getLevelInfo(exp) {
  let level = 0;
  let xpCap = 5;
  while (exp >= xpCap) {
    exp -= xpCap;
    level++;
    xpCap = (level + 1) * 5;
  }
  return { level, expInLevel: exp, expForNext: xpCap };
}

function getSortedJobs() {
  return [...JOBS].sort((a, b) => a.label.localeCompare(b.label));
}

function getPercentValue(exp, cap) {
  if (typeof exp !== "number") return null;
  const pct = Math.max(0, Math.min(100, (exp / cap) * 100));
  return +pct.toFixed(1);
}

function get1MPercentValue(jobKey) {
  const exp = lastExps[jobKey];
  return getPercentValue(exp, 1_000_000);
}

function get10MPercentValue(jobKey) {
  const exp = lastExps[jobKey];
  return getPercentValue(exp, 10_000_000);
}

function saveData() {
  localStorage.setItem("selected-jobs", JSON.stringify(selectedJobs));
  localStorage.setItem("exp-logs", JSON.stringify(expLogs));
}

function loadData() {
  selectedJobs = JSON.parse(localStorage.getItem("selected-jobs") || "[]");
  if (selectedJobs.length === 0) {
    selectedJobs = ["emergency"]; // FORCE EMS DEFAULT
    localStorage.setItem("selected-jobs", JSON.stringify(selectedJobs));
  }
  expLogs = JSON.parse(localStorage.getItem("exp-logs") || "{}");
  loadSettings();
  loadFontSize();
  renderSummary();
}

function resetAllData() {
  Object.keys(expLogs).forEach(key => delete expLogs[key]);
  Object.keys(initialExps).forEach(key => delete initialExps[key]);
  Object.keys(hasFirstGain).forEach(key => delete hasFirstGain[key]);
  Object.keys(lastUpdateTime).forEach(key => delete lastUpdateTime[key]);
  selectedJobs.forEach(jobKey => {
    const exp = lastExps[jobKey];
    if (typeof exp === "number") {
      expLogs[jobKey] = [];
      initialExps[jobKey] = exp;
      hasFirstGain[jobKey] = false;
    }
  });
  
  // RESET BRIDGE VARS
  emsSessionRevives = 0;
  emsLastXP = 0;
  
  saveData();
  renderStats();
}

function saveSettings() {
  try {
    const settings = {
      bxp: document.getElementById("toggle-bxp").checked,
      currentLevel: document.getElementById("toggle-current-level").checked,
      expHr: document.getElementById("toggle-exp-hr").checked,
      expMin: document.getElementById("toggle-exp-min").checked,
      perkChance: document.getElementById("toggle-perk-chance").checked,
      oneMPercent: document.getElementById("toggle-1m-percent").checked,
      tenMPercent: document.getElementById("toggle-10m-percent").checked,
      level: document.getElementById("toggle-level").checked
    };
    localStorage.setItem("tracker-settings", JSON.stringify(settings));
  } catch (error) {}
}

function loadSettings() {
  try {
    const savedSettings = localStorage.getItem("tracker-settings");
    const settings = savedSettings ? JSON.parse(savedSettings) : {};
    document.getElementById("toggle-bxp").checked = settings.bxp !== false;
    document.getElementById("toggle-current-level").checked = settings.currentLevel !== false;
    document.getElementById("toggle-exp-hr").checked = settings.expHr !== false;
    document.getElementById("toggle-exp-min").checked = settings.expMin !== false;
    document.getElementById("toggle-perk-chance").checked = settings.perkChance !== false;
    document.getElementById("toggle-1m-percent").checked = settings.oneMPercent === true;
    document.getElementById("toggle-10m-percent").checked = settings.tenMPercent === true;
    document.getElementById("toggle-level").checked = settings.level !== false;
  } catch (error) {}
}

function getSettings() {
  return {
    bxp: document.getElementById("toggle-bxp").checked,
    currentLevel: document.getElementById("toggle-current-level").checked,
    expHr: document.getElementById("toggle-exp-hr").checked,
    expMin: document.getElementById("toggle-exp-min").checked,
    perkChance: document.getElementById("toggle-perk-chance").checked,
    oneMPercent: document.getElementById("toggle-1m-percent").checked,
    tenMPercent: document.getElementById("toggle-10m-percent").checked,
    level: document.getElementById("toggle-level").checked
  };
}

function applySettingsPosition(position) {} 

function loadFontSize() {
  const size = localStorage.getItem(XP_FONT_SIZE_KEY) || "12";
  document.getElementById("xp-font-size").value = size;
  applyFontSize(size);
}

function saveFontSize(size) {
  localStorage.setItem(XP_FONT_SIZE_KEY, size);
  applyFontSize(size);
}

function applyFontSize(size) {
  document.documentElement.style.setProperty('--stat-font-size', size + 'px');
}

function savePosition() {
  const app = document.getElementById("tracker-app");
  if (app) {
    const position = {
      left: app.style.left,
      top: app.style.top,
      width: app.style.width,
      height: app.style.height
    };
    localStorage.setItem(TRACKER_POSITION_KEY, JSON.stringify(position));
  }
}

function adjustSettingsPosition() {} 

function loadPosition() {
  const savedPosition = localStorage.getItem(TRACKER_POSITION_KEY);
  if (savedPosition) {
    try {
      const position = JSON.parse(savedPosition);
      const app = document.getElementById("tracker-app");
      if (app && position) {
        if (position.left) app.style.left = position.left;
        if (position.top) app.style.top = position.top;
        if (position.width) app.style.width = position.width;
        if (position.height) app.style.height = position.height;
      }
    } catch (e) {}
  }
}

function renderStats() {
  const now = Date.now();
  if (now - lastRenderTime < RENDER_THROTTLE_MS) {
    return;
  }
  lastRenderTime = now;
  renderSummary();
  // INTEGRATION: UPDATE HUD
  updateEMSHUD(); 
}

function renderSummary() {} // Stubbed out - we use HUD instead

function calculateJobStats(jobKey) {
  const currentExp = lastExps[jobKey] || 0;
  const bxp = lastBXPs[jobKey] || 0;
  const log = expLogs[jobKey] || [];
  let expPerHour = 0;
  let expPerMin = 0;
  if (log.length >= 2) {
    const recent = log.filter(entry => Date.now() - entry.time <= RECENT_WINDOW_MS);
    if (recent.length >= 2) {
      const firstEntry = recent[0];
      const lastEntry = recent[recent.length - 1];
      const timeDiff = lastEntry.time - firstEntry.time;
      const expDiff = lastEntry.exp - firstEntry.exp;
      if (timeDiff > 0) {
        expPerHour = Math.round((expDiff / timeDiff) * (1000 * 60 * 60));
        expPerMin = Math.round(expPerHour / 60);
      }
    }
  }
  return {
    currentExp,
    bxp,
    expPerHour,
    expPerMin,
    levelInfo: getLevelInfo(currentExp)
  };
}

function backfillExpLogIfMissing(jobKey) {
  if (typeof lastExps[jobKey] === "number" && (!Array.isArray(expLogs[jobKey]) || expLogs[jobKey].length < 2)) {
    const exp = lastExps[jobKey];
    const now = Date.now();
    expLogs[jobKey] = [
      { time: now - 5000, exp },
      { time: now, exp }
    ];
    initialExps[jobKey] = exp;
    hasFirstGain[jobKey] = true;
  }
}

function setupUIHandlers() {
  // Minimized to prevent errors
}

function renderJobPills() {}

function toggleJob(jobKey) {}

window.toggleJob = toggleJob;

function processGameData(data) {
  const now = Date.now();
  let inventory = {};
  
  if (data.inventory) {
    try {
      inventory = typeof data.inventory === "string" ? JSON.parse(data.inventory) : data.inventory;
      if (inventory) {
          lastInventoryObj = inventory;
          processInventory(inventory); // EMS Inventory Logic
      }
    } catch {
      inventory = lastInventoryObj;
    }
  } else {
    inventory = lastInventoryObj;
  }
  
  // FALLBACK XP Check
  if (data.exp_paramedic && !data[JOB_EXP_KEYS.emergency]) {
      data[JOB_EXP_KEYS.emergency] = data.exp_paramedic;
  }

  JOBS.forEach(job => {
    const expKey = JOB_EXP_KEYS[job.key];
    const exp = data[expKey];
    if (typeof exp === "number") {
      lastExps[job.key] = exp;
    }
  });
  
  selectedJobs.forEach(jobKey => {
    const job = JOBS.find(j => j.key === jobKey);
    if (!job) return;
    
    const expKey = JOB_EXP_KEYS[jobKey];
    const exp = data[expKey];
    
    if (typeof exp === "number") {
      if (!expLogs[jobKey]) expLogs[jobKey] = [];
      const log = expLogs[jobKey];
      
      if (!hasFirstGain[jobKey]) {
        if (typeof initialExps[jobKey] !== "number") {
          initialExps[jobKey] = exp;
        }
      }
      if (!hasFirstGain[jobKey] && exp !== initialExps[jobKey]) {
        hasFirstGain[jobKey] = true;
        if (typeof initialExps[jobKey] !== "number" || initialExps[jobKey] === 0) {
          initialExps[jobKey] = exp - (exp - (log[log.length - 1]?.exp || 0));
        }
      }
      
      const lastEntry = log[log.length - 1];
      if (lastEntry === undefined) {
        lastUpdateTime[jobKey] = now;
      } else if (exp > lastEntry.exp) {
        log.push({ time: now, exp });
        lastUpdateTime[jobKey] = now;
        const lastDisplayed = lastDisplayedExps[jobKey] || 0;
        if (exp > lastDisplayed) {
          lastDisplayedExps[jobKey] = exp;
        }
      }
      if (log.length === 0 && hasFirstGain[jobKey]) {
        log.push({ time: now - 5000, exp: initialExps[jobKey] });
        log.push({ time: now, exp });
        lastUpdateTime[jobKey] = now;
      }
      if (log.length > 2) {
        const recentCutoff = now - RECENT_WINDOW_MS;
        expLogs[jobKey] = log.filter((entry, idx) => {
          return idx === 0 || entry.time >= recentCutoff;
        });
      }
    }
    
    const bxpToken = JOB_BXP_KEYS[jobKey];
    let bxpObj;
    if (bxpToken && data[bxpToken]) {
      bxpObj = data[bxpToken];
    }
    else if (bxpToken && inventory && typeof inventory === 'object') {
      bxpObj = inventory[bxpToken];
      if (!bxpObj) {
        const fallbackKey = Object.keys(inventory).find(k => k.startsWith(bxpToken));
        if (fallbackKey) bxpObj = inventory[fallbackKey];
      }
    }
    if (bxpObj && typeof bxpObj.amount === "number") {
      lastBXPs[jobKey] = bxpObj.amount;
    } else if (typeof bxpObj === "number") {
      lastBXPs[jobKey] = bxpObj;
    } else {
      delete lastBXPs[jobKey];
    }
  });
  saveData();
  renderStats();
}

function requestDataOnce(force = false) {
  if (hasRequestedOnce && !force) return;
  hasRequestedOnce = true;
  try {
    const keys = getAllRequiredKeys();
    window.parent.postMessage({ 
      type: "getNamedData",
      keys: keys
    }, "*");
  } catch (e) {
    window.parent.postMessage({ type: "getData" }, "*");
  }
}

function init() {
  loadData();
  loadPosition();
  renderStats();
  
  // Set fast polling
  setInterval(requestDataOnce, 1000); 
  
  saveSettings();
  
  window.addEventListener("message", (event) => {
    const msg = event.data;
    if (msg && msg.type === "data" && msg.data) {
      hasReceivedAnyData = true;         
      processGameData(msg.data);
    }
  });

  requestDataOnce();
  setTimeout(() => { if (!hasReceivedAnyData) requestDataOnce(true); }, 1200);
}

if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}

// --- DRAG HANDLER ---
(() => {
  const app = document.getElementById('tracker-app');
  const handle = document.getElementById('drag-handle');
  const rh = document.getElementById('resize-handle');
  if (!app || !handle) return;
  
  let sx=0, sy=0, ax=0, ay=0, dragging=false;
  let sw=0, sh=0, resizing=false;

  function startDrag(clientX, clientY, e) {
    if (e && e.target.closest('button')) return;
    if (e) { e.preventDefault(); e.stopPropagation(); }
    dragging = true; sx = clientX; sy = clientY;
    const rect = app.getBoundingClientRect(); ax = rect.left; ay = rect.top;
    handle.classList.add('dragging');
  }

  handle.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY, e));

  if (rh) {
    function startResize(clientX, clientY, e) {
      if (e) { e.preventDefault(); e.stopPropagation(); }
      resizing = true; sx = clientX; sy = clientY;
      const rect = app.getBoundingClientRect(); sw = rect.width; sh = rect.height;
    }
    rh.addEventListener('mousedown', (e) => startResize(e.clientX, e.clientY, e));
  }

  function handleMove(clientX, clientY, e) {
    if (dragging) {
      if (e) e.preventDefault();
      const dx = clientX - sx, dy = clientY - sy;
      app.style.transform = `translate(${dx}px, ${dy}px)`;
    } else if (resizing) {
      if (e) e.preventDefault();
      const dx = clientX - sx, dy = clientY - sy;
      app.style.width  = `${Math.max(280, sw + dx)}px`;
      app.style.height = `${Math.max(120, sh + dy)}px`;
    }
  }
  
  window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY, e));

  function endDrag() {
    if (dragging) {
      const transform = app.style.transform;
      const match = transform.match(/translate\(([-\d.]+)px, ([-\d.]+)px\)/);
      if (match) {
        const dx = parseFloat(match[1]) || 0;
        const dy = parseFloat(match[2]) || 0;
        app.style.transform = '';
        app.style.left = `${ax + dx}px`;
        app.style.top = `${ay + dy}px`;
      }
      savePosition();
    }
    dragging = false; resizing = false;
    handle.classList.remove('dragging');
  }
  window.addEventListener('mouseup', endDrag);
})();

// --- EMS SPECIFIC BRIDGE LOGIC ---

function processInventory(inv) {
    const invArray = Object.entries(inv).map(([id, data]) => {
        let qty = 0;
        if (typeof data === 'number') qty = data;
        else if (typeof data === 'object') qty = data.amount || data.count || 0;
        return { id: id.toLowerCase(), qty: qty };
    });
    const matches = invArray.filter(i => i.id.includes('defib'));
    const defibCount = matches.reduce((sum, item) => sum + item.qty, 0);
    const el = document.getElementById('stock-defib');
    if(el) {
        el.innerText = defibCount;
        el.style.color = defibCount < 2 ? "var(--alert)" : "white";
    }
}

// BRIDGE STATE
let emsLastXP = 0;
let emsSessionRevives = 0;
let emsAvgXP = 0;

function updateEMSHUD() {
    const stats = calculateJobStats('emergency');
    
    // XP & Level
    document.getElementById('disp-xp').innerText = formatNumber(stats.currentExp);
    document.getElementById('disp-level').innerText = stats.levelInfo.level;
    document.getElementById('level-bar').style.width = getPercentValue(stats.levelInfo.expInLevel, stats.levelInfo.expForNext) + "%";
    document.getElementById('level-text').innerText = getPercentValue(stats.levelInfo.expInLevel, stats.levelInfo.expForNext) + "%";
    
    // NEW: XP to next level
    const xpNeeded = Math.round(stats.levelInfo.expForNext - stats.levelInfo.expInLevel);
    document.getElementById('disp-xp-remaining').innerHTML = `<b>${formatNumber(xpNeeded)}</b> XP to Next Level`;

    // BXP
    if(stats.bxp > 0) document.getElementById('disp-bxp').innerText = formatNumber(stats.bxp);
    
    // REVIVE DETECTION LOGIC
    if (emsLastXP === 0 && stats.currentExp > 0) emsLastXP = stats.currentExp; // Init
    
    if (stats.currentExp > emsLastXP) {
        const delta = stats.currentExp - emsLastXP;
        // Assume anything > 50 XP is likely an active job action/revive
        if (delta > 50) {
            emsSessionRevives++;
            // Calculate Average for Calculator
            const sessionGain = stats.currentExp - initialExps['emergency'];
            emsAvgXP = sessionGain / emsSessionRevives;
        }
        emsLastXP = stats.currentExp;
    }
    
    document.getElementById('disp-callouts').innerText = emsSessionRevives;
    
    runCalculator(stats.expPerMin); 
}

// --- CALCULATOR ---
const calcInput = document.getElementById('target-input');
let currentAvgTime = 0;

if(calcInput) {
    calcInput.addEventListener('input', () => runCalculator(currentAvgTime));
}

function runCalculator(avgTime) {
    if(avgTime) currentAvgTime = avgTime;
    const val = document.getElementById('target-input').value;
    const el = document.getElementById('calc-result');
    
    if (currentAvgTime === 0 && emsSessionRevives === 0) {
        el.innerHTML = "<i>Work to enable calc...</i>";
        return;
    }
    if (!val) {
        el.innerText = "Enter target above.";
        return;
    }

    let inputVal = parseInt(val.replace(/,/g, ''));
    let targetXP = inputVal;
    
    // Level detect
    const currentExp = lastExps['emergency'] || 0;
    if (inputVal < 200) { 
         let lvlXP = getXPFromLevel(inputVal);
         if (lvlXP > currentExp) targetXP = lvlXP;
    }

    if (targetXP > currentExp) {
        const diff = targetXP - currentExp;
        const mins = Math.ceil(diff / currentAvgTime);
        
        let output = `Remaining: <b>${formatNumber(diff)} XP</b><br>`;
        output += `<span style="color:var(--primary)">Est. Time: <b>${mins} mins</b></span>`;
        
        // Add Revives Calculation if we have an average
        if (emsAvgXP > 0) {
            const revives = Math.ceil(diff / emsAvgXP);
            output += `<br><span style="color:#ffffff; font-size:0.9em;">Est. Revives: <b>${revives}</b></span>`;
        } else {
            // Default Fallback (Assume ~250 XP per revive if no data yet)
            const approx = Math.ceil(diff / 250);
            output += `<br><span style="color:#999; font-size:0.8em;">(Approx ~${approx} revives)</span>`;
        }
        
        el.innerHTML = output;
    } else {
        el.innerHTML = `Target reached.`;
    }
}

</script>
</body>
</html>
