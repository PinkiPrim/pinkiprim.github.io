<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Paramedic Helper</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        /* --- THEME --- */
        :root {
            --primary: #e53935; /* EMS Red */
            --primary-dim: #b71c1c;
            --bg-glass: rgba(15, 15, 15, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(229, 57, 53, 0.3);
            --green: #00e676;
            --alert: #ff9100;
        }

        /* EXACT WORKING BODY CSS */
        body {
            margin: 0;
            padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh;
            width: 100vw;
            user-select: none;
        }

        /* --- CONTAINER --- */
        #app-container {
            position: absolute;
            top: 50px;
            left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            resize: both;
            overflow: hidden;
            min-height: 250px;
        }

        header {
            background: linear-gradient(90deg, var(--primary-dim), var(--primary));
            padding: 8px 12px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 1.1em;
        }

        #content {
            padding: 12px;
            flex: 1;
            overflow-y: auto;
            scrollbar-width: thin;
        }

        .section {
            margin-bottom: 10px; padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .section:last-child { border-bottom: none; }

        .label {
            font-size: 0.7em; color: var(--text-dim);
            text-transform: uppercase; margin-bottom: 2px;
        }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }

        .progress-container {
            position: relative; height: 16px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px; margin: 5px 0 10px 0;
            overflow: hidden; border: 1px solid rgba(255,255,255,0.1);
        }
        .progress-bar {
            height: 100%; background: var(--primary);
            width: 0%; transition: width 0.3s ease;
        }
        .progress-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.7em; text-shadow: 1px 1px 2px black;
            font-weight: bold; z-index: 2;
        }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .stat-box {
            background: rgba(255,255,255,0.05); padding: 6px;
            border-radius: 4px; text-align: center;
        }

        /* INFO ROW */
        .info-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.05); padding: 6px 8px;
            margin-bottom: 4px; border-radius: 4px;
        }
        .info-text { font-family: 'Rajdhani', sans-serif; font-weight: 600; color: #fff; }

        .inv-row {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0,0,0,0.3); padding: 4px 8px;
            margin-bottom: 4px; border-radius: 4px;
            border-left: 3px solid var(--text-dim);
        }
        .inv-name { font-size: 0.8em; }
        .inv-stats { font-size: 0.8em; font-weight: bold; text-align: right; }
        .low-stock { border-left-color: var(--alert); }

        input[type="number"] {
            width: 90%; background: rgba(0,0,0,0.3);
            border: 1px solid #444; color: white; padding: 5px;
            border-radius: 4px; margin-top: 5px; font-family: inherit;
        }
        input:focus { outline: 1px solid var(--primary); }
        .calc-output {
            margin-top: 5px; font-size: 0.8em; line-height: 1.3;
            color: var(--text-dim); word-wrap: break-word;
        }
    </style>
</head>
<body>

<div id="app-container">
    <header id="drag-handle">
        <span>üöë EMS Ops</span>
        <span id="clock" style="font-size:0.8em">00:00</span>
    </header>

    <div id="content">
        
        <div class="section">
            <div class="label">Current Status</div>
            
            <div class="info-row">
                <div style="font-size:0.8em; color:#aaa;">üìç Region</div>
                <div class="info-text" id="disp-region">Searching...</div>
            </div>

            <div class="info-row">
                <div style="font-size:0.8em; color:#aaa;">üöë Vehicle</div>
                <div class="info-text" id="disp-vehicle">On Foot</div>
            </div>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div>
                    <div class="label">Paramedic Level</div>
                    <div class="value highlight" style="font-size:1.6em" id="disp-level">...</div>
                </div>
                <div style="text-align:right;">
                    <div class="label">Current XP</div>
                    <div class="value" id="disp-xp" style="font-size:0.9em">0</div>
                </div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>

            <div class="stat-grid">
                <div class="stat-box">
                    <div class="label">BXP Tokens</div>
                    <div class="value bxp" id="disp-bxp">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Revives/Heals</div>
                    <div class="value" id="disp-callouts">0</div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="label">Inventory</div>
            <div class="inv-row" id="row-defib">
                <div class="inv-name">‚ö° Defib Kit</div>
                <div class="inv-stats">
                    Stock: <span id="stock-defib">--</span>
                </div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Target Calculator</div>
            <div style="font-size:0.7em; color:#888;">Enter <b>Target XP</b> (e.g. 100,000):</div>
            <input type="number" id="target-input" placeholder="e.g. 100000">
            <div class="calc-output" id="calc-result">
                Start working to enable calculator...
            </div>
        </div>

    </div>
</div>

<script>
    // --- KEYS TO FETCH ---
    // We request multiple keys to ensure we catch the right data
    const DATA_REQUEST = [
        "exp_ems_paramedic", 
        "exp_paramedic",
        "exp_token_a|ems|paramedic",
        "inventory",
        "job_location",
        "job_name", 
        "job_grade_label",
        "vehicle_label",
        "vehicle_name"
    ];

    // MAPPING
    const REGION_MAP = {
        "Mount Zonah": "West Vinewood",
        "Pillbox Hill": "East Vinewood",
        "Central Los Santos": "Central Los Santos",
        "St. Fiarce": "Palomino Highlands",
        "Sandy Shores": "Blaine County",
        "Fort Zancudo": "Zancudo",
        "Paleto Bay": "Paleto Bay",
        "Sorrow Health": "Roxwood",
        "Woolward": "Roxwood"
    };

    const STATE = {
        currentXP: 0,
        currentBXP: 0,
        startXP: null,
        callouts: 0, 
        avgXP: 0
    };

    function getLevelFromXP(xp) {
        return Math.floor((Math.sqrt(1 + 8 * xp / 5) - 1) / 2);
    }
    function getXPFromLevel(level) {
        return Math.floor((5 * level * (level + 1)) / 2);
    }
    function formatNum(n) {
        return Math.floor(n).toLocaleString("en-US");
    }

    function requestData() {
        if(window.parent) {
            try {
                window.parent.postMessage({ 
                    type: "getNamedData",
                    keys: DATA_REQUEST
                }, "*");
            } catch(e) {}
        }
    }
    
    requestData();
    setInterval(requestData, 1000);

    window.addEventListener('message', (event) => {
        let payload = event.data;
        if (payload && payload.type === 'data' && payload.data) {
            payload = payload.data;
        }
        if (!payload) return;

        // --- 1. XP (Try primary, then fallback) ---
        let xp = payload.exp_ems_paramedic;
        if (xp === undefined) xp = payload.exp_paramedic;
        
        if (typeof xp === 'number') {
            updateXP(xp);
        }

        // --- 2. BXP ---
        if (payload["exp_token_a|ems|paramedic"]) {
            updateBXP(payload["exp_token_a|ems|paramedic"]);
        }

        // --- 3. VEHICLE (Try Label, then Name) ---
        let veh = payload.vehicle_label;
        if (!veh) veh = payload.vehicle_name;
        
        if (veh) {
            document.getElementById('disp-vehicle').innerText = veh;
        } else {
            // Only reset if we are sure we are getting data but no vehicle
            // But usually safe to leave as is or set 'On Foot'
        }

        // --- 4. REGION / STATION ---
        // Try to find the Station Name first
        let loc = payload.job_location || payload.job_name || payload.job_grade_label;
        if (loc) updateRegion(loc);

        // --- 5. INVENTORY ---
        if (payload.inventory) {
            try {
                const inv = typeof payload.inventory === 'string' ? JSON.parse(payload.inventory) : payload.inventory;
                processInventory(inv);
            } catch(e){}
        }
    });

    function updateRegion(stationName) {
        let region = "Unknown";
        
        // 1. Try Map Matching
        for (const [key, val] of Object.entries(REGION_MAP)) {
            if (stationName.includes(key)) {
                region = val;
                break;
            }
        }
        // 2. Fallback: If map failed, show raw name (maybe they are already in "Region" mode)
        if (region === "Unknown" && stationName.length > 2) {
            region = stationName; 
        }
        
        if (region !== "Unknown") {
            document.getElementById('disp-region').innerText = region;
        }
    }

    function processInventory(inv) {
        if (!inv) return;
        if (inv["exp_token_a|ems|paramedic"]) updateBXP(inv["exp_token_a|ems|paramedic"]);

        // Summation Logic for Defibs
        const invArray = Object.entries(inv).map(([id, data]) => {
            let qty = 0;
            if (typeof data === 'number') qty = data;
            else if (typeof data === 'object') {
                qty = data.amount || data.count || data.qty || 0;
            }
            return { id: id.toLowerCase(), qty: qty };
        });

        const matches = invArray.filter(i => i.id.includes('defib'));
        const defibCount = matches.reduce((sum, item) => sum + item.qty, 0);

        const el = document.getElementById('stock-defib');
        el.innerText = defibCount;
        
        if (defibCount < 2) el.style.color = "var(--alert)";
        else el.style.color = "white";
    }

    function updateBXP(val) {
        let amt = (typeof val === 'object') ? val.amount : val;
        if (amt >= 0) {
            STATE.currentBXP = amt;
            document.getElementById('disp-bxp').innerText = formatNum(amt);
        }
    }

    function updateXP(newXP) {
        if (STATE.startXP === null) {
            STATE.startXP = newXP;
            STATE.currentXP = newXP;
            renderDisplay();
            return;
        }

        if (newXP > STATE.currentXP) {
            STATE.callouts++; 
            const gained = newXP - STATE.startXP;
            STATE.avgXP = gained / STATE.callouts;

            if (getLevelFromXP(newXP) > getLevelFromXP(STATE.currentXP)) {
                window.parent.postMessage({ type: "sfx", sfx: 16 }, "*"); 
            }
        }

        STATE.currentXP = newXP;
        renderDisplay();
    }

    function renderDisplay() {
        const lvl = getLevelFromXP(STATE.currentXP);
        const nextLvlXP = getXPFromLevel(lvl + 1);
        const prevLvlXP = getXPFromLevel(lvl);
        const percent = Math.min(100, Math.max(0, ((STATE.currentXP - prevLvlXP) / (nextLvlXP - prevLvlXP)) * 100));

        document.getElementById('disp-level').innerText = lvl;
        document.getElementById('disp-xp').innerText = formatNum(STATE.currentXP);
        document.getElementById('level-bar').style.width = percent + "%";
        document.getElementById('level-text').innerText = percent.toFixed(1) + "%";
        document.getElementById('disp-callouts').innerText = STATE.callouts;

        runCalculator();
    }

    document.getElementById('target-input').addEventListener('input', runCalculator);

    function runCalculator() {
        const val = document.getElementById('target-input').value;
        const el = document.getElementById('calc-result');
        
        if (STATE.avgXP === 0) {
            el.innerHTML = "<i>Complete a revive to enable calc...</i>";
            return;
        }
        if (!val) {
            el.innerText = "Enter target above.";
            return;
        }

        let inputVal = parseInt(val.replace(/,/g, ''));
        let targetXP = inputVal;

        if (inputVal < 200) { 
             let lvlXP = getXPFromLevel(inputVal);
             if (lvlXP > STATE.currentXP) targetXP = lvlXP;
        }

        if (targetXP > STATE.currentXP) {
            const diff = targetXP - STATE.currentXP;
            const jobs = Math.ceil(diff / STATE.avgXP);
            el.innerHTML = `Remaining XP: <b>${formatNum(diff)}</b><br>` + 
                           `<span style="color:var(--primary)">Revives to go: <b>${formatNum(jobs)}</b></span>`;
        } else {
            const jobs = Math.ceil(inputVal / STATE.avgXP);
            el.innerHTML = `To add ${formatNum(inputVal)} XP:<br>Effort: <b>${formatNum(jobs)} revives</b>`;
        }
    }

    setInterval(() => {
        const now = new Date();
        document.getElementById('clock').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }, 1000);

    const elmnt = document.getElementById("app-container");
    const header = document.getElementById("drag-handle");
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    header.onmousedown = dragMouseDown;
    function dragMouseDown(e) {
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }
    function elementDrag(e) {
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
        elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
    }
    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }

</script>
</body>
</html>
