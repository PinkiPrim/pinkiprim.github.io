<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Cargo Pilot Helper</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800;900&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #0277bd;
            --primary-dim: #004c8c;
            --bg-glass: rgba(15, 15, 15, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(2, 119, 189, 0.3);
            --green: #00e676;
            --orange: #ff9800;
            --accent: #ffc107;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #tracker-app {
            position: absolute;
            top: 50px; left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            min-height: 200px;
        }

        /* --- HEADER & LAYOUT --- */
        header {
            background: linear-gradient(90deg, var(--primary-dim), var(--primary));
            padding: 0 12px; height: 46px;    
            cursor: move; display: flex;   
            justify-content: space-between; align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            position: relative; overflow: hidden;
        }

        .nav-icon, #clock { position: relative; z-index: 20; font-size: 1.1em; }
        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; }

        .header-center {
            position: absolute; left: 50%; top: 50%;
            transform: translate(-50%, -50%);
            text-align: center; width: 100%;
            pointer-events: none; z-index: 15;
        }

        .header-title {
            font-family: 'Rajdhani', sans-serif; font-weight: 900;
            text-transform: uppercase; letter-spacing: 2px; font-size: 1em;
            line-height: 1; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
            color: #ccc; margin-bottom: 2px;
        }

        #user-rank-display {
            font-family: 'Rajdhani', sans-serif;
            font-size: 1.3em; font-weight: 900; 
            text-transform: uppercase; letter-spacing: 1px;
            position: relative; line-height: 1;
            white-space: nowrap; transform: translateZ(0); 
        }

        /* --- üí• RANK EVOLUTION üí• --- */
        
        /* 0 - 50K: THE ENERGY PHASE (Already Approved) */
        .rank-5k { color: #ff9800; text-shadow: 0 0 10px #ff5722; animation: burnPulse 0.5s infinite alternate; }
        .rank-10k { color: #76ff03; text-shadow: 0 0 10px #ccff00; letter-spacing: 2px; animation: toxicPulse 2s infinite; }
        .rank-25k { background: linear-gradient(180deg, #fff 40%, #000 50%, #fff 60%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; animation: chromeFlash 4s infinite linear; }
        .rank-50k { color: #fff; text-shadow: 0 0 10px #2962ff; animation: shockwave 2s infinite; }

        /* 100K: LIQUID GOLD (Unlocks Fluid Gradient) */
        .rank-100k {
            background: linear-gradient(120deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
            background-size: 200%;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 3px gold);
            animation: shineFlow 2s linear infinite;
        }
        @keyframes shineFlow { to { background-position: 200% center; } }

        /* 250K: HELLFIRE (Unlocks Active Particles) */
        /* Text gets active burning effect */
        .rank-250k {
            color: #ff5722;
            text-shadow: 0 -3px 5px #ffeb3b, 0 -6px 10px #f44336;
            animation: fireBreath 0.2s infinite alternate;
        }
        @keyframes fireBreath { from { transform: scale(1); filter: brightness(1); } to { transform: scale(1.05); filter: brightness(1.3); } }

        /* 500K: CYBER (Unlocks Geometry/Pop) */
        .rank-500k {
            color: #00e5ff;
            text-shadow: 3px 0 #ff00de;
            animation: hardGlitch 0.3s infinite;
        }
        @keyframes hardGlitch {
            0% { transform: translate(0,0); clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); }
            20% { transform: translate(-3px, 1px); clip-path: polygon(0 0, 100% 0, 100% 40%, 0 40%); }
            40% { transform: translate(3px, -1px); clip-path: polygon(0 60%, 100% 60%, 100% 100%, 0 100%); }
            60% { transform: translate(0,0); clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); }
        }

        /* 1M: COSMIC (Unlocks Aura/Void) */
        .rank-1m {
            background: linear-gradient(45deg, #2b00ff, #ff00dd);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 0 10px #d500f9);
            animation: pulseAura 2s infinite ease-in-out;
        }
        @keyframes pulseAura { 0% { filter: drop-shadow(0 0 5px #d500f9); } 50% { filter: drop-shadow(0 0 20px #d500f9); transform: scale(1.1); } 100% { filter: drop-shadow(0 0 5px #d500f9); } }

        /* --- ‚úàÔ∏è 10M GOD TIER SEQUENCE ‚úàÔ∏è --- */
        
        .rank-10m {
            /* RAINBOW CORE */
            background: linear-gradient(90deg, #ff0000, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff, #ff0000);
            background-size: 300%;
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            
            /* MASSIVE GLOW */
            filter: drop-shadow(0 0 5px white) drop-shadow(0 0 10px cyan);
            
            /* CONSTANT ANIMATION (Not Stagnant) */
            animation: rainbowFlow 2s linear infinite, godPulse 0.5s infinite alternate;
            
            opacity: 0; /* Hidden until sequence reveals it */
        }
        
        /* The Active State (15s duration) */
        .rank-10m.revealed { opacity: 1; }
        /* The Exit State (Shrink) */
        .rank-10m.exiting { animation: shrinkOut 1s forwards; }

        @keyframes rainbowFlow { 0% { background-position: 0% 50%; } 100% { background-position: 100% 50%; } }
        @keyframes godPulse { from { transform: scale(1); } to { transform: scale(1.1); letter-spacing: 3px; } }
        @keyframes shrinkOut { 0% { opacity: 1; transform: scale(1.1); } 100% { opacity: 0; transform: scale(0); } }

        /* --- ASSETS & ANIMATIONS --- */
        #god-tier-assets {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 18; overflow: hidden;
            display: none;
        }

        /* HUGE PLANE */
        #gt-plane {
            position: absolute; top: -20%; left: -150%;
            height: 140%; /* Huge but fits vertically */
            width: auto;
            z-index: 25;
            filter: drop-shadow(5px 5px 5px rgba(0,0,0,0.5));
        }

        /* POP CLOUD */
        #gt-cloud {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0);
            width: 150px; opacity: 0;
            z-index: 22;
        }

        /* POP FLASH */
        #gt-flash {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: white; border-radius: 50%;
            opacity: 0; z-index: 21;
            box-shadow: 0 0 50px 20px white;
        }

        /* SEQUENCES */
        .anim-plane { animation: flyPlane 2s linear forwards; }
        .anim-cloud { animation: popCloud 1.5s linear forwards; animation-delay: 0.8s; } /* Timing matched to plane center */
        .anim-flash { animation: popFlash 0.5s ease-out forwards; animation-delay: 1.8s; }

        @keyframes flyPlane { 0% { left: -150%; } 100% { left: 150%; } }
        
        @keyframes popCloud {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            20% { transform: translate(-50%, -50%) scale(1.5); opacity: 1; }
            80% { transform: translate(-50%, -50%) scale(1.8); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(2.5); opacity: 0; }
        }

        @keyframes popFlash {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(10); opacity: 0; }
        }

        /* Particles (Shared by 250k+) */
        #particle-container {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 1; overflow: hidden;
        }
        .particle {
            position: absolute; background: white; border-radius: 50%;
            box-shadow: 0 0 5px white; pointer-events: none;
        }
        .ember { background: #ff5722; box-shadow: 0 0 5px orange; } /* For 250k */

        /* DEBUG DROPDOWN */
        #debug-ranks {
            width: 100%; background: #111; color: #aaa; 
            border: none; border-bottom: 1px solid #333; 
            padding: 4px; font-size: 0.8em; text-align: center; cursor: pointer;
        }

        /* --- BASE CSS (Standard) --- */
        #content { padding: 12px; flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .destination-display { background: rgba(255, 193, 7, 0.1); border: 1px dashed var(--accent); border-radius: 6px; padding: 10px; margin-bottom: 15px; text-align: center; }
        .dest-label { font-size: 0.7em; color: var(--accent); text-transform: uppercase; letter-spacing: 2px; margin-bottom: 4px; }
        .dest-value { font-family: 'Rajdhani', sans-serif; font-size: 1.3em; font-weight: 700; color: #fff; text-shadow: 0 0 10px rgba(0,0,0,0.5); line-height: 1.1; }
        .section { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .section:last-child { border-bottom: none; }
        .label { font-size: 0.7em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }
        .progress-container { position: relative; height: 16px; background: rgba(0,0,0,0.5); border-radius: 4px; margin: 5px 0 5px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; text-shadow: 1px 1px 2px black; font-weight: bold; z-index: 2; }
        .xp-remaining-text { text-align: center; font-size: 0.8em; color: var(--text-dim); margin-bottom: 10px; }
        .xp-remaining-text b { color: var(--primary); }
        .run-box { background: rgba(2, 119, 189, 0.1); border: 1px solid rgba(2, 119, 189, 0.3); border-radius: 4px; padding: 8px; margin-bottom: 10px; }
        .run-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.9em; }
        .run-val { font-weight: bold; color: #fff; }
        .run-label { font-size: 0.8em; color: #aaa; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 6px; border-radius: 4px; text-align: center; }
        .trunk-header { display: flex; justify-content: space-between; align-items: center; }
        .sync-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; background: #444; margin-left: 5px; }
        .sync-dot.live { background: var(--green); box-shadow: 0 0 5px var(--green); }
        .sync-dot.cached { background: var(--orange); }
        .trunk-item { display: flex; justify-content: space-between; font-size: 0.85em; padding: 4px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
        input[type="number"] { width: 90%; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; margin-top: 5px; font-family: inherit; }
        input:focus { outline: 1px solid var(--primary); }
        .calc-output { margin-top: 5px; font-size: 0.8em; line-height: 1.3; color: var(--text-dim); word-wrap: break-word; }
        #settings-panel, #job-list, #summary-table { display: none !important; }
        
        /* OTHER VFX KEYFRAMES */
        @keyframes burnPulse { from { filter: brightness(1); } to { filter: brightness(1.5); } }
        @keyframes toxicPulse { 0% { filter: hue-rotate(0deg); } 50% { filter: hue-rotate(30deg) drop-shadow(0 0 5px lime); } 100% { filter: hue-rotate(0deg); } }
        @keyframes chromeFlash { 0% { filter: brightness(1); } 50% { filter: brightness(1.5) drop-shadow(0 0 5px white); } 100% { filter: brightness(1); } }
        @keyframes shockwave { 0% { transform: scale(1); text-shadow: 0 0 5px #2962ff; } 5% { transform: scale(1.1); text-shadow: 0 0 20px #2962ff, 0 0 40px white; } 10% { transform: scale(1); text-shadow: 0 0 5px #2962ff; } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div id="tracker-app">
    <select id="debug-ranks" onchange="testRank(this.value)">
        <option value="0">Test: 0 XP (Standard)</option>
        <option value="5000">Test: 5K (Energy)</option>
        <option value="10000">Test: 10K (Toxic)</option>
        <option value="25000">Test: 25K (Chrome)</option>
        <option value="50000">Test: 50K (Tesla)</option>
        <option value="100000">Test: 100K (Midas)</option>
        <option value="250000">Test: 250K (Hellfire)</option>
        <option value="500000">Test: 500K (Cyber)</option>
        <option value="1000000">Test: 1M (Event Horizon)</option>
        <option value="10000000">Test: 10M (GOD SEQUENCE)</option>
    </select>

    <header id="drag-handle">
        
        <div id="god-tier-assets">
            <img id="gt-plane" src="https://www.nicepng.com/png/full/204-2044109_how-to-set-use-airplane-svg-vector.png">
            <img id="gt-cloud" src="https://wallpapers.com/images/high/cartoon-cloud-in-pastel-colors-png-vbg-3h4w3rkfn5fveu2t.png">
            <div id="gt-flash"></div>
        </div>
        
        <div id="particle-container"></div>

        <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon" style="text-decoration:none; cursor:pointer; font-size:1.2em;">üè†</a>
        
        <div class="header-center">
            <div class="header-title">‚úàÔ∏è Cargo Ops</div>
            <div id="user-rank-display">Unknown Pilot</div>
        </div>

        <span id="clock">00:00</span>
    </header>

    <div id="content">
        <div class="destination-display" id="dest-box">
            <div class="dest-label">Next Destination</div>
            <div class="dest-value" id="disp-destination">Waiting for cargo...</div>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Pilot Level</div><div class="value highlight" style="font-size:1.6em" id="disp-level">...</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>
            
            <div class="xp-remaining-text" id="disp-xp-remaining">Waiting for drop...</div>

            <div class="run-box">
                <div style="border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px; padding-bottom:3px; color:var(--primary); font-size:0.85em; font-weight:bold; letter-spacing:1px;">FLIGHT SESSION</div>
                <div class="run-grid">
                    <div>
                        <div class="run-label">Current Flight XP</div>
                        <div class="run-val" id="disp-flight-xp" style="color:var(--green)">0 XP</div>
                    </div>
                    <div style="text-align:right">
                        <div class="run-label">Avg XP / Flight</div>
                        <div class="run-val" id="disp-flight-avg">0 XP</div>
                    </div>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-box"><div class="label">BXP Tokens</div><div class="value bxp" id="disp-bxp">0</div></div>
                <div class="stat-box"><div class="label">Flights Done</div><div class="value" id="disp-ops" style="color:var(--accent)">0</div></div>
            </div>
        </div>

        <div class="section">
            <div class="trunk-header">
                <div class="label">üì¶ Cargo Hold <span id="sync-status" class="sync-dot"></span></div>
                <div class="label" id="trunk-capacity"></div>
            </div>
            <div id="trunk-list" style="min-height:30px; color:#666; font-size:0.8em; font-style:italic;">
                No cargo loaded.
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Flight Calculator</div>
            <input type="number" id="target-input" placeholder="e.g. 1000000">
            <div class="calc-output" id="calc-result">Complete 1 flight to calibrate...</div>
        </div>
    </div>
    <div id="resize-handle" style="position:absolute; bottom:0; right:0; width:15px; height:15px; cursor:nwse-resize;"></div>
</div>

<div id="settings-icon" style="display:none;"></div>
<div id="settings-panel" style="display:none;">
    <input type="checkbox" id="toggle-bxp"><input type="checkbox" id="toggle-current-level">
    <input type="checkbox" id="toggle-exp-hr"><input type="checkbox" id="toggle-exp-min">
    <input type="checkbox" id="toggle-perk-chance"><input type="checkbox" id="toggle-1m-percent">
    <input type="checkbox" id="toggle-10m-percent"><input type="checkbox" id="toggle-level">
    <input type="number" id="xp-font-size">
    <button id="reset-exp-log"></button>
    <div id="xp-font-size-value"></div>
</div>
<div id="job-list" style="display:none;"></div>
<table id="summary-table" style="display:none;"></table>

<script>
// --- AIRPORT DATABASE ---
const AIRPORTS = {
    "LSIA": "Los Santos INTL.", "SSIA": "Sandy Sh. INTL. Airport", "ZMA": "Zancudo Military Airport",
    "RAM": "Arroyo Muerto Municipal", "PBA": "Arroyo Muerto Municipal", 
    "POA": "Pacific Ocean Airport", "MGA": "Mount Gorgo Airport",
    "CIA": "Chumash Island Airport", "SCA": "San Chianski Airport", "POP": "PostOp Airport",
    "SAN": "Sandy Shores Airfield", "MKA": "McKenzie Airfield", "CPA": "Cayo Perico Airfield",
    "TVH": "Tongva Hills Airfield", "CV": "Carrier"
};

// --- STATE ---
let TRUNK_KEY = null;
let LAST_VEHICLE = null; 
let PARTICLE_INTERVAL = null;
let GOD_MODE_INTERVAL = null;
let GOD_HIDE_TIMEOUT = null;

let MEMORY = {
    inventory: {},
    trunk: {},
    weight: 0,
    lastTrunkUpdate: 0
};

const JOB_EXP_KEY = "exp_piloting_cargos";
const JOB_BXP_KEY = "exp_token_a|piloting|cargos";

const STATE = {
    currentXP: 0, 
    playerName: "Pilot",
    
    runActive: false,
    runStartXP: 0,      
    currentRunGain: 0,  
    completedRuns: 0,
    totalRunXP: 0,      
    avgRunXP: 0         
};

// --- CLOCK ---
setInterval(() => {
    document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}, 1000);

// --- ENGINE ---
function requestData() {
    if(window.parent) {
        try { 
            let keys = [
                "exp_piloting_cargos", "exp_token_a|piloting|cargos", 
                "inventory", "vehicle", "plate", "name", 
                "chest", "trunkCapacity", "trunkWeight"
            ];
            if(TRUNK_KEY) keys.push(TRUNK_KEY);
            window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
            window.parent.postMessage({ type: "getData" }, "*"); 
        } catch(e) {}
    }
}
setInterval(requestData, 1000); 

window.addEventListener('message', (event) => {
    let payload = event.data;
    if (payload && payload.type === 'data' && payload.data) payload = payload.data;
    if (!payload) return;

    processPayload(payload);
});

function processPayload(data) {
    if(data.name && STATE.playerName !== data.name) {
        STATE.playerName = data.name;
        document.getElementById('user-rank-display').innerText = STATE.playerName;
        updateRankVisuals(STATE.currentXP); 
    }

    let incomingPlate = data.plate || data.vehicle;
    if (incomingPlate) {
        if(LAST_VEHICLE && LAST_VEHICLE !== incomingPlate) {
            MEMORY.trunk = {}; 
            MEMORY.weight = 0;
            TRUNK_KEY = null;
            STATE.runActive = false;
            STATE.currentRunGain = 0;
        }
        LAST_VEHICLE = incomingPlate;
    }

    // VEHICLE TRUNK FILTER
    if(data.chest && typeof data.chest === 'string' && data.chest.includes("veh_")) {
        TRUNK_KEY = "chest_" + data.chest;
    }
    if(!TRUNK_KEY) {
        for(let key in data) {
            if(key.startsWith("chest_") && key.includes("veh_") && typeof data[key] === 'string' && data[key] !== "{}") {
                TRUNK_KEY = key;
                break;
            }
        }
    }

    if(data.inventory) {
        try { MEMORY.inventory = (typeof data.inventory === 'string') ? JSON.parse(data.inventory) : data.inventory; } catch(e){}
    }
    
    if(data.trunkWeight !== undefined) MEMORY.weight = Math.round(data.trunkWeight);
    
    // CRASH FIX: Check for empty string
    let incomingTrunk = null;
    if(TRUNK_KEY && data[TRUNK_KEY]) {
        try { 
            if(data[TRUNK_KEY] !== "") {
                incomingTrunk = (typeof data[TRUNK_KEY] === 'string') ? JSON.parse(data[TRUNK_KEY]) : data[TRUNK_KEY];
            }
        } catch(e){}
    }

    const syncDot = document.getElementById('sync-status');
    const now = Date.now();

    if(incomingTrunk && Object.keys(incomingTrunk).length > 0) {
        MEMORY.trunk = incomingTrunk;
        MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    } 
    else if (MEMORY.weight === 0) {
        MEMORY.trunk = {};
        MEMORY.lastTrunkUpdate = now;
        syncDot.className = "sync-dot live";
    }
    else {
        if(now - MEMORY.lastTrunkUpdate > 3000) syncDot.className = "sync-dot cached";
    }

    let hasCargo = checkForCargo(MEMORY.inventory, MEMORY.trunk);
    
    let currentXP = data[JOB_EXP_KEY];
    if(!currentXP && MEMORY.inventory[JOB_EXP_KEY]) currentXP = MEMORY.inventory[JOB_EXP_KEY];

    if (typeof currentXP === 'number') {
        updateRunLogic(currentXP, hasCargo);
        updateRankVisuals(currentXP);
        renderStats();
    }

    renderTrunkList(MEMORY.trunk);
    if(data.trunkCapacity !== undefined) {
        document.getElementById('trunk-capacity').innerText = `${MEMORY.weight}/${Math.round(data.trunkCapacity)}kg`;
    }

    let bxp = data[JOB_BXP_KEY];
    if(!bxp && MEMORY.inventory[JOB_BXP_KEY]) bxp = MEMORY.inventory[JOB_BXP_KEY];
    if (bxp) {
        let val = (typeof bxp === 'object') ? bxp.amount : bxp;
        document.getElementById('disp-bxp').innerText = formatNumber(val);
    }
}

// --- RANK VISUALS ---
function updateRankVisuals(xp) {
    const el = document.getElementById('user-rank-display');
    const assetContainer = document.getElementById('god-tier-assets');
    
    // Reset if rank changes
    // Only perform full reset if dropping below 10M to save resources
    if (xp < 10000000 && GOD_MODE_INTERVAL) {
        el.className = "";
        assetContainer.style.display = "none";
        clearInterval(GOD_MODE_INTERVAL); GOD_MODE_INTERVAL = null;
        clearInterval(PARTICLE_INTERVAL); PARTICLE_INTERVAL = null;
        clearTimeout(GOD_HIDE_TIMEOUT);
        document.getElementById('particle-container').innerHTML = '';
        el.style.opacity = "1"; // Show name for normal ranks
    }

    if (xp >= 10000000) { 
        if (!el.classList.contains("rank-10m")) {
            el.className = "rank-10m"; // Set base class
            assetContainer.style.display = "block";
            
            // START LOOPS
            triggerGodSequence();
            if (!GOD_MODE_INTERVAL) GOD_MODE_INTERVAL = setInterval(triggerGodSequence, 20000); // 20s Loop (15s visible + 5s reset)
            if (!PARTICLE_INTERVAL) PARTICLE_INTERVAL = setInterval(() => spawnParticle(true), 150);
        }
    } else {
        el.className = ""; // Reset
        if (xp >= 1000000) { el.classList.add("rank-1m"); if(!PARTICLE_INTERVAL) PARTICLE_INTERVAL = setInterval(() => spawnParticle(false), 200); }
        else if (xp >= 500000) el.classList.add("rank-500k");
        else if (xp >= 250000) { el.classList.add("rank-250k"); if(!PARTICLE_INTERVAL) PARTICLE_INTERVAL = setInterval(() => spawnParticle(false, 'ember'), 250); }
        else if (xp >= 100000) el.classList.add("rank-100k");
        else if (xp >= 50000) el.classList.add("rank-50k");
        else if (xp >= 25000) el.classList.add("rank-25k");
        else if (xp >= 10000) el.classList.add("rank-10k");
        else if (xp >= 5000) el.classList.add("rank-5k");
        
        // Clean up particles for non-particle ranks
        if (xp < 250000 && xp !== 1000000 && PARTICLE_INTERVAL) {
            clearInterval(PARTICLE_INTERVAL); PARTICLE_INTERVAL = null;
            document.getElementById('particle-container').innerHTML = '';
        }
        el.style.opacity = "1";
    }
}

function triggerGodSequence() {
    const plane = document.getElementById('gt-plane');
    const cloud = document.getElementById('gt-cloud');
    const flash = document.getElementById('gt-flash');
    const text = document.getElementById('user-rank-display');
    
    // Reset
    plane.classList.remove("anim-plane");
    cloud.classList.remove("anim-cloud");
    flash.classList.remove("anim-flash");
    text.classList.remove("revealed");
    text.classList.remove("exiting");
    
    void plane.offsetWidth; // Force Reflow
    
    // Start
    plane.classList.add("anim-plane");
    cloud.classList.add("anim-cloud");
    flash.classList.add("anim-flash");
    
    // Reveal Text at 1.8s
    setTimeout(() => { text.classList.add("revealed"); }, 1800);
    
    // Hide Text at 16.8s (15s visible)
    if(GOD_HIDE_TIMEOUT) clearTimeout(GOD_HIDE_TIMEOUT);
    GOD_HIDE_TIMEOUT = setTimeout(() => { text.classList.add("exiting"); }, 16800);
}

function spawnParticle(isRainbow, type) {
    const container = document.getElementById('particle-container');
    const p = document.createElement('div');
    p.classList.add('particle');
    if(type === 'ember') p.classList.add('ember');
    
    p.style.left = (50 + (Math.random() * 20 - 10)) + '%';
    p.style.top = (50 + (Math.random() * 20 - 10)) + '%';
    const size = Math.random() * 3 + 1;
    p.style.width = size + 'px'; p.style.height = size + 'px';
    
    // Physics
    const angle = Math.random() * 360;
    const velocity = Math.random() * 60 + 20;
    const tx = Math.cos(angle) * velocity;
    const ty = Math.sin(angle) * velocity;
    
    // Color logic
    if (isRainbow) {
        const colors = ['red', 'cyan', 'lime', 'yellow', 'magenta'];
        p.style.background = colors[Math.floor(Math.random() * colors.length)];
        p.style.boxShadow = `0 0 5px ${p.style.background}`;
    }

    p.animate([
        { transform: 'translate(0,0) scale(1)', opacity: 1 },
        { transform: `translate(${tx}px, ${ty}px) scale(0)`, opacity: 0 }
    ], { duration: 800, easing: 'ease-out' }).onfinish = () => p.remove();
    container.appendChild(p);
}

function testRank(val) { 
    // Force reset for testing
    STATE.currentXP = parseInt(val);
    const el = document.getElementById('user-rank-display');
    el.className = ""; // clear
    updateRankVisuals(STATE.currentXP); 
}

// --- FLIGHT LOGIC ---
function checkForCargo(pockets, trunk) {
    let destName = "Waiting for cargo...";
    
    const scan = (inv) => {
        if(!inv) return false;
        for (const key in inv) {
            const upperKey = key.toUpperCase();
            if(upperKey.includes("CARGO")) {
                for(const code in AIRPORTS) {
                    if (upperKey.includes(code)) {
                        destName = `${code} - ${AIRPORTS[code]}`;
                        return true;
                    }
                }
            }
        }
        return false;
    };

    let trunkHas = scan(trunk);
    let pocketsHas = scan(pockets);
    
    const box = document.getElementById('dest-box');
    const txt = document.getElementById('disp-destination');
    txt.innerText = destName;
    
    if(trunkHas || pocketsHas) {
        box.style.borderColor = "var(--green)";
        box.style.background = "rgba(0, 230, 118, 0.1)";
        txt.style.color = "var(--green)";
        return true; 
    } else {
        box.style.borderColor = "var(--accent)";
        box.style.background = "rgba(255, 193, 7, 0.1)";
        txt.style.color = "#fff";
        return false; 
    }
}

function updateRunLogic(currentXP, hasCargo) {
    if (STATE.currentXP === 0) STATE.currentXP = currentXP;

    if (hasCargo && !STATE.runActive) {
        STATE.runActive = true;
        STATE.runStartXP = currentXP;
        STATE.currentRunGain = 0;
    }

    if (STATE.runActive) {
        if (currentXP > STATE.runStartXP) {
            STATE.currentRunGain = currentXP - STATE.runStartXP;
        }
    }

    if (!hasCargo && STATE.runActive) {
        STATE.completedRuns++;
        STATE.totalRunXP += STATE.currentRunGain;
        STATE.avgRunXP = STATE.totalRunXP / STATE.completedRuns;
        STATE.runActive = false;
        STATE.currentRunGain = 0;
    }

    STATE.currentXP = currentXP;
}

function renderStats() {
    const lvl = getLevelInfo(STATE.currentXP);
    document.getElementById('disp-xp').innerText = formatNumber(STATE.currentXP);
    document.getElementById('disp-level').innerText = lvl.level;
    
    const pct = getPercentValue(lvl.expInLevel, lvl.expForNext);
    document.getElementById('level-bar').style.width = pct + "%";
    document.getElementById('level-text').innerText = pct + "%";

    document.getElementById('disp-flight-xp').innerText = formatNumber(STATE.currentRunGain) + " XP";
    document.getElementById('disp-flight-avg').innerText = Math.round(STATE.avgRunXP) + " XP";
    document.getElementById('disp-ops').innerText = STATE.completedRuns;

    const needed = Math.round(lvl.expForNext - lvl.expInLevel);
    document.getElementById('disp-xp-remaining').innerHTML = `<b>${formatNumber(needed)}</b> XP to Next Level`;

    runCalculator();
}

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "K";
    return num.toLocaleString();
}

function getLevelInfo(exp) {
    let level = 0, xpCap = 5;
    while (exp >= xpCap) { exp -= xpCap; level++; xpCap = (level + 1) * 5; }
    return { level, expInLevel: exp, expForNext: xpCap };
}

function getPercentValue(exp, cap) {
    return Math.min(100, Math.max(0, ((exp / cap) * 100))).toFixed(1);
}

const calcInput = document.getElementById('target-input');
if(calcInput) calcInput.addEventListener('input', runCalculator);

function runCalculator() {
    const val = document.getElementById('target-input').value;
    const el = document.getElementById('calc-result');
    
    if (STATE.avgRunXP === 0) { el.innerHTML = "<i>Complete 1 flight to calibrate...</i>"; return; }
    if (!val) { el.innerText = "Enter target above."; return; }

    let inputVal = parseInt(val.replace(/,/g, ''));
    let targetXP = inputVal;
    
    if (inputVal < 200) { 
         let lvlXP = 0; 
         for(let i=0; i<inputVal; i++) lvlXP += (5 * i * (i + 1)) / 2;
         targetXP = (5 * inputVal * (inputVal + 1)) / 2;
    }

    if (targetXP > STATE.currentXP) {
        const diff = targetXP - STATE.currentXP;
        const ops = Math.ceil(diff / STATE.avgRunXP);
        el.innerHTML = `Remaining: <b>${formatNumber(diff)} XP</b><br><span style="color:var(--primary)">Est. Flights: <b>${formatNumber(ops)}</b></span>`;
    } else {
        el.innerHTML = `Target reached.`;
    }
}

function renderTrunkList(trunk) {
    const el = document.getElementById('trunk-list');
    el.innerHTML = "";
    
    if((!trunk || Object.keys(trunk).length === 0) && MEMORY.weight > 0) {
        el.innerHTML = "<div style='color:var(--orange); font-style:italic;'>‚ö† Cargo Detected<br>(Open Trunk to Sync)</div>";
        return;
    }
    
    if(!trunk || Object.keys(trunk).length === 0) {
        el.innerHTML = "Cargo hold is empty.";
        return;
    }

    for(let key in trunk) {
        let item = trunk[key];
        let qty = item.amount || item.count || item;
        if(qty > 0) {
            el.innerHTML += `<div class="trunk-item"><span>${key}</span><span>x${qty}</span></div>`;
        }
    }
}

// --- DRAG HANDLER ---
(() => {
    const app = document.getElementById('tracker-app');
    const handle = document.getElementById('drag-handle');
    const rh = document.getElementById('resize-handle');
    if (!app || !handle) return;
    
    let sx=0, sy=0, ax=0, ay=0, dragging=false;
    let sw=0, sh=0, resizing=false;

    function startDrag(clientX, clientY, e) {
        if (e && e.target.closest('button')) return;
        if (e) { e.preventDefault(); e.stopPropagation(); }
        dragging = true; sx = clientX; sy = clientY;
        const rect = app.getBoundingClientRect(); ax = rect.left; ay = rect.top;
        handle.classList.add('dragging');
    }

    handle.addEventListener('mousedown', (e) => startDrag(e.clientX, e.clientY, e));

    if (rh) {
        function startResize(clientX, clientY, e) {
            if (e) { e.preventDefault(); e.stopPropagation(); }
            resizing = true; sx = clientX; sy = clientY;
            const rect = app.getBoundingClientRect(); sw = rect.width; sh = rect.height;
        }
        rh.addEventListener('mousedown', (e) => startResize(e.clientX, e.clientY, e));
    }

    function handleMove(clientX, clientY, e) {
        if (dragging) {
            if (e) e.preventDefault();
            const dx = clientX - sx, dy = clientY - sy;
            app.style.transform = `translate(${dx}px, ${dy}px)`;
        } else if (resizing) {
            if (e) e.preventDefault();
            const dx = clientX - sx, dy = clientY - sy;
            app.style.width  = `${Math.max(280, sw + dx)}px`;
            app.style.height = `${Math.max(120, sh + dy)}px`;
        }
    }
    
    window.addEventListener('mousemove', (e) => handleMove(e.clientX, e.clientY, e));

    function endDrag() {
        if (dragging) {
            const transform = app.style.transform;
            const match = transform.match(/translate\(([-\d.]+)px, ([-\d.]+)px\)/);
            if (match) {
                const dx = parseFloat(match[1]) || 0;
                const dy = parseFloat(match[2]) || 0;
                app.style.transform = '';
                app.style.left = `${ax + dx}px`;
                app.style.top = `${ay + dy}px`;
            }
        }
        dragging = false; resizing = false;
        handle.classList.remove('dragging');
    }
    window.addEventListener('mouseup', endDrag);
})();
</script>
</body>
</html>
