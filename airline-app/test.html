<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Airline Ops</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #03a9f4; 
            --primary-dim: #0277bd;
            --bg-glass: rgba(18, 18, 18, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(3, 169, 244, 0.3);
            --green: #00e676;
            --orange: #ff9800;
            --red: #ff5252;
            --accent: #81d4fa;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #tracker-app {
            position: absolute;
            top: 50px; left: 50px;
            width: 320px; /* Standard Width */
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
            min-height: 200px; /* Standard Height */
        }

        /* --- MICRO MODE (The Straight Line) --- */
        #tracker-app.micro-mode {
            width: auto !important;
            min-width: 480px; /* Wide enough for the line */
            max-width: 800px;
            height: 36px !important; /* Single Line Height */
            min-height: 36px !important;
            border-radius: 18px; /* Rounded pill shape */
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid var(--primary);
        }

        /* Hide Standard Elements in Micro Mode */
        #tracker-app.micro-mode header, 
        #tracker-app.micro-mode #sky-container, 
        #tracker-app.micro-mode #content {
            display: none !important;
        }

        /* Show Micro Elements in Micro Mode */
        #micro-view {
            display: none;
            height: 100%;
            align-items: center;
            padding: 0 10px;
            font-family: 'Rajdhani', sans-serif;
            font-size: 0.9em;
            gap: 12px;
            cursor: move; /* Whole bar is draggable */
            white-space: nowrap;
        }

        #tracker-app.micro-mode #micro-view {
            display: flex;
        }

        /* Micro View Items */
        .micro-item { display: flex; align-items: center; gap: 5px; }
        .micro-sep { width: 1px; height: 16px; background: rgba(255,255,255,0.2); }
        .micro-label { color: var(--text-dim); font-size: 0.85em; text-transform: uppercase; }
        .micro-val { color: #fff; font-weight: 700; }
        .micro-val.active { color: var(--green); }
        .micro-val.urgent { color: var(--red); }
        
        .micro-btn {
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #fff; padding: 1px 6px; border-radius: 4px; 
            font-size: 0.75em; cursor: pointer; text-transform: uppercase;
        }
        .micro-btn:hover { background: var(--primary); }

        /* --- STANDARD HEADER & SKY --- */
        header {
            background: linear-gradient(180deg, var(--primary-dim), rgba(3, 169, 244, 0.2));
            height: 65px; 
            padding: 0 10px;
            cursor: move;
            position: relative;
            display: flex; align-items: flex-start; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            overflow: hidden; 
            padding-top: 5px;
        }

        .header-title {
            position: absolute; left: 50%; top: 25%;
            transform: translate(-50%, -50%);
            font-family: 'Rajdhani', sans-serif; 
            font-weight: 900; font-size: 1.2em;
            text-transform: uppercase; letter-spacing: 2px;
            color: #fff; pointer-events: none; white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
            z-index: 10;
        }

        #user-name-fly {
            position: absolute; top: 38px; left: -150px;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.95em;
            color: #fff; white-space: nowrap; pointer-events: none; z-index: 10;
            text-shadow: 0 0 5px var(--primary), 0 0 10px var(--accent), 0 0 20px var(--primary-dim);
        }

        @keyframes flyCycle {
            0% { left: -150px; transform: translateX(0) translateY(0); opacity: 0; }
            10% { left: 50%; transform: translateX(-50%) translateY(0); opacity: 1; } 
            20% { left: 50%; transform: translateX(-50%) translateY(-2px); }
            30% { left: 50%; transform: translateX(-50%) translateY(1px); }
            40% { left: 50%; transform: translateX(-50%) translateY(-1px); }
            50% { left: 50%; transform: translateX(-50%) translateY(2px); }
            60% { left: 50%; transform: translateX(-50%) translateY(-2px); }
            70% { left: 50%; transform: translateX(-50%) translateY(1px); }
            80% { left: 50%; transform: translateX(-50%) translateY(0); }
            90% { left: 50%; transform: translateX(-50%); opacity: 1; }
            100% { left: 120%; transform: translateX(0); opacity: 0; } 
        }

        .cloud { position: absolute; background-image: url('https://pngimg.com/uploads/cloud/cloud_PNG112272.png'); background-size: contain; background-repeat: no-repeat; opacity: 0.25; pointer-events: none; z-index: 1; }
        .cloud-1 { top: 10px; left: -50px; width: 60px; height: 30px; animation: floatCloud 25s linear infinite; }
        .cloud-2 { top: 35px; left: -60px; width: 40px; height: 20px; animation: floatCloud 35s linear infinite 5s; }
        .cloud-3 { top: 20px; left: -40px; width: 50px; height: 25px; animation: floatCloud 45s linear infinite 12s; }
        @keyframes floatCloud { 0% { transform: translateX(0); } 100% { transform: translateX(450px); } }

        .header-controls { display: flex; gap: 8px; z-index: 20; align-items: center; }
        .nav-icon { text-decoration: none; font-size: 1.1em; cursor: pointer; color: #ccc; }
        .nav-icon:hover { color: #fff; }
        
        #mini-btn { font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.75em; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 2px 5px; border-radius: 4px; cursor: pointer; }
        #mini-btn:hover { background: var(--primary); color: white; border-color: var(--accent); }
        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #fff; font-size: 0.85em; z-index: 20; margin-top: 4px; }

        /* --- STANDARD CONTENT --- */
        #content { padding: 10px; flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .route-box { background: rgba(3, 169, 244, 0.1); border: 1px dashed var(--accent); border-radius: 6px; padding: 5px; margin-bottom: 6px; text-align: center; }
        .route-label { font-size: 0.6em; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 1px; }
        .route-name { font-family: 'Rajdhani', sans-serif; font-size: 0.95em; font-weight: 700; color: #fff; line-height: 1.1; margin-bottom: 2px; }
        .route-progress { font-size: 0.75em; color: var(--text-dim); font-weight: bold; }
        .status-container { background: rgba(255,255,255,0.05); border-radius: 6px; padding: 4px; margin-bottom: 10px; text-align: center; display: flex; flex-direction: column; gap: 2px; }
        .status-line { font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.8em; color: #ccc; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; text-transform: uppercase; letter-spacing: 1px; }
        .timer-line { font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.1em; color: var(--text-dim); line-height: 1; transition: color 0.2s ease; }
        .timer-line.active { color: var(--green); text-shadow: 0 0 8px rgba(0, 230, 118, 0.4); }
        .timer-line.urgent { color: var(--red); text-shadow: 0 0 8px rgba(255, 82, 82, 0.6); }
        .section { margin-bottom: 8px; padding-bottom: 6px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .section:last-child { border-bottom: none; }
        .label { font-size: 0.7em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }
        .progress-container { position: relative; height: 14px; background: rgba(0,0,0,0.5); border-radius: 4px; margin: 4px 0 4px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.65em; text-shadow: 1px 1px 2px black; font-weight: bold; z-index: 2; }
        .xp-remaining-text { text-align: center; font-size: 0.75em; color: var(--text-dim); margin-bottom: 8px; }
        .xp-remaining-text b { color: var(--primary); }
        .run-box { background: rgba(79, 195, 247, 0.1); border: 1px solid rgba(79, 195, 247, 0.3); border-radius: 4px; padding: 6px; margin-bottom: 8px; }
        .run-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 0.85em; }
        .run-val { font-weight: bold; color: #fff; }
        .run-label { font-size: 0.8em; color: #aaa; }
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 5px; border-radius: 4px; text-align: center; }
        .inv-row { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 4px 8px; margin-bottom: 4px; border-radius: 4px; border-left: 3px solid var(--text-dim); }
        .inv-name { font-size: 0.85em; }
        .inv-stats { font-size: 0.9em; font-weight: bold; text-align: right; }
        .low-stock { border-left-color: var(--red); background: rgba(255, 82, 82, 0.1); }
        input[type="number"] { width: 90%; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 4px; border-radius: 4px; margin-top: 4px; font-family: inherit; font-size: 0.9em; }
        input:focus { outline: 1px solid var(--primary); }
        .calc-output { margin-top: 4px; font-size: 0.75em; line-height: 1.2; color: var(--text-dim); word-wrap: break-word; }
        .quick-btn-row { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        .quick-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: bold; flex: 1; }
        .quick-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

<div id="tracker-app">
    <div id="micro-view" onmousedown="dragMouseDown(event)">
        <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon" style="color:var(--primary)">‚úàÔ∏è</a>
        
        <div class="micro-item">
            <span class="micro-val" id="micro-status">IDLE</span>
            <span class="micro-val" id="micro-timer">--</span>
        </div>
        
        <div class="micro-sep"></div>
        
        <div class="micro-item">
            <span class="micro-label">Dest:</span>
            <span class="micro-val" id="micro-dest">--</span>
        </div>

        <div class="micro-sep"></div>

        <div class="micro-item">
            <span class="micro-label">Meals:</span>
            <span class="micro-val" id="micro-meal">0</span>
        </div>

        <div class="micro-sep"></div>

        <div class="micro-item">
            <span class="micro-label">Flights Left:</span>
            <span class="micro-val" id="micro-calc" style="color:var(--primary)">--</span>
        </div>

        <div style="flex:1"></div> <button class="micro-btn" onclick="toggleMini()">MAX</button>
    </div>

    <header id="drag-handle">
        <div class="header-controls">
            <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon">üè†</a>
        </div>
        
        <div class="cloud cloud-1"></div>
        <div class="cloud cloud-2"></div>
        <div class="cloud cloud-3"></div>
        
        <div class="header-title">AIRLINE OPS</div>
        <div id="user-name-fly">Pilot ...</div>

        <div class="header-controls" style="flex-direction:column; gap:2px; align-items:flex-end;">
            <button id="mini-btn" onclick="toggleMini()">MINI</button>
            <span id="clock">00:00</span>
        </div>
    </header>

    <div id="content">
        <div class="route-box" id="route-box">
            <div class="route-label">Current Destination</div>
            <div class="route-name" id="disp-route-name">Waiting for route...</div>
            <div class="route-progress" id="disp-dist">Dist: -/-</div>
        </div>

        <div class="status-container">
            <div class="status-line" id="disp-status">IDLE</div>
            <div class="timer-line" id="disp-timer">--</div>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Airline Pilot Level</div><div class="value highlight" style="font-size:1.6em" id="disp-level">...</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>
            
            <div class="xp-remaining-text" id="disp-xp-remaining">Start a flight...</div>

            <div class="run-box">
                <div style="border-bottom:1px solid rgba(255,255,255,0.1); margin-bottom:5px; padding-bottom:3px; color:var(--primary); font-size:0.85em; font-weight:bold; letter-spacing:1px;">SESSION TRACKER</div>
                <div class="run-grid">
                    <div>
                        <div class="run-label">Session XP Gain</div>
                        <div class="run-val" id="disp-session-xp" style="color:var(--green)">0 XP</div>
                    </div>
                    <div style="text-align:right">
                        <div class="run-label">Avg XP / Flight</div>
                        <div class="run-val" id="disp-xp-drop">0 XP</div>
                    </div>
                </div>
            </div>

            <div class="stat-grid">
                <div class="stat-box"><div class="label">Pilot Tokens</div><div class="value bxp" id="disp-bxp">0</div></div>
                <div class="stat-box"><div class="label">Flights Done</div><div class="value" id="disp-drops" style="color:var(--accent)">0</div></div>
            </div>
        </div>

        <div class="section">
            <div class="label">Galley Supplies</div>
            <div class="inv-row" id="row-meal">
                <div class="inv-name">üç± Airline Meals</div>
                <div class="inv-stats">
                    Stock: <span id="stock-meal">0</span>
                </div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Flight Calculator</div>
            <input type="number" id="target-input" placeholder="e.g. 500000">
            
            <div class="quick-btn-row">
                <button class="quick-btn" onclick="setCalc(100000)">100K</button>
                <button class="quick-btn" onclick="setCalc(1000000)">1M</button>
                <button class="quick-btn" onclick="setCalc(10000000)">10M</button>
            </div>

            <div class="calc-output" id="calc-result">Complete 1 flight to calibrate...</div>
        </div>
    </div>
    
    <div id="resize-handle" style="position:absolute; bottom:0; right:0; width:15px; height:15px; cursor:nwse-resize;"></div>
</div>

<script>
// --- STATE ---
let SESSION_START_TIME = Date.now();
const JOB_EXP_KEY = "exp_piloting_piloting";
const JOB_BXP_KEY_A = "exp_token_a|piloting|piloting";
const JOB_BXP_KEY_B = "exp_token|piloting|piloting";
const ITEM_MEAL = "fridge_airline_meal";
const STORAGE_KEY_CALC = "target_xp_airline"; 
const STORAGE_KEY_MINI = "micro_mode_airline"; // Changed key name for clarity

let routeResetTimeout = null;
let hasCountedCurrent = false;
let TRUNK_KEY = null;

const MEMORY = { inventory: {}, trunk: {} };
const STATE = { currentXP: 0, startXP: 0, sessionGain: 0, completedRuns: 0, avgXP: 0 };

// --- INIT ---
const savedTarget = localStorage.getItem(STORAGE_KEY_CALC);
if (savedTarget) document.getElementById('target-input').value = savedTarget;

// RESTORE MICRO MODE
const savedMini = localStorage.getItem(STORAGE_KEY_MINI);
if (savedMini === "true") {
    document.getElementById('tracker-app').classList.add('micro-mode');
    document.getElementById('mini-btn').innerText = "FULL";
}

// --- MICRO MODE TOGGLE ---
function toggleMini() {
    const app = document.getElementById('tracker-app');
    app.classList.toggle('micro-mode');
    const isMicro = app.classList.contains('micro-mode');
    document.getElementById('mini-btn').innerText = isMicro ? "FULL" : "MINI";
    localStorage.setItem(STORAGE_KEY_MINI, isMicro);
}

// --- ANIMATION ---
const nameEl = document.getElementById('user-name-fly');
function startNameCycle() {
    nameEl.style.animation = 'none'; nameEl.offsetHeight; 
    nameEl.style.animation = 'flyCycle 15s linear infinite'; 
}
startNameCycle();

// --- CLOCK ---
setInterval(() => {
    document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}, 1000);

// --- ENGINE ---
function requestData() {
    if(window.parent) {
        try { 
            let keys = [
                "exp_piloting_piloting", "exp_token_a|piloting|piloting", "exp_token|piloting|piloting",
                "status", "inventory", "chest", "trunkCapacity", "trunkWeight", "name" 
            ];
            if(TRUNK_KEY) keys.push(TRUNK_KEY);
            window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
            window.parent.postMessage({ type: "getData" }, "*"); 
        } catch(e) {}
    }
}
setInterval(requestData, 1000); 

window.addEventListener('message', (event) => {
    let payload = event.data;
    if (payload && payload.type === 'data' && payload.data) payload = payload.data;
    if (!payload) return;
    processPayload(payload);
});

function processPayload(data) {
    if (data.name) document.getElementById('user-name-fly').innerText = "Pilot " + data.name;

    // 1. STATUS PARSING
    if (data.status) {
        if (routeResetTimeout) { clearTimeout(routeResetTimeout); routeResetTimeout = null; }
        try {
            let statusData = (typeof data.status === 'string') ? JSON.parse(data.status) : data.status;
            if (statusData && statusData.lines) {
                let lines = statusData.lines;
                
                if (lines[0]) {
                    let rawStatusLine = cleanString(lines[0]); 
                    let cleanStatus = rawStatusLine.replace("Status:", "").replace(/\(\d+\s*seconds?\)/i, "").trim();
                    let timerMatch = rawStatusLine.match(/\((\d+)\s*seconds?\)/i);
                    let timerEl = document.getElementById('disp-timer');
                    let microTimer = document.getElementById('micro-timer');
                    let microStatus = document.getElementById('micro-status');
                    
                    document.getElementById('disp-status').innerText = cleanStatus || "ACTIVE";
                    microStatus.innerText = cleanStatus || "ACTIVE";

                    if (timerMatch) {
                        let sec = parseInt(timerMatch[1]);
                        timerEl.innerText = sec + "s";
                        microTimer.innerText = sec + "s";
                        
                        let timerClass = (sec <= 10) ? "timer-line urgent" : "timer-line active";
                        let microClass = (sec <= 10) ? "micro-val urgent" : "micro-val active";
                        
                        timerEl.className = timerClass;
                        microTimer.className = microClass;
                    } else {
                        timerEl.innerText = "--";
                        microTimer.innerText = "--";
                        timerEl.className = "timer-line";
                        microTimer.className = "micro-val";
                    }

                    if (cleanStatus.toUpperCase().includes("DEBOARDING")) {
                        if (!hasCountedCurrent) {
                            STATE.completedRuns++;
                            hasCountedCurrent = true; 
                            updateAverages();
                        }
                    } else if ((cleanStatus.toUpperCase().includes("BOARDING") || cleanStatus.toUpperCase().includes("ROUTE")) && !cleanStatus.toUpperCase().includes("DEBOARDING")) {
                        hasCountedCurrent = false;
                    }
                }

                if (lines[1]) {
                    let destLine = cleanString(lines[1]).replace("Destination:", "").trim();
                    document.getElementById('disp-route-name').innerText = destLine;
                    document.getElementById('micro-dest').innerText = destLine.substring(0, 15); // Truncate for micro view
                }

                if (lines[2]) {
                    let distLine = cleanString(lines[2]).replace("Distance to destination:", "").trim();
                    document.getElementById('disp-dist').innerText = "Dist: " + distLine;
                }
            }
        } catch (e) {}
    }

    // 2. XP LOGIC
    let currentXP = data[JOB_EXP_KEY];
    if (typeof currentXP === 'number') {
        if (STATE.startXP === 0) { STATE.startXP = currentXP; STATE.currentXP = currentXP; } 
        else { STATE.currentXP = currentXP; STATE.sessionGain = currentXP - STATE.startXP; updateAverages(); }
        renderStats();
    }

    // 3. INVENTORY LOGIC
    if(data.chest && typeof data.chest === 'string' && data.chest.includes("veh_")) TRUNK_KEY = "chest_" + data.chest;
    
    if(data.inventory) {
        try { let inv = (typeof data.inventory === 'string') ? JSON.parse(data.inventory) : data.inventory; if(inv && Object.keys(inv).length > 0) MEMORY.inventory = inv; } catch(e){}
    }
    if(TRUNK_KEY && data[TRUNK_KEY]) {
        try { let trunk = (typeof data[TRUNK_KEY] === 'string') ? JSON.parse(data[TRUNK_KEY]) : data[TRUNK_KEY]; if(trunk && Object.keys(trunk).length > 0) MEMORY.trunk = trunk; } catch(e){}
    }
    
    let totalMeals = 0;
    if(MEMORY.inventory && MEMORY.inventory[ITEM_MEAL]) totalMeals += (MEMORY.inventory[ITEM_MEAL].amount || MEMORY.inventory[ITEM_MEAL] || 0);
    if(MEMORY.trunk && MEMORY.trunk[ITEM_MEAL]) totalMeals += (MEMORY.trunk[ITEM_MEAL].amount || MEMORY.trunk[ITEM_MEAL] || 0);
    
    const mealEl = document.getElementById('stock-meal');
    const mealRow = document.getElementById('row-meal');
    const microMeal = document.getElementById('micro-meal');
    
    mealEl.innerText = totalMeals;
    microMeal.innerText = totalMeals;
    
    if(totalMeals < 5) {
        mealRow.className = "inv-row low-stock";
        microMeal.className = "micro-val urgent";
    } else {
        mealRow.className = "inv-row";
        microMeal.className = "micro-val";
    }

    // 4. BXP LOGIC
    let bxp = data[JOB_BXP_KEY_A] || data[JOB_BXP_KEY_B];
    if (!bxp && MEMORY.inventory) bxp = MEMORY.inventory[JOB_BXP_KEY_A] || MEMORY.inventory[JOB_BXP_KEY_B];
    if (bxp) {
        let val = (typeof bxp === 'object') ? bxp.amount : bxp;
        document.getElementById('disp-bxp').innerText = formatNumber(val);
    }
}

function updateAverages() {
    if (STATE.completedRuns > 0) STATE.avgXP = STATE.sessionGain / STATE.completedRuns;
}

function cleanString(str) {
    if (!str) return "";
    return str.replace(/~[a-z]~/g, "").trim();
}

function renderStats() {
    const lvl = getLevelInfo(STATE.currentXP);
    document.getElementById('disp-xp').innerText = formatNumber(STATE.currentXP);
    document.getElementById('disp-level').innerText = lvl.level;
    
    const pct = getPercentValue(lvl.expInLevel, lvl.expForNext);
    document.getElementById('level-bar').style.width = pct + "%";
    document.getElementById('level-text').innerText = pct + "%";

    document.getElementById('disp-session-xp').innerText = formatNumber(STATE.sessionGain) + " XP";
    document.getElementById('disp-xp-drop').innerText = Math.round(STATE.avgXP) + " XP";
    document.getElementById('disp-drops').innerText = STATE.completedRuns;

    const needed = Math.round(lvl.expForNext - lvl.expInLevel);
    document.getElementById('disp-xp-remaining').innerHTML = `<b>${formatNumber(needed)}</b> XP to Next Level`;

    runCalculator();
}

function formatNumber(num) {
    if (num >= 1000000) return (num / 1000000).toFixed(2) + "M";
    if (num >= 1000) return (num / 1000).toFixed(1) + "K";
    return num.toLocaleString();
}

function getLevelInfo(exp) {
    let level = 0, xpCap = 5;
    while (exp >= xpCap) { exp -= xpCap; level++; xpCap = (level + 1) * 5; }
    return { level, expInLevel: exp, expForNext: xpCap };
}

function getPercentValue(exp, cap) {
    return Math.min(100, Math.max(0, ((exp / cap) * 100))).toFixed(1);
}

// --- CALCULATOR ---
const calcInput = document.getElementById('target-input');
if(calcInput) calcInput.addEventListener('input', runCalculator);

function setCalc(amount) {
    document.getElementById('target-input').value = amount;
    runCalculator();
}

function runCalculator() {
    const val = document.getElementById('target-input').value;
    const el = document.getElementById('calc-result');
    const microEl = document.getElementById('micro-calc');
    
    localStorage.setItem(STORAGE_KEY_CALC, val);

    if (STATE.completedRuns === 0) { 
        el.innerHTML = "<i>Complete 1 flight to calibrate...</i>"; 
        microEl.innerText = "Calibrating...";
        return; 
    }
    if (!val) { 
        el.innerText = "Enter target above."; 
        microEl.innerText = "Set Target";
        return; 
    }

    let inputVal = parseInt(val.replace(/,/g, ''));
    let targetXP = inputVal;
    
    if (inputVal < 200) { 
         let lvlXP = 0; 
         for(let i=0; i<inputVal; i++) lvlXP += (5 * i * (i + 1)) / 2;
         targetXP = (5 * inputVal * (inputVal + 1)) / 2;
    }

    if (targetXP > STATE.currentXP) {
        const diff = targetXP - STATE.currentXP;
        const avgDrop = (STATE.avgXP > 0) ? STATE.avgXP : 1; 
        const estDrops = Math.ceil(diff / avgDrop);
        el.innerHTML = `Remaining: <b>${formatNumber(diff)} XP</b><br><span style="color:var(--primary)">Est. Flights: <b>${formatNumber(estDrops)}</b></span>`;
        microEl.innerText = formatNumber(estDrops);
    } else {
        el.innerHTML = `Target reached.`;
        microEl.innerText = "Done";
    }
}

// --- DRAG HANDLER ---
let elmnt = document.getElementById("tracker-app");
let header = document.getElementById("drag-handle");
let microView = document.getElementById("micro-view");
let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;

header.onmousedown = dragMouseDown;
// microView is handled via inline onmousedown

function dragMouseDown(e) {
    if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
    e.preventDefault();
    pos3 = e.clientX;
    pos4 = e.clientY;
    document.onmouseup = closeDragElement;
    document.onmousemove = elementDrag;
}

function elementDrag(e) {
    e.preventDefault();
    pos1 = pos3 - e.clientX;
    pos2 = pos4 - e.clientY;
    pos3 = e.clientX;
    pos4 = e.clientY;
    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
}

function closeDragElement() {
    document.onmouseup = null;
    document.onmousemove = null;
}

// Resize handle logic remains similar if needed, but usually not for fixed/micro modes
const rh = document.getElementById('resize-handle');
if (rh) {
    rh.addEventListener('mousedown', (e) => {
        e.preventDefault();
        window.addEventListener('mousemove', resize);
        window.addEventListener('mouseup', stopResize);
    });
}
function resize(e) {
    if(elmnt.classList.contains('micro-mode')) return; // Disable resize in micro mode
    elmnt.style.width = Math.max(280, e.clientX - elmnt.getBoundingClientRect().left) + 'px';
    elmnt.style.height = Math.max(200, e.clientY - elmnt.getBoundingClientRect().top) + 'px';
}
function stopResize() {
    window.removeEventListener('mousemove', resize);
    window.removeEventListener('mouseup', stopResize);
}
</script>
</body>
</html>
