<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Trucking Ops v3.1</title>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        :root {
            --primary: #ff5722; 
            --primary-dim: #bf360c;
            --bg-glass: rgba(20, 10, 5, 0.95);
            --bg-dark: rgba(15, 5, 0, 0.98);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(255, 87, 34, 0.3);
            --green: #00e676;
            --red: #ff5252;
            --gold: #ffd700; 
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #tracker-app {
            position: absolute; top: 50px; left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            overflow: hidden;
            transition: width 0.2s ease, height 0.2s ease;
            min-height: 350px;
        }

        /* --- MINI MODE --- */
        #tracker-app.mini-mode {
            width: 460px !important; 
            height: 74px !important;
            min-height: 74px !important;
            border-radius: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--primary);
            resize: none;
        }
        #tracker-app.mini-mode header, 
        #tracker-app.mini-mode #manifest-panel,
        #tracker-app.mini-mode #content,
        #tracker-app.mini-mode #settings-panel,
        #tracker-app.mini-mode #grinder-panel { display: none !important; }

        #micro-view {
            display: none; flex-direction: column; justify-content: center;
            height: 100%; padding: 0 10px; font-family: 'Rajdhani', sans-serif; cursor: move;
        }
        #tracker-app.mini-mode #micro-view { display: flex; }

        /* Micro Rows */
        .micro-row { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 50%; gap: 5px; }
        .micro-group { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .micro-sep { width: 1px; height: 12px; background: rgba(255,255,255,0.2); }
        .micro-label { color: var(--text-dim); font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; }
        .micro-val { color: #fff; font-weight: 700; font-size: 0.9em; }
        .micro-val.highlight { color: var(--primary); }
        .micro-val.active { color: var(--green); }
        .micro-progress-bg { width: 50px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 0 5px; }
        .micro-progress-fill { height: 100%; background: var(--primary); width: 0%; }
        .micro-btn {
            position: absolute; top: 4px; right: 4px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #aaa; padding: 0px 4px; border-radius: 3px; 
            font-size: 0.6em; cursor: pointer; text-transform: uppercase; z-index: 99;
        }
        .micro-btn:hover { background: var(--primary); color: white; }

        /* --- HEADER --- */
        header {
            background: linear-gradient(180deg, var(--primary-dim), rgba(0, 0, 0, 0.8));
            padding: 8px 10px; cursor: move; border-bottom: 1px solid rgba(255,255,255,0.15);
            display: flex; flex-direction: column; gap: 6px; z-index: 60;
        }

        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.2em; text-transform: uppercase; color: #fff; }
        .mini-toggle-btn { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 0.8em; }
        .mini-toggle-btn:hover { background: var(--primary); border-color: var(--primary); }

        /* Recipe Controls */
        .recipe-control { 
            display: flex; justify-content: space-between; align-items: center; 
            background: rgba(0,0,0,0.3); padding: 4px 8px; border-radius: 4px; border: 1px solid rgba(255,255,255,0.1); 
        }
        .recipe-label { font-size: 0.7em; color: var(--text-dim); text-transform: uppercase; margin-right: 5px; }
        #recipe-select { 
            background: #222; color: white; border: 1px solid #444; 
            font-family: 'Rajdhani', sans-serif; font-weight: bold; padding: 2px; border-radius: 3px; cursor: pointer;
        }
        #active-recipe-display { color: var(--gold); font-weight: bold; font-size: 0.9em; }

        /* BURGER MENU */
        .menu-container { position: relative; }
        .burger-btn { background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 2px 8px; border-radius: 4px; cursor: pointer; }
        .dropdown-menu { 
            position: absolute; top: 100%; right: 0; width: 140px; 
            background: #111; border: 1px solid var(--primary); 
            display: none; flex-direction: column; z-index: 100;
        }
        .dropdown-menu.show { display: flex; }
        .menu-item { padding: 10px; border-bottom: 1px solid #333; cursor: pointer; font-size: 0.85em; }
        .menu-item:hover { background: var(--primary); color: #000; }

        /* --- MANIFEST PANEL (Expandable Box) --- */
        #manifest-panel {
            position: absolute; top: 90px; left: 0; width: 100%; height: calc(100% - 90px);
            background: rgba(15, 8, 5, 0.99); z-index: 50; display: none;
            flex-direction: column; padding: 10px; box-sizing: border-box;
            border-top: 1px solid var(--primary);
        }
        #manifest-panel.active { display: flex; }

        .panel-header { font-family: 'Rajdhani', sans-serif; color: var(--primary); border-bottom: 1px solid #333; margin-bottom: 10px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        
        .manifest-list { flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .manifest-item { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 0.9em; }
        .manifest-name { color: #ccc; }
        .manifest-count { font-weight: bold; font-family: 'Rajdhani', sans-serif; }
        .manifest-count.good { color: var(--green); }
        .manifest-count.bad { color: var(--red); }

        /* --- MAIN CONTENT --- */
        #content { padding: 10px; flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }

        .section { padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .label { font-size: 0.7em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }

        /* Progress Bar */
        .progress-container { position: relative; height: 14px; background: rgba(0,0,0,0.5); border-radius: 4px; margin: 4px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.65em; font-weight: bold; z-index: 2; text-shadow: 1px 1px 1px black; }

        /* Buttons */
        .action-btn { width: 100%; background: rgba(255, 87, 34, 0.2); border: 1px solid var(--primary); color: white; padding: 8px; font-family: 'Rajdhani', sans-serif; font-weight: bold; cursor: pointer; border-radius: 4px; margin-bottom: 5px; transition: 0.2s; }
        .action-btn:hover { background: var(--primary); color: black; }

        /* Stats Grid */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 5px; text-align: center; border-radius: 4px; }
        .stat-val { font-weight: bold; font-size: 1.1em; }

        /* Calculator */
        input[type="number"] { width: 95%; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 5px; margin-top: 5px; font-family: inherit; }
        .calc-result { font-size: 0.8em; color: var(--text-dim); margin-top: 5px; }

        /* OVERLAYS (Grinder & Settings) */
        .overlay-panel {
            position: absolute; top: 105px; left: 0; width: 100%; height: calc(100% - 105px);
            background: rgba(10, 5, 0, 0.98); z-index: 50; display: none; flex-direction: column; padding: 10px;
        }
        .overlay-panel.active { display: flex; }
        .overlay-header { color: var(--gold); border-bottom: 1px solid #333; font-weight: bold; margin-bottom: 10px; }
        
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 0.9em; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .api-input { width: 95%; margin-bottom: 10px; background: #222; border: 1px solid #444; color: #fff; padding: 5px; }

        #resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; }
    </style>
</head>
<body>

<div id="tracker-app">
    <div id="micro-view" onmousedown="dragStart(event)">
        <button class="micro-btn" onclick="toggleMini()">EXPAND</button>
        <div class="micro-row" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="micro-group"><span style="font-size:1.2em">üöõ</span><span class="micro-val highlight">RECIPE OPS</span></div>
            <div class="micro-group"><span class="micro-val" id="micro-recipe">Test 1</span></div>
        </div>
        <div class="micro-row">
            <div class="micro-group" style="width:100%">
                <span class="micro-label">Lvl</span><span class="micro-val highlight" id="micro-level">0</span>
                <div class="micro-progress-bg" style="flex:1"><div class="micro-progress-fill" id="micro-bar"></div></div>
            </div>
        </div>
        <div class="micro-row" style="padding-top:2px;">
            <div class="micro-group"><span class="micro-label">XP:</span><span class="micro-val" id="micro-xp">0</span></div>
            <div class="micro-group"><span class="micro-label">Tok:</span><span class="micro-val active" id="micro-tokens">0</span></div>
            <div class="micro-group"><span class="micro-label">Acts:</span><span class="micro-val highlight" id="micro-acts">0</span></div>
        </div>
    </div>

    <header id="drag-handle" onmousedown="dragStart(event)">
        <div class="header-top">
            <div style="flex:1">
                <div class="header-title">TRUCKING OPS</div>
                <div class="header-user" id="disp-name" style="font-size:0.8em; color:#aaa">Trucker ...</div>
            </div>
            <div style="text-align:right">
                <div id="clock" style="font-weight:bold; font-size:0.9em;">00:00</div>
                <div class="menu-container">
                    <button class="burger-btn" onclick="toggleMenu()">‚ò∞</button>
                    <div class="dropdown-menu" id="main-menu">
                        <div class="menu-item" onclick="toggleMini()">üóñ Mini Mode</div>
                        <div class="menu-item" onclick="toggleGrinder()">üìà Grinder Stats</div>
                        <div class="menu-item" onclick="toggleSettings()">‚öôÔ∏è API Settings</div>
                        <div class="menu-item" onclick="resetSession()">üîÑ Reset Session</div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="recipe-control">
            <div style="display:flex; align-items:center;">
                <span class="recipe-label">Plan:</span>
                <select id="recipe-select" onmousedown="event.stopPropagation()" onchange="changeRecipe()">
                    <option value="Test 1">Test 1</option>
                    <option value="Test 2">Test 2</option>
                    <option value="Test 3">Test 3</option>
                </select>
            </div>
            <div id="active-recipe-display">Test 1</div>
        </div>
    </header>

    <div id="manifest-panel">
        <div class="panel-header">
            <span>RECIPE MANIFEST</span>
            <span style="cursor:pointer; font-size:0.8em; color:#ccc;" onclick="toggleManifest()">CLOSE [X]</span>
        </div>
        <div style="font-size:0.75em; color:#aaa; margin-bottom:8px; border-bottom:1px solid #333; padding-bottom:4px;">
            COMBINED STORAGE (POCKET + TRUNK + API)
        </div>
        <div class="manifest-list" id="manifest-content">
            <div style="text-align:center; color:#666; margin-top:20px;">Scanning inventory...</div>
        </div>
    </div>

    <div id="content">
        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Trucking Level</div><div class="value highlight" id="disp-level">0</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>
            <div class="progress-container"><div class="progress-bar" id="level-bar"></div><div class="progress-text" id="level-text">0%</div></div>
        </div>

        <button class="action-btn" id="check-btn" onclick="checkStorage()">CHECK STORAGE (INV + TRUNK + API)</button>

        <div class="section">
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="label">Session BXP</div>
                    <div class="stat-val" style="color:var(--green)" id="disp-session">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Tokens</div>
                    <div class="stat-val" style="color:var(--gold)" id="disp-tokens">0</div>
                </div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Target XP Calculator</div>
            <input type="number" id="target-input" placeholder="Enter Target XP" onmousedown="event.stopPropagation()" oninput="runCalculator()">
            <div class="calc-result">
                Avg XP/Action: <span id="avg-xp" style="color:#fff">0</span><br>
                Potential Actions: <span id="est-actions" style="color:var(--primary); font-weight:bold; font-size:1.1em;">--</span>
            </div>
        </div>
    </div>

    <div id="grinder-panel" class="overlay-panel">
        <div class="overlay-header">TOKEN TRACKER (TRUCKING)</div>
        <div class="stat-row"><span>Session Earned</span><span class="micro-val" style="color:var(--gold)" id="g-session">0</span></div>
        <div class="stat-row"><span>AVG Per Hour</span><span class="micro-val" id="g-1h">0</span></div>
        <div class="stat-row"><span>AVG Per 6h</span><span class="micro-val" id="g-6h">0</span></div>
        <div class="stat-row"><span>AVG Per 12h</span><span class="micro-val" id="g-12h">0</span></div>
        <div class="stat-row"><span>AVG Per 24h</span><span class="micro-val" id="g-24h">0</span></div>
        
        <div class="overlay-header" style="margin-top:15px; color:var(--primary)">ACTIVE BONUSES</div>
        <div id="bonus-list" style="font-size:0.8em; color:#ccc;">Scanning...</div>
        
        <button class="action-btn" style="margin-top:auto;" onclick="toggleGrinder()">CLOSE</button>
    </div>

    <div id="settings-panel" class="overlay-panel">
        <div class="overlay-header">API SETTINGS</div>
        <div class="label">USER ID</div>
        <input type="text" id="setting-uid" class="api-input" placeholder="e.g. 757858">
        <div class="label">TYCOON API KEY</div>
        <input type="password" id="setting-key" class="api-input" placeholder="Paste Key Here">
        <button class="action-btn" onclick="saveSettings()">SAVE SETTINGS</button>
        <div style="font-size:0.7em; color:#666; margin-top:10px;">Use /api private new in-game to get a key.</div>
        <button class="action-btn" style="margin-top:auto;" onclick="toggleSettings()">CLOSE</button>
    </div>

    <div id="resize-handle"></div>
</div>

<script>
// --- HELPERS ---
function safeSetText(id, text) { const el = document.getElementById(id); if(el) el.innerText = text; }
function safeSetVal(id, val) { const el = document.getElementById(id); if(el) el.value = val; }

// --- CONFIGURATION (TRAILER CAPACITIES) ---
const TRAILER_CONFIG = {
  "trailerswb": 400, "trailers": 475, "trailerlogs2": 600, "botdumptr": 775,
  "drybulktr": 1000, "dumptr": 1500, "docktrailer2": 2200, "docktrailer": 2500,
  "trailers2": 2750, "trailerswb2": 3000, "tvtrailer": 3500, "tvtrailer2": 5000,
  "boxlongtr": 8500, "trailerlarge": 9000, "mk15": 6000
};

const RECIPES = {
    "Test 1": { "tcargologs": 1, "mechanicals_jumper_cable": 1 },
    "Test 2": { "defibkit": 1, "jerry_can|DIESEL|Petrol": 1 },
    "Test 3": { "spaceship_part": 1, "gut_knife_st|0": 1 } 
};

// --- STATE ---
const JOB_EXP_KEY = "exp_trucking_trucking";
const JOB_TOKEN_KEY = "exp_token|trucking|trucking"; // Physical
const JOB_BXP_KEY = "exp_token_a|trucking|trucking"; // Pool
const STORAGE_KEY_MINI = "tt_truck_recipe_mini";

let STATE = {
    currentRecipe: "Test 1",
    currentXP: 0,
    startXP: 0,
    sessionGain: 0,
    actionCount: 0, 
    inventory: {}, // Merged Inv + Trunk + API
    tokens: 0,
    startTokens: 0,
    bxp: 0,
    startTime: Date.now(),
    uid: localStorage.getItem("tt_uid") || "",
    apiKey: localStorage.getItem("tt_key") || ""
};

// --- INIT ---
const savedMini = localStorage.getItem(STORAGE_KEY_MINI);
if (savedMini === "true") document.getElementById('tracker-app').classList.add('mini-mode');
safeSetVal('recipe-select', STATE.currentRecipe);
if(STATE.uid) safeSetVal('setting-uid', STATE.uid);
if(STATE.apiKey) safeSetVal('setting-key', STATE.apiKey);

// --- FUNCTIONS ---
function toggleMini() {
    const app = document.getElementById('tracker-app');
    app.classList.toggle('mini-mode');
    localStorage.setItem(STORAGE_KEY_MINI, app.classList.contains('mini-mode'));
}

function toggleMenu() { document.getElementById('main-menu').classList.toggle('show'); }
function toggleGrinder() { 
    document.getElementById('grinder-panel').classList.toggle('active'); 
    document.getElementById('main-menu').classList.remove('show');
}
function toggleSettings() {
    document.getElementById('settings-panel').classList.toggle('active');
    document.getElementById('main-menu').classList.remove('show');
}
function toggleManifest() {
    document.getElementById('manifest-panel').classList.toggle('active');
}

function saveSettings() {
    STATE.uid = document.getElementById('setting-uid').value;
    STATE.apiKey = document.getElementById('setting-key').value;
    localStorage.setItem("tt_uid", STATE.uid);
    localStorage.setItem("tt_key", STATE.apiKey);
    toggleSettings();
    alert("Settings Saved!");
}

function changeRecipe() {
    const sel = document.getElementById('recipe-select');
    STATE.currentRecipe = sel.value;
    safeSetText('active-recipe-display', sel.value);
    safeSetText('micro-recipe', sel.value);
    safeSetText('req-name', sel.value);
    renderManifest(); 
}

// --- DATA PROCESSING ---
window.addEventListener('message', (event) => {
    let data = event.data;
    if (data.type === 'data') data = data.data;
    if (!data) return;

    // 1. XP Logic
    if (data[JOB_EXP_KEY]) {
        let xp = data[JOB_EXP_KEY];
        if (STATE.startXP === 0) { STATE.startXP = xp; STATE.currentXP = xp; }
        
        if (xp > STATE.currentXP) {
            STATE.actionCount++; 
            STATE.currentXP = xp;
            STATE.sessionGain = xp - STATE.startXP;
        }
        renderStats();
    }

    // 2. Inventory Merging (Local)
    let mergedInv = {};
    
    // Personal
    if (data.inventory) {
        try {
            let inv = (typeof data.inventory === 'string') ? JSON.parse(data.inventory) : data.inventory;
            for (let key in inv) {
                let amt = (typeof inv[key] === 'object') ? inv[key].amount : inv[key];
                mergedInv[key] = (mergedInv[key] || 0) + amt;
            }
        } catch(e) {}
    }

    // Trunk/Chest
    for (let key in data) {
        if (key.startsWith("chest")) {
            try {
                if (data[key] === "none" || !data[key]) continue;
                let chest = (typeof data[key] === 'string') ? JSON.parse(data[key]) : data[key];
                for (let itemKey in chest) {
                    let amt = (typeof chest[itemKey] === 'object') ? chest[itemKey].amount : chest[itemKey];
                    mergedInv[itemKey] = (mergedInv[itemKey] || 0) + amt;
                }
            } catch(e) {}
        }
    }
    
    // Store local inventory for now, API merge happens on button click
    STATE.localInventory = mergedInv;
    STATE.inventory = mergedInv; // Default to local
    
    // Tokens
    if (mergedInv[JOB_TOKEN_KEY]) {
        let t = mergedInv[JOB_TOKEN_KEY];
        if(STATE.startTokens === 0) STATE.startTokens = t;
        STATE.tokens = t;
        updateGrinderUI();
    }
    
    // Bonuses
    if(data.menu_choices) {
        try {
            let menu = JSON.parse(data.menu_choices);
            let id = menu.find(m => m[0] === 'Identity');
            if(id) parseBonus(id[1]);
        } catch(e){}
    }
    
    if(data.name) safeSetText('disp-name', "Trucker " + data.name);
    
    // If panel open, refresh (local only until button pressed)
    if(document.getElementById('manifest-panel').classList.contains('active')) {
        renderManifest();
    }
});

async function checkStorage() {
    const btn = document.getElementById('check-btn');
    
    if (!STATE.uid || !STATE.apiKey) {
        alert("Please set User ID and API Key in Settings first.");
        return;
    }

    btn.innerText = "FETCHING API DATA...";
    
    try {
        const response = await fetch(`https://ttycoon.eu/api/v1/playerdata/storages?id=${STATE.uid}`, {
            headers: { 'X-Tycoon-Key': STATE.apiKey }
        });
        
        if (response.ok) {
            const json = await response.json();
            // Merge API data with Local data
            let combined = { ...STATE.localInventory }; 
            
            // Iterate over API storage array
            if(json.data && Array.isArray(json.data)) {
                json.data.forEach(storage => {
                    if(storage.inventory) {
                        for (let itemKey in storage.inventory) {
                            let amt = storage.inventory[itemKey].amount || 0;
                            combined[itemKey] = (combined[itemKey] || 0) + amt;
                        }
                    }
                });
            }
            
            STATE.inventory = combined; // Update main state
            renderManifest();
            toggleManifest(); // Open the panel
            btn.innerText = "CHECK STORAGE (SUCCESS)";
            setTimeout(() => btn.innerText = "CHECK STORAGE (INV + TRUNK + API)", 2000);
        } else {
            throw new Error("API Error");
        }
    } catch (e) {
        console.error(e);
        btn.innerText = "API ERROR (CHECK CONSOLE)";
        setTimeout(() => btn.innerText = "CHECK STORAGE (INV + TRUNK + API)", 2000);
    }
}

function renderManifest() {
    const list = document.getElementById('manifest-content');
    if (!list) return;

    list.innerHTML = ""; 
    const requirements = RECIPES[STATE.currentRecipe];
    if (!requirements) return;

    for (let itemCode in requirements) {
        let have = STATE.inventory[itemCode] || 0;
        let niceName = itemCode.replace(/_/g, " ").toUpperCase();
        if(niceName.length > 25) niceName = niceName.substring(0, 22) + "...";

        let countClass = (have > 0) ? "good" : "bad";

        let row = document.createElement('div');
        row.className = 'manifest-item';
        row.innerHTML = `
            <span class="manifest-name">${niceName}</span>
            <span class="manifest-count ${countClass}">x${have}</span>
        `;
        list.appendChild(row);
    }
}

function updateGrinderUI() {
    let earned = STATE.tokens - STATE.startTokens;
    if(earned < 0) { STATE.startTokens = STATE.tokens; earned = 0; }
    
    safeSetText('g-session', earned);
    safeSetText('g-start', STATE.startTokens);
    safeSetText('disp-tokens', STATE.tokens.toLocaleString());
    safeSetText('micro-tokens', STATE.tokens.toLocaleString());
    safeSetText('disp-session', STATE.sessionGain.toLocaleString());
    safeSetText('micro-acts', STATE.actionCount);

    let mins = (Date.now() - STATE.startTime) / 60000;
    if(mins < 1) mins = 1;
    let rate = earned / mins;
    
    safeSetText('g-1h', Math.round(rate * 60));
    safeSetText('g-6h', Math.round(rate * 360));
    safeSetText('g-12h', Math.round(rate * 720));
    safeSetText('g-24h', Math.round(rate * 1440));
}

function parseBonus(html) {
    let lines = html.split(/<br\s*\/?>/i);
    let out = "";
    lines.forEach(l => {
        let t = l.replace(/<[^>]*>/g, "").replace(/&#(\d+);/g, (m,d)=>String.fromCharCode(d)).trim();
        if(t && (t.includes("Exp Bonus") || t.includes("Premium") || t.includes("Skill"))) {
            out += `<div>‚òÖ ${t}</div>`;
        }
    });
    document.getElementById('bonus-list').innerHTML = out;
}

function renderStats() {
    let xp = STATE.currentXP;
    let level = 0, cap = 5;
    while (xp >= cap) { xp -= cap; level++; cap = (level + 1) * 5; }
    
    safeSetText('disp-level', level);
    safeSetText('micro-level', level);
    safeSetText('disp-xp', STATE.currentXP.toLocaleString());
    safeSetText('micro-xp', STATE.currentXP.toLocaleString());
    
    let pct = Math.min(100, Math.max(0, (xp / cap) * 100)).toFixed(1);
    document.getElementById('level-bar').style.width = pct + "%";
    safeSetText('level-text', pct + "%");
    document.getElementById('xp-needed').innerText = Math.round(cap - xp) + " XP to Next Level";

    runCalculator();
}

function runCalculator() {
    const input = document.getElementById('target-input');
    if (!input.value) return;
    
    let target = parseInt(input.value);
    let avg = STATE.actionCount > 0 ? Math.round(STATE.sessionGain / STATE.actionCount) : 0;
    
    safeSetText('avg-xp', avg > 0 ? avg + " XP" : "Calibrating...");

    const actEl = document.getElementById('est-actions');
    if (avg > 0 && target > STATE.currentXP) {
        let diff = target - STATE.currentXP;
        let actions = Math.ceil(diff / avg);
        actEl.innerText = actions.toLocaleString() + " Runs";
    } else {
        actEl.innerText = "--";
    }
}

function resetSession() {
    STATE.startXP = STATE.currentXP;
    STATE.startTokens = STATE.tokens;
    STATE.startTime = Date.now();
    STATE.actionCount = 0;
    STATE.sessionGain = 0;
    document.getElementById('main-menu').classList.remove('show');
}

// Request Data Loop
setInterval(() => {
    if(window.parent) {
        window.parent.postMessage({ type: "getNamedData", keys: [JOB_EXP_KEY, "inventory", "chest", "name", "menu_choices"] }, "*");
        window.parent.postMessage({ type: "getData" }, "*");
    }
}, 1000);

// Clock
setInterval(() => {
    safeSetText('clock', new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}));
}, 1000);

// Drag
const h = document.getElementById("drag-handle");
let drag=false, sx, sy, lx, ly;
if(h) {
    h.addEventListener('mousedown', e => {
        if(e.target.tagName === 'SELECT' || e.target.tagName === 'BUTTON') return;
        drag=true; sx=e.clientX; sy=e.clientY;
        let r = document.getElementById('tracker-app').getBoundingClientRect();
        lx=r.left; ly=r.top;
        window.addEventListener('mousemove', mm);
        window.addEventListener('mouseup', mu);
    });
}
function mm(e) { if(drag) {
    let d = document.getElementById('tracker-app');
    d.style.left = (lx + e.clientX - sx) + 'px';
    d.style.top = (ly + e.clientY - sy) + 'px';
}}
function mu() { drag=false; window.removeEventListener('mousemove', mm); window.removeEventListener('mouseup', mu); }

const rh = document.getElementById('resize-handle');
rh.addEventListener('mousedown', (e) => {
    e.preventDefault();
    window.addEventListener('mousemove', resize);
    window.addEventListener('mouseup', stopResize);
});
function resize(e) {
    const elm = document.getElementById('tracker-app');
    if(elm.classList.contains('mini-mode')) return;
    elm.style.width = Math.max(280, e.clientX - elm.getBoundingClientRect().left) + 'px';
    elm.style.height = Math.max(250, e.clientY - elm.getBoundingClientRect().top) + 'px';
}
function stopResize() {
    window.removeEventListener('mousemove', resize);
    window.removeEventListener('mouseup', stopResize);
}

</script>
</body>
</html>
