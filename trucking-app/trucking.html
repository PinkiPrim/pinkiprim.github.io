<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Trucking Ops v3.8</title>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');
        :root {
            --primary: #ff5722; --primary-dim: #bf360c;
            --bg-glass: rgba(18, 18, 18, 0.96); --bg-dark: rgba(10, 5, 2, 0.98);
            --text-main: #ffffff; --text-dim: #aaaaaa;
            --border: 1px solid rgba(255, 87, 34, 0.4);
            --green: #00e676; --orange: #ff9800; --red: #ff5252; --gold: #ffd700; 
        }
        body { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background-color: transparent; color: var(--text-main); overflow: hidden; height: 100vh; width: 100vw; user-select: none; }
        #tracker-app { position: absolute; top: 50px; left: 50px; width: 340px; background: var(--bg-glass); border: var(--border); border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.9); display: flex; flex-direction: column; overflow: hidden; min-height: 520px; transition: width 0.2s, height 0.2s; }
        
        #tracker-app.mini-mode { width: 460px !important; height: 74px !important; min-height: 74px !important; border-radius: 12px; background: var(--bg-dark); border: 1px solid var(--primary); resize: none; }
        #tracker-app.mini-mode header, #tracker-app.mini-mode .plan-row, #tracker-app.mini-mode #content, #tracker-app.mini-mode .overlay-panel { display: none !important; }
        #micro-view { display: none; flex-direction: column; justify-content: center; height: 100%; padding: 0 12px; font-family: 'Rajdhani', sans-serif; cursor: move; }
        #tracker-app.mini-mode #micro-view { display: flex; }
        .micro-row { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 50%; gap: 5px; }
        .micro-group { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .micro-val { color: #fff; font-weight: 700; font-size: 0.95em; }
        .micro-val.highlight { color: var(--primary); }
        .micro-progress-bg { width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 0 5px; }
        .micro-progress-fill { height: 100%; background: var(--primary); width: 0%; }

        header { background: linear-gradient(180deg, var(--primary-dim), rgba(0, 0, 0, 0.85)); height: 65px; padding: 0 10px; cursor: move; position: relative; display: flex; align-items: flex-start; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.15); overflow: visible; padding-top: 5px; z-index: 60; }
        .header-title { position: absolute; left: 50%; top: 25%; transform: translate(-50%, -50%); font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.3em; text-transform: uppercase; letter-spacing: 2px; color: #fff; pointer-events: none; text-shadow: 0 2px 4px rgba(0,0,0,0.6); z-index: 10; }
        #user-name-fly { position: absolute; top: 38px; left: -150px; font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.95em; color: #fff; white-space: nowrap; pointer-events: none; z-index: 10; text-shadow: 0 0 8px var(--primary); animation: flyCycle 18s linear infinite; }
        @keyframes flyCycle { 0% { left: -150px; transform: translateX(0); opacity: 0; } 10% { left: 50%; transform: translateX(-50%); opacity: 1; } 90% { left: 50%; transform: translateX(-50%); opacity: 1; } 100% { left: 125%; transform: translateX(0); opacity: 0; } }
        .nav-icon { text-decoration: none; font-size: 1.2em; cursor: pointer; color: #ccc; margin-top: 5px; }
        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #fff; font-size: 0.9em; margin-top: 5px; }
        .burger-btn { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 3px 7px; border-radius: 4px; cursor: pointer; font-size: 1.1em; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 5px; background: #0f0f0f; border: 1px solid var(--primary); border-radius: 4px; width: 150px; display: none; flex-direction: column; z-index: 100; box-shadow: 0 8px 16px rgba(0,0,0,1); }
        .dropdown-menu.show { display: flex; }
        .menu-item { padding: 12px; color: #ddd; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 0.95em; border-bottom: 1px solid #222; }
        .menu-item:hover { background: var(--primary); color: #000; font-weight: bold; }
        
        .plan-row { background: #141414; padding: 8px 12px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; }
        .plan-label { font-family: 'Rajdhani', sans-serif; font-size: 0.85em; color: var(--primary); font-weight: 800; text-transform: uppercase; }
        #recipe-select { background: #000; color: white; border: 1px solid #444; font-family: 'Rajdhani', sans-serif; font-weight: bold; padding: 4px; width: 190px; border-radius: 3px; font-size: 0.85em; }

        #content { padding: 12px; flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .section { padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 12px; }
        .label { font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .value { font-size: 1.2em; font-weight: 800; }
        .highlight { color: var(--primary); }

        .progress-container { position: relative; height: 16px; background: rgba(0,0,0,0.6); border-radius: 4px; margin: 6px 0; overflow: hidden; border: 1px solid #333; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary-dim), var(--primary)); width: 0%; transition: width 0.4s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 900; z-index: 2; text-shadow: 1px 1px 2px black; }

        .cargo-item { background: rgba(255,255,255,0.02); border-left: 3px solid var(--primary-dim); margin-bottom: 6px; padding: 6px 10px; }
        .cargo-main { display: flex; justify-content: space-between; font-family: 'Rajdhani', sans-serif; font-weight: 800; }
        .cargo-locs { font-size: 0.75em; color: #888; margin-top: 4px; border-top: 1px solid #222; padding-top: 4px; }
        .loc-row { display: flex; justify-content: space-between; padding: 1px 0; }
        .loc-qty { color: var(--primary); font-weight: bold; }

        .action-btn { width: 100%; background: rgba(216, 67, 21, 0.15); border: 1px solid var(--primary); color: #fff; padding: 10px; font-family: 'Rajdhani', sans-serif; font-weight: 800; cursor: pointer; border-radius: 4px; margin: 8px 0; text-transform: uppercase; }
        .action-btn:hover { background: var(--primary); color: #000; box-shadow: 0 0 10px var(--primary-dim); }
        .overlay-panel { position: absolute; top: 65px; left: 0; width: 100%; height: calc(100% - 65px); background: #0a0a0a; z-index: 80; display: none; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .overlay-panel.active { display: flex; }
        .panel-title { font-family: 'Rajdhani', sans-serif; font-weight: 900; color: var(--gold); border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 15px; text-transform: uppercase; display: flex; justify-content: space-between; }
        .stat-row-g { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; border-bottom: 1px solid #222; padding-bottom: 5px; }

        #resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 100; }
    </style>
</head>
<body>

<div id="tracker-app">
    <div id="micro-view" onmousedown="dragStart(event)">
        <div class="micro-row">
            <span class="micro-group">üöõ <span class="micro-val highlight">TRUCK OPS</span></span>
            <span class="micro-val" id="micro-recipe">--</span>
        </div>
        <div class="micro-row">
            <span class="micro-group">LVL <span class="micro-val highlight" id="micro-lvl">0</span> <div class="micro-progress-bg"><div class="micro-progress-fill" id="micro-bar"></div></div></span>
            <span class="micro-val">XP <span id="micro-xp">0</span></span>
        </div>
        <button class="micro-btn" style="position:absolute; top:2px; right:2px;" onclick="toggleMini()">üóñ</button>
    </div>

    <header id="drag-handle">
        <div class="header-controls"><a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon">üè†</a></div>
        <div class="header-title">TRUCKING OPS</div>
        <div id="user-name-fly">Driver ...</div>
        <div class="header-controls" style="flex-direction:column; gap:0; align-items:flex-end;">
            <div class="menu-container">
                <button class="burger-btn" onclick="toggleMenu()">‚ò∞</button>
                <div class="dropdown-menu" id="main-menu">
                    <div class="menu-item" onclick="toggleMini()">üóñ Mini Mode</div>
                    <div class="menu-item" onclick="toggleGrinder()">üìà Grinder Stats</div>
                    <div class="menu-item" onclick="toggleSettings()">‚öôÔ∏è API Settings</div>
                    <div class="menu-item" onclick="resetSession()">üîÑ Reset Session</div>
                </div>
            </div>
            <span id="clock">00:00</span>
        </div>
    </header>

    <div class="plan-row">
        <span class="plan-label">PLAN:</span>
        <select id="recipe-select" onchange="changeRecipe()"></select>
    </div>

    <div id="content">
        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Trucking Level</div><div class="value highlight" style="font-size:1.8em" id="disp-lvl">0</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>
            <div class="progress-container"><div class="progress-bar" id="level-bar"></div><div class="progress-text" id="level-text">0%</div></div>
            <div id="xp-needed" style="text-align:center; font-size:0.8em; color:var(--primary); font-weight:bold;"></div>
        </div>

        <div class="section">
            <div class="label" style="color:var(--primary)">CARGO LOG (MANIFEST)</div>
            <div id="cargo-log-list"><div style="text-align:center; color:#444; padding:10px;">Select a plan...</div></div>
            <button class="action-btn" id="api-btn" onclick="fetchStorages()">üì¶ CHECK STORAGE (INV+TRUNK+API)</button>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Target XP Calculator</div>
            <input type="number" id="target-input" placeholder="Enter Target XP" oninput="runCalculator()">
            <div class="calc-result">Potential Actions To Target XP: <span id="est-actions" style="color:var(--primary); font-weight:bold;">--</span></div>
        </div>
    </div>

    <div id="grinder-panel" class="overlay-panel">
        <div class="panel-title"><span>TOKEN TRACKER</span><span style="font-size:0.6em; color:#888;">PHYSICAL</span></div>
        <div id="bxp-rows"></div>
        <div class="panel-title" style="margin-top:15px; color:var(--primary)">ACTIVE BONUSES</div>
        <div id="bonus-list" style="font-size:0.85em; color:#ccc;"></div>
        <button class="action-btn" style="margin-top:auto;" onclick="toggleGrinder()">CLOSE</button>
    </div>

    <div id="settings-panel" class="overlay-panel">
        <div class="panel-title">API SETTINGS</div>
        <div class="label">USER ID</div><input type="text" id="api-uid" placeholder="e.g. 757858">
        <div class="label" style="margin-top:10px">API KEY</div><input type="password" id="api-key" placeholder="Tycoon API Key">
        <button class="action-btn" onclick="saveSettings()">SAVE SETTINGS</button>
        <button class="action-btn" style="margin-top:auto;" onclick="toggleSettings()">CLOSE</button>
    </div>
</div>

<script>
// --- FULL DATA MANIFEST ---
const ITEM_DB = {
    "tcargologs": "Logs", "mechanicals_jumper_cable": "Jumper Cable", "defibkit": "Defibrillator Kit", "jerry_can|DIESEL|Petrol": "Jerry Can (Petrol)", "spaceship_part": "Spaceship Part", "gut_knife_st": "StatTrak Gut Knife", "scrap_acid": "Acid", "fridge_airline_meal": "Airline Meal", "petrochem_asphalt": "Asphalt Concrete", "backpack": "Backpack", "engine_bag": "Bag-o-Engines", "bandages": "Bandage", "crafted_batteries": "Batteries", "mechanicals_battery": "Car Battery", "crafted_cardboard": "Cardboard", "crafted_cement": "Cement Mix", "crafted_ceramictiles": "Ceramic Tiles", "mechanicals_chassis": "Chassis", "military_chemicals": "Chemicals", "crafted_circuit": "Circuit Boards", "crafted_computer": "Computers", "crafted_concrete": "Concrete", "mining_copper": "Copper Ore", "crafted_copperwire": "Copper Wire Spool", "petrochem_oil": "Crude Oil", "petrochem_diesel": "Diesel", "tcargosmall": "Erasers", "military_explosives": "Explosives", "crafted_fiberglass": "Fiberglass Spool", "refined_flint": "Flint", "refined_glass": "Glass", "scrap_gravel": "Gravel", "mining_iron": "Iron Ore", "petrochem_kerosene": "Kerosene", "petrochem_petrol": "Petrol", "refined_planks": "Planks", "petrochem_propane": "Propane", "recycled_rubble": "Quarry Rubble", "scrap_emerald": "Raw Emeralds", "petrochem_gas": "Raw Gas", "scrap_ore": "Raw Ore Mix", "crafted_rebar": "Rebar", "recycled_electronics": "Recycled Electronics", "recycled_trash": "Recycled Trash", "refined_aluminum": "Refined Aluminum", "refined_amalgam": "Refined Amalgam", "refined_bronze": "Refined Bronze Alloy", "refined_copper": "Refined Copper", "refined_gold": "Refined Gold", "refined_solder": "Refined Solder", "refined_tin": "Refined Tin", "refined_zinc": "Refined Zinc", "mechanicals_rubber": "Rubber", "refined_sand": "Sand", "tcargodust": "Sawdust", "scrap_aluminum": "Scrap Aluminum", "scrap_copper": "Scrap Copper", "scrap_gold": "Scrap Gold", "scrap_lead": "Scrap Lead", "scrap_mercury": "Scrap Mercury", "scrap_plastic": "Scrap Plastic", "scrap_tin": "Scrap Tin", "shipping_crate_empty": "Shipping Container", "petrochem_sulfur": "Sulfur", "military_titanium": "Titanium", "military_titanium_ore": "Titanium Ore", "pucargosmall": "Tools", "recycled_waste": "Toxic Waste", "mechanicals_battery_evb": "Traction Battery", "liquid_water": "Treated Water", "liquid_water_raw": "Unfiltered Water", "mechanicals_vehicle_framework": "Vehicle Framework", "petrochem_waste": "Waste Water", "mechanicals_wheels": "Wheels"
};

const RECIPE_DB = [
    { name: "Alamo: Sell Fish", items: ["fish_meat", "fish_meat_premium"] },
    { name: "CollinsCo: Boat Vouchers", items: ["collinsco_boat_voucher"] },
    { name: "House Construction", items: ["crafted_copperwire", "crafted_rebar", "crafted_concrete", "refined_planks", "crafted_ceramictiles", "crafted_computer"] },
    { name: "EMS: Defib Charging", items: ["e_defibkit", "defibkit"] },
    { name: "Illegal: Pill Crafting", items: ["illegal_meth", "illegal_crate", "pills"] },
    { name: "Illegal: Defib Charging", items: ["scrap_plastic", "e_defibkit"] },
    { name: "Log Collection", items: ["tcargologs"] },
    { name: "Construction Site Delivery", items: ["petrochem_asphalt", "crafted_rebar", "crafted_concrete"] },
    { name: "Refinery: Crude Oil", items: ["petrochem_oil", "petrochem_diesel", "petrochem_petrol", "petrochem_kerosene"] },
    { name: "Refinery: Asphalt/Gas", items: ["petrochem_oil", "scrap_gravel", "petrochem_gas", "military_chemicals", "petrochem_propane"] },
    { name: "Filtering: Concrete/Ore", items: ["liquid_water", "crafted_cement", "mining_token_copper", "mining_token_iron", "scrap_emerald", "scrap_ore", "scrap_gravel"] },
    { name: "Filtering: Waste/Gravel", items: ["recycled_waste", "scrap_mercury", "scrap_lead", "scrap_acid", "scrap_gravel", "refined_sand", "refined_flint", "recycled_rubble"] },
    { name: "Fridgit: Airline Meals", items: ["fridge_meat", "fridge_veggies", "fridge_dairy", "fridge_airline_meal", "fridge_store_delivery"] },
    { name: "Electronics Store", items: ["crafted_copperwire", "refined_solder", "recycled_electronics", "crafted_fiberglass", "refined_amalgam", "crafted_circuit"] },
    { name: "Vehicle Parts Factory", items: ["refined_amalgam", "refined_glass", "mechanicals_chassis", "crafted_circuit", "mechanicals_battery", "mechanicals_wheels", "crafted_fiberglass", "petrochem_kerosene", "mechanicals_vehicle_framework"] }
];

let STATE = {
    planIdx: 0, xp: 0, startXp: 0, actions: 0, tok: 0, startTok: 0, startT: Date.now(),
    localInv: {}, apiInv: {}, uid: localStorage.getItem("tt_uid_t") || "", key: localStorage.getItem("tt_key_t") || ""
};

function init() {
    const sel = document.getElementById('recipe-select');
    RECIPE_DB.forEach((r, i) => sel.innerHTML += `<option value="${i}">${r.name}</option>`);
    if(STATE.uid) document.getElementById('api-uid').value = STATE.uid;
    if(STATE.key) document.getElementById('api-key').value = STATE.key;
    updateStats();
    renderCargo();
}

function toggleMenu() { document.getElementById('main-menu').classList.toggle('show'); }
function toggleGrinder() { document.getElementById('grinder-panel').classList.toggle('active'); toggleMenu(); }
function toggleSettings() { document.getElementById('settings-panel').classList.toggle('active'); toggleMenu(); }
function toggleMini() { document.getElementById('tracker-app').classList.toggle('mini-mode'); toggleMenu(); }

function saveSettings() {
    STATE.uid = document.getElementById('api-uid').value;
    STATE.key = document.getElementById('api-key').value;
    localStorage.setItem("tt_uid_t", STATE.uid);
    localStorage.setItem("tt_key_t", STATE.key);
    document.getElementById('settings-panel').classList.remove('active');
}

function changeRecipe() {
    STATE.planIdx = document.getElementById('recipe-select').value;
    document.getElementById('micro-recipe').innerText = RECIPE_DB[STATE.planIdx].name;
    renderCargo();
}

window.addEventListener('message', (event) => {
    let data = event.data.type === 'data' ? event.data.data : event.data;
    if (!data) return;
    if (data.name) document.getElementById('user-name-fly').innerText = "Driver " + data.name;
    
    if (data["exp_trucking_trucking"]) {
        let val = data["exp_trucking_trucking"];
        if (STATE.startXp === 0) STATE.startXp = val;
        if (val > STATE.xp && STATE.xp !== 0) STATE.actions++;
        STATE.xp = val;
        updateUI();
    }

    let merged = {};
    const proc = (raw, label) => {
        if(!raw) return;
        let obj = (typeof raw === 'string') ? JSON.parse(raw) : raw;
        for(let k in obj) {
            let qty = obj[k].amount || obj[k];
            if(!merged[k]) merged[k] = [];
            merged[k].push({ loc: label, qty: qty });
        }
    };
    proc(data.inventory, "Pocket");
    proc(data.backpack, "Backpack");
    for(let k in data) if(k.startsWith("chest") && data[k] !== "none") proc(data[k], "Vehicle/Storage");
    STATE.localInv = merged;

    if (merged["exp_token|trucking|trucking"]) {
        let t = merged["exp_token|trucking|trucking"].reduce((a,b)=>a+b.qty,0);
        if (STATE.startTok === 0) STATE.startTok = t;
        STATE.tok = t;
        updateGrinder();
    }
    if(data.menu_choices) {
        try {
            let id = JSON.parse(data.menu_choices).find(m => m[0] === 'Identity');
            if(id) parseBonuses(id[1]);
        } catch(e){}
    }
    renderCargo();
});

async function fetchStorages() {
    if(!STATE.uid || !STATE.key) return alert("API Config missing in settings!");
    const btn = document.getElementById('api-btn');
    btn.innerText = "‚ö° BATCH SCANNING ALL LOCATIONS...";
    try {
        const res = await fetch(`https://ttycoon.eu/api/v1/playerdata/storages?id=${STATE.uid}`, { headers: { 'X-Tycoon-Key': STATE.key } });
        const json = await res.json();
        if(json.code == "200") {
            STATE.apiInv = {};
            json.data.forEach(s => {
                for(let k in s.inventory) {
                    if(!STATE.apiInv[k]) STATE.apiInv[k] = [];
                    STATE.apiInv[k].push({ loc: s.displayName || s.name, qty: s.inventory[k].amount });
                }
            });
            btn.innerText = "‚úÖ ALL STORAGES SYNCED";
        }
    } catch(e) { btn.innerText = "‚ùå API CONNECTION ERROR"; }
    setTimeout(() => btn.innerText = "üì¶ CHECK STORAGE (INV+TRUNK+API)", 3000);
}

function renderCargo() {
    let html = "";
    let reqs = RECIPE_DB[STATE.planIdx].items;
    reqs.forEach(k => {
        let local = STATE.localInv[k] || [];
        let remote = STATE.apiInv[k] || [];
        let total = local.reduce((a,b)=>a+b.qty,0) + remote.reduce((a,b)=>a+b.qty,0);
        html += `<div class="cargo-item"><div class="cargo-main"><span>${(ITEM_DB[k] || k).toUpperCase()}</span><span style="color:${total > 0 ? 'var(--green)' : 'var(--red)'}">${total}</span></div><div class="cargo-locs">`;
        [...local, ...remote].forEach(d => html += `<div class="loc-row"><span>${d.loc}</span><span class="loc-qty">${d.qty}</span></div>`);
        if(total === 0) html += `<div>Missing from all locations</div>`;
        html += `</div></div>`;
    });
    document.getElementById('cargo-log-list').innerHTML = html;
}

function updateUI() {
    let x = STATE.xp, c = 5, l = 0;
    while (x >= c) { x -= c; l++; c = (l + 1) * 5; }
    document.getElementById('disp-lvl').innerText = l;
    document.getElementById('micro-lvl').innerText = l;
    document.getElementById('disp-xp').innerText = STATE.xp.toLocaleString();
    document.getElementById('micro-xp').innerText = STATE.xp.toLocaleString();
    let p = (x/c*100).toFixed(1);
    document.getElementById('level-bar').style.width = p + "%";
    document.getElementById('level-text').innerText = p + "%";
    document.getElementById('micro-bar').style.width = p + "%";
    document.getElementById('xp-needed').innerText = Math.round(c - x).toLocaleString() + " XP to Next Level";
    runCalculator();
}

function updateGrinder() {
    let e = STATE.tok - STATE.startTok;
    const set = (id, val) => document.getElementById(id).innerText = Math.round(val).toLocaleString();
    let r = e / ((Date.now() - STATE.startT) / 60000 || 1);
    document.getElementById('g-session').innerText = e.toLocaleString();
    document.getElementById('micro-tok').innerText = e.toLocaleString();
    set('bxp-rows', ''); // Clear and rebuild
    let html = `
        <div class="stat-row-g"><span>Session Earned</span><span class="highlight">${e}</span></div>
        <div class="stat-row-g"><span>AVG Per Hour</span><span>${Math.round(r*60)}</span></div>
        <div class="stat-row-g"><span>AVG Per 6h</span><span>${Math.round(r*360)}</span></div>
        <div class="stat-row-g"><span>AVG Per 12h</span><span>${Math.round(r*720)}</span></div>
        <div class="stat-row-g"><span>AVG Per 24h</span><span>${Math.round(r*1440)}</span></div>
    `;
    document.getElementById('bxp-rows').innerHTML = html;
}

function parseBonuses(h) {
    let out = "";
    h.split(/<br\s*\/?>/i).forEach(l => {
        let t = l.replace(/<[^>]*>/g, "").replace(/&#(\d+);/g, (m,d)=>String.fromCharCode(d)).trim();
        if(t && (t.includes("Bonus") || t.includes("Premium") || t.includes("Skill"))) out += `<div>‚òÖ ${t}</div>`;
    });
    document.getElementById('bonus-list').innerHTML = out;
}

function runCalculator() {
    let t = parseInt(document.getElementById('target-input').value);
    if (!t || STATE.actions === 0) return;
    let avg = (STATE.xp - STATE.startXp) / STATE.actions;
    let diff = t - STATE.xp;
    document.getElementById('est-actions').innerText = diff > 0 ? Math.ceil(diff/avg).toLocaleString() + " Actions" : "TARGET REACHED";
}

function resetSession() { STATE.startXp = STATE.xp; STATE.actions = 0; STATE.startTok = STATE.tok; STATE.startT = Date.now(); toggleMenu(); }

setInterval(() => {
    if(window.parent) window.parent.postMessage({ type: "getNamedData", keys: [EXP_KEY, "inventory", "chest", "backpack", "name", "menu_choices"] }, "*");
    document.getElementById('clock').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit', hour12:true});
}, 1000);

const dH = document.getElementById("drag-handle");
let dr=false, sx, sy, ox, oy;
dH.onmousedown = e => { if(e.target.tagName==='SELECT'||e.target.tagName==='BUTTON')return; dr=true; sx=e.clientX; sy=e.clientY; let r=document.getElementById('tracker-app').getBoundingClientRect(); ox=r.left; oy=r.top; };
window.onmousemove = e => { if(dr){ let a=document.getElementById('tracker-app'); a.style.left=(ox+e.clientX-sx)+'px'; a.style.top=(oy+e.clientY-sy)+'px'; }};
window.onmouseup = () => dr=false;

init();
</script>
</body>
</html>
