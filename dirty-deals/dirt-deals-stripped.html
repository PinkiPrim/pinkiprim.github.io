<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dirty Deals - Brick 2</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --accent: #5e6bf6; 
            --bg-glass: #121212;
            --border: 1px solid #333;
            --text-main: #ffffff;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
        }

        #app-container {
            position: absolute; top: 50px; left: 50px;
            width: 850px; height: 600px; 
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.95);
            display: flex; flex-direction: column;
            overflow: hidden; z-index: 1000;
        }

        /* --- LOADING OVERLAY --- */
        #loading-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #121212; z-index: 5000;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            transition: opacity 0.5s ease;
        }
        .spinner {
            border: 4px solid rgba(255,255,255,0.1);
            border-left-color: var(--accent);
            border-radius: 50%;
            width: 50px; height: 50px;
            animation: spin 0.8s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loading-text { font-family: 'Rajdhani', sans-serif; font-size: 1.5em; color: #fff; letter-spacing: 1px; }

        /* --- HEADER --- */
        header {
            background: #181818; padding: 0 20px;
            cursor: move; display: flex; justify-content: space-between;
            align-items: center; border-bottom: var(--border);
            font-family: 'Rajdhani', sans-serif; text-transform: uppercase;
            letter-spacing: 1px; font-weight: 700; height: 60px;
        }

        #main-content { 
            flex: 1; display: flex; justify-content: center; align-items: center; 
            color: #555; font-family: monospace;
        }
    </style>
</head>
<body>

<div id="app-container">
    <div id="loading-overlay">
        <div class="spinner"></div>
        <div class="loading-text" id="status-text">CONNECTING...</div>
    </div>

    <header id="drag-handle">
        <span style="display:flex; align-items:center; gap:10px;">
            <img src="https://files.catbox.moe/u9bulk.png" alt="Logo" style="height: 35px; width: auto;">
            <span>Dirty Deals</span>
        </span>
        
        <div style="text-align:right;">
            <div id="username-display" style="font-size:0.9em; color:#fff;">...</div>
            <div id="userid-display" style="font-size:0.7em; color:#555;">ID: --</div>
        </div>
    </header>

    <div id="main-content">
        UI Shell Loaded. Waiting for ID...
    </div>
</div>

<script>
    // --- THIS IS THE EXACT LOGIC FROM THE WORKING TEST SCRIPT ---
    
    window.addEventListener('message', function(event) {
        var payload = event.data;

        // 1. Unwrap if nested
        if (payload && payload.type === 'data' && payload.data) {
            payload = payload.data;
        }

        // 2. Validate
        if (!payload) return;

        // 3. Extract Name
        var username = "Unknown";
        if (payload.name) username = payload.name;
        else if (payload.player && payload.player.name) username = payload.player.name;
        else if (typeof payload.player === 'string') username = payload.player;

        // 4. Extract ID
        var userId = "0";
        if (payload.user_id) userId = String(payload.user_id);
        else if (payload.player_id) userId = String(payload.player_id);
        else if (payload.id) userId = String(payload.id);

        // 5. Success Check -> UPDATE UI
        if (userId !== "0") {
            updateInterface(username, userId);
        }
    });

    function updateInterface(name, id) {
        // Update Header
        document.getElementById('username-display').innerText = name;
        document.getElementById('userid-display').innerText = "ID: " + id;
        
        // Remove Loader
        var overlay = document.getElementById('loading-overlay');
        if(overlay && overlay.style.opacity !== '0') {
            overlay.style.opacity = '0';
            setTimeout(() => { overlay.style.display = 'none'; }, 500);
        }
        
        document.getElementById('main-content').innerText = "CONNECTION SUCCESSFUL.\nNext Step: Add Grid.";
    }

    // --- TRIGGER REQUEST (SAME AS TEST) ---
    function requestData() {
        if(window.parent) {
            window.parent.postMessage({ type: "getNamedData", keys: ["name", "user_id"] }, "*");
        }
    }

    // Start immediately and poll just like the test script
    requestData();
    setInterval(requestData, 1000);

    // --- DRAG LOGIC (Safe to keep) ---
    var elmnt = document.getElementById("app-container");
    var handle = document.getElementById("drag-handle");
    var pos1=0, pos2=0, pos3=0, pos4=0;
    handle.onmousedown = function(e) { e.preventDefault(); pos3=e.clientX; pos4=e.clientY; document.onmouseup=closeDrag; document.onmousemove=elmDrag; };
    function elmDrag(e) { e.preventDefault(); pos1=pos3-e.clientX; pos2=pos4-e.clientY; pos3=e.clientX; pos4=e.clientY; elmnt.style.top=(elmnt.offsetTop-pos2)+"px"; elmnt.style.left=(elmnt.offsetLeft-pos1)+"px"; }
    function closeDrag() { document.onmouseup=null; document.onmousemove=null; }
</script>
</body>
</html>
