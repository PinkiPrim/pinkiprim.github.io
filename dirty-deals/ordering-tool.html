<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Dirty Deals Tool</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&family=Roboto:wght@400;700&display=swap');

        :root {
            --accent: #5e6bf6; 
            --accent-hover: #4b56c4;
            --bg-glass: #121212;
            --bg-card: #1e1e1e;
            --border: 1px solid #333;
            --text-main: #ffffff;
            --text-dim: #888888;
        }

        * { box-sizing: border-box; user-select: none; }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
        }

        /* --- DRAGGABLE CONTAINER --- */
        #app-container {
            position: absolute;
            top: 50px; left: 50px;
            width: 760px; 
            height: 580px; /* Slight height increase for comfort */
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 15px 50px rgba(0,0,0,0.95);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }

        /* --- HEADER --- */
        header {
            background: #181818;
            padding: 15px 20px;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: var(--border);
            font-family: 'Rajdhani', sans-serif;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            height: 60px;
            flex-shrink: 0;
        }

        /* --- LAYOUT --- */
        #main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* LEFT: ITEM GRID */
        .selection-area {
            flex: 2;
            padding: 20px;
            overflow-y: auto;
            border-right: var(--border);
            background: #141414;
        }
        
        .section-title {
            color: var(--text-main);
            font-size: 1.1em;
            margin-bottom: 15px;
            font-family: 'Rajdhani', sans-serif;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            padding-bottom: 20px;
        }

        .grid-item {
            background: var(--bg-card);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 6px;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
            height: 110px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        .grid-item:hover { 
            background: rgba(255,255,255,0.08); 
            transform: translateY(-2px);
        }
        
        .grid-item.active {
            border: 1px solid var(--accent);
            background: rgba(94, 107, 246, 0.1);
            box-shadow: inset 0 0 15px rgba(94, 107, 246, 0.1);
        }
        
        .check-mark {
            position: absolute; top: 6px; right: 6px;
            color: var(--accent); font-size: 14px; opacity: 0;
        }
        .grid-item.active .check-mark { opacity: 1; }

        .item-icon { font-size: 32px; margin-bottom: 8px; display: block; filter: grayscale(100%); transition: 0.2s; }
        .grid-item.active .item-icon { filter: grayscale(0%); }
        
        .item-name { display: block; font-weight: bold; font-size: 0.9em; margin-bottom: 4px; color: #fff; }
        .item-price { display: block; font-size: 0.8em; color: var(--text-dim); }

        /* RIGHT: ORDER FORM */
        .details-area {
            flex: 1;
            padding: 25px;
            background: #181818;
            display: flex;
            flex-direction: column;
            gap: 15px;
            justify-content: flex-start;
        }

        .input-group { margin-bottom: 5px; }
        .label { font-size: 0.75em; color: var(--text-dim); margin-bottom: 6px; text-transform: uppercase; }
        
        input[type="text"], input[type="number"], select {
            width: 100%;
            background: #252525;
            border: 1px solid #383838;
            color: white;
            padding: 12px;
            border-radius: 4px;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 0.95em;
        }
        input:focus, select:focus { outline: none; border-color: var(--accent); }

        /* Range Slider */
        input[type=range] {
            width: 100%; margin-top: 10px; accent-color: var(--accent); cursor: pointer;
        }

        /* Total Price (FIXED: Added min-height and flex-shrink) */
        .total-box {
            margin-top: auto; 
            text-align: right;
            border-top: 1px solid #333;
            padding-top: 10px;
            margin-bottom: 5px;
            
            /* The Fix: Force it to keep its space */
            flex-shrink: 0; 
            min-height: 80px; 
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .total-label { font-size: 0.8em; color: var(--text-dim); margin-bottom: 5px; }
        
        .total-price { 
            font-size: 2.2em; /* Slightly larger default */
            font-weight: 700; 
            color: var(--text-main); 
            font-family: 'Rajdhani', sans-serif; 
            white-space: nowrap; 
            line-height: 1.1; /* Ensure text doesn't overlap lines */
            transition: font-size 0.2s ease;
        }

        /* Order Button */
        .btn-order {
            background: var(--accent);
            color: white;
            border: none;
            width: 100%;
            padding: 15px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 1em;
            text-transform: uppercase;
            cursor: pointer;
            transition: 0.2s;
            letter-spacing: 1px;
            flex-shrink: 0; /* Ensure button doesn't shrink either */
        }
        .btn-order:hover { background: var(--accent-hover); box-shadow: 0 0 15px rgba(94, 107, 246, 0.4); }
        .btn-order:disabled { background: #333; color: #555; cursor: not-allowed; box-shadow: none; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #111; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    </style>
</head>
<body>

<div id="app-container">
    <header id="drag-handle">
        <span style="display:flex; align-items:center; gap:10px;">
            <span style="color:var(--accent); font-size:1.2em;">ðŸ“¦</span> 
            <span>Dirty Deals Ordering Tool</span>
        </span>
        <div style="text-align:right;">
            <div id="username-display" style="font-size:0.9em; color:#fff;">Wait...</div>
            <div id="userid-display" style="font-size:0.7em; color:#555;">ID: --</div>
        </div>
    </header>

    <div id="main-content">
        <div class="selection-area">
            <div class="section-title">Select Item</div>
            <div class="grid-container" id="item-grid">
                </div>
        </div>

        <div class="details-area">
            
            <div class="input-group">
                <div class="label">Selected Item</div>
                <input type="text" id="disp-item-name" placeholder="Select from grid..." readonly 
                       style="background:#1a1a1a; border-color:transparent; color:#888;">
            </div>

            <div class="input-group">
                <div class="label">Quantity</div>
                <input type="number" id="input-qty" value="1" min="1" max="1000000">
                <input type="range" id="range-qty" min="1" max="1000000" value="1">
            </div>

            <div class="input-group">
                <div class="label">Priority Level</div>
                <select id="input-priority">
                    <option value="normal">Normal (100%)</option>
                    <option value="high">High Priority (125% Cost)</option>
                </select>
            </div>

            <div class="total-box">
                <div class="total-label">Total Price</div>
                <div class="total-price" id="disp-total">$0</div>
            </div>

            <div>
                <button class="btn-order" id="btn-submit" onclick="submitOrder()" disabled>Confirm Order</button>
                <div id="status-msg" style="text-align:center; font-size:0.75em; margin-top:8px; color:#555;">Select an item to start</div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- 1. CONFIGURATION ---
    const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwPJmoFYMVnKPX4gc9m66dfGfK28xavtDstfNoWLgP6HLSn0XzcAOJKQucxacVrMPb0/exec";
    const MAX_QTY = 1000000;

    const ITEMS = [
        { id: 'airline', name: 'Airline', price: 6000, icon: 'âœˆï¸' },
        { id: 'biz', name: 'Biz', price: 3000, icon: 'ðŸ¢' },
        { id: 'bus', name: 'Bus', price: 7000, icon: 'ðŸšŒ' },
        { id: 'cargo', name: 'Cargo', price: 8000, icon: 'ðŸ“¦' },
        { id: 'conductor', name: 'Conductor', price: 3000, icon: 'ðŸŽ«' },
        { id: 'ems', name: 'EMS', price: 5000, icon: 'ðŸš‘' },
        { id: 'farming', name: 'Farming', price: 2500, icon: 'ðŸšœ' },
        { id: 'fire', name: 'Firefighter', price: 9000, icon: 'ðŸ”¥' },
        { id: 'police', name: 'Police', price: 4000, icon: 'ðŸš“' },
    ];

    let state = {
        selectedItem: null,
        qty: 1,
        priority: 'normal',
        username: "Unknown",
        playerId: "0"
    };

    // --- 2. INITIALIZATION ---
    window.onload = function() {
        renderGrid();
        updateCalc();
        initDrag();
        requestPlayerData();
        setInterval(requestPlayerData, 2000);
    };

    function renderGrid() {
        const container = document.getElementById('item-grid');
        if(!container) return;
        container.innerHTML = '';

        ITEMS.forEach(item => {
            const div = document.createElement('div');
            div.className = `grid-item ${state.selectedItem && state.selectedItem.id === item.id ? 'active' : ''}`;
            div.onclick = () => selectItem(item);
            div.innerHTML = `
                <div class="check-mark">âœ”</div>
                <span class="item-icon">${item.icon}</span>
                <span class="item-name">${item.name}</span>
                <span class="item-price">$${item.price.toLocaleString()}</span>
            `;
            container.appendChild(div);
        });
    }

    function selectItem(item) {
        state.selectedItem = item;
        document.getElementById('disp-item-name').value = item.name;
        document.getElementById('disp-item-name').style.color = "#fff";
        document.getElementById('status-msg').innerText = "Ready to order";
        document.getElementById('status-msg').style.color = "#555";
        renderGrid(); 
        updateCalc();
    }

    // --- 3. LOGIC & INPUTS ---
    const qtyInput = document.getElementById('input-qty');
    const rangeInput = document.getElementById('range-qty');
    const prioInput = document.getElementById('input-priority');

    if(qtyInput) {
        qtyInput.addEventListener('input', (e) => {
            let val = parseInt(e.target.value) || 0;
            if (val > MAX_QTY) val = MAX_QTY; 
            state.qty = val;
            if(rangeInput) rangeInput.value = state.qty; 
            updateCalc();
        });
    }

    if(rangeInput) {
        rangeInput.addEventListener('input', (e) => {
            state.qty = parseInt(e.target.value);
            if(qtyInput) qtyInput.value = state.qty;
            updateCalc();
        });
    }

    if(prioInput) {
        prioInput.addEventListener('change', (e) => {
            state.priority = e.target.value;
            updateCalc();
        });
    }

    function updateCalc() {
        const btn = document.getElementById('btn-submit');
        const priceEl = document.getElementById('disp-total');
        
        if (!state.selectedItem) {
            priceEl.innerText = "$0";
            if(btn) btn.disabled = true;
            return;
        }
        if(btn) btn.disabled = false;

        let base = state.selectedItem.price * state.qty;
        if (state.priority === 'high') {
            base = base * 1.25; 
        }

        const finalPrice = Math.floor(base);
        const priceString = "$" + finalPrice.toLocaleString();
        
        // Auto-Resize Font Logic
        const len = priceString.length;
        if(len > 18) priceEl.style.fontSize = "1.0em";
        else if(len > 15) priceEl.style.fontSize = "1.2em";
        else if(len > 12) priceEl.style.fontSize = "1.5em";
        else if(len > 9) priceEl.style.fontSize = "1.8em";
        else priceEl.style.fontSize = "2.2em";

        priceEl.innerText = priceString;
    }

    // --- 4. DATA COMMS ---
    function requestPlayerData() {
        if(window.parent) {
            window.parent.postMessage({ 
                type: "getNamedData", 
                keys: ["player", "player_id"] 
            }, "*");
        }
    }

    window.addEventListener('message', (event) => {
        let payload = event.data;
        if (payload && payload.type === 'data' && payload.data) {
            payload = payload.data;
        }
        if (!payload) return;

        if (payload.player) {
            const name = typeof payload.player === 'object' ? (payload.player.name || "Player") : payload.player;
            state.username = name;
            document.getElementById('username-display').innerText = state.username;
        }

        if (payload.player_id) {
            state.playerId = payload.player_id;
            document.getElementById('userid-display').innerText = "ID: " + state.playerId;
        }
    });

    // --- 5. SEND ORDER ---
    function submitOrder() {
        const btn = document.getElementById('btn-submit');
        const status = document.getElementById('status-msg');
        
        // Security Check
        if (state.username === "Unknown" || state.username === "Wait...") {
            status.innerText = "âš ï¸ Error: Identity Unknown. Cannot send.";
            status.style.color = "#ff4444";
            return; 
        }

        btn.disabled = true;
        btn.innerText = "Processing...";
        status.innerText = "Sending to server...";
        status.style.color = "var(--accent)";

        const totalString = document.getElementById('disp-total').innerText; 

        const payload = {
            username: `${state.username} (ID: ${state.playerId})`, 
            item: state.selectedItem.name,
            quantity: state.qty,
            priority: state.priority,
            totalPrice: totalString
        };

        fetch(GOOGLE_SCRIPT_URL, {
            method: "POST",
            mode: "no-cors", 
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        })
        .then(() => {
            status.innerText = "ORDER SENT";
            status.style.color = "#00e676";
            btn.innerText = "Done";
            
            setTimeout(() => {
                status.innerText = "Ready for next order";
                status.style.color = "#555";
                btn.innerText = "Confirm Order";
                btn.disabled = false;
            }, 3000);
        })
        .catch(err => {
            status.innerText = "Network Error";
            status.style.color = "#ff4444";
            btn.disabled = false;
            btn.innerText = "Retry";
        });
    }

    // --- 6. DRAG FUNCTIONALITY ---
    function initDrag() {
        const elmnt = document.getElementById("app-container");
        const handle = document.getElementById("drag-handle");
        let pos1=0, pos2=0, pos3=0, pos4=0;
        
        if(handle) {
            handle.onmousedown = dragMouseDown;
        }

        function dragMouseDown(e) {
            e.preventDefault();
            pos3 = e.clientX;
            pos4 = e.clientY;
            document.onmouseup = closeDragElement;
            document.onmousemove = elementDrag;
        }

        function elementDrag(e) {
            e.preventDefault();
            pos1 = pos3 - e.clientX;
            pos2 = pos4 - e.clientY;
            pos3 = e.clientX;
            pos4 = e.clientY;
            elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
        }

        function closeDragElement() {
            document.onmouseup = null;
            document.onmousemove = null;
        }
    }

</script>
</body>
</html>
