<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unified Ops Hub</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0;
            background-color: transparent;
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
            font-family: 'Roboto', sans-serif;
        }

        /* --- IFRAME CONTAINER --- */
        #app-viewport {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass through empty space */
        }

        iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: none;
            pointer-events: auto; /* Re-enable clicks on the app */
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s ease;
        }

        /* --- TRANSITION ANIMATIONS --- */
        .slide-in-setup { transform: translateX(-50px); opacity: 0; }
        .slide-in-active { transform: translateX(0); opacity: 1; }
        .slide-out-active { transform: translateX(50px); opacity: 0; }

        /* --- UNKNOWN JOB OVERLAY --- */
        #unknown-overlay {
            position: absolute; top: 50px; left: 50px;
            width: 550px; height: 40px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #444;
            border-radius: 20px;
            display: flex; align-items: center;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-family: 'Rajdhani', sans-serif;
            pointer-events: auto;
            cursor: move;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
        }

        #unknown-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .marquee-container {
            width: 100%; overflow: hidden; white-space: nowrap; 
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }

        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
            font-size: 1em; font-weight: bold; line-height: 40px;
        }

        .mq-text { color: #ddd; margin-right: 4px; }
        .mq-job { color: #fff; margin: 0 8px; font-weight: 900; letter-spacing: 1px; }
        
        /* Glowing Job Colors */
        .mq-airline { text-shadow: 0 0 10px #03a9f4; color: #03a9f4; }
        .mq-bus { text-shadow: 0 0 10px #00bcd4; color: #00bcd4; }
        .mq-cargo { text-shadow: 0 0 10px #0277bd; color: #0277bd; }
        .mq-ems { text-shadow: 0 0 10px #e53935; color: #e53935; }
        .mq-fire { text-shadow: 0 0 10px #ff5100; color: #ff5100; }
        .mq-heli { text-shadow: 0 0 10px #ff9800; color: #ff9800; }
        .mq-hunter { text-shadow: 0 0 10px #76ff03; color: #76ff03; }
        .mq-mech { text-shadow: 0 0 10px #0091ea; color: #0091ea; }
        .mq-train { text-shadow: 0 0 10px #ffb300; color: #ffb300; }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
    </style>
</head>
<body>

<div id="app-viewport"></div>

<div id="unknown-overlay" onmousedown="dragStart(event)">
    <div class="marquee-container">
        <div class="marquee-content">
            <span class="mq-text">Unknown Job. Please start:</span>
            <span class="mq-job mq-airline">AIRLINE</span>
            <span class="mq-job mq-bus">BUS</span>
            <span class="mq-job mq-cargo">CARGO</span>
            <span class="mq-job mq-ems">EMS</span>
            <span class="mq-job mq-fire">FIRE</span>
            <span class="mq-job mq-heli">HELI</span>
            <span class="mq-job mq-hunter">HUNTER</span>
            <span class="mq-job mq-mech">MECHANIC</span>
            <span class="mq-job mq-train">TRAIN</span>
            <span class="mq-text">- to track accordingly.</span>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const TOOLS = {
        airline: "https://pinkiprim.github.io/airline-app/airline.html",
        fire: "https://pinkiprim.github.io/fire-app/index.html",
        mechanic: "https://pinkiprim.github.io/mechanic-app/mechanic.html",
        ems: "https://pinkiprim.github.io/ems-app/ems.html",
        cargo: "https://pinkiprim.github.io/cargo-app/cargo.html",
        hunter: "https://pinkiprim.github.io/hunter-app/hunter.html",
        heli: "https://pinkiprim.github.io/helipilot-app/helipilot.html",
        train: "https://pinkiprim.github.io/train-app/train.html",
        bus: "https://pinkiprim.github.io/bus-app/bus.html"
    };

    // --- STATE ---
    let currentJobKey = null;
    let activeIframe = null;
    let isTransitioning = false;

    // --- MAIN LOOP ---
    window.addEventListener('message', (e) => {
        // 1. DATA BRIDGE: RELAY (Game <-> App)
        // If message is from our active iframe -> Send UP to Game
        if (activeIframe && e.source === activeIframe.contentWindow) {
            window.parent.postMessage(e.data, '*');
            return;
        }

        // If message is from Game -> Send DOWN to Iframe
        if (activeIframe && e.source !== activeIframe.contentWindow) {
            activeIframe.contentWindow.postMessage(e.data, '*');
        }

        // 2. DETECTION LOGIC
        let data = e.data;
        if (data.type === 'data' && data.data) data = data.data;
        if (!data) return;

        detectAndSwitch(data);
    });

    function detectAndSwitch(d) {
        let rawJob = d.job;
        
        // Anti-Flicker: If the game sends a packet WITHOUT job data (e.g. just inventory update),
        // IGNORE IT. Do not switch to unknown.
        if (rawJob === undefined) return;

        let detectedKey = null;

        // --- MAP JOBS ---
        if (rawJob === "pilot_airline") detectedKey = "airline";
        else if (rawJob === "firefighter") detectedKey = "fire";
        else if (rawJob === "mechanic") detectedKey = "mechanic";
        else if (rawJob === "paramedic") detectedKey = "ems";
        else if (rawJob === "pilot_cargo") detectedKey = "cargo";
        else if (rawJob === "pilot_heli") detectedKey = "heli";
        else if (rawJob === "bus_driver") detectedKey = "bus";
        
        // --- SPECIAL CASES ---
        
        // 1. Train vs Bus (Both can appear as "train_conductor" in some frameworks)
        else if (rawJob === "train_conductor") {
            if (d.job_name && d.job_name.toLowerCase().includes("bus")) detectedKey = "bus";
            else detectedKey = "train";
        }

        // 2. Hunter Fallback (Only if explicitly holding hunter weapon or if job is missing but skill active)
        // Removed loose XP check. Now requires 'unemployed' state + specific condition if needed.
        // For now, Hunter often doesn't have a specific 'job' key.
        // If user is unemployed, we check if they are likely hunting.
        if ((!rawJob || rawJob === "unemployed" || rawJob === "none") && !detectedKey) {
            // Check inventory for hunting weapon to confirm intent
            // (Requires inventory data)
            let invStr = JSON.stringify(d.inventory || "");
            if (invStr.includes("weapon_musket") || invStr.includes("weapon_knife")) {
                detectedKey = "hunter";
            }
        }

        // EXECUTE SWITCH
        if (detectedKey !== currentJobKey) {
            loadTool(detectedKey);
        }
    }

    function loadTool(jobKey) {
        if (isTransitioning) return;
        currentJobKey = jobKey;

        const viewport = document.getElementById('app-viewport');
        const overlay = document.getElementById('unknown-overlay');

        // CASE 1: UNKNOWN JOB (Show Marquee)
        if (!jobKey || !TOOLS[jobKey]) {
            if (activeIframe) {
                activeIframe.classList.add('slide-out-active');
                setTimeout(() => { 
                    if(activeIframe) activeIframe.remove(); 
                    activeIframe = null; 
                }, 500);
            }
            overlay.classList.add('visible');
            return;
        }

        // CASE 2: LOAD NEW TOOL
        isTransitioning = true;
        overlay.classList.remove('visible');

        const newFrame = document.createElement('iframe');
        newFrame.src = TOOLS[jobKey];
        newFrame.classList.add('slide-in-setup');
        
        viewport.appendChild(newFrame);

        // Force Reflow
        void newFrame.offsetWidth;

        // Animate In
        newFrame.classList.add('slide-in-active');

        // Animate Out Old
        if (activeIframe) {
            const oldFrame = activeIframe;
            oldFrame.classList.remove('slide-in-active');
            oldFrame.classList.add('slide-out-active');
            setTimeout(() => { oldFrame.remove(); }, 500);
        }

        activeIframe = newFrame;

        // Unlock
        setTimeout(() => { isTransitioning = false; }, 500);
    }

    // --- DRAG LOGIC FOR OVERLAY ---
    let isDragging = false;
    let startX, startY, initialLeft, initialTop;
    const overlay = document.getElementById('unknown-overlay');

    function dragStart(e) {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const rect = overlay.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
    }

    function dragMove(e) {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        overlay.style.left = (initialLeft + dx) + 'px';
        overlay.style.top = (initialTop + dy) + 'px';
    }

    function dragEnd() {
        isDragging = false;
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
    }

    // --- INITIAL DATA REQUEST ---
    setInterval(() => {
        if (window.parent) {
            // Request everything to ensure detection works
            const keys = [
                "job", "job_name", "status", "inventory", 
                "exp_hunting_skill" // Only needed for hunter fallback
            ];
            try {
                window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
                window.parent.postMessage({ type: "getData" }, "*");
            } catch(e) {}
        }
    }, 1000);

</script>
</body>
</html>
