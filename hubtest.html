<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unified Ops Hub</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0;
            background-color: transparent;
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
            font-family: 'Roboto', sans-serif;
        }

        /* --- IFRAME CONTAINER --- */
        #app-viewport {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; /* Let clicks pass through empty space */
        }

        iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: none;
            pointer-events: auto; /* Re-enable clicks on the app */
            transition: transform 0.5s cubic-bezier(0.2, 0.8, 0.2, 1), opacity 0.5s ease;
        }

        /* --- TRANSITION CLASSES --- */
        .slide-in-setup {
            transform: translateX(-100%); /* Start off-screen left */
            opacity: 0;
        }
        .slide-in-active {
            transform: translateX(0); /* Move to center */
            opacity: 1;
        }
        .slide-out-active {
            transform: translateX(100%); /* Move off-screen right */
            opacity: 0;
        }

        /* --- UNKNOWN JOB OVERLAY --- */
        #unknown-overlay {
            position: absolute; top: 50px; left: 50px;
            width: 600px; height: 40px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #444;
            border-radius: 20px;
            display: flex; align-items: center;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            font-family: 'Rajdhani', sans-serif;
            pointer-events: auto;
            cursor: default;
            transition: opacity 0.3s ease;
            opacity: 0;
            pointer-events: none;
        }

        #unknown-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .marquee-container {
            width: 100%; overflow: hidden; white-space: nowrap; 
            mask-image: linear-gradient(to right, transparent, black 10%, black 90%, transparent);
        }

        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 15s linear infinite;
            font-size: 1em; font-weight: bold; line-height: 40px;
        }

        .mq-text { color: #ddd; margin-right: 4px; }
        .mq-job { color: #fff; margin: 0 8px; font-weight: 900; letter-spacing: 1px; }
        
        /* Glowing Job Colors */
        .mq-airline { text-shadow: 0 0 10px #03a9f4; color: #03a9f4; }
        .mq-bus { text-shadow: 0 0 10px #00bcd4; color: #00bcd4; }
        .mq-cargo { text-shadow: 0 0 10px #0277bd; color: #0277bd; }
        .mq-ems { text-shadow: 0 0 10px #e53935; color: #e53935; }
        .mq-fire { text-shadow: 0 0 10px #ff5100; color: #ff5100; }
        .mq-heli { text-shadow: 0 0 10px #ff9800; color: #ff9800; }
        .mq-hunter { text-shadow: 0 0 10px #76ff03; color: #76ff03; }
        .mq-mech { text-shadow: 0 0 10px #0091ea; color: #0091ea; }
        .mq-train { text-shadow: 0 0 10px #ffb300; color: #ffb300; }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
    </style>
</head>
<body>

<div id="app-viewport"></div>

<div id="unknown-overlay">
    <div class="marquee-container">
        <div class="marquee-content">
            <span class="mq-text">Unknown Job. Please start:</span>
            <span class="mq-job mq-airline">AIRLINE</span>
            <span class="mq-job mq-bus">BUS</span>
            <span class="mq-job mq-cargo">CARGO</span>
            <span class="mq-job mq-ems">EMS</span>
            <span class="mq-job mq-fire">FIRE</span>
            <span class="mq-job mq-heli">HELI</span>
            <span class="mq-job mq-hunter">HUNTER</span>
            <span class="mq-job mq-mech">MECHANIC</span>
            <span class="mq-job mq-train">TRAIN</span>
            <span class="mq-text">- to track accordingly.</span>
        </div>
    </div>
</div>

<script>
    // --- CONFIGURATION ---
    const TOOLS = {
        airline: "https://pinkiprim.github.io/airline-app/airline.html",
        fire: "https://pinkiprim.github.io/fire-app/index.html",
        mechanic: "https://pinkiprim.github.io/mechanic-app/mechanic.html",
        ems: "https://pinkiprim.github.io/ems-app/ems.html",
        cargo: "https://pinkiprim.github.io/cargo-app/cargo.html",
        hunter: "https://pinkiprim.github.io/hunter-app/hunter.html",
        heli: "https://pinkiprim.github.io/helipilot-app/helipilot.html",
        train: "https://pinkiprim.github.io/train-app/train.html",
        bus: "https://pinkiprim.github.io/bus-app/bus.html"
    };

    // --- STATE ---
    let currentJobKey = null;
    let activeIframe = null;
    let isTransitioning = false;

    // --- JOB DETECTION MAP ---
    // Maps internal game strings to our keys in TOOLS
    const JOB_MAP = {
        "pilot_airline": "airline",
        "firefighter": "fire",
        "mechanic": "mechanic",
        "paramedic": "ems",
        "pilot_cargo": "cargo",
        "pilot_heli": "heli",
        "train_conductor": "train", // Default, will check for bus overlap
        "bus_driver": "bus"
    };

    // --- MAIN LOOP ---
    window.addEventListener('message', (e) => {
        // 1. DATA BRIDGE: Relaying
        // If message is from our active iframe -> Send UP to Game
        if (activeIframe && e.source === activeIframe.contentWindow) {
            window.parent.postMessage(e.data, '*');
            return;
        }

        // If message is from Game -> Send DOWN to Iframe
        if (activeIframe && e.source !== activeIframe.contentWindow) {
            activeIframe.contentWindow.postMessage(e.data, '*');
        }

        // 2. LOGIC: Job Detection
        // Only process 'data' packets for switching
        let data = e.data;
        if (data.type === 'data' && data.data) data = data.data;
        if (!data) return;

        detectAndSwitch(data);
    });

    function detectAndSwitch(d) {
        let rawJob = d.job;
        
        // Anti-Flicker: Ignore if job data is missing entirely
        if (rawJob === undefined) return;

        // Smart Detection Logic (for Unemployed/Overlapping jobs)
        let detectedKey = null;

        // 1. Check Explicit Job Name
        if (JOB_MAP[rawJob]) {
            detectedKey = JOB_MAP[rawJob];
        }

        // 2. Special Case: Train vs Bus (Both can be "train_conductor")
        if (rawJob === "train_conductor") {
            // Compare XP to guess which one is active
            const busXP = d.exp_train_bus || 0;
            const trainXP = d.exp_train_train || 0;
            // If recently gained bus XP or bus is higher significantly? 
            // Simple heuristic: If rawJob is conductor, default train, but if explicit bus data implies active...
            // Actually, usually users switch job at center. Let's trust the map unless:
            if (d.job_name && d.job_name.toLowerCase().includes("bus")) detectedKey = "bus";
        }

        // 3. Fallback: "Unemployed" but active skill
        if (!rawJob || rawJob === "unemployed" || rawJob === "none") {
            if (d.exp_trucking_mechanic > 0 && d.status && d.status.includes("Mechanic")) detectedKey = "mechanic";
            else if (d.exp_hunting_skill > 0 && d.inventory && d.inventory.includes("weapon")) detectedKey = "hunter";
        }
        
        // 4. Manual Fallback triggers (keys specific to jobs)
        if (!detectedKey) {
            if (d.exp_hunting_skill) detectedKey = "hunter";
            // Add more specific overrides if needed
        }

        // EXECUTE SWITCH
        if (detectedKey !== currentJobKey) {
            loadTool(detectedKey);
        }
    }

    function loadTool(jobKey) {
        if (isTransitioning) return; // Prevent spam switching
        currentJobKey = jobKey;

        const viewport = document.getElementById('app-viewport');
        const overlay = document.getElementById('unknown-overlay');

        // CASE 1: UNKNOWN JOB
        if (!jobKey || !TOOLS[jobKey]) {
            // Slide out existing app
            if (activeIframe) {
                activeIframe.classList.add('slide-out-active');
                setTimeout(() => { 
                    if(activeIframe) activeIframe.remove(); 
                    activeIframe = null; 
                }, 500);
            }
            // Show overlay
            overlay.classList.add('visible');
            return;
        }

        // CASE 2: VALID JOB
        isTransitioning = true;
        overlay.classList.remove('visible');

        // Create New Iframe
        const newFrame = document.createElement('iframe');
        newFrame.src = TOOLS[jobKey];
        newFrame.classList.add('slide-in-setup');
        
        viewport.appendChild(newFrame);

        // Force Reflow
        void newFrame.offsetWidth;

        // Animate In
        newFrame.classList.add('slide-in-active');

        // Animate Out Old
        if (activeIframe) {
            const oldFrame = activeIframe;
            oldFrame.classList.remove('slide-in-active');
            oldFrame.classList.add('slide-out-active');
            
            setTimeout(() => {
                oldFrame.remove();
            }, 500);
        }

        activeIframe = newFrame;

        // Reset Lock
        setTimeout(() => {
            isTransitioning = false;
        }, 500);
    }

    // --- INITIAL POLLING ---
    // The hub needs to ask for data to trigger the first detection
    setInterval(() => {
        if (window.parent) {
            // Request broad set of keys to ensure we catch any job indicators
            const keys = [
                "job", "job_name", "status", "inventory", "chest", 
                "exp_trucking_mechanic", "exp_hunting_skill", 
                "exp_train_bus", "exp_train_train"
            ];
            try {
                window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
                window.parent.postMessage({ type: "getData" }, "*");
            } catch(e) {}
        }
    }, 1000);

</script>
</body>
</html>
