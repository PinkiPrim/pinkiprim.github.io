<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Unified Ops Hub</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        body {
            margin: 0; padding: 0;
            background-color: transparent;
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
            font-family: 'Roboto', sans-serif;
        }

        /* --- VIEWPORT (The Website Container) --- */
        #app-viewport {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none; /* Allow clicks to pass through empty areas */
        }

        iframe {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border: none;
            pointer-events: auto; /* Enable interaction with the tool */
            opacity: 0;
            transform: translateX(-20px);
            transition: opacity 0.5s ease, transform 0.5s ease;
        }

        iframe.active {
            opacity: 1;
            transform: translateX(0);
        }

        /* --- UNKNOWN JOB OVERLAY --- */
        #unknown-overlay {
            position: absolute; top: 50px; left: 50px;
            width: 600px; height: 50px;
            background: rgba(10, 10, 10, 0.95);
            border: 1px solid #444;
            border-radius: 8px;
            display: flex; align-items: center;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.8);
            font-family: 'Rajdhani', sans-serif;
            cursor: move;
            z-index: 9999;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        #unknown-overlay.visible {
            opacity: 1;
            pointer-events: auto;
        }

        .marquee-container {
            width: 100%; overflow: hidden; white-space: nowrap; 
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }

        .marquee-content {
            display: inline-block;
            padding-left: 100%;
            animation: marquee 20s linear infinite;
            font-size: 1.1em; font-weight: bold; line-height: 50px;
        }

        .mq-text { color: #888; margin-right: 5px; }
        .mq-job { margin: 0 10px; font-weight: 900; letter-spacing: 1px; color: #fff; }
        
        /* Glowing Colors */
        .mq-airline { text-shadow: 0 0 10px #03a9f4; color: #03a9f4; }
        .mq-bus { text-shadow: 0 0 10px #00bcd4; color: #00bcd4; }
        .mq-cargo { text-shadow: 0 0 10px #0277bd; color: #0277bd; }
        .mq-ems { text-shadow: 0 0 10px #e53935; color: #e53935; }
        .mq-fire { text-shadow: 0 0 10px #ff5100; color: #ff5100; }
        .mq-heli { text-shadow: 0 0 10px #ff9800; color: #ff9800; }
        .mq-hunter { text-shadow: 0 0 10px #76ff03; color: #76ff03; }
        .mq-mech { text-shadow: 0 0 10px #0091ea; color: #0091ea; }
        .mq-train { text-shadow: 0 0 10px #ffb300; color: #ffb300; }

        @keyframes marquee {
            0% { transform: translate(0, 0); }
            100% { transform: translate(-100%, 0); }
        }
    </style>
</head>
<body>

<div id="unknown-overlay" onmousedown="dragStart(event)">
    <div class="marquee-container">
        <div class="marquee-content">
            <span class="mq-text">Unknown Job. Please start:</span>
            <span class="mq-job mq-airline">AIRLINE</span>
            <span class="mq-job mq-bus">BUS</span>
            <span class="mq-job mq-cargo">CARGO</span>
            <span class="mq-job mq-ems">EMS</span>
            <span class="mq-job mq-fire">FIRE</span>
            <span class="mq-job mq-heli">HELI</span>
            <span class="mq-job mq-hunter">HUNTER</span>
            <span class="mq-job mq-mech">MECHANIC</span>
            <span class="mq-job mq-train">TRAIN</span>
            <span class="mq-text">- to track accordingly.</span>
        </div>
    </div>
</div>

<div id="app-viewport"></div>

<script>
    // --- YOUR EXACT LINKS ---
    const TOOLS = {
        airline: "https://pinkiprim.github.io/airline-app/airline.html",
        fire: "https://pinkiprim.github.io/fire-app/index.html",
        mechanic: "https://pinkiprim.github.io/mechanic-app/mechanic.html",
        ems: "https://pinkiprim.github.io/ems-app/ems.html",
        cargo: "https://pinkiprim.github.io/cargo-app/cargo.html",
        hunter: "https://pinkiprim.github.io/hunter-app/hunter.html",
        heli: "https://pinkiprim.github.io/helipilot-app/helipilot.html",
        train: "https://pinkiprim.github.io/train-app/train.html",
        bus: "https://pinkiprim.github.io/bus-app/bus.html"
    };

    let currentJobKey = null;
    let activeIframe = null;

    // --- MAIN EVENT LOOP ---
    window.addEventListener('message', (event) => {
        // 1. Relaying Data to Active Iframe
        if (activeIframe && activeIframe.contentWindow) {
            // Forward the exact event data down to the hosted page
            activeIframe.contentWindow.postMessage(event.data, '*');
        }

        // 2. Job Detection Logic
        let data = event.data;
        if (data.type === 'data' && data.data) data = data.data;
        if (!data) return;

        // Anti-Flicker: Ignore packets that don't have job info
        if (data.job === undefined) return;

        detectAndSwitch(data);
    });

    function detectAndSwitch(d) {
        let rawJob = d.job;
        let detectedKey = null;

        // --- MAP JOBS ---
        if (rawJob === "pilot_airline") detectedKey = "airline";
        else if (rawJob === "firefighter") detectedKey = "fire";
        else if (rawJob === "mechanic") detectedKey = "mechanic";
        else if (rawJob === "paramedic" || rawJob === "ambulance") detectedKey = "ems";
        else if (rawJob === "pilot_cargo") detectedKey = "cargo";
        else if (rawJob === "pilot_heli") detectedKey = "heli";
        else if (rawJob === "bus_driver") detectedKey = "bus";
        
        // --- SPECIAL CASES ---
        else if (rawJob === "train_conductor") {
            if (d.job_name && d.job_name.toLowerCase().includes("bus")) detectedKey = "bus";
            else detectedKey = "train";
        }

        // --- FALLBACKS ---
        if (!detectedKey || rawJob === "unemployed" || rawJob === "none") {
            if (d.exp_trucking_mechanic && d.status && d.status.includes("Mechanic")) detectedKey = "mechanic";
            else if (d.exp_hunting_skill && d.inventory && JSON.stringify(d.inventory).includes("weapon")) detectedKey = "hunter";
        }

        // EXECUTE SWITCH
        if (detectedKey !== currentJobKey) {
            loadTool(detectedKey);
        }
    }

    function loadTool(jobKey) {
        currentJobKey = jobKey;
        const viewport = document.getElementById('app-viewport');
        const overlay = document.getElementById('unknown-overlay');

        // IF JOB IS UNKNOWN OR NULL
        if (!jobKey || !TOOLS[jobKey]) {
            if (activeIframe) {
                activeIframe.classList.remove('active');
                setTimeout(() => { if(activeIframe) activeIframe.remove(); activeIframe = null; }, 500);
            }
            overlay.classList.add('visible');
            return;
        }

        // IF JOB IS VALID
        overlay.classList.remove('visible');

        // Create new iframe
        const newFrame = document.createElement('iframe');
        newFrame.src = TOOLS[jobKey];
        viewport.appendChild(newFrame);

        // Force Reflow
        void newFrame.offsetWidth;

        // Animate In
        newFrame.classList.add('active');

        // Remove old
        if (activeIframe) {
            const oldFrame = activeIframe;
            oldFrame.classList.remove('active');
            setTimeout(() => { oldFrame.remove(); }, 500);
        }

        activeIframe = newFrame;
    }

    // --- DRAG LOGIC FOR OVERLAY ---
    // (Iframes handle their own dragging, this is just for the "Unknown" bar)
    let isDragging = false, startX, startY, initialLeft, initialTop;
    const overlay = document.getElementById('unknown-overlay');

    function dragStart(e) {
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const rect = overlay.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;
        document.addEventListener('mousemove', dragMove);
        document.addEventListener('mouseup', dragEnd);
    }

    function dragMove(e) {
        if (!isDragging) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        overlay.style.left = (initialLeft + dx) + 'px';
        overlay.style.top = (initialTop + dy) + 'px';
    }

    function dragEnd() {
        isDragging = false;
        document.removeEventListener('mousemove', dragMove);
        document.removeEventListener('mouseup', dragEnd);
    }

    // --- POLLING ---
    setInterval(() => {
        if (window.parent) {
            const keys = [
                "job", "job_name", "status", "inventory", 
                "exp_trucking_mechanic", "exp_hunting_skill"
            ];
            try {
                window.parent.postMessage({ type: "getNamedData", keys: keys }, "*");
                window.parent.postMessage({ type: "getData" }, "*");
            } catch(e) {}
        }
    }, 1000);

</script>
</body>
</html>
