<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT PostOP Ops v2.0</title>
    <script src="nui://game/ui/jquery.js" type="text/javascript"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        :root {
            /* PostOP Theme: Purple & Gold */
            --primary: #673ab7; 
            --primary-dim: #4527a0;
            --accent: #ffd700;
            
            --bg-glass: rgba(20, 15, 25, 0.96);
            --bg-dark: rgba(10, 5, 15, 0.99);
            --text-main: #ffffff;
            --text-dim: #b39ddb;
            --border: 1px solid rgba(103, 58, 183, 0.5);
            --green: #00e676;
            --red: #ff5252;
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #tracker-app {
            position: absolute; top: 50px; left: 50px;
            width: 340px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.9);
            display: flex; flex-direction: column;
            overflow: hidden;
            min-height: 420px;
            transition: width 0.2s, height 0.2s;
        }

        /* --- MINI MODE --- */
        #tracker-app.mini-mode {
            width: 460px !important; height: 74px !important;
            min-height: 74px !important; border-radius: 12px;
            background: var(--bg-dark); border: 1px solid var(--accent);
            resize: none;
        }
        #tracker-app.mini-mode header, 
        #tracker-app.mini-mode #content,
        #tracker-app.mini-mode #grinder-panel { display: none !important; }

        #micro-view {
            display: none; flex-direction: column; justify-content: center;
            height: 100%; padding: 0 12px; font-family: 'Rajdhani', sans-serif; cursor: move;
        }
        #tracker-app.mini-mode #micro-view { display: flex; }
        .micro-row { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 50%; gap: 5px; }
        .micro-group { display: flex; align-items: center; gap: 6px; white-space: nowrap; }
        .micro-val { color: #fff; font-weight: 700; font-size: 0.95em; }
        .micro-val.highlight { color: var(--accent); }
        .micro-progress-bg { width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin: 0 5px; }
        .micro-progress-fill { height: 100%; background: var(--accent); width: 0%; }

        .micro-btn {
            position: absolute; top: 4px; right: 4px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #aaa; padding: 0px 4px; border-radius: 3px; 
            font-size: 0.6em; cursor: pointer; text-transform: uppercase; z-index: 99;
        }
        .micro-btn:hover { background: var(--primary); color: white; }

        /* --- HEADER & ANIMATION --- */
        header {
            background: linear-gradient(180deg, var(--primary-dim), rgba(0, 0, 0, 0.85));
            height: 85px; padding: 0 10px; cursor: move; position: relative;
            display: flex; align-items: flex-start; justify-content: space-between;
            border-bottom: 1px solid rgba(255,255,255,0.15); overflow: hidden; padding-top: 5px; z-index: 60; 
        }

        .header-title {
            position: absolute; left: 50%; top: 15%; transform: translate(-50%, -50%);
            font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.3em;
            text-transform: uppercase; letter-spacing: 2px; color: #fff; pointer-events: none;
            text-shadow: 0 2px 4px rgba(0,0,0,0.6); z-index: 10;
        }

        /* --- POSTMAN ANIMATION SCENE --- */
        #delivery-scene {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 50px;
            overflow: hidden; pointer-events: none; z-index: 5;
            background: linear-gradient(to bottom, transparent 90%, #333 90%);
        }

        .house-container {
            position: absolute; bottom: 5px; width: 100%; height: 100%;
            display: flex; justify-content: space-around; padding: 0 20px; box-sizing: border-box;
        }

        .house-spot { position: relative; width: 30px; height: 30px; }
        .house-emoji { font-size: 24px; position: absolute; bottom: 0; left: 0; z-index: 2; }
        
        .package {
            font-size: 14px; position: absolute; bottom: 2px; left: -5px; z-index: 3;
            opacity: 0; /* Hidden by default */
        }

        /* Package Appear Animations */
        /* Total cycle: 12s. Stops happen at approx 10%, 25%, 40%, 55%, 70%, 85% */
        .pkg-1 { animation: pkgAppear 12s step-end infinite; animation-delay: 1.2s; }
        .pkg-2 { animation: pkgAppear 12s step-end infinite; animation-delay: 2.8s; }
        .pkg-3 { animation: pkgAppear 12s step-end infinite; animation-delay: 4.4s; }
        .pkg-4 { animation: pkgAppear 12s step-end infinite; animation-delay: 6.0s; }
        .pkg-5 { animation: pkgAppear 12s step-end infinite; animation-delay: 7.6s; }
        .pkg-6 { animation: pkgAppear 12s step-end infinite; animation-delay: 9.2s; }

        @keyframes pkgAppear {
            0% { opacity: 1; } /* Visible after delay */
            90% { opacity: 1; }
            95% { opacity: 0; } /* Reset */
            100% { opacity: 0; }
        }

        .postman {
            position: absolute; bottom: 2px; left: -30px;
            font-size: 28px; z-index: 10;
            animation: postmanRoute 12s linear infinite;
        }

        /* Postman Route: Move -> Stop -> Move -> Stop */
        /* Houses are roughly at 8%, 25%, 42%, 58%, 75%, 92% of container width */
        @keyframes postmanRoute {
            0% { left: -30px; }
            8% { left: 6%; }  /* Stop 1 Arrive */
            12% { left: 6%; } /* Stop 1 Wait */
            22% { left: 22%; } /* Stop 2 Arrive */
            26% { left: 22%; } /* Stop 2 Wait */
            36% { left: 39%; } /* Stop 3 Arrive */
            40% { left: 39%; } /* Stop 3 Wait */
            50% { left: 56%; } /* Stop 4 Arrive */
            54% { left: 56%; } /* Stop 4 Wait */
            64% { left: 72%; } /* Stop 5 Arrive */
            68% { left: 72%; } /* Stop 5 Wait */
            78% { left: 89%; } /* Stop 6 Arrive */
            82% { left: 89%; } /* Stop 6 Wait */
            100% { left: 110%; } /* Exit */
        }

        #user-name-display {
            position: absolute; bottom: 55px; left: 10px;
            font-family: 'Rajdhani', sans-serif; font-weight: 700; font-size: 0.8em;
            color: #ccc; z-index: 15;
        }

        .header-controls { display: flex; gap: 8px; z-index: 30; align-items: center; }
        .nav-icon { text-decoration: none; font-size: 1.2em; cursor: pointer; color: #ccc; }
        .nav-icon:hover { color: #fff; }
        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #fff; font-size: 0.9em; margin-top: 4px; }

        /* BURGER MENU */
        .menu-container { position: relative; }
        .burger-btn { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.2); color: #fff; padding: 2px 6px; border-radius: 4px; cursor: pointer; }
        .dropdown-menu { position: absolute; top: 100%; right: 0; margin-top: 5px; background: #0f0f0f; border: 1px solid var(--primary); border-radius: 4px; width: 150px; display: none; flex-direction: column; z-index: 100; box-shadow: 0 8px 16px rgba(0,0,0,1); }
        .dropdown-menu.show { display: flex; }
        .menu-item { padding: 12px; color: #ddd; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-size: 0.95em; border-bottom: 1px solid #222; }
        .menu-item:hover { background: var(--primary); color: #fff; font-weight: bold; }

        /* CONTENT */
        #content { padding: 12px; flex: 1; overflow-y: auto; scrollbar-width: thin; }

        .status-box {
            background: rgba(255, 215, 0, 0.05); border: 1px solid var(--accent);
            border-radius: 6px; padding: 8px; margin-bottom: 12px; text-align: center;
        }
        .status-title { font-size: 0.7em; color: var(--accent); letter-spacing: 1px; margin-bottom: 2px; }
        .status-main { font-family: 'Rajdhani', sans-serif; font-size: 1.1em; font-weight: 800; color: #fff; }
        .status-sub { font-size: 0.85em; color: #ccc; margin-top: 2px; }

        .section { padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.08); margin-bottom: 12px; }
        .label { font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .value { font-size: 1.2em; font-weight: 800; }
        .highlight { color: var(--primary); }

        .progress-container { position: relative; height: 16px; background: rgba(0,0,0,0.6); border-radius: 4px; margin: 6px 0; overflow: hidden; border: 1px solid #333; }
        .progress-bar { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); width: 0%; transition: width 0.4s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; font-weight: 900; z-index: 2; text-shadow: 1px 1px 2px black; }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 5px; text-align: center; border-radius: 4px; }
        .stat-val { font-weight: bold; font-size: 1.1em; }

        input[type="number"] { width: 95%; background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; padding: 6px; border-radius: 4px; font-family: 'Rajdhani', sans-serif; font-weight: bold; margin-top: 5px;}
        .calc-result { font-size: 0.85em; color: var(--text-dim); margin-top: 5px; }
        
        .quick-btn-row { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        .quick-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; cursor: pointer; flex: 1; font-family: 'Rajdhani', sans-serif; font-weight: bold; }
        .quick-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        /* GRINDER OVERLAY */
        .overlay-panel { position: absolute; top: 70px; left: 0; width: 100%; height: calc(100% - 70px); background: #0a0a0a; z-index: 80; display: none; flex-direction: column; padding: 15px; box-sizing: border-box; }
        .overlay-panel.active { display: flex; }
        .panel-title { font-family: 'Rajdhani', sans-serif; font-weight: 900; color: var(--accent); border-bottom: 1px solid #333; padding-bottom: 8px; margin-bottom: 15px; text-transform: uppercase; display: flex; justify-content: space-between; }
        .stat-row-g { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 0.9em; border-bottom: 1px solid #222; padding-bottom: 5px; }
        
        .action-btn { width: 100%; background: rgba(103, 58, 183, 0.3); border: 1px solid var(--primary); color: #fff; padding: 10px; font-family: 'Rajdhani', sans-serif; font-weight: 800; cursor: pointer; border-radius: 4px; margin: 8px 0; text-transform: uppercase; }
        .action-btn:hover { background: var(--primary); color: #fff; box-shadow: 0 0 10px var(--primary-dim); }

        #resize-handle { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; cursor: nwse-resize; z-index: 100; }
    </style>
</head>
<body>

<div id="tracker-app">
    <div id="micro-view" onmousedown="dragStart(event)">
        <div class="micro-row">
            <span class="micro-group">üì¶ <span class="micro-val highlight">POST OPS</span></span>
            <span class="micro-val" id="micro-status">IDLE</span>
        </div>
        <div class="micro-row">
            <span class="micro-group">LVL <span class="micro-val highlight" id="micro-lvl">0</span> <div class="micro-progress-bg"><div class="micro-progress-fill" id="micro-bar"></div></div></span>
            <span class="micro-val">XP <span id="micro-xp">0</span></span>
        </div>
        <button class="micro-btn" style="position:absolute; top:2px; right:2px;" onclick="toggleMini()">üóñ</button>
    </div>

    <header id="drag-handle">
        <div class="header-controls"><a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon">üè†</a></div>
        <div class="header-title">POSTOP OPS</div>
        
        <div id="delivery-scene">
            <div id="user-name-display">Driver ...</div>
            <div class="postman">üßë‚Äçüíº</div>
            <div class="house-container">
                <div class="house-spot"><div class="house">üè†</div><div class="package pkg-1">üì¶</div></div>
                <div class="house-spot"><div class="house">üè†</div><div class="package pkg-2">üì¶</div></div>
                <div class="house-spot"><div class="house">üè†</div><div class="package pkg-3">üì¶</div></div>
                <div class="house-spot"><div class="house">üè†</div><div class="package pkg-4">üì¶</div></div>
                <div class="house-spot"><div class="house">üè†</div><div class="package pkg-5">üì¶</div></div>
                <div class="house-spot"><div class="house">üè†</div><div class="package pkg-6">üì¶</div></div>
            </div>
        </div>

        <div class="header-controls" style="flex-direction:column; gap:0; align-items:flex-end;">
            <div class="menu-container">
                <button class="burger-btn" onclick="toggleMenu()">‚ò∞</button>
                <div class="dropdown-menu" id="main-menu">
                    <div class="menu-item" onclick="toggleMini()">üóñ Mini Mode</div>
                    <div class="menu-item" onclick="toggleGrinder()">üìà Grinder Stats</div>
                    <div class="menu-item" onclick="resetSession()">üîÑ Reset Session</div>
                </div>
            </div>
            <span id="clock">00:00</span>
        </div>
    </header>

    <div id="content">
        <div class="status-box">
            <div class="status-title">CURRENT STATUS</div>
            <div class="status-main" id="disp-status">Waiting for job data...</div>
            <div class="status-sub" id="disp-sub">--</div>
        </div>

        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">PostOP Level</div><div class="value highlight" style="font-size:1.8em" id="disp-lvl">0</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>
            <div class="progress-container"><div class="progress-bar" id="level-bar"></div><div class="progress-text" id="level-text">0%</div></div>
            <div style="text-align:center; font-size:0.8em; color:var(--primary); font-weight:bold; margin-top:5px;" id="xp-needed">...</div>
        </div>

        <div class="section">
            <div class="stat-grid">
                <div class="stat-box">
                    <div class="label">Session XP</div>
                    <div class="stat-val" style="color:var(--green)" id="disp-session">0</div>
                </div>
                <div class="stat-box">
                    <div class="label">Tokens</div>
                    <div class="stat-val" style="color:var(--accent)" id="disp-tokens">0</div>
                </div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Target XP Calculator</div>
            <input type="number" id="target-input" placeholder="Enter Target XP" oninput="runCalculator()">
            <div class="quick-btn-row">
                <button class="quick-btn" onclick="setCalc(100000)">100K</button>
                <button class="quick-btn" onclick="setCalc(1000000)">1M</button>
                <button class="quick-btn" onclick="setCalc(10000000)">10M</button>
            </div>
            <div class="calc-result">Potential Actions: <span id="est-actions" style="color:var(--accent); font-weight:bold;">--</span></div>
        </div>
    </div>

    <div id="grinder-panel" class="overlay-panel">
        <div class="panel-title"><span>TOKEN TRACKER</span><span style="font-size:0.6em; color:#888;">POSTOP</span></div>
        <div id="bxp-rows"></div>
        <div class="panel-title" style="margin-top:15px; color:var(--primary)">ACTIVE BONUSES</div>
        <div id="bonus-list" style="font-size:0.85em; color:#ccc;"></div>
        <button class="action-btn" style="margin-top:auto;" onclick="toggleGrinder()">CLOSE</button>
    </div>

    <div id="resize-handle"></div>
</div>

<script>
// --- CONFIG ---
const JOB_EXP_KEY = "exp_trucking_postop";
const JOB_TOK_KEY = "exp_token|trucking|postop";
const JOB_BONUS_KEY = "exp_token_a|trucking|postop";

let STATE = {
    xp: 0, startXp: 0, actions: 0, tok: 0, startTok: 0, startT: Date.now(),
    lastStatus: ""
};

// --- UI LOGIC ---
function toggleMenu() { document.getElementById('main-menu').classList.toggle('show'); }
function toggleGrinder() { document.getElementById('grinder-panel').classList.toggle('active'); toggleMenu(); }
function toggleMini() { document.getElementById('tracker-app').classList.toggle('mini-mode'); toggleMenu(); }
function setCalc(val) { document.getElementById('target-input').value = val; runCalculator(); }

window.addEventListener('message', (event) => {
    let data = event.data.type === 'data' ? event.data.data : event.data;
    if (!data) return;

    if (data.name) document.getElementById('user-name-display').innerText = "Driver " + data.name;

    // 1. Status Parsing
    if(data.status) {
        try {
            let s = (typeof data.status === 'string') ? JSON.parse(data.status) : data.status;
            if(s.lines) {
                let statusLine = cleanString(s.lines[0]); // e.g. "Status: Unloading (17s)"
                let subText = "";
                if(s.lines[1]) subText += cleanString(s.lines[1]) + " ";
                if(s.lines[2]) subText += cleanString(s.lines[2]);

                document.getElementById('disp-status').innerText = statusLine || "Idle";
                document.getElementById('disp-sub').innerText = subText || "--";
                document.getElementById('micro-status').innerText = (statusLine.split(':')[1] || statusLine).trim().substring(0,15);
            }
        } catch(e){}
    }

    // 2. XP
    let xp = data[JOB_EXP_KEY];
    if (typeof xp === 'number') {
        if (STATE.startXp === 0) STATE.startXp = xp;
        if (xp > STATE.xp && STATE.xp !== 0) STATE.actions++;
        STATE.xp = xp;
        updateUI();
    }

    // 3. Tokens
    let inv = {};
    if (data.inventory) {
        try { inv = (typeof data.inventory === 'string') ? JSON.parse(data.inventory) : data.inventory; } catch(e){}
    }
    
    let tObj = inv[JOB_TOK_KEY] || data[JOB_TOK_KEY];
    if (tObj) {
        let tVal = (typeof tObj === 'object') ? tObj.amount : tObj;
        if (STATE.startTok === 0) STATE.startTok = tVal;
        STATE.tok = tVal;
        updateGrinder();
    }

    // 4. Bonuses
    if(data.menu_choices) {
        try {
            let menu = (typeof data.menu_choices === 'string') ? JSON.parse(data.menu_choices) : data.menu_choices;
            let id = menu.find(m => m[0] === 'Identity');
            if(id) parseBonuses(id[1]);
        } catch(e){}
    }
});

function updateUI() {
    let x = STATE.xp, c = 5, l = 0;
    while (x >= c) { x -= c; l++; c = (l + 1) * 5; }
    document.getElementById('disp-lvl').innerText = l;
    document.getElementById('micro-lvl').innerText = l;
    document.getElementById('disp-xp').innerText = STATE.xp.toLocaleString();
    document.getElementById('micro-xp').innerText = STATE.xp.toLocaleString();
    
    let p = (x/c*100).toFixed(1);
    document.getElementById('level-bar').style.width = p + "%";
    document.getElementById('level-text').innerText = p + "%";
    document.getElementById('micro-bar').style.width = p + "%";
    document.getElementById('xp-needed').innerText = Math.round(c - x).toLocaleString() + " XP to Next Level";
    
    let ses = STATE.xp - STATE.startXp;
    document.getElementById('disp-session').innerText = ses.toLocaleString() + " XP";
    
    runCalculator();
}

function updateGrinder() {
    let e = STATE.tok - STATE.startTok;
    document.getElementById('disp-tokens').innerText = e.toLocaleString();
    document.getElementById('micro-tokens').innerText = e.toLocaleString();
    
    let r = e / ((Date.now() - STATE.startT) / 60000 || 1);
    
    let html = `
        <div class="stat-row-g"><span>Session Earned</span><span class="highlight">${e}</span></div>
        <div class="stat-row-g"><span>AVG Per Hour</span><span>${Math.round(r*60)}</span></div>
        <div class="stat-row-g"><span>AVG Per 6h</span><span>${Math.round(r*360)}</span></div>
        <div class="stat-row-g"><span>AVG Per 12h</span><span>${Math.round(r*720)}</span></div>
        <div class="stat-row-g"><span>AVG Per 24h</span><span>${Math.round(r*1440)}</span></div>
    `;
    document.getElementById('bxp-rows').innerHTML = html;
}

function parseBonuses(h) {
    let out = "";
    h.split(/<br\s*\/?>/i).forEach(l => {
        let t = l.replace(/<[^>]*>/g, "").replace(/&#(\d+);/g, (m,d)=>String.fromCharCode(d)).trim();
        if(t && (t.includes("Bonus") || t.includes("Premium") || t.includes("Skill"))) out += `<div>‚òÖ ${t}</div>`;
    });
    document.getElementById('bonus-list').innerHTML = out;
}

function runCalculator() {
    let t = parseInt(document.getElementById('target-input').value);
    if (!t || STATE.actions === 0) return;
    let avg = (STATE.xp - STATE.startXp) / STATE.actions;
    let diff = t - STATE.xp;
    document.getElementById('est-actions').innerText = diff > 0 ? Math.ceil(diff/avg).toLocaleString() + " Stops" : "TARGET REACHED";
    document.getElementById('micro-calc').innerText = diff > 0 ? Math.ceil(diff/avg) : "-";
}

function cleanString(s) {
    return s.replace(/~[a-z]~/g, "").trim();
}

function resetSession() { 
    STATE.startXp = STATE.xp; STATE.actions = 0; STATE.startTok = STATE.tok; STATE.startT = Date.now(); 
    toggleMenu(); 
}

setInterval(() => {
    if(window.parent) window.parent.postMessage({ type: "getNamedData", keys: [JOB_EXP_KEY, JOB_TOK_KEY, JOB_BONUS_KEY, "inventory", "status", "name", "menu_choices"] }, "*");
    let d = new Date();
    document.getElementById('clock').innerText = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
}, 1000);

const dH = document.getElementById("drag-handle");
let dr=false, sx, sy, ox, oy;
dH.onmousedown = e => { if(e.target.tagName==='BUTTON'||e.target.tagName==='INPUT')return; dr=true; sx=e.clientX; sy=e.clientY; let r=document.getElementById('tracker-app').getBoundingClientRect(); ox=r.left; oy=r.top; };
window.onmousemove = e => { if(dr){ let a=document.getElementById('tracker-app'); a.style.left=(ox+e.clientX-sx)+'px'; a.style.top=(oy+e.clientY-sy)+'px'; }};
window.onmouseup = () => dr=false;

// Resize
const rh = document.getElementById('resize-handle');
rh.onmousedown = e => { e.preventDefault(); window.addEventListener('mousemove', rs); window.addEventListener('mouseup', rsEnd); };
function rs(e) { let a=document.getElementById('tracker-app'); if(!a.classList.contains('mini-mode')) { a.style.width=Math.max(280, e.clientX-a.getBoundingClientRect().left)+'px'; a.style.height=Math.max(200, e.clientY-a.getBoundingClientRect().top)+'px'; } }
function rsEnd() { window.removeEventListener('mousemove', rs); window.removeEventListener('mouseup', rsEnd); }

</script>
</body>
</html>
