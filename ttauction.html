<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pinki TT Auction</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700&display=swap');

        :root {
            --primary: #00ffff;
            --primary-dim: rgba(0, 255, 255, 0.1);
            --bg-dark: rgba(0, 15, 30, 0.90);
            --border: 1px solid rgba(0, 255, 255, 0.5);
            --glass: blur(4px);
            --admin-color: #ff0055;
            --warning-red: #ff4444;
        }

        * { box-sizing: border-box; user-select: none; }
        
        body { margin: 0; overflow: hidden; background: transparent; font-family: 'Rajdhani', sans-serif; color: white; height: 100vh; width: 100vw; }

        /* LOGIN */
        #login-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .login-box { width: 450px; padding: 30px; background: rgba(0, 10, 20, 0.95); border: 2px solid var(--primary); box-shadow: 0 0 20px var(--primary-dim); text-align: center; }
        .login-input { width: 100%; background: rgba(0,0,0,0.8); border: 1px solid #444; color: #888; padding: 12px; margin-bottom: 10px; cursor: not-allowed; }
        .login-input.verified { color: var(--primary); border-color: var(--primary); background: rgba(0, 255, 255, 0.05); }
        .pin-entry { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid var(--primary); color: white; padding: 15px; margin-bottom: 15px; font-size: 1.5em; text-align: center; letter-spacing: 5px; display: none; cursor: text; }
        .btn-auth { width: 100%; padding: 15px; background: var(--primary-dim); border: 1px solid var(--primary); color: white; font-weight: bold; cursor: pointer; margin-top:5px; }
        .btn-auth:disabled { background: #333; border-color: #555; color: #888; }
        
        /* WARNING BOX */
        .warning-box { margin-top: 20px; padding: 10px; border: 1px solid var(--warning-red); background: rgba(255, 68, 68, 0.1); color: var(--warning-red); font-size: 0.75em; text-align: center; box-shadow: 0 0 10px rgba(255, 68, 68, 0.2); text-transform: uppercase; letter-spacing: 1px; width: 100%; }

        /* 3D WRAPPER */
        .perspective-container { width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; perspective: 1500px; }
        .pivot-wrapper { position: relative; width: 450px; height: 600px; transform-style: preserve-3d; transition: transform 0.1s ease-out, width 0.5s ease; display: none; }
        .pivot-wrapper.expanded { width: 950px; height: 700px; }

        /* MINI MODE */
        body.mini-mode .pivot-wrapper { 
            width: 300px !important; height: auto !important; min-height: 150px;
            transform: none !important; margin: 0; position: absolute;
            top: 25%; right: 50px; left: auto; cursor: move;
        }
        body.mini-mode .menu-container { display: none; }
        body.mini-mode .detail-left, body.mini-mode .back-btn, body.mini-mode .content-header { display: none !important; }
        body.mini-mode .submenu-container { background: rgba(0,0,0,0.95); border: 2px solid var(--primary); top:0; transform: none; height: auto; padding: 15px; border-radius: 5px; box-shadow: 0 0 20px rgba(0,0,0,0.8); }
        body.mini-mode .detail-right { background: transparent; border: none; padding: 0; }
        body.mini-mode #detail-title { font-size: 1.2em; margin: 0; border-bottom: 1px solid #333; padding-bottom: 5px; pointer-events: none; }
        body.mini-mode #detail-price { font-size: 1.8em; margin: 10px 0; text-align: center; pointer-events: none; }
        body.mini-mode #min-btn { position: absolute; top: -5px; right: 0; font-size: 0.8em; padding: 2px 8px; border: none; background: transparent; color: #888; cursor: pointer; }
        body.mini-mode #min-btn:hover { color: white; }
        body.mini-mode #detail-live-timer { font-size: 1.2em; text-align: center; display: block; margin-bottom: 10px; pointer-events: none; }

        /* MENUS */
        .menu-container { position: absolute; width: 100%; top: 0; left: 0; display: flex; flex-direction: column; gap: 15px; z-index: 20; transition: opacity 0.5s; }
        .header-text { font-size: 2.5rem; font-weight: 700; letter-spacing: 4px; text-align: center; color: white; text-shadow: 0 0 15px var(--primary); border-bottom: 1px solid var(--primary); margin-bottom: 20px; padding-bottom: 10px; }
        .holo-btn { background: var(--bg-dark); border: var(--border); padding: 15px 20px; display: flex; align-items: center; gap: 20px; cursor: pointer; transition: 0.3s; transform: translateX(50px); opacity: 0; backdrop-filter: var(--glass); }
        .holo-btn.show { opacity: 1; transform: translateX(0); }
        .holo-btn:hover { background: var(--primary-dim); border-color: var(--primary); box-shadow: 0 0 15px var(--primary-dim); transform: translateX(10px); }
        .icon-box { color: var(--primary); font-size: 1.4rem; width: 30px; text-align: center; }

        /* SUBMENU */
        .submenu-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, rgba(0, 10, 20, 0.95), rgba(0, 5, 10, 0.9)); border: 1px solid var(--primary); opacity: 0; pointer-events: none; transform: translateY(20px) translateZ(-50px); transition: 0.5s; display: flex; flex-direction: column; padding: 20px; }
        .submenu-container.active { opacity: 1; pointer-events: all; transform: translateY(0) translateZ(0); }
        
        .content-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); padding-bottom: 10px; margin-bottom: 15px; flex-shrink: 0; }
        .grid-scroll { flex: 1; overflow-y: auto; padding-right: 10px; }
        .auction-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }

        .auction-card { background: rgba(0,0,0,0.6); border: 1px solid #333; display: flex; flex-direction: column; transition: 0.2s; position: relative; overflow: hidden; cursor: pointer; min-height: 100px; }
        .auction-card:hover { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-dim); transform: translateY(-3px); }
        .card-img { width: 100%; height: 120px; object-fit: cover; background: #000; border-bottom: 1px solid #333; }
        .card-body { padding: 15px; display: flex; flex-direction: column; justify-content: center; height: 100%; }
        .card-title { font-weight: bold; font-size: 1.1em; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 5px; }
        .card-price { color: var(--primary); font-size: 1.3em; font-weight: bold; }
        .card-timer { font-size: 0.9em; color: #ff4444; font-weight: bold; text-align: right; margin-top: 5px; display: flex; align-items: center; justify-content: flex-end; gap: 5px; }
        
        .st-Active { color: #00ff00; }
        .st-Ended { color: #ffaa00; }
        .st-Completed { color: #0088ff; }
        .st-Fulfilled { color: #888; text-decoration: line-through; }

        .hk-dashboard { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; flex-shrink: 0; }
        .stat-box { background: rgba(255, 0, 85, 0.1); border: 1px solid var(--admin-color); padding: 15px; text-align: center; }
        .stat-val { font-size: 2em; font-weight: bold; color: var(--admin-color); }
        .hk-list-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; background: rgba(0,0,0,0.3); font-size: 0.85em; }
        
        /* DETAIL VIEW */
        #view-detail { display: none; height: 100%; flex-direction: column; }
        /* CSS FIX FOR BACK BUTTON: Use flex: 1 and min-height: 0 to allow proper scrolling/sizing */
        .detail-layout { display: flex; gap: 20px; flex: 1; min-height: 0; margin-bottom: 10px; }
        .detail-left { flex: 1; display: flex; flex-direction: column; gap: 10px; }
        .detail-right { flex: 1; background: rgba(0,0,0,0.3); border: 1px solid #333; padding: 15px; display: flex; flex-direction: column; position: relative; overflow-y: auto; }
        .detail-img { width: 100%; height: 250px; object-fit: contain; background: #000; border: 1px solid #444; }
        
        #view-sell { display: none; height: 100%; flex-direction: column; }
        .sell-layout { display: flex; gap: 20px; flex: 1; min-height: 0; }
        .sell-form { flex: 1; display: flex; flex-direction: column; gap: 15px; overflow-y: auto; }
        .sell-preview-box { flex: 1; background: rgba(0,0,0,0.5); border: 1px dashed var(--primary); display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden; }
        .preview-image-actual { max-width: 100%; max-height: 300px; object-fit: contain; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        
        .input-group label { display: block; font-size: 0.8em; color: var(--primary); margin-bottom: 3px; }
        input[type="text"], input[type="number"], select { width: 100%; background: rgba(0,0,0,0.5); border: 1px solid #444; color: white; padding: 12px; font-family: 'Rajdhani', sans-serif; font-size: 1rem; }
        input:focus { border-color: var(--primary); outline: none; }
        .checkbox-row { display: flex; align-items: center; gap: 10px; margin-top: 5px; cursor: pointer; }

        .action-btn { background: var(--primary-dim); border: 1px solid var(--primary); color: white; padding: 12px; cursor: pointer; width: 100%; margin-top: 10px; font-weight: bold; font-size: 1.1em; transition: 0.2s; }
        .action-btn:hover { background: var(--primary); color: black; box-shadow: 0 0 15px var(--primary); }
        /* BACK BTN FIX: Ensure it doesn't shrink */
        .back-btn { margin-top: auto; padding: 15px; text-align: center; border-top: 1px solid #333; cursor: pointer; color: #ff4444; flex-shrink: 0; }

        /* PIN MODAL */
        #pin-modal { display:none; position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:1000; align-items:center; justify-content:center; flex-direction:column; }
        .pin-box { background:#111; border:2px solid var(--admin-color); padding:20px; width:300px; text-align:center; }
        .pin-input { width:100%; padding:10px; background:#222; border:1px solid #444; color:white; font-size:1.5em; text-align:center; letter-spacing:5px; margin-bottom:10px; }

        /* USER MANAGER TABLE */
        .user-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.3); border-bottom: 1px solid #333; margin-bottom: 2px; }
        .user-list-item select { width: 120px; background: #222; border: 1px solid #444; color: white; padding: 5px; }

        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: var(--primary); }
        #debug-id-match { font-size:0.7em; color:#444; position:absolute; bottom:5px; left:5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <div class="header-text" style="border:none; font-size: 2em;">SYSTEM AUTH</div>
            <input type="text" id="login-name" class="login-input" placeholder="Scanning Identity..." readonly disabled>
            <input type="text" id="login-id" class="login-input" placeholder="Waiting for Server..." readonly disabled>
            
            <button id="btn-signin" class="btn-auth" onclick="startAuthentication()">CONNECT</button>
            
            <div id="pin-section" style="display:none;">
                <input type="password" id="login-pin" class="pin-entry" placeholder="PIN" maxlength="4" style="display:block;">
                <button id="btn-enter" class="btn-auth" style="background:#2ecc71; border-color:#27ae60;" onclick="submitPin()">LOGIN</button>
            </div>
            
            <button id="btn-request" class="btn-auth" style="display:none; background:#e67e22; border-color:#d35400;" onclick="requestAccess()">REQUEST ACCESS</button>

            <div id="login-status" style="margin-top:10px; font-size:0.8em; color:#888;">Secure Connection Required</div>
            <div class="warning-box">WARNING: If you do not hold up your end of the deal, or you do anything that is troll-worthy, you may be blacklisted from this User-App</div>
        </div>
    </div>

    <div id="pin-modal">
        <div class="pin-box">
            <h3 style="color:var(--admin-color);">ADMIN AUTH</h3>
            <input type="password" id="admin-pin-input" class="pin-input" placeholder="PIN">
            <button class="action-btn" onclick="submitAdminAction()">CONFIRM</button>
            <button class="action-btn" onclick="closePinModal()" style="background:#333; margin-top:5px;">CANCEL</button>
        </div>
    </div>

    <div class="perspective-container">
        <div class="pivot-wrapper" id="pivot-wrapper">
            
            <div class="menu-container" id="main-menu">
                <div class="header-text">PINKI TT AUCTION</div>
                <div class="holo-btn" onclick="openSubmenu('browse')"><div class="icon-box"><i class="fas fa-globe"></i></div><span class="btn-text">BROWSE LISTINGS</span></div>
                <div class="holo-btn" onclick="openSubmenu('mydata')"><div class="icon-box"><i class="fas fa-box-open"></i></div><span class="btn-text">MY HISTORY</span></div>
                <div class="holo-btn" onclick="openSubmenu('sell')"><div class="icon-box"><i class="fas fa-upload"></i></div><span class="btn-text">CREATE LISTING</span></div>
                <div class="holo-btn" id="btn-hk" style="display:none; border-color: var(--admin-color);" onclick="openSubmenu('hk')"><div class="icon-box" style="color:var(--admin-color);"><i class="fas fa-shield-alt"></i></div><span class="btn-text" style="color:var(--admin-color);">HK DASHBOARD</span></div>
                <div class="holo-btn" id="btn-users" style="display:none; border-color: cyan;" onclick="openSubmenu('users')"><div class="icon-box" style="color:cyan;"><i class="fas fa-users"></i></div><span class="btn-text" style="color:cyan;">USER MANAGER</span></div>
                <div class="holo-btn" onclick="closeApp()"><div class="icon-box"><i class="fas fa-power-off"></i></div><span class="btn-text">DISCONNECT</span></div>
                <div class="warning-box" style="margin-top: auto; opacity: 0.8;">WARNING: If you do not hold up your end of the deal, or you do anything that is troll-worthy, you may be blacklisted from this User-App</div>
            </div>

            <div class="submenu-container" id="submenu-layer">
                
                <div id="view-browse" class="view-content" style="display:none; height:100%; flex-direction:column;">
                    <div class="content-header"><h3>ACTIVE MARKET</h3><button class="action-btn" style="width:auto; margin:0;" onclick="fetchData('browse')">REFRESH</button></div>
                    <div class="grid-scroll"><div class="auction-grid" id="browse-grid"></div></div>
                    <div class="back-btn" onclick="closeSubmenu()"><i class="fas fa-chevron-left"></i> RETURN</div>
                </div>

                <div id="view-mydata" class="view-content" style="display:none; height:100%; flex-direction:column;">
                    <div class="content-header"><h3>MY HISTORY</h3><button class="action-btn" id="btn-arch" style="width:auto; margin:0; font-size:0.8em;" onclick="toggleArchive()">SHOW PREVIOUS</button></div>
                    <div class="grid-scroll"><div class="auction-grid" id="my-grid"></div></div>
                    <div class="back-btn" onclick="closeSubmenu()"><i class="fas fa-chevron-left"></i> RETURN</div>
                </div>

                <div id="view-hk" class="view-content" style="display:none; height:100%; flex-direction:column;">
                    <div class="content-header"><h3 style="color:var(--admin-color);">HOUSEKEEPING</h3><button class="action-btn" style="width:auto; margin:0; border-color:var(--admin-color);" onclick="fetchData('hk')">REFRESH</button></div>
                    <div class="hk-dashboard">
                        <div class="stat-box"><div class="stat-val" id="st-total">0</div><div class="stat-label">Total</div></div>
                        <div class="stat-box"><div class="stat-val" id="st-active">0</div><div class="stat-label">Active</div></div>
                        <div class="stat-box"><div class="stat-val" id="st-comp">0</div><div class="stat-label">Completed</div></div>
                        <div class="stat-box"><div class="stat-val" id="st-ful">0</div><div class="stat-label">Fulfilled</div></div>
                    </div>
                    <div class="grid-scroll" id="hk-list"></div>
                    <div class="back-btn" onclick="closeSubmenu()"><i class="fas fa-chevron-left"></i> RETURN</div>
                </div>

                <div id="view-users" class="view-content" style="display:none; height:100%; flex-direction:column;">
                    <div class="content-header"><h3 style="color:cyan;">USER PERMISSIONS</h3><button class="action-btn" style="width:auto; margin:0;" onclick="fetchData('users')">REFRESH</button></div>
                    <div class="grid-scroll" id="user-list"></div>
                    <div class="back-btn" onclick="closeSubmenu()"><i class="fas fa-chevron-left"></i> RETURN</div>
                </div>

                <div id="view-detail" class="view-content">
                    <div class="content-header"><h3>ITEM DETAILS</h3></div>
                    <div class="detail-layout">
                        <div class="detail-left">
                            <div id="detail-img-container" style="width:100%; height:250px; background:#000; border:1px solid #444; display:flex; align-items:center; justify-content:center;"></div>
                            <div style="font-size:0.9em; color:#888; margin-top:10px;">SELLER: <span id="detail-seller" style="color:white;"></span></div>
                            <div style="font-size:0.9em; color:#888;">STATUS: <span id="detail-status" style="font-weight:bold;"></span></div>
                            <div id="debug-id-match"></div>
                        </div>
                        <div class="detail-right">
                            <button id="min-btn" class="action-btn" style="position:absolute; top:0; right:0; width:auto; margin:0; padding:5px 10px; font-size:0.8em;" onclick="toggleMiniMode()">[-]</button>
                            <div id="detail-title" style="font-size:1.8em; font-weight:bold; margin-bottom:10px; margin-top:20px;">Item Name</div>
                            <div id="detail-price" style="font-size:2em; color:var(--primary); font-weight:bold; margin-bottom:5px;">$0</div>
                            <div style="color:#ff4444; font-weight:bold; margin-bottom:15px;"><i class="far fa-clock"></i> <span id="detail-live-timer">00:00</span></div>
                            <div style="margin-bottom:20px;">High Bidder: <span id="detail-bidder">None</span></div>
                            
                            <div id="controls-bid" style="display:none;">
                                <input type="number" id="detail-bid-input" placeholder="Amount...">
                                <button class="action-btn" onclick="placeBid()">CONFIRM BID</button>
                            </div>
                            
                            <div id="controls-actions" style="display:none; text-align:center;">
                                <div id="action-msg" style="color:#e67e22; margin-bottom:10px;"></div>
                                <div id="action-buttons"></div>
                            </div>
                            
                            <div id="controls-admin" style="display:none; margin-top:15px; border-top:1px dashed #555; padding-top:10px;">
                                <div style="color:var(--admin-color); font-size:0.8em; text-align:center;">ADMIN OVERRIDE</div>
                                <button class="action-btn" onclick="promptAdminAction('Completed')" style="background:#444; font-size:0.8em; margin-top:5px;">FORCE COMPLETE (PIN)</button>
                                <button class="action-btn" onclick="promptAdminAction('Delete')" style="background:#444; font-size:0.8em; margin-top:5px;">FORCE DELETE (PIN)</button>
                            </div>

                        </div>
                    </div>
                    <div class="back-btn" onclick="returnToLastView()"><i class="fas fa-chevron-left"></i> BACK</div>
                </div>

                <div id="view-sell" class="view-content">
                    <div class="content-header"><h3>UPLOAD TO MARKET</h3></div>
                    <div class="sell-layout">
                        <div class="sell-form">
                            <div class="input-group"><label>ITEM NAME</label><input type="text" id="sell-name" placeholder="e.g. Import Car"></div>
                            <div class="input-group"><label>IMAGE URL (Catbox.moe)</label><input type="text" id="sell-img" placeholder="https://..." oninput="previewImg(this.value)"><div class="checkbox-row"><input type="checkbox" id="no-img-check" onchange="toggleImgInput()"><label for="no-img-check">NO IMAGE</label></div></div>
                            <div class="input-group"><label>STARTING BID</label><input type="number" id="sell-price" placeholder="5000"></div>
                            <div class="input-group"><label>DURATION</label><select id="sell-duration"><option value="15">15 Minutes</option><option value="60">1 Hour</option><option value="1440">24 Hours</option></select></div>
                        </div>
                        <div class="sell-preview-box"><div id="img-preview" style="color:#555;">NO IMAGE PREVIEW</div></div>
                    </div>
                    <button class="action-btn" onclick="postAuction()">CREATE LISTING</button>
                    <div id="sell-status" style="text-align:center; margin-top:5px; height:20px; color:cyan;"></div>
                    <div class="back-btn" onclick="closeSubmenu()"><i class="fas fa-chevron-left"></i> RETURN</div>
                </div>

            </div>
        </div>
    </div>

<script>
    const CONST_GOOGLE_URL = "https://script.google.com/macros/s/AKfycbwNfqTNIxvqNpae4DSl45adFXTKrhqh1E3Y9oW8U2P25zzE5BVT9E-k9EMpQiQ597ht/exec";
    const ADMIN_ID = "757858";

    let userData = { name: "", id: "", pin: "" };
    let currentData = [];
    let isMenuOpen = false;
    let currentDetailId = null;
    let lastView = 'browse';
    let showArchive = false;
    let pollingInterval = null;
    let countdownInterval = null;
    let pendingAdminAction = null;

    document.addEventListener('mousemove', (e) => {
        if (!isMenuOpen || document.body.classList.contains('mini-mode')) return;
        const wrapper = document.getElementById('pivot-wrapper');
        const rotX = ((e.clientY - window.innerHeight/2) / window.innerHeight/2) * -5;
        const rotY = ((e.clientX - window.innerWidth/2) / window.innerWidth/2) * 5;
        wrapper.style.transform = `rotateX(${rotX}deg) rotateY(${rotY}deg)`;
    });

    // DRAG
    const wrapper = document.getElementById('pivot-wrapper');
    let isDragging = false;
    let offset = { x: 0, y: 0 };
    wrapper.addEventListener('mousedown', function(e) {
        if (!document.body.classList.contains('mini-mode')) return;
        if (e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
        isDragging = true; offset.x = e.clientX - wrapper.offsetLeft; offset.y = e.clientY - wrapper.offsetTop;
        wrapper.style.right = 'auto'; wrapper.style.bottom = 'auto';
    });
    document.addEventListener('mouseup', function() { isDragging = false; });
    document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        wrapper.style.left = (e.clientX - offset.x) + 'px'; wrapper.style.top = (e.clientY - offset.y) + 'px';
    });

    window.addEventListener('message', (event) => {
        if (event.data.action === "open") { document.body.style.display = 'block'; resetLogin(); }
        if (event.data.type === "data" || event.data.user_id) {
            let d = event.data.data || event.data;
            if(d.user_id || d.player_id || d.id) {
                userData.name = d.name || d.player || "Unknown";
                userData.id = cleanID(d.user_id || d.player_id || d.id);
                document.getElementById('login-name').value = userData.name;
                document.getElementById('login-name').classList.add('verified');
                document.getElementById('login-id').value = userData.id;
                document.getElementById('login-id').classList.add('verified');
                
                document.getElementById('btn-signin').style.display = "none";
                document.getElementById('pin-section').style.display = "block";
                document.getElementById('btn-request').style.display = "block"; 
                document.getElementById('login-pin').focus();
            }
        }
    });

    function cleanID(id) { return String(id).replace(/[^0-9]/g, ''); }

    function resetLogin() {
        document.getElementById('login-screen').style.display = 'flex';
        document.getElementById('pivot-wrapper').style.display = 'none';
        document.getElementById('login-name').value = ""; document.getElementById('login-name').classList.remove('verified');
        document.getElementById('login-id').value = ""; document.getElementById('login-id').classList.remove('verified');
        document.getElementById('login-pin').value = ""; 
        document.getElementById('pin-section').style.display = "none";
        document.getElementById('btn-request').style.display = "none";
        document.getElementById('btn-signin').style.display = "block";
        document.getElementById('btn-signin').disabled = false; document.getElementById('btn-signin').innerText = "CONNECT";
        document.getElementById('login-status').innerText = "Secure Connection Required";
        document.getElementById('login-status').style.color = "#888";
    }

    function startAuthentication() {
        document.getElementById('btn-signin').disabled = true;
        document.getElementById('btn-signin').innerText = "POLLING...";
        if(window.parent) window.parent.postMessage({ type: "getNamedData", keys: ["name", "user_id"] }, "*");
    }

    function submitPin() {
        const pin = document.getElementById('login-pin').value;
        if(pin.length < 4) {
            document.getElementById('login-status').innerText = "PIN must be at least 4 digits";
            document.getElementById('login-status').style.color = "#ff4444";
            return;
        }
        
        userData.pin = pin;
        document.getElementById('btn-enter').disabled = true;
        document.getElementById('btn-enter').innerText = "VERIFYING...";

        fetch(CONST_GOOGLE_URL, {
            method: "POST", mode: "no-cors",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ action: "login", userId: userData.id, name: userData.name, pin: userData.pin })
        }).then(() => {
            // Note: In no-cors mode we cannot read response so we assume success for UI flow
            // If failed, next actions will fail silently or user will notice nothing loads
            document.getElementById('login-screen').style.display = 'none';
            enterMarket();
        });
    }

    function requestAccess() {
        fetch(CONST_GOOGLE_URL, {
            method: "POST", mode: "no-cors",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({ action: "requestAccess", userId: userData.id, name: userData.name })
        }).then(() => {
            alert("Request Sent! Contact an Admin to approve your access.");
        });
    }

    function enterMarket() {
        isMenuOpen = true;
        document.getElementById('pivot-wrapper').style.display = "block";
        
        if(userData.id === ADMIN_ID) {
            document.getElementById('btn-hk').style.display = 'flex';
            document.getElementById('btn-users').style.display = 'flex';
        } else {
            document.getElementById('btn-hk').style.display = 'none';
            document.getElementById('btn-users').style.display = 'none';
        }

        const btns = document.querySelectorAll('.holo-btn');
        btns.forEach((btn, i) => { btn.classList.remove('show'); setTimeout(() => btn.classList.add('show'), i * 100); });
        
        if(countdownInterval) clearInterval(countdownInterval);
        countdownInterval = setInterval(updateAllTimers, 1000);
    }

    function closeApp() {
        isMenuOpen = false;
        document.getElementById('pivot-wrapper').style.display = "none";
        document.getElementById('login-screen').style.display = 'none';
        if(pollingInterval) clearInterval(pollingInterval);
        if(countdownInterval) clearInterval(countdownInterval);
        fetch(`https://${GetParentResourceName()}/close`, { method: 'POST' }).catch(e=>{});
    }

    // [Navigation & Common Functions remain similar]
    function openSubmenu(view) {
        lastView = view;
        document.getElementById('pivot-wrapper').classList.add('expanded');
        document.getElementById('main-menu').style.opacity = '0';
        document.getElementById('main-menu').style.pointerEvents = 'none';
        document.querySelectorAll('.view-content').forEach(el => el.style.display = 'none');
        document.getElementById('view-' + view).style.display = 'flex';
        if(view === 'browse' || view === 'mydata' || view === 'hk' || view === 'users') fetchData(view);
        setTimeout(() => document.getElementById('submenu-layer').classList.add('active'), 300);
    }

    function closeSubmenu() {
        document.getElementById('submenu-layer').classList.remove('active');
        setTimeout(() => {
            document.getElementById('pivot-wrapper').classList.remove('expanded');
            document.getElementById('main-menu').style.opacity = '1';
            document.getElementById('main-menu').style.pointerEvents = 'all';
        }, 300);
    }

    function toggleArchive() {
        showArchive = !showArchive;
        document.getElementById('btn-arch').innerText = showArchive ? "HIDE PREVIOUS" : "SHOW PREVIOUS";
        fetchData('mydata');
    }

    function fetchData(view) {
        let action = "browse"; 
        if(view === 'hk') action = "getAll";
        else if(view === 'mydata') action = "getMyData";
        else if(view === 'users') action = "getUsers";
        
        let containerId = (view === 'hk') ? 'hk-list' : (view === 'users') ? 'user-list' : (view === 'mydata' ? 'my-grid' : 'browse-grid');
        let container = document.getElementById(containerId);
        container.innerHTML = '<div style="color:cyan; padding:20px; text-align:center; width:100%;">LOADING DATA...</div>';

        fetch(`${CONST_GOOGLE_URL}?action=${action}&userId=${userData.id}`)
        .then(res => res.json())
        .then(data => {
            currentData = data;
            if(view === 'hk') renderHK(data);
            else if(view === 'users') renderUsers(data);
            else renderGrid(data, container, view === 'mydata');
        });
    }

    // --- RENDERERS ---
    function renderGrid(data, container, isHistory) {
        container.innerHTML = '';
        const now = new Date().getTime();
        let count = 0;
        data.forEach(item => {
            if(isHistory && !showArchive && item.status !== "Active") return;
            count++;
            let status = item.status;
            if (status === "Active" && now > item.endTime) status = "Ended";
            let imgHTML = (item.img && item.img.startsWith('http')) ? `<img src="${item.img}" class="card-img" onerror="this.style.display='none'">` : '';
            let timerHTML = (status === 'Active') ? `<div class="card-timer" data-end="${item.endTime}"><i class="far fa-clock"></i> ...</div>` : '';

            let card = document.createElement('div');
            card.className = 'auction-card';
            card.onclick = () => openDetail(item);
            card.innerHTML = `${imgHTML}<div class="card-body"><div class="card-title">${item.item}</div><div class="card-price">$${parseInt(item.price).toLocaleString()}</div>${timerHTML}<div style="font-size:0.8em; margin-top:5px;">Status: <span class="st-${status}">${status}</span></div><div style="font-size:0.7em; color:#888;">Seller: ${item.seller}</div></div>`;
            container.appendChild(card);
        });
        if(count === 0) container.innerHTML = '<div style="padding:20px; color:#555;">No records found.</div>';
        updateAllTimers();
    }

    function renderHK(data) {
        const list = document.getElementById('hk-list'); list.innerHTML = '';
        let active = 0, comp = 0, ful = 0;
        data.forEach(item => {
            if(item.status === 'Active') active++; if(item.status === 'Completed') comp++; if(item.status === 'Fulfilled') ful++;
            let row = document.createElement('div'); row.className = 'hk-list-item';
            row.innerHTML = `<span style="width:30%; overflow:hidden;">${item.item}</span><span style="width:20%;">${item.seller}</span><span style="width:20%;">$${item.price}</span><span style="width:20%;" class="st-${item.status}">${item.status}</span><span style="width:10%; cursor:pointer;" onclick='openDetail(${JSON.stringify(item)})'>üëÅÔ∏è</span>`;
            list.appendChild(row);
        });
        document.getElementById('st-total').innerText = data.length; document.getElementById('st-active').innerText = active; document.getElementById('st-comp').innerText = comp; document.getElementById('st-ful').innerText = ful;
    }

    function renderUsers(data) {
        const list = document.getElementById('user-list'); list.innerHTML = '';
        data.forEach(user => {
            let row = document.createElement('div');
            row.className = 'user-list-item';
            
            // Dropdown logic
            let select = document.createElement('select');
            ['Requested', 'Whitelisted', 'Blacklisted'].forEach(opt => {
                let option = document.createElement('option');
                option.value = opt; option.text = opt; if(user.status === opt) option.selected = true;
                select.appendChild(option);
            });
            select.onchange = function() { updateUserPermission(user.id, this.value); };

            row.innerHTML = `<span>${user.name} (${user.id})</span>`;
            row.appendChild(select);
            list.appendChild(row);
        });
    }

    // --- ACTIONS ---
    function updateUserPermission(targetId, newStatus) {
        promptAdminAction('UserStatus', {targetId: targetId, newStatus: newStatus});
    }

    // --- DETAIL VIEW ---
    function openDetail(item) {
        currentDetailId = item.id;
        document.querySelectorAll('.view-content').forEach(el => el.style.display = 'none');
        document.getElementById('view-detail').style.display = 'flex';
        if(pollingInterval) clearInterval(pollingInterval);
        pollingInterval = setInterval(refreshDetail, 1000);
        renderDetail(item);
    }

    function refreshDetail() {
        fetch(`${CONST_GOOGLE_URL}?action=getAll&userId=${userData.id}`).then(r=>r.json()).then(data=>{
            currentData = data; const item = data.find(i => String(i.id) === String(currentDetailId));
            if(item) renderDetail(item);
        });
    }

    function renderDetail(item) {
        const now = new Date().getTime();
        let displayStatus = item.status;
        if(displayStatus === 'Active' && now > item.endTime) displayStatus = 'Ended';

        document.getElementById('detail-title').innerText = item.item;
        document.getElementById('detail-seller').innerText = item.seller;
        document.getElementById('detail-price').innerText = "$" + parseInt(item.price).toLocaleString();
        document.getElementById('detail-bidder').innerText = (item.highBidder === "No Bids" || item.highBidder === "None") ? "No Bids" : item.highBidder;
        document.getElementById('detail-status').innerText = displayStatus;
        document.getElementById('detail-status').className = `st-${displayStatus}`;
        
        const imgContainer = document.getElementById('detail-img-container');
        if (item.img && item.img.startsWith('http')) imgContainer.innerHTML = `<img src="${item.img}" style="width:100%; height:100%; object-fit:contain;">`;
        else imgContainer.innerHTML = `<span style="color:#555;">NO IMAGE</span>`;

        document.getElementById('controls-bid').style.display = 'none';
        document.getElementById('controls-actions').style.display = 'none';
        document.getElementById('controls-admin').style.display = 'none';
        document.getElementById('action-buttons').innerHTML = ''; 

        const sellerID = cleanID(item.sellerId); const buyerID = cleanID(item.bidderId);
        const myID = cleanID(userData.id); const adminID = cleanID(ADMIN_ID);
        const isSeller = (sellerID === myID); const isBuyer = (buyerID === myID);
        const isAdmin = (myID === adminID);
        const noBids = (buyerID == "0" || item.highBidder == "None" || item.highBidder == "No Bids");

        document.getElementById('debug-id-match').innerText = `Me:${myID} | Seller:${sellerID}`;

        if(isAdmin) document.getElementById('controls-admin').style.display = 'block';

        if (displayStatus === 'Active') {
            if(!isSeller) document.getElementById('controls-bid').style.display = 'block';
            else { document.getElementById('controls-actions').style.display = 'block'; document.getElementById('action-msg').innerText = "AUCTION IN PROGRESS"; }
        } 
        else if (displayStatus === 'Ended') {
            document.getElementById('controls-actions').style.display = 'block';
            if (isSeller) {
                document.getElementById('action-msg').innerText = "AUCTION ENDED - ACTION REQUIRED";
                const btnContainer = document.getElementById('action-buttons');
                const btn = document.createElement('button'); btn.className = 'action-btn';
                if(noBids) { btn.innerText = "REMOVE (UNSOLD)"; btn.style.backgroundColor = "#ff4444"; btn.onclick = removeListing; }
                else { btn.innerText = "MARK AS COMPLETED"; btn.style.backgroundColor = "#e67e22"; btn.onclick = () => updateStatus('Completed'); }
                btnContainer.appendChild(btn);
            } else {
                document.getElementById('action-msg').innerText = noBids ? "ENDED - UNSOLD" : "ENDED - WAITING FOR SELLER";
            }
        } 
        else if (displayStatus === 'Completed') {
            document.getElementById('controls-actions').style.display = 'block';
            if (isBuyer) {
                document.getElementById('action-msg').innerText = "SELLER COMPLETED - CONFIRM RECEIPT";
                const btnContainer = document.getElementById('action-buttons');
                const btn = document.createElement('button'); btn.className = 'action-btn';
                btn.innerText = "CONFIRM RECEIPT"; btn.style.backgroundColor = "#2ecc71";
                btn.onclick = () => updateStatus('Fulfilled');
                btnContainer.appendChild(btn);
            } else { document.getElementById('action-msg').innerText = "SELLER COMPLETED - WAITING FOR BUYER"; }
        } 
        else if (displayStatus === 'Fulfilled') {
            document.getElementById('controls-actions').style.display = 'block';
            document.getElementById('action-msg').innerText = "TRANSACTION CLOSED";
        }
    }

    // --- TIMERS ---
    function updateAllTimers() {
        const now = new Date().getTime();
        document.querySelectorAll('.card-timer').forEach(el => {
            const end = parseInt(el.getAttribute('data-end'));
            el.innerHTML = `<i class="far fa-clock"></i> ${formatTime(end - now)}`;
        });
        if(currentDetailId && document.getElementById('view-detail').style.display !== 'none') {
            const item = currentData.find(i => String(i.id) === String(currentDetailId));
            if(item) document.getElementById('detail-live-timer').innerText = formatTime(item.endTime - now);
        }
    }
    function formatTime(ms) {
        if(ms <= 0) return "ENDED";
        let h = Math.floor(ms / 3600000); let m = Math.floor((ms % 3600000) / 60000); let s = Math.floor((ms % 60000) / 1000);
        return `${h}h ${m}m ${s}s`;
    }

    // --- PIN MODAL ---
    function promptAdminAction(actionType, extraData) {
        pendingAdminAction = { type: actionType, data: extraData };
        document.getElementById('pin-modal').style.display = 'flex';
        document.getElementById('admin-pin-input').value = '';
        document.getElementById('admin-pin-input').focus();
    }

    function closePinModal() {
        document.getElementById('pin-modal').style.display = 'none';
        pendingAdminAction = null;
    }

    function submitAdminAction() {
        const pin = document.getElementById('admin-pin-input').value;
        if (!pin) return;
        
        let payload = { requesterId: userData.id, pin: pin };

        if (pendingAdminAction.type === 'Delete') {
            payload.action = 'delete'; payload.id = currentDetailId;
        } else if (pendingAdminAction.type === 'Completed') {
            payload.action = 'updateStatus'; payload.id = currentDetailId; payload.newStatus = 'Completed';
        } else if (pendingAdminAction.type === 'UserStatus') {
            payload.action = 'updateUserStatus'; payload.adminId = userData.id;
            payload.targetId = pendingAdminAction.data.targetId; payload.newStatus = pendingAdminAction.data.newStatus;
        }

        fetch(CONST_GOOGLE_URL, {
            method: "POST", mode: "no-cors",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        }).then(() => { 
            closePinModal();
            if(pendingAdminAction.type === 'UserStatus') fetchData('users');
            else returnToLastView(); 
        });
    }

    // --- STANDARD ACTIONS ---
    function removeListing() {
        // Pass session PIN automatically
        const payload = { action: "delete", id: currentDetailId, requesterId: userData.id, pin: userData.pin };
        fetch(CONST_GOOGLE_URL, { method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload) })
        .then(() => { returnToLastView(); });
    }

    function updateStatus(newStatus) {
        const payload = { action: "updateStatus", id: currentDetailId, newStatus: newStatus, requesterId: userData.id, pin: userData.pin };
        fetch(CONST_GOOGLE_URL, { method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload) })
        .then(() => { returnToLastView(); });
    }

    function placeBid() {
        let amt = document.getElementById('detail-bid-input').value;
        if(!amt) return;
        const payload = { action: "bid", id: currentDetailId, amount: amt, bidderName: userData.name, bidderId: userData.id, pin: userData.pin };
        fetch(CONST_GOOGLE_URL, { method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"}, body: JSON.stringify(payload) })
        .then(() => { document.getElementById('detail-bid-input').value = ""; });
    }

    function toggleImgInput() {
        const checkbox = document.getElementById('no-img-check');
        const input = document.getElementById('sell-img');
        const preview = document.getElementById('img-preview');
        if(checkbox.checked) { input.disabled = true; input.value = ""; preview.innerHTML = `<span style="color:#555;">IMAGE DISABLED</span>`; }
        else { input.disabled = false; preview.innerHTML = `<span style="color:#555;">NO IMAGE PREVIEW</span>`; }
    }

    function previewImg(url) {
        const div = document.getElementById('img-preview');
        div.innerHTML = '';
        if(url.startsWith('http')) div.innerHTML = `<img src="${url}" class="preview-image-actual">`;
        else div.innerHTML = `<span style="color:#555;">INVALID URL</span>`;
    }

    function postAuction() {
        const btn = document.querySelector('#view-sell .action-btn');
        const name = document.getElementById('sell-name').value;
        const price = document.getElementById('sell-price').value;
        if(!name || !price) { document.getElementById('sell-status').innerText = "ERROR: MISSING FIELDS"; return; }

        btn.disabled = true; btn.innerText = "UPLOADING...";
        const imgVal = document.getElementById('no-img-check').checked ? "" : document.getElementById('sell-img').value;

        fetch(CONST_GOOGLE_URL, {
            method: "POST", mode: "no-cors", headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                action: "create", seller: userData.name, sellerId: userData.id, pin: userData.pin,
                item: name, img: imgVal, price: price, duration: document.getElementById('sell-duration').value
            })
        }).then(() => {
            setTimeout(() => {
                closeSubmenu();
                document.getElementById('sell-name').value = '';
                document.getElementById('sell-price').value = '';
                btn.disabled = false; btn.innerText = "CREATE LISTING";
            }, 1000);
        });
    }

    // UPDATED returnToLastView (Safety check for default view)
    function returnToLastView() {
        if(pollingInterval) clearInterval(pollingInterval);
        document.body.classList.remove('mini-mode');
        document.getElementById('view-detail').style.display = 'none';

        // Fallback to browse if lastView is somehow invalid or null
        if (!lastView || !document.getElementById('view-' + lastView)) {
            lastView = 'browse';
        }

        document.getElementById('view-' + lastView).style.display = 'flex';
        fetchData(lastView);
    }

    document.onkeydown = function(e) { if(e.keyCode == 27) closeApp(); };
</script>
</body>
</html>
