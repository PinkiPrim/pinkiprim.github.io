<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Sticky Scanner</title>
    <style>
        body {
            margin: 0; padding: 20px;
            background-color: #050505;
            color: #00ff00;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
        }
        #status { color: #ffff00; margin-bottom: 10px; border-bottom: 1px solid #333; padding-bottom: 5px;}
        
        /* The main display for the LATEST valid packet */
        #latest-data {
            border: 2px solid #00e676;
            background: #111;
            padding: 10px;
            margin-bottom: 20px;
            white-space: pre-wrap;
            word-break: break-all;
            max-height: 40vh;
            overflow-y: auto;
        }

        /* History log */
        #history {
            border-top: 1px solid #444;
            padding-top: 10px;
            color: #888;
            max-height: 40vh;
            overflow-y: auto;
        }

        .key-highlight { color: #00e676; font-weight: bold; background: rgba(0, 100, 0, 0.3); }
        .val-highlight { color: #fff; }
    </style>
</head>
<body>

    <h3>TT Sticky Scanner</h3>
    <div id="status">Scanning... (Waiting for non-empty data)</div>

    <div style="color:#aaa; font-size:0.9em; margin-bottom:5px;">LATEST VALID DATA PACKET:</div>
    <div id="latest-data">Waiting...</div>

    <div style="color:#aaa; font-size:0.9em; margin-bottom:5px; margin-top:20px;">HISTORY LOG (Newest First):</div>
    <div id="history"></div>

    <script>
        const latestEl = document.getElementById('latest-data');
        const historyEl = document.getElementById('history');
        const statusEl = document.getElementById('status');

        // KEYS TO LISTEN FOR
        const guessKeys = [
            "inventory", "vehicle", "vehicle_inventory", "trunk", "trunk_inventory", 
            "glovebox", "secondary_inventory", "cargo", 
            "job", "job_name", "job_stage", "destination", "dest", "waypoint", "route"
        ];

        function scan() {
            if(window.parent) {
                try {
                    window.parent.postMessage({ type: "getNamedData", keys: guessKeys }, "*");
                    statusEl.innerText = "Scanning... " + new Date().toLocaleTimeString();
                } catch(e) {}
            }
        }
        setInterval(scan, 1500); // Ask every 1.5 seconds

        window.addEventListener('message', (event) => {
            let data = event.data;
            if (data.type === 'data' && data.data) data = data.data;

            // --- FILTER: IGNORE EMPTY DATA ---
            // If data is null, or an empty array [], or empty object {}, IGNORE IT.
            if (!data) return;
            if (Array.isArray(data) && data.length === 0) return;
            if (Object.keys(data).length === 0) return;

            // --- IF WE GET HERE, WE HAVE REAL DATA ---
            renderData(data);
        });

        function renderData(data) {
            let html = "";
            let timestamp = new Date().toLocaleTimeString();

            for (let key in data) {
                let val = data[key];
                
                // Skip empty values inside the packet too
                if (val === null || val === undefined || val === "" || val === false) continue;

                // Stringify objects for display
                if (typeof val === 'object') val = JSON.stringify(val, null, 2);

                html += `<div><span class="key-highlight">"${key}"</span>: <span class="val-highlight">${val}</span></div><hr style="border:0; border-bottom:1px dashed #333; margin:5px 0;">`;
            }

            // Update Main Box
            if (html !== "") {
                latestEl.innerHTML = html;
                
                // Add to History (Small log entry)
                const historyEntry = document.createElement("div");
                historyEntry.style.marginBottom = "5px";
                historyEntry.innerText = `[${timestamp}] Received data packet (${Object.keys(data).length} keys)`;
                historyEl.prepend(historyEntry);
            }
        }
    </script>
</body>
</html>
