<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Deep Probe Scanner</title>
    <style>
        body {
            margin: 0; padding: 0;
            background-color: #050505;
            color: #ccc;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 13px;
            display: flex; flex-direction: column;
            height: 100vh; overflow: hidden;
        }

        /* HEADER */
        #header {
            padding: 10px; background: #111; border-bottom: 2px solid #333;
            display: flex; justify-content: space-between; align-items: center;
        }
        .status { color: #ffff00; font-weight: bold; }
        .btn {
            background: #222; border: 1px solid #555; color: #fff;
            padding: 5px 15px; cursor: pointer; font-family: inherit;
        }
        .btn:hover { background: #444; }
        .btn-copy { border-color: #00e676; color: #00e676; }

        /* MAIN CONTENT */
        #container {
            flex: 1; display: flex; overflow: hidden;
        }

        /* LEFT PANEL: LIVE DATA */
        #live-panel {
            flex: 1; padding: 10px; overflow-y: auto;
            border-right: 1px solid #333;
        }

        /* RIGHT PANEL: HISTORY LOG */
        #log-panel {
            width: 35%; padding: 10px; overflow-y: auto;
            background: #0a0a0a; font-size: 0.9em;
        }

        /* ENTRIES */
        .entry {
            margin-bottom: 5px; padding: 5px;
            border-bottom: 1px dashed #222;
        }
        .key { color: #00e676; font-weight: bold; }
        .val { color: #fff; word-break: break-all; }
        .type { color: #555; font-size: 0.8em; margin-right: 5px; }

        /* CHANGED VALUE HIGHLIGHT */
        .changed { animation: flashYellow 1s ease; color: #ffeb3b; }
        @keyframes flashYellow {
            0% { background: rgba(255, 235, 59, 0.4); }
            100% { background: transparent; }
        }

        /* Section Headers */
        .section-title {
            color: #0277bd; font-weight: bold; 
            border-bottom: 1px solid #0277bd; 
            margin-top: 15px; margin-bottom: 5px;
            text-transform: uppercase;
        }
    </style>
</head>
<body>

    <div id="header">
        <div>
            <strong>TT DEEP PROBE</strong> | <span id="status" class="status">Initializing...</span>
            <div style="font-size:0.8em; color:#666;">Scan Interval: 2.0s</div>
        </div>
        <button class="btn btn-copy" onclick="copyAll()">ðŸ“‹ COPY REPORT</button>
    </div>

    <div id="container">
        <div id="live-panel">
            <div style="color:#666; font-style:italic;">Waiting for data stream...</div>
        </div>
        <div id="log-panel">
            <div style="border-bottom:1px solid #444; margin-bottom:10px; color:#888;">EVENT LOG</div>
            <div id="log-content"></div>
        </div>
    </div>

<script>
    // --- 1. THE DRAGNET: Massive list of potential keys ---
    const PROBE_KEYS = [
        // Standard
        "player", "player_id", "source", "inventory", "accounts", "money",
        // Vehicles & Trunk (The main target)
        "vehicle", "vehicle_data", "vehicle_plate", "plate", 
        "trunk", "trunk_inventory", "trunk_data", "boot",
        "secondary_inventory", "other_inventory", "stash", "storage",
        "glovebox", "cargo", "trailer", "container",
        // Jobs & Missions (The other target)
        "job", "job_name", "job_label", "job_grade",
        "job_stage", "job_info", "current_job", "duty",
        "mission", "mission_data", "task", "objective",
        "waypoint", "destination", "dest", "gps", "route", "coords", "blip"
    ];

    const livePanel = document.getElementById('live-panel');
    const logContent = document.getElementById('log-content');
    const statusEl = document.getElementById('status');
    
    // Store previous values to detect changes
    let lastDataState = {};

    // --- 2. SEND REQUESTS ---
    function ping() {
        if(window.parent) {
            try {
                // We ask for the specific keys...
                window.parent.postMessage({ type: "getNamedData", keys: PROBE_KEYS }, "*");
                
                // ...AND generic "getData" to catch everything else
                window.parent.postMessage({ type: "getData" }, "*"); 
                
                statusEl.innerText = "Scanning... " + new Date().toLocaleTimeString();
            } catch(e) {
                statusEl.innerText = "Error: " + e.message;
            }
        }
    }
    setInterval(ping, 2000);

    // --- 3. LISTEN & ANALYZE ---
    window.addEventListener('message', (event) => {
        let payload = event.data;
        
        // Unwrap standard FiveM NUI wrappers
        if (payload.type === 'data' && payload.data) payload = payload.data;
        if (payload.type === 'ui_update' && payload.data) payload = payload.data; // Common wrapper
        
        // Ignore Empty Packets
        if (!payload || (typeof payload === 'object' && Object.keys(payload).length === 0)) return;

        processData(payload);
    });

    function processData(data) {
        livePanel.innerHTML = ""; // Rebuild list (inefficient but cleaner for sorting)
        
        // Sort keys alphabetically for readability
        const keys = Object.keys(data).sort();
        
        if(keys.length === 0) {
            livePanel.innerHTML = "<div style='color:#666'>Received empty data packet.</div>";
            return;
        }

        keys.forEach(key => {
            let value = data[key];
            let displayVal = formatValue(value);
            
            // CHECK FOR CHANGE
            let isChanged = false;
            let oldValStr = JSON.stringify(lastDataState[key]);
            let newValStr = JSON.stringify(value);
            
            if (lastDataState[key] !== undefined && oldValStr !== newValStr) {
                isChanged = true;
                logChange(key, oldValStr, newValStr);
            }
            lastDataState[key] = value; // Update state

            // RENDER ENTRY
            const div = document.createElement('div');
            div.className = "entry";
            
            let keyClass = "key";
            if (isChanged) keyClass += " changed";

            // Highlight known "Target" keywords for you
            if(key.includes("trunk") || key.includes("inv") || key.includes("cargo")) {
                div.style.borderLeft = "3px solid #00e676";
                div.style.paddingLeft = "8px";
            }
            if(key.includes("job") || key.includes("waypoint") || key.includes("dest")) {
                div.style.borderLeft = "3px solid #0277bd";
                div.style.paddingLeft = "8px";
            }

            div.innerHTML = `
                <span class="${keyClass}">"${key}"</span> 
                <span class="type">(${typeof value})</span>
                <span class="val">${displayVal}</span>
            `;
            livePanel.appendChild(div);
        });
    }

    function formatValue(val) {
        if (val === null) return "null";
        if (val === undefined) return "undefined";
        if (typeof val === 'object') return JSON.stringify(val);
        return val.toString();
    }

    function logChange(key, oldVal, newVal) {
        // Don't log huge inventory updates to keep log clean
        if(key.includes("inventory") && newVal.length > 100) return;

        const div = document.createElement('div');
        div.style.marginBottom = "5px";
        div.style.fontSize = "0.85em";
        div.innerHTML = `<span style="color:#ffeb3b">âš  ${key} changed:</span><br>
                         <span style="color:#666; text-decoration:line-through;">${oldVal ? oldVal.substring(0,20) : 'null'}</span> 
                         &rarr; <span style="color:#fff;">${newVal ? newVal.substring(0,20) : 'null'}...</span>`;
        logContent.prepend(div);
    }

    // --- COPY FUNCTION ---
    window.copyAll = function() {
        const text = JSON.stringify(lastDataState, null, 4);
        const el = document.createElement('textarea');
        el.value = text;
        document.body.appendChild(el);
        el.select();
        document.execCommand('copy');
        document.body.removeChild(el);
        
        const btn = document.querySelector('.btn-copy');
        const originalText = btn.innerText;
        btn.innerText = "COPIED!";
        setTimeout(() => btn.innerText = originalText, 2000);
    }
</script>
</body>
</html>
