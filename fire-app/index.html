<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>TT Firefighting Helper v2.4</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;900&family=Roboto:wght@400;700&display=swap');

        /* --- THEME --- */
        :root {
            --primary: #ff5100; /* Fire Orange */
            --primary-dim: #963100;
            --bg-glass: rgba(15, 5, 5, 0.95);
            --text-main: #ffffff;
            --text-dim: #aaaaaa;
            --border: 1px solid rgba(255, 81, 0, 0.4);
            --green: #00e676;
            --yellow: #ffeb3b;
            --ash: #424242;
            --water: #29b6f6;
            --heart-color: #ff4081; /* Pinki Pink */
        }

        body {
            margin: 0; padding: 0;
            font-family: 'Roboto', sans-serif;
            background-color: transparent;
            color: var(--text-main);
            overflow: hidden;
            height: 100vh; width: 100vw;
            user-select: none;
        }

        #app-container {
            position: absolute;
            top: 50px; left: 50px;
            width: 320px;
            background: var(--bg-glass);
            border: var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.8);
            display: flex; flex-direction: column;
            resize: both; overflow: hidden;
            min-height: 200px;
            transition: width 0.2s ease, height 0.2s ease;
        }

        /* --- WATER SPLASH SYSTEM --- */
        #water-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 100; overflow: hidden;
            opacity: 0; transition: opacity 0.5s;
        }
        
        #splash-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% 30%, rgba(225, 245, 254, 0.9) 0%, rgba(41, 182, 246, 0.6) 50%, transparent 80%);
            mix-blend-mode: hard-light;
            opacity: 0; transform: scale(0.8);
        }

        .drip {
            position: absolute;
            background: linear-gradient(to bottom, rgba(255,255,255,0.8), rgba(41, 182, 246, 0.9));
            border-radius: 50px;
            width: 3px; height: 15px;
            opacity: 0.8;
            filter: blur(1px);
        }

        .splash-active #water-layer { opacity: 1; }
        
        .splash-active #splash-overlay {
            animation: impactSplash 2.5s ease-out forwards;
        }

        @keyframes impactSplash {
            0% { opacity: 0; transform: scale(0.5); }
            5% { opacity: 1; transform: scale(1.1); }
            20% { opacity: 0.8; transform: scale(1.0); }
            100% { opacity: 0; transform: scale(1.05); }
        }

        @keyframes dripFall {
            0% { transform: translateY(0) scaleY(1); opacity: 0; }
            10% { opacity: 1; }
            80% { opacity: 0.8; }
            100% { transform: translateY(300px) scaleY(1.5); opacity: 0; }
        }

        /* --- MINI MODE --- */
        #app-container.mini-mode {
            width: 420px !important;
            height: 74px !important;
            min-height: 74px !important;
            border-radius: 12px;
            resize: none;
        }
        #app-container.mini-mode header,
        #app-container.mini-mode #ember-container,
        #app-container.mini-mode #content,
        #app-container.mini-mode .support-footer { display: none !important; }

        #micro-view {
            display: none; flex-direction: column; justify-content: center; height: 100%; padding: 0 12px;
            font-family: 'Rajdhani', sans-serif; cursor: move;
        }
        #app-container.mini-mode #micro-view { display: flex; }

        .micro-row { display: flex; justify-content: space-between; align-items: center; width: 100%; height: 50%; }
        .micro-group { display: flex; align-items: center; gap: 8px; }
        .micro-sep { width: 1px; height: 12px; background: rgba(255,255,255,0.2); }
        .micro-label { color: var(--text-dim); font-size: 0.75em; text-transform: uppercase; letter-spacing: 1px; }
        .micro-val { color: #fff; font-weight: 700; font-size: 0.9em; }
        .micro-val.highlight { color: var(--primary); }
        .micro-val.active { color: var(--green); }
        .micro-progress-bg { width: 60px; height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow: hidden; margin: 0 5px; }
        .micro-progress-fill { height: 100%; background: var(--primary); width: 0%; }
        
        .micro-btn {
            position: absolute; top: 4px; right: 4px;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: #aaa; padding: 0px 4px; border-radius: 3px; font-size: 0.6em; cursor: pointer;
        }
        .micro-btn:hover { background: var(--primary); color: white; }

        /* --- HEADER & ANIMATION --- */
        header {
            background: linear-gradient(135deg, #b71c1c, #e65100, #b71c1c);
            background-size: 200% 200%;
            animation: fireBreath 6s ease-in-out infinite;
            height: 60px; padding: 0 10px; cursor: move;
            position: relative; display: flex; align-items: flex-start; justify-content: space-between;
            border-bottom: 1px solid rgba(255,81,0,0.3);
            overflow: hidden; padding-top: 5px;
        }
        @keyframes fireBreath {
            0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; }
        }

        .header-title {
            position: absolute; left: 50%; top: 20%; transform: translate(-50%, -50%);
            font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.2em;
            text-transform: uppercase; letter-spacing: 2px; color: #fff; pointer-events: none; white-space: nowrap;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5); z-index: 10;
        }

        #user-name-fire {
            position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%);
            font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.1em;
            white-space: nowrap; opacity: 0; z-index: 10;
            animation: ashCycle 15s linear infinite;
        }
        @keyframes ashCycle {
            0% { opacity: 0; color: var(--yellow); letter-spacing: 0px; filter: blur(2px); }
            10% { opacity: 1; color: #fff; text-shadow: 0 0 10px var(--primary), 0 0 20px var(--primary); filter: blur(0px); }
            60% { opacity: 1; color: #fff; text-shadow: 0 0 10px var(--primary); letter-spacing: 0px; filter: blur(0px); }
            80% { color: #555; text-shadow: none; }
            90% { opacity: 0.5; color: #333; letter-spacing: 4px; filter: blur(2px); transform: translateX(-50%) translateY(-5px); }
            100% { opacity: 0; transform: translateX(-50%) translateY(-10px); }
        }

        #ember-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; overflow: hidden; pointer-events: none; z-index: 5; }
        .ember {
            position: absolute; bottom: -5px; width: 4px; height: 4px;
            background: var(--yellow); border-radius: 50%; box-shadow: 0 0 6px var(--primary);
            opacity: 0; animation: rise 4s linear infinite;
        }
        .ember:nth-child(1) { left: 10%; animation-duration: 5s; animation-delay: 0s; }
        .ember:nth-child(2) { left: 30%; animation-duration: 3s; animation-delay: 1s; }
        .ember:nth-child(3) { left: 60%; animation-duration: 4s; animation-delay: 2s; }
        .ember:nth-child(4) { left: 80%; animation-duration: 6s; animation-delay: 0.5s; }
        .ember:nth-child(5) { left: 5%; animation-duration: 4.5s; animation-delay: 0.2s; }
        .ember:nth-child(6) { left: 15%; animation-duration: 3.5s; animation-delay: 1.5s; }
        .ember:nth-child(7) { left: 25%; animation-duration: 5.5s; animation-delay: 0.8s; }
        .ember:nth-child(8) { left: 35%; animation-duration: 4s; animation-delay: 2.5s; }
        .ember:nth-child(9) { left: 45%; animation-duration: 3s; animation-delay: 0.3s; }
        .ember:nth-child(10) { left: 55%; animation-duration: 5s; animation-delay: 1.2s; }
        .ember:nth-child(11) { left: 65%; animation-duration: 4.2s; animation-delay: 2.8s; }
        .ember:nth-child(12) { left: 75%; animation-duration: 3.8s; animation-delay: 0.6s; }
        .ember:nth-child(13) { left: 85%; animation-duration: 5.2s; animation-delay: 1.8s; }
        .ember:nth-child(14) { left: 95%; animation-duration: 4.8s; animation-delay: 0.1s; }
        .ember:nth-child(15) { left: 20%; animation-duration: 3.2s; animation-delay: 2.2s; }
        .ember:nth-child(16) { left: 70%; animation-duration: 5.8s; animation-delay: 1.1s; }
        @keyframes rise {
            0% { bottom: -5px; opacity: 1; transform: translateX(0); }
            50% { opacity: 0.8; }
            100% { bottom: 60px; opacity: 0; transform: translateX(10px); }
        }

        .header-controls { display: flex; gap: 8px; z-index: 20; align-items: center; }
        .nav-icon { text-decoration: none; font-size: 1.1em; cursor: pointer; color: #ccc; }
        .nav-icon:hover { color: #fff; }
        #mini-btn { font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.75em; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.2); color: #ccc; padding: 2px 5px; border-radius: 4px; cursor: pointer; }
        #mini-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        #clock { font-family: 'Rajdhani', sans-serif; font-weight: 700; color: #fff; font-size: 0.85em; z-index: 20; margin-top: 4px; }

        /* CONTENT */
        #content { padding: 12px; flex: 1; overflow-y: auto; scrollbar-width: thin; }
        .section { margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .section:last-child { border-bottom: none; }
        .label { font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; margin-bottom: 2px; }
        .value { font-size: 1.1em; font-weight: bold; color: var(--text-main); }
        .value.highlight { color: var(--primary); }
        .value.bxp { color: var(--green); }

        .progress-container { position: relative; height: 16px; background: rgba(0,0,0,0.5); border-radius: 4px; margin: 5px 0 5px 0; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); }
        .progress-bar { height: 100%; background: var(--primary); width: 0%; transition: width 0.3s ease; }
        .progress-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 0.7em; text-shadow: 1px 1px 2px black; font-weight: bold; z-index: 2; }
        
        .fires-remaining-text { font-size: 0.75em; color: var(--text-dim); text-align: center; margin-bottom: 10px; }
        .fires-remaining-text b { color: var(--primary); }

        /* STREAK DISPLAY */
        .streak-display {
            text-align: center; font-family: 'Rajdhani', sans-serif; font-weight: 900; font-size: 1.4em;
            color: var(--yellow); text-shadow: 0 0 10px rgba(255, 235, 59, 0.4);
            margin: 8px 0; letter-spacing: 2px; text-transform: uppercase;
        }
        .streak-display.synced { color: var(--green); text-shadow: 0 0 10px rgba(0, 230, 118, 0.4); }

        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 6px; border-radius: 4px; text-align: center; }

        input[type="number"] { width: 90%; background: rgba(0,0,0,0.3); border: 1px solid #444; color: white; padding: 5px; border-radius: 4px; margin-top: 5px; font-family: inherit; }
        input:focus { outline: 1px solid var(--primary); }
        .calc-output { margin-top: 5px; font-size: 0.8em; line-height: 1.3; color: var(--text-dim); word-wrap: break-word; }
        .quick-btn-row { display: flex; gap: 5px; margin-top: 5px; justify-content: center; }
        .quick-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: #ccc; font-size: 0.7em; padding: 2px 6px; border-radius: 3px; cursor: pointer; font-family: 'Rajdhani', sans-serif; font-weight: bold; flex: 1; }
        .quick-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }

        #streak-status {
            font-family: 'Rajdhani', sans-serif; font-weight: bold; font-size: 0.85em; 
            margin-bottom: 5px; color: var(--yellow); text-align: center; border: 1px dashed var(--primary-dim); padding: 4px; border-radius: 4px;
        }

        /* --- SUPPORT FOOTER --- */
        .support-footer {
            width: 100%;
            text-align: center;
            padding: 4px 0;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        .support-link {
            font-size: 0.65em;
            color: var(--text-dim);
            text-decoration: none;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            letter-spacing: 1px;
            opacity: 0.6;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .support-link:hover { opacity: 1; color: #fff; }
        .heart-spin {
            display: inline-block;
            color: var(--heart-color);
            margin-left: 2px;
            font-size: 1.1em;
            animation: spinHeart 2.5s infinite linear;
        }
        @keyframes spinHeart { 0% { transform: rotateY(0deg); } 100% { transform: rotateY(360deg); } }

    </style>
</head>
<body>

<div id="app-container">
    <div id="water-layer">
        <div id="splash-overlay"></div>
    </div>

    <div id="micro-view" onmousedown="dragStart(event)">
        <button class="micro-btn" onclick="toggleMini()">EXPAND</button>
        
        <div class="micro-row" style="border-bottom: 1px solid rgba(255,255,255,0.1);">
            <div class="micro-group">
                <span style="font-size:1.2em">üî•</span>
                <span class="micro-val highlight">FIRE OPS</span>
            </div>
            <div class="micro-group">
                <span class="micro-label">Streak:</span>
                <span class="micro-val active" id="micro-streak">?</span>
            </div>
        </div>

        <div class="micro-row">
            <div class="micro-group" style="min-width: 90px;">
                <span class="micro-label">Lvl</span>
                <span class="micro-val highlight" id="micro-level">0</span>
                <div class="micro-progress-bg">
                    <div class="micro-progress-fill" id="micro-bar"></div>
                </div>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Tok:</span>
                <span class="micro-val active" id="micro-tokens">0</span>
            </div>
            <div class="micro-sep"></div>
            <div class="micro-group">
                <span class="micro-label">Left:</span>
                <span class="micro-val highlight" id="micro-calc">--</span>
            </div>
        </div>
    </div>

    <header id="drag-handle">
        <div class="header-controls">
            <a href="https://pinkiprim.github.io/pinkiapps.html" class="nav-icon">üè†</a>
        </div>
        
        <div class="header-title">FIRE OPS</div>
        
        <div id="ember-container">
            <div class="ember"></div><div class="ember"></div><div class="ember"></div><div class="ember"></div>
            <div class="ember"></div><div class="ember"></div><div class="ember"></div><div class="ember"></div>
            <div class="ember"></div><div class="ember"></div><div class="ember"></div><div class="ember"></div>
            <div class="ember"></div><div class="ember"></div><div class="ember"></div><div class="ember"></div>
            <div id="user-name-fire">Firefighter ...</div>
        </div>

        <div class="header-controls" style="flex-direction:column; gap:2px; align-items:flex-end;">
            <button id="mini-btn" onclick="toggleMini()">MINI</button>
            <span id="clock">00:00</span>
        </div>
    </header>

    <div id="content">
        <div class="section">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <div><div class="label">Current Level</div><div class="value highlight" style="font-size:1.8em" id="disp-level">...</div></div>
                <div style="text-align:right;"><div class="label">Current XP</div><div class="value" id="disp-xp" style="font-size:0.9em">0</div></div>
            </div>

            <div class="progress-container">
                <div class="progress-bar" id="level-bar"></div>
                <div class="progress-text" id="level-text">Waiting for data...</div>
            </div>
            
            <div class="streak-display" id="main-streak-display">STREAK: ?</div>
            
            <div class="fires-remaining-text" id="fires-to-level">Complete a fire to calculate remaining...</div>

            <div class="stat-grid">
                <div class="stat-box"><div class="label">BXP Tokens</div><div class="value bxp" id="disp-bxp">0</div></div>
                <div class="stat-box"><div class="label">Avg XP</div><div class="value" id="disp-avg-xp">0</div></div>
                <div class="stat-box"><div class="label">Fires Done</div><div class="value" id="disp-session-fires">0</div></div>
            </div>
        </div>

        <div class="section" style="border:none;">
            <div class="label">Streak-Based Calculator</div>
            <div id="streak-status">‚ö† Open Identity Tab Once to Sync Streak</div>
            
            <div style="font-size:0.7em; color:#888; margin-top:5px;">Enter <b>Target XP</b>:</div>
            <input type="number" id="target-input" placeholder="e.g. 50000">
            
            <div class="quick-btn-row">
                <button class="quick-btn" onclick="setCalc(100000)">100K</button>
                <button class="quick-btn" onclick="setCalc(1000000)">1M</button>
                <button class="quick-btn" onclick="setCalc(10000000)">10M</button>
            </div>

            <div class="calc-output" id="calc-result">Waiting for streak data...</div>
        </div>
    </div>
    
    <div class="support-footer">
        <div onclick="openExternal('https://www.paypal.com/paypalme/pinkiprim')" class="support-link">
            Support PinkiPrim <span class="heart-spin">‚ù§</span>
        </div>
    </div>
    
</div>

<script>
    // --- SAFE SET HELPER ---
    // This prevents the "Cannot set properties of null" error
    function safeSetText(id, text) {
        const el = document.getElementById(id);
        if (el) el.innerText = text;
    }
    function safeSetHTML(id, html) {
        const el = document.getElementById(id);
        if (el) el.innerHTML = html;
    }

    function openExternal(url) {
        try {
            window.invokeNative('openUrl', url);
        } catch(e) {
            window.open(url, '_blank');
        }
    }

    // --- STATE ---
    const KEYS = { XP: "exp_ems_fire", BXP: "exp_token_a|ems|fire" };
    const STORAGE_KEY_CALC = "target_xp_fire";
    const STORAGE_KEY_MINI = "mini_mode_fire";

    const STATE = {
        currentXP: 0, currentBXP: 0, 
        startXP: null, lastKnownXP: -1,
        sessionFires: 0, sessionXP: 0, avgXP: 0,
        streak: 0, streakSynced: false,
        lastFireTime: 0 // For Debounce
    };

    // --- INIT ---
    const savedTarget = localStorage.getItem(STORAGE_KEY_CALC);
    if (savedTarget) document.getElementById('target-input').value = savedTarget;

    const savedMini = localStorage.getItem(STORAGE_KEY_MINI);
    if (savedMini === "true") {
        document.getElementById('app-container').classList.add('mini-mode');
        document.getElementById('mini-btn').innerText = "FULL";
    }

    function toggleMini() {
        const app = document.getElementById('app-container');
        app.classList.toggle('mini-mode');
        const isMini = app.classList.contains('mini-mode');
        document.getElementById('mini-btn').innerText = isMini ? "FULL" : "MINI";
        localStorage.setItem(STORAGE_KEY_MINI, isMini);
    }

    // --- COMMS ---
    function requestData() {
        if(window.parent) {
            try { 
                window.parent.postMessage({ type: "getNamedData", keys: [KEYS.XP, KEYS.BXP, "inventory", "name", "menu_choices"] }, "*"); 
            } catch(e) {}
        }
    }
    requestData();
    setInterval(requestData, 1000);

    // --- LISTENER ---
    window.addEventListener('message', (event) => {
        let payload = event.data;
        if (payload && payload.type === 'data' && payload.data) payload = payload.data;
        if (!payload) return;
        
        if(payload.name) safeSetText('user-name-fire', "Firefighter " + payload.name);

        // 1. UPDATE BXP FIRST (Priority)
        let bxpFound = -1;
        if (payload[KEYS.BXP]) bxpFound = extractBXP(payload[KEYS.BXP]);
        else if (payload.inventory) {
            try { 
                const inv = typeof payload.inventory === 'string' ? JSON.parse(payload.inventory) : payload.inventory;
                if (inv && inv[KEYS.BXP]) bxpFound = extractBXP(inv[KEYS.BXP]);
            } catch(e){}
        }
        if (bxpFound >= 0) {
            STATE.currentBXP = bxpFound;
            let txt = formatNum(STATE.currentBXP);
            safeSetText('disp-bxp', txt);
            safeSetText('micro-tokens', txt);
        }

        // 2. UPDATE XP
        if (typeof payload[KEYS.XP] === 'number') updateXP(payload[KEYS.XP]);
        else if (payload.inventory) {
            try { 
                const inv = typeof payload.inventory === 'string' ? JSON.parse(payload.inventory) : payload.inventory;
                if(inv[KEYS.XP]) updateXP(inv[KEYS.XP]);
            } catch(e){}
        }

        // 3. MENU SCANNING (IDENTITY)
        if (payload.menu_choices) {
            try {
                let menu = (typeof payload.menu_choices === 'string') ? JSON.parse(payload.menu_choices) : payload.menu_choices;
                let identityItem = menu.find(m => m[0] === "Identity");
                if (identityItem && identityItem[1]) {
                    parseIdentity(identityItem[1]);
                }
            } catch(e) {}
        }
    });

    function parseIdentity(html) {
        let match = html.match(/Firefighter:\s*(\d+)/i);
        if (match && match[1]) {
            let streakVal = parseInt(match[1]);
            if (!isNaN(streakVal)) {
                STATE.streak = streakVal;
                STATE.streakSynced = true;
                updateStreakUI();
            }
        }
    }

    function extractBXP(val) {
        if (typeof val === 'number') return val;
        if (typeof val === 'object' && val.amount) return val.amount;
        return -1;
    }

    function updateXP(val) {
        const newXP = Number(val);
        if (isNaN(newXP)) return;

        // Init
        if (STATE.startXP === null) {
            STATE.startXP = newXP;
            STATE.lastKnownXP = newXP;
            STATE.currentXP = newXP;
            renderDisplay();
            return;
        }

        if (STATE.lastKnownXP > -1 && newXP > STATE.lastKnownXP) {
            const diff = newXP - STATE.lastKnownXP;
            
            // Bridge Logic
            if (diff > 5) {
                STATE.sessionXP += diff;
                
                // DEBOUNCE LOGIC (10 seconds)
                const now = Date.now();
                if (now - STATE.lastFireTime > 10000) {
                    STATE.sessionFires++; 
                    if (STATE.streakSynced) {
                        STATE.streak++;
                        updateStreakUI();
                    }
                    STATE.lastFireTime = now;
                    triggerSplash();
                }
                
                if (STATE.sessionFires > 0) {
                    STATE.avgXP = STATE.sessionXP / STATE.sessionFires;
                }
            }
            STATE.lastKnownXP = newXP;
        }
        STATE.currentXP = newXP;
        renderDisplay();
    }

    function updateStreakUI() {
        if (STATE.streakSynced) {
            safeSetHTML('streak-status', `Tracking Streak: <span style="color:var(--green)">${STATE.streak}</span>`);
            
            const mainStreak = document.getElementById('main-streak-display');
            if(mainStreak) {
                mainStreak.innerText = "STREAK: " + STATE.streak;
                mainStreak.classList.add('synced');
            }
            safeSetText('micro-streak', STATE.streak);
            runCalculator(); 
        }
    }

    function triggerSplash() {
        const app = document.getElementById('app-container');
        const layer = document.getElementById('water-layer');
        if(!app || !layer) return;
        
        const oldDrips = layer.querySelectorAll('.drip');
        oldDrips.forEach(d => d.remove());

        app.classList.remove('splash-active');
        void app.offsetWidth; 
        
        for(let i=0; i<20; i++) {
            const drip = document.createElement('div');
            drip.className = 'drip';
            drip.style.left = Math.random() * 100 + "%";
            drip.style.top = (Math.random() * -50) + "px"; 
            drip.style.animation = `dripFall ${1.5 + Math.random()}s linear forwards`;
            drip.style.animationDelay = (Math.random() * 0.5) + "s";
            layer.appendChild(drip);
        }

        app.classList.add('splash-active');
    }

    function renderDisplay() {
        const lvl = getLevelFromXP(STATE.currentXP);
        const xp = STATE.currentXP;
        const nextLvlXP = getXPFromLevel(lvl + 1);
        const prevLvlXP = getXPFromLevel(lvl);
        const percent = Math.min(100, Math.max(0, ((xp - prevLvlXP) / (nextLvlXP - prevLvlXP)) * 100));

        safeSetText('disp-level', lvl);
        safeSetText('disp-xp', formatNum(xp));
        
        const bar = document.getElementById('level-bar');
        if(bar) bar.style.width = percent + "%";
        safeSetText('level-text', percent.toFixed(1) + "%");
        
        // Micro UI
        safeSetText('micro-level', lvl);
        safeSetText('micro-xp', formatNum(xp));
        const mBar = document.getElementById('micro-bar');
        if(mBar) mBar.style.width = percent + "%";
        safeSetText('micro-fires', STATE.sessionFires);

        safeSetText('disp-session-fires', STATE.sessionFires);
        safeSetText('disp-avg-xp', Math.round(STATE.avgXP));

        // Use FORMULA for main display if streak tracked, else simple average
        const xpNeeded = nextLvlXP - xp;
        let estimateXP = STATE.avgXP;
        
        if (STATE.streakSynced) {
            estimateXP = calculateFireXP(STATE.streak);
        }

        if (estimateXP > 0) {
            const firesToLevel = Math.ceil(xpNeeded / estimateXP);
            safeSetHTML('fires-to-level', `Approx <b>${formatNum(firesToLevel)} fires</b> to Level ${lvl + 1}`);
        }

        runCalculator();
    }

    // --- FORMULAS ---
    function getLevelFromXP(xp) { return Math.floor((Math.sqrt(1 + 8 * xp / 5) - 1) / 2); }
    function getXPFromLevel(level) { return Math.floor((5 * level * (level + 1)) / 2); }
    function formatNum(num) { return Math.floor(num).toLocaleString("en-US"); }

    function calculateFireXP(streak) {
        const tier = 6; 
        const difficulty = 3; 
        const base = (tier * 5) + 7 + difficulty;
        const multiplier = 1 + 0.2 * Math.pow((streak - 1) / 100, 1.5);
        return base * multiplier;
    }

    // --- CALCULATOR ---
    const calcInput = document.getElementById('target-input');
    if(calcInput) calcInput.addEventListener('input', runCalculator);

    function setCalc(amount) {
        document.getElementById('target-input').value = amount;
        runCalculator();
    }

    function runCalculator() {
        const val = document.getElementById('target-input').value;
        const el = document.getElementById('calc-result');
        const microEl = document.getElementById('micro-calc');
        
        localStorage.setItem(STORAGE_KEY_CALC, val);

        if (!STATE.streakSynced) {
            safeSetHTML('calc-result', "<span style='color:orange'>Please open Identity tab to sync Streak data first.</span>");
            safeSetText('micro-calc', "Sync..");
            return;
        }

        if (!val) {
            safeSetText('calc-result', "Enter XP amount above.");
            safeSetText('micro-calc', "Set..");
            return;
        }

        let inputVal = parseInt(val);
        let targetXP = inputVal;
        
        if (inputVal < 200) { 
             let lvlXP = getXPFromLevel(inputVal);
             if (lvlXP > STATE.currentXP) targetXP = lvlXP;
        }

        if (targetXP > STATE.currentXP) {
            const diff = targetXP - STATE.currentXP;
            const xpPerFire = calculateFireXP(STATE.streak);
            const fires = Math.ceil(diff / xpPerFire);
            
            safeSetHTML('calc-result', `Remaining: <b>${formatNum(diff)} XP</b><br>
                            Current Streak XP: ~${Math.round(xpPerFire)}<br>
                            <span style="color:var(--primary)">Est. Fires: <b>${formatNum(fires)}</b></span>`);
            safeSetText('micro-calc', formatNum(fires));
        } else {
            safeSetHTML('calc-result', `Target reached.`);
            safeSetText('micro-calc', "Done");
        }
    }

    // --- CLOCK & DRAG ---
    setInterval(() => {
        safeSetText('clock', new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));
    }, 1000);

    const elmnt = document.getElementById("app-container");
    const header = document.getElementById("drag-handle");
    const microView = document.getElementById("micro-view");
    let isDragging = false, startX, startY, initialLeft, initialTop;

    if(header) header.addEventListener("mousedown", dragStart);
    if(microView) microView.addEventListener("mousedown", dragStart);

    function dragStart(e) {
        if(e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT' || e.target.tagName === 'A') return;
        e.preventDefault();
        isDragging = true;
        startX = e.clientX;
        startY = e.clientY;
        const rect = elmnt.getBoundingClientRect();
        initialLeft = rect.left;
        initialTop = rect.top;
        document.addEventListener("mousemove", dragMove);
        document.addEventListener("mouseup", dragEnd);
    }

    function dragMove(e) {
        if (!isDragging) return;
        e.preventDefault();
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        elmnt.style.left = `${initialLeft + dx}px`;
        elmnt.style.top = `${initialTop + dy}px`;
    }

    function dragEnd() {
        isDragging = false;
        document.removeEventListener("mousemove", dragMove);
        document.removeEventListener("mouseup", dragEnd);
    }
</script>
</body>
</html>
